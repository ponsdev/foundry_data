var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class SETTINGS{static get MOD_NAME(){return this._MOD_NAME}static init(modName){this._MOD_NAME=modName;}static register(key,config){game.settings.register(SETTINGS._MOD_NAME,key,config);}static get(key){return game.settings.get(SETTINGS._MOD_NAME,key)}static set(key,value){return __awaiter(this,void 0,void 0,function*(){return yield game.settings.set(SETTINGS._MOD_NAME,key,value)})}static default(key){return game.settings.settings.get(`${SETTINGS._MOD_NAME}.${key}`).default}static typeOf(){return Object}}

var __awaiter$1=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class DFChatArchive{static setUpdateListener(listener){this._updateListener=listener;}static registerSettings(){SETTINGS.register(this.PREF_LOGS,{scope:"world",config:!1,type:Object,default:[],onChange:()=>{null!=this._updateListener&&this._updateListener();}}),SETTINGS.register(this.PREF_CID,{scope:"world",config:!1,type:Number,default:0}),SETTINGS.register(this.PREF_FOLDER,{scope:"world",config:!1,type:String,default:`worlds/${game.world.name}/chat-archive`,onChange:()=>{this.createArchiveFolderIfMissing(this.DATA_FOLDER,SETTINGS.get(this.PREF_FOLDER)),null!=this._updateListener&&this._updateListener();}}),this.createArchiveFolderIfMissing(this.DATA_FOLDER,SETTINGS.get(this.PREF_FOLDER));}static createArchiveFolderIfMissing(origin,folder){FilePicker.browse(origin,folder).then(loc=>{loc.target=="worlds/"+game.world.name&&FilePicker.createDirectory(origin,folder,{});}).catch(_=>{throw new Error("Could not access the archive folder: "+folder)});}static getLogs(){return SETTINGS.get(this.PREF_LOGS)}static getArchive(id){return this.getLogs().find(x=>x.id==id)}static exists(id){return !!this.getLogs().find(x=>x.id==id)}static _generateChatArchiveFile(id,name,chats,visible){return __awaiter$1(this,void 0,void 0,function*(){const folderPath=SETTINGS.get(this.PREF_FOLDER),fileName=encodeURI(`${id}_${name}.json`),file=new File([JSON.stringify(chats,null,"")],fileName,{type:"application/json"}),response=yield FilePicker.upload(this.DATA_FOLDER,folderPath,file);if(!response.path)throw new Error("Could not upload the archive to server: "+fileName);return {id:id,name:name,visible:visible,filepath:response.path,filename:fileName}})}static createChatArchive(name,chats,visible){return __awaiter$1(this,void 0,void 0,function*(){var newId=SETTINGS.get(this.PREF_CID)+1;SETTINGS.set(this.PREF_CID,newId);const entry=yield this._generateChatArchiveFile(newId,name,chats,visible),logs=SETTINGS.get(this.PREF_LOGS);return logs.push(entry),yield SETTINGS.set(this.PREF_LOGS,logs),null!=this._updateListener&&this._updateListener(),entry})}static getArchiveContents(archive){return __awaiter$1(this,void 0,void 0,function*(){const response=yield fetch(archive.filepath),data=yield response.json().catch(error=>console.error(`Failed to read JSON for archive ${archive.filepath}\n${error}`));if(response.ok)return data;throw new Error("Could not access the archive from server side: "+archive.filepath)})}static updateChatArchive(archive,newChatData){return __awaiter$1(this,void 0,void 0,function*(){if(!this.getLogs().find(x=>x.id==archive.id))throw new Error("Could not locate an archive for the given ID: "+archive.id.toString());if(newChatData){const folderPath=SETTINGS.get(this.PREF_FOLDER),file=new File([JSON.stringify(newChatData)],archive.filename,{type:"application/json"});if(!(yield FilePicker.upload(this.DATA_FOLDER,folderPath,file,{})).path)throw new Error("Could not upload the archive to server side: "+archive.id.toString())}const logs=this.getLogs(),idx=logs.findIndex(x=>x.id===archive.id);return idx<0?archive:(logs[idx]=archive,yield SETTINGS.set(DFChatArchive.PREF_LOGS,logs),archive)})}static deleteAll(){return __awaiter$1(this,void 0,void 0,function*(){const folderPath=SETTINGS.get(this.PREF_FOLDER);var logs=SETTINGS.get(this.PREF_LOGS);yield Promise.all(logs.map(archive=>{const file=new File([""],archive.filename,{type:"application/json"});return FilePicker.upload(this.DATA_FOLDER,folderPath,file,{})})),yield SETTINGS.set(this.PREF_LOGS,[]),null!=this._updateListener&&this._updateListener();})}static deleteChatArchive(id){return __awaiter$1(this,void 0,void 0,function*(){const folderPath=SETTINGS.get(this.PREF_FOLDER),logs=SETTINGS.get(this.PREF_LOGS),entryIdx=logs.findIndex(x=>x.id===id);if(entryIdx<0)return void console.error(`Could not find entry for ID#${id}`);const entry=logs[entryIdx],file=new File([""],entry.filename,{type:"application/json"});yield FilePicker.upload(this.DATA_FOLDER,folderPath,file,{}),logs.splice(entryIdx,1),yield SETTINGS.set(this.PREF_LOGS,logs),null!=this._updateListener&&this._updateListener();})}static upgradeFromDatabaseEntries(){return __awaiter$1(this,void 0,void 0,function*(){if(!game.user.isGM)return;var logData=SETTINGS.get(this.PREF_LOGS);logData instanceof String&&(logData=JSON.parse(logData.toString()));const needUpgrades=logData.filter(x=>void 0!==x.chats),logs=logData.filter(x=>void 0!==x.filename);console.log("DF Chat Enhancements: Upgrading obsolete entries: ",needUpgrades),needUpgrades.length>0&&ui.notifications.info("DF Chat Enhancements: Migrating Chat Archive data...");const newEntries=[];for(let entry of needUpgrades)newEntries.push(yield this._generateChatArchiveFile(entry.id,entry.name,entry.chats,entry.visible));console.log("DF Chat Enhancements: upgraded entries: ",JSON.stringify(newEntries.map(x=>x.filepath),null,"\t")),logs.push(...newEntries),newEntries.length>0&&(yield SETTINGS.set(this.PREF_LOGS,logs),null!=this._updateListener&&this._updateListener(),ui.notifications.info("DF Chat Enhancements: Migration complete."));})}}DFChatArchive.PREF_LOGS="logs",DFChatArchive.PREF_CID="currentId",DFChatArchive.PREF_FOLDER="archiveFolder",DFChatArchive.DATA_FOLDER="data",DFChatArchive._updateListener=null;

var __awaiter$2=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class CONFIG{static requestReload(){return __awaiter$2(this,void 0,void 0,function*(){(yield Dialog.confirm({title:game.i18n.localize("DF_CHAT_ENHANCE.ReloadGameTitle"),content:game.i18n.localize("DF_CHAT_ENHANCE.ReloadGameContent"),defaultYes:!0}))&&window.location.reload();})}}CONFIG.MOD_NAME="df-chat-enhance";

var __awaiter$3=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class DFChatArchiveNew extends FormApplication{static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{template:"modules/df-chat-enhance/templates/archive-new.hbs",resizable:!1,minimizable:!1,title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveNew_Title")})}static registerSettings(){game.settings.register(CONFIG.MOD_NAME,DFChatArchiveNew.PREF_DELETE,{config:!1,scope:"world",type:Boolean,default:!0});}getData(options){return mergeObject(super.getData(options),{shouldDelete:game.settings.get(CONFIG.MOD_NAME,DFChatArchiveNew.PREF_DELETE)})}_updateObject(_event,formData){return __awaiter$3(this,void 0,void 0,function*(){game.settings.set(CONFIG.MOD_NAME,DFChatArchiveNew.PREF_DELETE,formData.delete);const name=formData.name;if(!name)throw ui.notifications.warn(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveNew_ErrorNameMissing")),Error(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveNew_ErrorNameMissing"));var chats=[...ui.chat.collection.values()];if("date"===formData["date-or-all"]){const fromDate=new Date(formData.from).getTime(),toDate=new Date(formData.to).getTime();if(isNaN(fromDate)||isNaN(toDate))throw ui.notifications.warn(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveNew_ErrorDatesMissing")),Error('Missing "from" and/or "to" dates');chats=chats.filter(value=>value.data.timestamp>=fromDate&&value.data.timestamp<=toDate);}if(ui.notifications.info(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveNew_NoticeSuccess").replace("{0}",name)),DFChatArchive.createChatArchive(name,chats,formData.visible),formData.delete)for(let chat of chats)chat.delete();})}_renderInner(data,options){return super._renderInner(data,options).then(html=>{const from=html.find("#dfca-from"),to=html.find("#dfca-to");return html.find("#dfca-all").on("change",()=>{from.prop("disabled",!0),to.prop("disabled",!0),this._recalculateDimensions();}),html.find("#dfca-date").on("change",()=>{from.prop("disabled",!1),to.prop("disabled",!1),this._recalculateDimensions();}),html})}}DFChatArchiveNew.PREF_DELETE="new-should-delete",DFChatArchiveNew.PREF_HIDE_EXPORT="hide-export";

var __awaiter$4=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class DFChatArchiveViewer extends Application{constructor(archive,onCloseCallBack){super(),this.archive=archive,this.onCloseCallBack=onCloseCallBack;}static get defaultOptions(){return mergeObject(Application.defaultOptions,{template:"modules/df-chat-enhance/templates/archive-viewer.hbs",width:300,height:500,resizable:!0,title:"DF_CHAT_ARCHIVE.ArchiveViewer_Title",classes:["df-chat-log-window"]})}getData(options={}){var _a;return super.getData(options),{name:this.archive.name,isGM:game.user.isGM,visible:null!==(_a=this.archive.visible)&&void 0!==_a&&_a,logId:"df-chat-log-"+this.archive.id}}_renderInner(data,options){return super._renderInner(data,options).then(html=>__awaiter$4(this,void 0,void 0,function*(){html.find("#visible").on("change",element=>__awaiter$4(this,void 0,void 0,function*(){this.archive.visible=element.target.checked,yield DFChatArchive.updateChatArchive(this.archive);})),html.find("#edit").on("click",()=>__awaiter$4(this,void 0,void 0,function*(){setTimeout(()=>__awaiter$4(this,void 0,void 0,function*(){const dialog=new Dialog({title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_NameEdit_Title"),content:`<input id="name" type="text" value="${this.archive.name}"/>`,buttons:{save:{icon:'<i class="fas fa-save"></i>',label:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_NameEdit_Save"),callback:html=>__awaiter$4(this,void 0,void 0,function*(){this.archive.name=$(html).find("#name").val(),yield dialog.close(),yield DFChatArchive.updateChatArchive(this.archive),yield this.render(!1);})},close:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_NameEdit_Cancel"),callback:()=>__awaiter$4(this,void 0,void 0,function*(){yield dialog.close();})}},default:"save"});dialog.render(!0);}),1);})),html.find("#print").on("click",()=>__awaiter$4(this,void 0,void 0,function*(){const clone=html.find("#df-chat-log").clone();clone.addClass("df-chat-print"),$("body").hide(),$("html").addClass("df-chat-print"),$("html").append(clone),window.print(),clone.remove(),$("html").removeClass("df-chat-print"),$("body").show();})),html.find("#merge").on("click",()=>__awaiter$4(this,void 0,void 0,function*(){if(1==DFChatArchive.getLogs().length)return void ui.notifications.info(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_Merge_OnlyOneArchive"));const dialog=new Dialog({title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_Merge_Title"),default:"merge",content:yield renderTemplate("modules/df-chat-enhance/templates/archive-merge.hbs",{name:this.archive.name,archives:DFChatArchive.getLogs().filter(x=>x.id!=this.archive.id)}),buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_Merge_Cancel"),callback:()=>__awaiter$4(this,void 0,void 0,function*(){return yield dialog.close()})},merge:{icon:'<i class="fas fa-sitemap"></i>',label:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_Merge_Merge"),callback:html=>__awaiter$4(this,void 0,void 0,function*(){const val=$(html).find("#archive").val();if(isNaN(parseInt(val)))return;const id=parseInt(val),source=DFChatArchive.getLogs().find(x=>x.id==id),currentChats=yield DFChatArchive.getArchiveContents(this.archive),sourceChats=yield DFChatArchive.getArchiveContents(source),mergedChats=currentChats.concat(sourceChats).sort((a,b)=>a.timestamp-b.timestamp);DFChatArchive.updateChatArchive(this.archive,mergedChats),this.render(!1),$(html).find("#delete")[0].checked&&DFChatArchive.deleteChatArchive(id);})}}});yield dialog.render(!0);}));const log=html.find("#df-chat-log"),messageHtml=[];var currentChats=yield DFChatArchive.getArchiveContents(this.archive);const deletionList=[],deleteButton=html.find("#dfal-save-changes");for(let value of currentChats){const chatMessage=value instanceof ChatMessage?value:new ChatMessage(value);try{const html=$(yield chatMessage.render());1==currentChats.length&&html.find("a.message-delete").hide(),html.find("a.message-delete").on("click",event=>{var _a,_b,_c;const messageHtml=$(null===(_c=null===(_b=null===(_a=event.target.parentElement)||void 0===_a?void 0:_a.parentElement)||void 0===_b?void 0:_b.parentElement)||void 0===_c?void 0:_c.parentElement),buttonIcon=$(event.target);messageHtml.hasClass("dfal-deleted")?(messageHtml.removeClass("dfal-deleted"),buttonIcon.removeClass("fa-redo-alt"),buttonIcon.addClass("fa-trash"),deletionList.splice(deletionList.findIndex(x=>x===messageHtml.attr("data-message-id")),1)):(messageHtml.addClass("dfal-deleted"),buttonIcon.removeClass("fa-trash"),buttonIcon.addClass("fa-redo-alt"),deletionList.push(messageHtml.attr("data-message-id"))),deletionList.length>0?deleteButton.show():deleteButton.hide();}),messageHtml.push(html);}catch(err){console.error(`Chat message ${chatMessage.id} failed to render.\n${err})`);}}return log.prepend(messageHtml),deleteButton.hide(),deleteButton.on("click",()=>__awaiter$4(this,void 0,void 0,function*(){console.log(deletionList),deletionList.length!==currentChats.length?Dialog.confirm({title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_DeleteTitle"),content:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_DeleteContent"),defaultYes:!1,no:()=>{},yes:()=>__awaiter$4(this,void 0,void 0,function*(){for(let id of deletionList){const message=html.find(`li[data-message-id="${id}"]`);message.hide(500,()=>message.remove());}currentChats=currentChats.filter(x=>!deletionList.includes(x._id)),yield DFChatArchive.updateChatArchive(this.archive,currentChats);})}):ui.notifications.warn(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveViewer_Error_Delete_All"));})),html}))}close(options={}){return this.onCloseCallBack(this),super.close(options)}}

var __awaiter$5=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class DFChatArchiveManager extends Application{static get defaultOptions(){return mergeObject(Application.defaultOptions,{template:"modules/df-chat-enhance/templates/archive-manager.hbs",resizable:!0,minimizable:!0,width:300,height:500,title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_Title")})}getData(options){let data=super.getData(options);var messages=DFChatArchive.getLogs();return game.user.isGM||(messages=messages.filter(x=>x.visible)),mergeObject(data,{messages:messages}),data}_subscribeView(element){element.on("click",function(){const id=parseInt($(this).attr("data-id"));if(isNaN(id)||!DFChatArchive.exists(id))throw ui.notifications.error(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ErrorBadId")),Error(`Invalid id for Chat Archive: '${$(this).attr("data-id")}'`);DFChatArchiveManager.chatViewers.has(id)?DFChatArchiveManager.chatViewers.get(id).bringToTop():(DFChatArchiveManager.chatViewers.set(id,new DFChatArchiveViewer(DFChatArchive.getArchive(id),view=>{DFChatArchiveManager.chatViewers.delete(view.archive.id);})),DFChatArchiveManager.chatViewers.get(id).render(!0));});}_subscribeDelete(element){element.on("click",function(){return __awaiter$5(this,void 0,void 0,function*(){const id=parseInt($(this).attr("data-id"));if(isNaN(id)||!DFChatArchive.exists(id))throw ui.notifications.error(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ErrorBadId")),Error(`Invalid id for Chat Archive: '${$(this).attr("data-id")}'`);const archive=DFChatArchive.getArchive(id);yield Dialog.confirm({title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteArchiveTitle"),content:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteArchiveContent").replace("{name}",archive.name),defaultYes:!1,yes:()=>__awaiter$5(this,void 0,void 0,function*(){return yield DFChatArchive.deleteChatArchive(id)})});})});}activateListeners(html){DFChatArchive.setUpdateListener(this._archiveChanged.bind(this)),DFChatArchive.getLogs().length>0&&html.find("p.dfca-no-items").hide(),html.find('a[data-type="view"]').each((i,element)=>{this._subscribeView($(element));}),html.find('a[data-type="delete"]').each((i,element)=>{this._subscribeDelete($(element));}),html.find("#dfca-delete-all").on("click",function(){return __awaiter$5(this,void 0,void 0,function*(){yield Dialog.confirm({title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllTitle"),content:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllMessage1"),defaultYes:!1,yes:()=>__awaiter$5(this,void 0,void 0,function*(){yield Dialog.confirm({title:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllTitle"),content:game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllMessage2"),defaultYes:!1,yes:()=>__awaiter$5(this,void 0,void 0,function*(){yield DFChatArchive.deleteAll(),ui.notifications.info(game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllComplete"));})});})});})});}close(options={}){return DFChatArchive.setUpdateListener(null),super.close(options)}_archiveChanged(){return __awaiter$5(this,void 0,void 0,function*(){var logs=DFChatArchive.getLogs();game.user.isGM||(logs=logs.filter(x=>x.visible));const archiveContainer=this.element.find("#dfca-archives");archiveContainer.empty();for(let archive of logs){const visible=!0===archive.visible?`<i class="dfca-visible fas fa-users" title="${game.i18n.localize("DF_CHAT_ARCHIVE.ArchiveManager_VisibleToPlayers")}"></i>`:"",html=$(`\n\t\t<li class="dfca-archive-item" data-id="${archive.id}">\n\t\t\t<div>\n\t\t\t\t<a class="button dfca-view" data-type="view" data-id="${archive.id}"><i class="fas fa-eye"></i>\n\t\t\t\t\t<span>${archive.name}</span>\n\t\t\t\t</a>\n\t\t\t\t${visible}\n\t\t\t\t<a class="button dfca-delete" data-type="delete" data-id="${archive.id}"><i class="fas fa-trash"></i></a>\n\t\t\t</div>\n\t\t</li>`);this._subscribeView(html.find('a[data-type="view"]')),this._subscribeDelete(html.find('a[data-type="delete"]')),archiveContainer.append(html);}0==archiveContainer[0].children.length?this.element.find("p.dfca-no-items").show():this.element.find("p.dfca-no-items").hide();})}}DFChatArchiveManager.chatViewers=new Map;

function init(){var archiveNew=null,archiveManager=null;DFChatArchive.registerSettings(),DFChatArchiveNew.registerSettings(),SETTINGS.register(DFChatArchiveNew.PREF_HIDE_EXPORT,{name:"DF_CHAT_ARCHIVE.Settings_HideExport",scope:"world",type:Boolean,default:!1,config:!0,onChange:newValue=>{newValue?$("#chat-controls .export-log").hide():$("#chat-controls .export-log").show();}}),Hooks.on("renderChatLog",function(chatLog,html,data){const archiveButton=$(`<a class="button chat-archive" title="${game.i18n.localize("DF_CHAT_ARCHIVE.ExportButtonTitle")}">\n\t\t<i class="fas fa-archive"></i></a>`);archiveButton.on("click",()=>{null==archiveNew?(archiveNew=new DFChatArchiveNew).render(!0):archiveNew.bringToTop();}),html.find(".control-buttons").prepend(archiveButton).attr("style","flex:0 0 auto;"),game.settings.get(CONFIG.MOD_NAME,DFChatArchiveNew.PREF_HIDE_EXPORT)&&html.find(".control-buttons .export-log").hide();}),Hooks.on("renderSettings",function(settings,html,data){const archiveManagerHtml=$(`<div id="df-chat-enhance-settings" style="margin:0">\n\t<h4>${game.i18n.localize("DF_CHAT_ARCHIVE.ChatEnhanceSettingGroup")}</h4>\n\t<button data-action="archive"><i class="fas fa-archive"></i>${game.i18n.localize("DF_CHAT_ARCHIVE.OpenChatArchive")}</button>\n</div>`);archiveManagerHtml.on("click",()=>{null==archiveManager?(archiveManager=new DFChatArchiveManager).render(!0):archiveManager.bringToTop();}),html.find("#settings-game").append(archiveManagerHtml);}),Hooks.on("closeDFChatArchiveNew",()=>archiveNew=null),Hooks.on("closeDFChatArchiveManager",()=>archiveManager=null),Hooks.on("renderDFChatArchiveNew",function(app,html,data){html.find('input[type="text"]')[0].focus();});}function ready(){DFChatArchive.upgradeFromDatabaseEntries();}

var __awaiter$6=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class DFChatEditor extends FormApplication{constructor(chatMessage){super(),this.chatMessage=chatMessage;}static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{closeOnSubmit:!0,editable:!0,resizable:!0,width:400,popOut:!0,title:"DF_CHAT_EDIT.Editor_Title",template:"modules/df-chat-enhance/templates/chat-edit.hbs"})}getData(options){return mergeObject(options,{messageText:this.chatMessage.data.content.replace(/< *br *\/?>/gm,"\n").replace(/\<p +class="df-edited"\>.+/,"")})}activateListeners(html){super.activateListeners(html),html.find("#cancel").on("click",()=>__awaiter$6(this,void 0,void 0,function*(){return yield this.close()}));}_updateObject(_event,formData){return __awaiter$6(this,void 0,void 0,function*(){var data=formData.content;(data=data.replace(/\r?\n/gm,"<br/>")).search(/\<p +class="df-edited"\>/)<0&&(data+=`<p class="df-edited">${game.i18n.localize("DF_CHAT_EDIT.EditedFlag")}</p>`),this.chatMessage.update({content:data});})}close(options){return delete this.chatMessage.chatEditor,super.close(options)}}

const PREF_EDIT_ALLOWED="edit-allowed",PREF_GM_ALL="gm-edit-all";function initDFChatEdit(){game.settings.register(CONFIG.MOD_NAME,PREF_EDIT_ALLOWED,{name:"DF_CHAT_EDIT.Settings_AllowEditName",hint:"DF_CHAT_EDIT.Settings_AllowEditHint",type:Boolean,default:!0,scope:"world",config:!0}),game.settings.register(CONFIG.MOD_NAME,PREF_GM_ALL,{name:"DF_CHAT_EDIT.Settings_GMEditAllName",hint:"DF_CHAT_EDIT.Settings_GMEditAllHint",type:Boolean,default:!1,config:!0,scope:"world",onChange:()=>{processAllMessages();}}),(game.user.isGM||game.settings.get(CONFIG.MOD_NAME,PREF_EDIT_ALLOWED))&&(Hooks.on("renderChatMessage",processChatMessage),processAllMessages()),libWrapper.register(CONFIG.MOD_NAME,"ChatLog.prototype._onChatKeyDown",(wrapper,...args)=>{const event=args[0];if("ArrowUp"===game.keyboard.getKey(event)&&event.shiftKey){event.preventDefault();var messages=[...ui.chat.collection.values()];const message=(messages=messages.sort((a,b)=>b.data.timestamp-a.data.timestamp)).find(x=>x.data.user===game.user.id);if(!message)return;editChatMessage.bind(message)();}else wrapper(...args);},"MIXED");}function editChatMessage(){if(!game.settings.get(CONFIG.MOD_NAME,PREF_EDIT_ALLOWED))return ui.notifications.warn(game.i18n.localize("DF_CHAT_EDIT.Error_NoPermission")),void processAllMessages();this.chatEditor?this.chatEditor.bringToTop():(this.chatEditor=new DFChatEditor(this),this.chatEditor.render(!0));}function processAllMessages(){var element;ui.chat.element.find("li.chat-message").each(function(){element=$(this);const message=game.messages.get(element.attr("data-message-id"));processChatMessage(message,element,message.data);});}function processChatMessage(chatMessage,html,data){if(!ui.chat.collection.has(chatMessage.id))return;if(0!=html.find("a.button.message-edit").length&&html.find("a.button.message-edit").remove(),!game.settings.get(CONFIG.MOD_NAME,PREF_EDIT_ALLOWED)||chatMessage.isRoll||chatMessage.data.user!==game.userId&&(!game.user.isGM||!game.settings.get(CONFIG.MOD_NAME,PREF_GM_ALL)))return;const header=html.find("header.message-header"),editButton=$('<a class="button message-edit"><i class="fas fa-pencil-alt"></i></a>');header.prepend(editButton),editButton.on("click",editChatMessage.bind(chatMessage));}

var __awaiter$7=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};String.prototype.trimStart||(String.prototype.trimStart=function(){const whitespace=[" ","\n","\r"];var index=-1;for(let c=0;c<this.length&&!whitespace.every(x=>x!==this[c]);c++)index=c;return this.substr(index+1)});class DFAdventureLogProcessor{static initialise(){libWrapper.register(CONFIG.MOD_NAME,"ChatLog.prototype._getEntryContextOptions",function(wrapped,...args){const options=wrapped(...args);return options.push({name:"DF_CHAT_LOG.ContextMenu_AsEvent",icon:'<i style="color:SeaGreen" class="fas fa-edit"></i>',condition:()=>{const enabled=SETTINGS.get(DFAdventureLogProcessor.PREF_ENABLE),isGM=game.user.isGM,gmOnly=SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY);return enabled&&(!gmOnly||isGM)},callback:header=>{const chatData=ui.chat.collection.get($(header).attr("data-message-id")).data;return DFAdventureLogProcessor.commandProcessor(chatData.content,!1),{}}}),options.push({name:"DF_CHAT_LOG.ContextMenu_AsQuote",icon:'<i style="color:SeaGreen" class="fas fa-quote-right"></i>',condition:()=>{const enabled=SETTINGS.get(DFAdventureLogProcessor.PREF_ENABLE),isGM=game.user.isGM,gmOnly=SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY);return enabled&&(!gmOnly||isGM)},callback:header=>{const chatData=ui.chat.collection.get($(header).attr("data-message-id")).data;return chatData.content.trimStart().startsWith('"')?DFAdventureLogProcessor.commandProcessor("q "+chatData.content,!1):DFAdventureLogProcessor.commandProcessor(`q "${game.users.get(chatData.user).name}" ${chatData.content}`,!1),{}}}),options.push({name:"DF_CHAT_LOG.ContextMenu_AsGmEvent",icon:'<i style="color:FireBrick" class="fas fa-edit"></i>',condition:()=>{const enabled=SETTINGS.get(DFAdventureLogProcessor.PREF_ENABLE),isGM=game.user.isGM,gmOnly=SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY);return enabled&&(!gmOnly||isGM)},callback:header=>{const chatData=ui.chat.collection.get($(header).attr("data-message-id")).data;return DFAdventureLogProcessor.commandProcessor(chatData.content,!0),{}}}),options.push({name:"DF_CHAT_LOG.ContextMenu_AsGmQuote",icon:'<i style="color:FireBrick" class="fas fa-quote-right"></i>',condition:()=>{const enabled=SETTINGS.get(DFAdventureLogProcessor.PREF_ENABLE),isGM=game.user.isGM,gmOnly=SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY);return enabled&&(!gmOnly||isGM)},callback:header=>{const chatData=ui.chat.collection.get($(header).attr("data-message-id")).data;return chatData.content.trimStart().startsWith('"')?DFAdventureLogProcessor.commandProcessor("q "+chatData.content,!0):DFAdventureLogProcessor.commandProcessor(`q "${game.users.get(chatData.user).name}" ${chatData.content}`,!0),{}}}),options},"WRAPPER");}static setupSettings(){SETTINGS.register(DFAdventureLogProcessor.PREF_ENABLE,{scope:"world",name:"DF_CHAT_LOG.Setting_EnableTitle",hint:"DF_CHAT_LOG.Setting_EnableHint",config:!0,type:Boolean,default:!0,onChange:enabled=>{!enabled&&DFAdventureLogProcessor.logCommand?DFAdventureLogProcessor.deregisterCommand():DFAdventureLogProcessor.registerCommand();}}),SETTINGS.register(DFAdventureLogProcessor.PREF_GMONLY,{name:"DF_CHAT_LOG.Setting_GmOnlyTitle",hint:"DF_CHAT_LOG.Setting_GmOnlyHint",scope:"world",type:Boolean,default:!1,config:!0,onChange:gmOnly=>{gmOnly&&!game.user.isGM?DFAdventureLogProcessor.deregisterCommand():DFAdventureLogProcessor.registerCommand();}}),SETTINGS.register(DFAdventureLogProcessor.PREF_GMONLY_WHISPER,{name:"DF_CHAT_LOG.Setting_GmOnlyWhisperName",hint:"DF_CHAT_LOG.Setting_GmOnlyWhisperHint",scope:"world",type:Boolean,default:!1,config:!0}),SETTINGS.register(DFAdventureLogProcessor.PREF_MESSAGES,{name:"DF_CHAT_LOG.Setting_PrintMessagesName",hint:"DF_CHAT_LOG.Setting_PrintMessagesHint",scope:"world",type:Boolean,default:!0,config:!0}),SETTINGS.register(DFAdventureLogProcessor.PREF_SORTDESC,{name:"DF_CHAT_LOG.Setting_SortDescendingName",hint:"DF_CHAT_LOG.Setting_SortDescendingHint",scope:"world",type:Boolean,default:!1,config:!0,onChange:()=>this.resortLog()}),Hooks.on("closeDFAdventureLogConfig",()=>{DFAdventureLogProcessor.logConfig=null;}),game.chatCommands?DFAdventureLogProcessor.registerCommand():Hooks.on("chatCommandsReady",function(chatCommands){DFAdventureLogProcessor.registerCommand();});}static deregisterCommand(){game.chatCommands.deregisterCommand(DFAdventureLogProcessor.logCommand),DFAdventureLogProcessor.gmlogCommand&&game.chatCommands.deregisterCommand(DFAdventureLogProcessor.gmlogCommand),DFAdventureLogProcessor.logCommand=null,DFAdventureLogProcessor.gmlogCommand=null;}static registerCommand(){SETTINGS.get(DFAdventureLogProcessor.PREF_ENABLE)&&(SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY)&&!game.user.isGM||DFAdventureLogProcessor.logCommand||(DFAdventureLogProcessor.logCommand=game.chatCommands.createCommandFromData({commandKey:"/log",invokeOnCommand:(_cl,msg,_cd)=>__awaiter$7(this,void 0,void 0,function*(){return yield DFAdventureLogProcessor.commandProcessor(msg,!1)}),shouldDisplayToChat:!1,iconClass:"fa-edit",description:game.i18n.localize("DF_CHAT_LOG.CommandDescription")}),game.chatCommands.registerCommand(DFAdventureLogProcessor.logCommand),game.user.isGM&&(DFAdventureLogProcessor.gmlogCommand=game.chatCommands.createCommandFromData({commandKey:"/gmlog",invokeOnCommand:(_cl,msg,_cd)=>__awaiter$7(this,void 0,void 0,function*(){return yield DFAdventureLogProcessor.commandProcessor(msg,!0)}),shouldDisplayToChat:!1,iconClass:"fa-edit",description:game.i18n.localize("DF_CHAT_LOG.GMCommandDescription")}),game.chatCommands.registerCommand(DFAdventureLogProcessor.gmlogCommand))));}static commandProcessor(messageText,gmLog,preventPostToChat=!1){return __awaiter$7(this,void 0,void 0,function*(){const tokens=(messageText=messageText.trim()).split(" ");if(!SETTINGS.get(DFAdventureLogProcessor.PREF_ENABLE))return game.chatCommands.deregisterCommand(DFAdventureLogProcessor.logCommand),void ui.notifications.warn(game.i18n.localize("DF_CHAT_LOG.Error_Disabled"));if(0==messageText.length||tokens.every(x=>0==x.length))return void setTimeout(()=>__awaiter$7(this,void 0,void 0,function*(){yield Dialog.prompt({title:game.i18n.localize("DF_CHAT_LOG.HelpDialog_Title"),label:"OK",callback:()=>{},content:yield renderTemplate(`modules/df-chat-enhance/templates/lang/log-help.${game.i18n.localize("DF_CHAT_ENHANCE.LANG")}.hbs`,{isGM:game.user.isGM}),options:{width:800}});}),1);const speaker=ChatMessage.getSpeaker({user:game.user}),messageData={flavor:"",user:game.user._id,speaker:speaker,type:CONST.CHAT_MESSAGE_TYPES.OOC,content:""};switch(tokens[0].toLowerCase()){case"config":return game.user.isGM?void setTimeout(()=>__awaiter$7(this,void 0,void 0,function*(){DFAdventureLogProcessor.logConfig?DFAdventureLogProcessor.logConfig.bringToTop():(DFAdventureLogProcessor.logConfig=new DFAdventureLogConfig,DFAdventureLogProcessor.logConfig.render(!0));}),1):void ui.notifications.warn(game.i18n.localize("DF_CHAT_LOG.Error_ConfigGmOnly"));case"q":case"quote":var source;if(messageText=messageText.replace(tokens[0],"").trimStart(),'"'===tokens[1][0]&&'"'!==tokens[1][tokens[1].length-1]){var index=-1;for(let c=1;c<messageText.length;c++)if('"'===messageText[c]){index=c;break}if(index<0)return ui.notifications.error(game.i18n.localize("DF_CHAT_LOG.Error_MissingQuote").replace("{0}",tokens[1])),void setTimeout(()=>$("#chat-message").val("/log q "+messageText),1);source=messageText.slice(0,index+1);}else source=tokens[1];if(messageText=messageText.replace(source,"").trim(),source=source.replace(/"/gm,""),messageData.flavor=`${game.user.name} quoted ${source}`,messageData.content=`<span class="dfal-qu">${messageText}</span>`,0==messageText.length)return ui.notifications.error(game.i18n.localize("DF_CHAT_LOG.Error_MissingMessage")),void setTimeout(()=>$("#chat-message").val(`/log q "${source}" ${messageText}`),1);line=(line=(line=(line=game.i18n.localize("DF_CHAT_LOG.Log_Quote")).replace("{0}",(new Date).toLocaleString("sv").replace(",","").replace(/ ([AP])/,"$1"))).replace("{1}",game.user.name)).replace("{2}",source),messageText=line.replace("{3}",messageText);break;case"e":case"event":messageText=messageText.replace(tokens[0],"").trim();default:var line;messageText=messageText.trim(),messageData.flavor="Event Logged",messageData.content=`<span class="dfal-ev">${messageText}</span>`,line=(line=(line=game.i18n.localize("DF_CHAT_LOG.Log_Event")).replace("{0}",(new Date).toLocaleString("sv").replace(",","").replace(/ ([AP])/,"$1"))).replace("{1}",game.user.name),messageText=line.replace("{2}",messageText);}const journalId=SETTINGS.get(gmLog?DFAdventureLogConfig.PREF_JOURNAL_GM:DFAdventureLogConfig.PREF_JOURNAL);if(!game.journal.has(journalId))return void(game.user.isGM?ui.notifications.error(game.i18n.localize("DF_CHAT_LOG.Error_NoJournalSetGM"),{permanent:!0}):ui.notifications.warn(game.i18n.localize("DF_CHAT_LOG.Error_NoJournalSet")));const journal=game.journal.get(journalId);var html=$(journal.data.content),messageHtml=$(messageText),article=html.find("article.df-adventure-log");0==article.length&&(yield DFAdventureLogConfig.initializeJournal(journalId,!1,gmLog),html=$(journal.data.content),messageHtml=$(messageText),article=html.find("article.df-adventure-log")),SETTINGS.get(this.PREF_SORTDESC)?article.prepend(messageHtml):article.append(messageHtml),yield journal.update({content:$("<div></div>").append(html).html()});const rollType=game.settings.get("core","rollMode");game.user.isGM&&("roll"!==rollType||SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY)&&SETTINGS.get(DFAdventureLogProcessor.PREF_GMONLY_WHISPER))&&(messageData.whisper=[game.user.id]),gmLog&&(messageData.whisper=[game.user.id]),!preventPostToChat&&SETTINGS.get(DFAdventureLogProcessor.PREF_MESSAGES)&&(yield ChatMessage.create(messageData,{}));})}static resortLog(){return __awaiter$7(this,void 0,void 0,function*(){const descending=SETTINGS.get(this.PREF_SORTDESC),journalAll=SETTINGS.get(DFAdventureLogConfig.PREF_JOURNAL),journalGM=SETTINGS.get(DFAdventureLogConfig.PREF_JOURNAL_GM),journalSort=journal=>__awaiter$7(this,void 0,void 0,function*(){var html=$(journal.data.content);const article=html.find("article.df-adventure-log"),result=article.find("p").sort(function(a,b){return descending?$(b).find("span.dfal-ts").text().localeCompare($(a).find("span.dfal-ts").text()):$(a).find("span.dfal-ts").text().localeCompare($(b).find("span.dfal-ts").text())});article.html(result),yield journal.update({content:$("<div></div>").append(html).html()});});game.journal.has(journalAll)&&(yield journalSort(game.journal.get(journalAll))),game.journal.has(journalGM)&&(yield journalSort(game.journal.get(journalGM)));})}}DFAdventureLogProcessor.PREF_ENABLE="enable-command",DFAdventureLogProcessor.PREF_GMONLY="df-log-gmonly",DFAdventureLogProcessor.PREF_GMONLY_WHISPER="df-log-gmonly-whisper",DFAdventureLogProcessor.PREF_MESSAGES="df-log-messages",DFAdventureLogProcessor.PREF_SORTDESC="df-log-sortdesc",DFAdventureLogProcessor.logCommand=null,DFAdventureLogProcessor.gmlogCommand=null,DFAdventureLogProcessor.logConfig=null;

var __awaiter$8=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};class DFAdventureLogConfig extends FormApplication{static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{template:"modules/df-chat-enhance/templates/log-config.hbs",resizable:!1,minimizable:!1,title:game.i18n.localize("DF_CHAT_LOG.Config_Title")})}static setupSettings(){game.settings.register(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_JOURNAL,{scope:"world",type:String,default:"",config:!1}),game.settings.register(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_JOURNAL_GM,{scope:"world",type:String,default:"",config:!1}),game.settings.registerMenu(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_CONFIG,{restricted:!0,type:DFAdventureLogConfig,label:"DF_CHAT_LOG.Config_Title",icon:"fas fa-edit"});}getData(options){const data=super.getData(options),keys=game.journal.keys(),selectedLog=game.settings.get(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_JOURNAL),selectedGMLog=game.settings.get(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_JOURNAL_GM);var logJournals=[],gmlogJournals=[];for(let key of keys)logJournals.push({id:key,name:game.journal.get(key).data.name,selected:key===selectedLog}),gmlogJournals.push({id:key,name:game.journal.get(key).data.name,selected:key===selectedGMLog});return logJournals=logJournals.sort((a,b)=>a.name.localeCompare(b.name)),gmlogJournals=gmlogJournals.sort((a,b)=>a.name.localeCompare(b.name)),mergeObject(data,{logJournals:logJournals,gmlogJournals:gmlogJournals}),data}_updateObject(_event,formData){return __awaiter$8(this,void 0,void 0,function*(){const logJournal=formData["dfal-journal"],gmlogJournal=formData["dfal-journal-gm"],clear=formData["dfal-clear"],gmClear=formData["dfal-clear-gm"];game.settings.set(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_JOURNAL,logJournal),game.settings.set(CONFIG.MOD_NAME,DFAdventureLogConfig.PREF_JOURNAL_GM,gmlogJournal),yield DFAdventureLogConfig.initializeJournal(logJournal,clear,!1),yield DFAdventureLogConfig.initializeJournal(gmlogJournal,gmClear,!0);})}static initializeJournal(id,clear,isGMOnly){return __awaiter$8(this,void 0,void 0,function*(){if(!game.journal.has(id))return;const journal=game.journal.get(id);(clear||null===journal.data.content)&&(journal.data.content=""),0==$(journal.data.content).find('article[class="df-adventure-log"]').length?yield journal.update({content:journal.data.content+`\n\t\t\t<section>\n\t\t\t\t<h2>${game.i18n.localize(isGMOnly?"DF_CHAT_LOG.GMLog_Header":"DF_CHAT_LOG.Log_Header")}</h2>\n\t\t\t\t<article class="df-adventure-log"></article>\n\t\t\t\t<hr />\n\t\t\t</section>\n\t\t\t`}):yield DFAdventureLogProcessor.resortLog();})}}DFAdventureLogConfig.PREF_JOURNAL="log-journal",DFAdventureLogConfig.PREF_JOURNAL_GM="gmlog-journal",DFAdventureLogConfig.PREF_CONFIG="log-config-menu";

var __awaiter$9=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};function init$1(){var _a;(null===(_a=game.modules.get("lib-wrapper"))||void 0===_a?void 0:_a.active)&&DFAdventureLogProcessor.initialise();const api={event:function(message,postToChat=!1){return __awaiter$9(this,void 0,void 0,function*(){DFAdventureLogProcessor.commandProcessor("event "+message,!1,!postToChat);})}.bind(DFAdventureLogProcessor),gmevent:function(message,postToChat=!1){return __awaiter$9(this,void 0,void 0,function*(){game.user.isGM?DFAdventureLogProcessor.commandProcessor("event "+message,!0,!postToChat):ui.notifications.warn(game.i18n.localize("DF_CHAT_LOG.Error_ApiLog_NotGm"));})}.bind(DFAdventureLogProcessor),quote:function(speaker,message,postToChat=!1){return __awaiter$9(this,void 0,void 0,function*(){DFAdventureLogProcessor.commandProcessor(`quote "${speaker}" ${message}`,!1,!postToChat);})}.bind(DFAdventureLogProcessor),gmquote:function(speaker,message,postToChat=!1){return __awaiter$9(this,void 0,void 0,function*(){game.user.isGM?DFAdventureLogProcessor.commandProcessor(`quote "${speaker}" ${message}`,!0,!postToChat):ui.notifications.warn(game.i18n.localize("DF_CHAT_LOG.Error_ApiLog_NotGm"));})}.bind(DFAdventureLogProcessor)};window.AdventureLog=api;}function ready$1(){var _a;(null===(_a=game.modules.get("lib-wrapper"))||void 0===_a?void 0:_a.active)&&(DFAdventureLogConfig.setupSettings(),DFAdventureLogProcessor.setupSettings());}

var __awaiter$a=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator.throw(value));}catch(e){reject(e);}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());})};const ICONS_FOR_KNOWN_ROLL_TYPES={roll:"fas fa-dice-d20",gmroll:"fas fa-user-secret",blindroll:"fas fa-user-ninja",selfroll:"fas fa-ghost"};function calcColour(current,count){return `rgb(${current/count*255},${255*(1-current/count)},0)`}function handleChatLogRendering(chat,html,data){return __awaiter$a(this,void 0,void 0,function*(){const modes=Object.keys(data.rollModes),buttons=[],iconKeys=Object.keys(ICONS_FOR_KNOWN_ROLL_TYPES);for(let c=0;c<modes.length;c++){const rt=modes[c];rt in ICONS_FOR_KNOWN_ROLL_TYPES?buttons.push({rt:rt,name:data.rollModes[rt],active:data.rollMode===rt,icon:ICONS_FOR_KNOWN_ROLL_TYPES[rt],colour:calcColour(iconKeys.findIndex(x=>x==rt),iconKeys.length)}):console.warn(Error(`Unknown roll type '${rt}'`));}const buttonHtml=$(yield renderTemplate("modules/df-chat-enhance/templates/privacy-button.hbs",{buttons:buttons}));if(buttonHtml.find("button").on("click",function(){const rollType=$(this).attr("data-id");game.settings.set("core","rollMode",rollType),buttonHtml.find("button.active").removeClass("active"),$(this).addClass("active");}),html.find("select.roll-type-select").after(buttonHtml),html.find("select.roll-type-select").remove(),game.settings.get(CONFIG.MOD_NAME,"replace-buttons")){buttonHtml.attr("style","margin:0 0 0 0.5em");var first=!0;html.find("#chat-controls div.control-buttons a").each(function(idx,element){let html=$(this).html(),classes=$(this).attr("class"),title=$(this).attr("title"),style=$(this).attr("style"),click=$._data(this,"events").click[0].handler,button=$(`<button class="${classes}" title="${title}" style="${style}">${html}</button>`);button.on("click",click),first&&(button.attr("style","margin-left:0.5em"),first=!1),buttonHtml.append(button);}),html.find("#chat-controls div.control-buttons").remove();}})}function initDFChatPrivacy(){game.settings.register(CONFIG.MOD_NAME,"enabled",{name:"DF_CHAT_PRIVACY.Settings_EnableTitle",hint:"DF_CHAT_PRIVACY.Settings_EnableHint",scope:"client",type:Boolean,default:!0,config:!0,onChange:CONFIG.requestReload}),game.settings.register(CONFIG.MOD_NAME,"replace-buttons",{name:"DF_CHAT_PRIVACY.Settings_ReplaceButtonsTitle",hint:"DF_CHAT_PRIVACY.Settings_ReplaceButtonsHint",scope:"client",type:Boolean,default:!0,config:!0,onChange:CONFIG.requestReload}),!1!==game.settings.get(CONFIG.MOD_NAME,"enabled")&&Hooks.on("renderChatLog",handleChatLogRendering);}

SETTINGS.init("df-chat-enhance"),Application.prototype._recalculateDimensions=function(){this.element[0].style.height="",this.element[0].style.width="",this.setPosition({});},Hooks.once("init",function(){init(),initDFChatPrivacy(),init$1();}),Hooks.once("ready",function(){var _a;ready(),(null===(_a=game.modules.get("lib-wrapper"))||void 0===_a?void 0:_a.active)||(console.error("Missing libWrapper module dependency"),game.user.isGM&&ui.notifications.error(game.i18n.localize("DF_CHAT_LOG.Error_LibWrapperMissing"))),ready$1(),initDFChatEdit();});
