/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";var e=[,(e,t,a)=>{a.r(t),a.d(t,{init:()=>init});var i=a(2),r=a(5),o=a(3),s=a(4);function init(){let e=null,t=null;o.DFChatArchive.registerSettings(),i.default.registerSettings(),s.default.register(i.default.PREF_HIDE_EXPORT,{name:"DF_CHAT_ARCHIVE.Settings.HideExport",scope:"world",type:Boolean,default:!1,config:!0,onChange:e=>{e?$("#chat-controls .export-log").hide():$("#chat-controls .export-log").show()}}),s.default.register(r.default.PREF_REVERSE_SORT,{scope:"world",type:Boolean,default:!1,config:!1}),Hooks.on("renderChatLog",(function(t,a){const r=$(`<a class="button chat-archive" title="${"DF_CHAT_ARCHIVE.ExportButtonTitle".localize()}">\n\t\t<i class="fas fa-archive"></i></a>`);r.on("click",(()=>{null==e?(e=new i.default({}),e.render(!0)):e.bringToTop()})),a.find(".control-buttons").prepend(r).attr("style","flex:0 0 auto;"),s.default.get(i.default.PREF_HIDE_EXPORT)&&a.find(".control-buttons .export-log").hide()})),Hooks.on("renderSettings",(function(e,a){const i=$(`<div id="df-chat-enhance-settings" style="margin:0">\n\t<h4>${"DF_CHAT_ARCHIVE.ChatEnhanceSettingGroup".localize()}</h4>\n\t<button data-action="archive"><i class="fas fa-archive"></i>${"DF_CHAT_ARCHIVE.OpenChatArchive".localize()}</button>\n</div>`);i.on("click",(()=>{null!=t&&[Application.RENDER_STATES.RENDERED,Application.RENDER_STATES.RENDERING].includes(t._state)?t.bringToTop():(t=new r.default,t.render(!0))})),a.find("#settings-game").append(i)})),Hooks.on("closeDFChatArchiveNew",(()=>{e=null})),Hooks.on("closeDFChatArchiveManager",(()=>{e=null})),Hooks.on("renderDFChatArchiveNew",(function(e,t){t.find('input[type="text"]')[0].focus()}))}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFChatArchiveNew});var i=a(3),r=a(4);class DFChatArchiveNew extends FormApplication{static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{template:"modules/df-chat-enhance/templates/archive-new.hbs",resizable:!1,minimizable:!1,title:"DF_CHAT_ARCHIVE.ArchiveNew_Title".localize()})}static registerSettings(){r.default.register(DFChatArchiveNew.PREF_DELETE,{config:!1,scope:"world",type:Boolean,default:!0})}getData(e){return mergeObject(super.getData(e),{shouldDelete:r.default.get(DFChatArchiveNew.PREF_DELETE)})}async _updateObject(e,t){r.default.set(DFChatArchiveNew.PREF_DELETE,t.delete);const a=t.name;if(!a)throw ui.notifications.warn("DF_CHAT_ARCHIVE.ArchiveNew_ErrorNameMissing".localize()),Error("DF_CHAT_ARCHIVE.ArchiveNew_ErrorNameMissing".localize());let o=[...ui.chat.collection.values()];if("date"===t["date-or-all"]){const e=new Date(t.from).getTime(),a=new Date(t.to).getTime();if(isNaN(e)||isNaN(a))throw ui.notifications.warn("DF_CHAT_ARCHIVE.ArchiveNew_ErrorDatesMissing".localize()),Error('Missing "from" and/or "to" dates');o=o.filter((t=>t.data.timestamp>=e&&t.data.timestamp<=a))}ui.notifications.info("DF_CHAT_ARCHIVE.ArchiveNew_NoticeSuccess".localize().replace("{0}",a));try{await i.DFChatArchive.createChatArchive(a,o,t.visible)}catch(e){return}if(t.delete)for(const e of o)e.delete()}_renderInner(e){return super._renderInner(e).then((e=>{const t=e.find("#dfca-from"),a=e.find("#dfca-to");return e.find("#dfca-all").on("change",(()=>{t.prop("disabled",!0),a.prop("disabled",!0),this._recalculateDimensions()})),e.find("#dfca-date").on("change",(()=>{t.prop("disabled",!1),a.prop("disabled",!1),this._recalculateDimensions()})),e}))}}DFChatArchiveNew.PREF_DELETE="new-should-delete",DFChatArchiveNew.PREF_HIDE_EXPORT="hide-export"},(e,t,a)=>{a.r(t),a.d(t,{DFChatArchive:()=>DFChatArchive});var i=a(4);class ArchiveFolderMenu extends FormApplication{constructor(){super(...arguments),this.folder=i.default.get(DFChatArchive.PREF_FOLDER),this.source=i.default.get(DFChatArchive.PREF_FOLDER_SOURCE)}static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{width:400,height:125,resizable:!1,minimizable:!1,title:"DF_CHAT_ARCHIVE.Settings.ArchiveFolder_Name",template:"modules/df-chat-enhance/templates/archive-folder.hbs",submitOnClose:!1,submitOnChange:!1,closeOnSubmit:!0})}getData(e){return{path:this.folder}}async _renderInner(e){const t=await super._renderInner(e),a=t.find("input#dfce-ca-folder-path")[0];return t.find("label>button").on("click",(async e=>{e.preventDefault();const t=new FilePicker({title:"DF_CHAT_ARCHIVE.Settings.ArchiveFolder_Name",type:"folder",field:a,callback:async e=>{this.source=t.activeSource,this.folder=e},button:e.currentTarget});await t.browse(i.default.get(DFChatArchive.PREF_FOLDER))})),t}async _updateObject(){await i.default.set(DFChatArchive.PREF_FOLDER,this.folder),await i.default.set(DFChatArchive.PREF_FOLDER_SOURCE,this.source)}}class DFChatArchive{static get DATA_FOLDER(){return i.default.get(DFChatArchive.PREF_FOLDER_SOURCE)}static setUpdateListener(e){this._updateListener=e}static registerSettings(){i.default.register(this.PREF_LOGS,{scope:"world",config:!1,type:Object,default:[],onChange:()=>{null!=this._updateListener&&this._updateListener()}}),i.default.register(this.PREF_CID,{scope:"world",config:!1,type:Number,default:0}),i.default.registerMenu(this.PREF_FOLDER_MENU,{label:"DF_CHAT_ARCHIVE.Settings.ArchiveFolder_Name",hint:"DF_CHAT_ARCHIVE.Settings.ArchiveFolder_Hint",restricted:!0,type:ArchiveFolderMenu}),i.default.register(this.PREF_FOLDER,{scope:"world",config:!1,type:String,default:`worlds/${game.world.id}/chat-archive`,onChange:async()=>{await this.createArchiveFolderIfMissing(),null!=this._updateListener&&this._updateListener()}}),i.default.register(this.PREF_FOLDER_SOURCE,{scope:"world",config:!1,type:String,default:"data"}),this.createArchiveFolderIfMissing()}static async createArchiveFolderIfMissing(){const e=i.default.get(this.PREF_FOLDER);await FilePicker.browse(this.DATA_FOLDER,e).catch((async t=>{if(!await FilePicker.createDirectory(this.DATA_FOLDER,e,{}))throw new Error("Could not access the archive folder: "+e)}))}static getLogs(){return i.default.get(this.PREF_LOGS)}static getArchive(e){return this.getLogs().find((t=>t.id==e))}static exists(e){return!!this.getLogs().find((t=>t.id==e))}static async _generateChatArchiveFile(e,t,a,r){const o=i.default.get(this.PREF_FOLDER),s=t.replace(/[^ a-z0-9-_()[\]<>]/gi,"_"),n=encodeURI(`${e}_${s}.json`),l=new File([JSON.stringify(a,null,"")],n,{type:"application/json"}),c=await FilePicker.upload(this.DATA_FOLDER,o,l);if(!c.path)throw console.error(`Could not create archive ${n}\nReason: ${c}`),new Error("Could not upload the archive to server: "+n);return{id:e,name:t,visible:r,filepath:c.path,filename:n}}static async createChatArchive(e,t,a){const r=i.default.get(this.PREF_CID)+1;i.default.set(this.PREF_CID,r);const o=await this._generateChatArchiveFile(r,e,t,a),s=i.default.get(this.PREF_LOGS);return s.push(o),await i.default.set(this.PREF_LOGS,s),null!=this._updateListener&&this._updateListener(),o}static async getArchiveContents(e){const t=await fetch(e.filepath),a=await t.json().catch((t=>console.error(`Failed to read JSON for archive ${e.filepath}\n${t}`)));if(t.ok)return a;throw new Error("Could not access the archive from server side: "+e.filepath)}static async updateChatArchive(e,t){if(!this.getLogs().find((t=>t.id==e.id)))throw new Error("Could not locate an archive for the given ID: "+e.id.toString());if(t){const a=i.default.get(this.PREF_FOLDER),r=new File([JSON.stringify(t)],e.filename,{type:"application/json"});if(!(await FilePicker.upload(this.DATA_FOLDER,a,r,{})).path)throw new Error("Could not upload the archive to server side: "+e.id.toString())}const a=this.getLogs(),r=a.findIndex((t=>t.id===e.id));return r<0||(a[r]=e,await i.default.set(DFChatArchive.PREF_LOGS,a)),e}static async deleteAll(){const e=i.default.get(this.PREF_FOLDER),t=i.default.get(this.PREF_LOGS);await Promise.all(t.map((t=>{const a=new File([""],t.filename,{type:"application/json"});return FilePicker.upload(this.DATA_FOLDER,e,a,{})}))),await i.default.set(this.PREF_LOGS,[]),null!=this._updateListener&&this._updateListener()}static async deleteChatArchive(e){const t=i.default.get(this.PREF_FOLDER),a=i.default.get(this.PREF_LOGS),r=a.findIndex((t=>t.id===e));if(r<0)return void console.error(`Could not find entry for ID#${e}`);const o=a[r],s=new File([""],o.filename,{type:"application/json"});await FilePicker.upload(this.DATA_FOLDER,t,s,{}),a.splice(r,1),await i.default.set(this.PREF_LOGS,a),null!=this._updateListener&&this._updateListener()}}DFChatArchive.PREF_LOGS="logs",DFChatArchive.PREF_CID="currentId",DFChatArchive.PREF_FOLDER="archiveFolder",DFChatArchive.PREF_FOLDER_SOURCE="archiveFolderSource",DFChatArchive.PREF_FOLDER_MENU="archiveFolderMenu",DFChatArchive._updateListener=null},(e,t,a)=>{a.r(t),a.d(t,{default:()=>SETTINGS});class SETTINGS{static init(e){this.MOD_NAME=e,String.prototype.localize||(String.prototype.localize=function(){return game.i18n.localize(this.valueOf())})}static register(e,t){game.settings.register(SETTINGS.MOD_NAME,e,t)}static registerMenu(e,t){game.settings.registerMenu(SETTINGS.MOD_NAME,e,t)}static get(e){return game.settings.get(SETTINGS.MOD_NAME,e)}static async set(e,t){return await game.settings.set(SETTINGS.MOD_NAME,e,t)}static default(e){return game.settings.settings.get(SETTINGS.MOD_NAME+"."+e).default}static typeOf(){return Object}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFChatArchiveManager});var i=a(4),r=a(3),o=a(6);class DFChatArchiveManager extends Application{static get defaultOptions(){return mergeObject(Application.defaultOptions,{template:"modules/df-chat-enhance/templates/archive-manager.hbs",resizable:!0,minimizable:!0,width:300,height:500,title:"DF_CHAT_ARCHIVE.ArchiveManager_Title".localize()})}getData(e){const t=super.getData(e);let a=r.DFChatArchive.getLogs();game.user.isGM||(a=a.filter((e=>e.visible))),a=a.sort(((e,t)=>e.name.localeCompare(t.name)));const o=i.default.get(DFChatArchiveManager.PREF_REVERSE_SORT);return mergeObject(t,{messages:o?a.reverse():a,isGM:game.user.isGM,reverseSort:o}),t}_subscribeView(e){e.on("click",(function(){const e=parseInt($(this).attr("data-id"));if(isNaN(e)||!r.DFChatArchive.exists(e))throw ui.notifications.error("DF_CHAT_ARCHIVE.ArchiveManager_ErrorBadId".localize()),Error(`Invalid id for Chat Archive: '${$(this).attr("data-id")}'`);DFChatArchiveManager.chatViewers.has(e)?DFChatArchiveManager.chatViewers.get(e).bringToTop():(DFChatArchiveManager.chatViewers.set(e,new o.default(r.DFChatArchive.getArchive(e),(e=>{DFChatArchiveManager.chatViewers.delete(e.archive.id)}))),DFChatArchiveManager.chatViewers.get(e).render(!0))}))}_subscribeDelete(e){e.on("click",(async function(){const e=parseInt($(this).attr("data-id"));if(isNaN(e)||!r.DFChatArchive.exists(e))throw ui.notifications.error("DF_CHAT_ARCHIVE.ArchiveManager_ErrorBadId".localize()),Error(`Invalid id for Chat Archive: '${$(this).attr("data-id")}'`);const t=r.DFChatArchive.getArchive(e);await Dialog.confirm({title:"DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteArchiveTitle".localize(),content:"DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteArchiveContent".localize().replace("{name}",t.name),defaultYes:!1,yes:async()=>await r.DFChatArchive.deleteChatArchive(e)})}))}activateListeners(e){r.DFChatArchive.setUpdateListener(this._archiveChanged.bind(this)),r.DFChatArchive.getLogs().length>0&&e.find("p.dfca-no-items").hide(),e.find('a[data-type="view"]').each(((e,t)=>{this._subscribeView($(t))})),e.find('a[data-type="delete"]').each(((e,t)=>{this._subscribeDelete($(t))})),e.find("#dfca-delete-all").on("click",(async function(){await Dialog.confirm({title:"DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllTitle".localize(),content:"DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllMessage1".localize(),defaultYes:!1,yes:async()=>{await Dialog.confirm({title:"DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllTitle".localize(),content:"DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllMessage2".localize(),defaultYes:!1,yes:async()=>{await r.DFChatArchive.deleteAll(),ui.notifications.info("DF_CHAT_ARCHIVE.ArchiveManager_ConfirmDeleteAllComplete".localize())}})}})}));const t=e.find("#dfca-sort-asc"),a=e.find("#dfca-sort-dsc");t.on("click",(async()=>{await i.default.set(DFChatArchiveManager.PREF_REVERSE_SORT,!0),t.hide(),a.show(),this.render()})),a.on("click",(async()=>{await i.default.set(DFChatArchiveManager.PREF_REVERSE_SORT,!1),a.hide(),t.show(),this.render()}))}close(e){return r.DFChatArchive.setUpdateListener(null),super.close(e)}async _archiveChanged(){let e=r.DFChatArchive.getLogs();game.user.isGM||(e=e.filter((e=>e.visible)));const t=this.element.find("#dfca-archives");t.empty();for(const a of e){const e=!0===a.visible?`<i class="dfca-visible fas fa-users" title="${"DF_CHAT_ARCHIVE.ArchiveManager_VisibleToPlayers".localize()}"></i>`:"",i=$(`\n\t\t<li class="dfca-archive-item" data-id="${a.id}">\n\t\t\t<div>\n\t\t\t\t<a class="button dfca-view" data-type="view" data-id="${a.id}"><i class="fas fa-eye"></i>\n\t\t\t\t\t<span>${a.name}</span>\n\t\t\t\t</a>\n\t\t\t\t${e}\n\t\t\t\t<a class="button dfca-delete" data-type="delete" data-id="${a.id}"><i class="fas fa-trash"></i></a>\n\t\t\t</div>\n\t\t</li>`);this._subscribeView(i.find('a[data-type="view"]')),this._subscribeDelete(i.find('a[data-type="delete"]')),t.append(i)}0==t[0].children.length?this.element.find("p.dfca-no-items").show():this.element.find("p.dfca-no-items").hide()}}DFChatArchiveManager.PREF_REVERSE_SORT="dfca-manager-reverseSort",DFChatArchiveManager.chatViewers=new Map},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFChatArchiveViewer});var i=a(3);class DFChatArchiveViewer extends Application{constructor(e,t){super(),this.archive=e,this.onCloseCallBack=t}static get defaultOptions(){return mergeObject(Application.defaultOptions,{template:"modules/df-chat-enhance/templates/archive-viewer.hbs",width:300,height:500,resizable:!0,title:"DF_CHAT_ARCHIVE.ArchiveViewer_Title",classes:["df-chat-log-window"]})}getData(e={}){var t;return super.getData(e),{name:this.archive.name,isGM:game.user.isGM,visible:null!==(t=this.archive.visible)&&void 0!==t&&t,logId:"df-chat-log-"+this.archive.id}}static toBinary(e){const t=new Uint16Array(e.length);for(let a=0;a<t.length;a++)t[a]=e.charCodeAt(a);const a=new Uint8Array(t.buffer);let i="";for(let e=0;e<a.byteLength;e++)i+=String.fromCharCode(a[e]);return i}_renderInner(e){return super._renderInner(e).then((async e=>{e.find("#visible-df-chat-log-"+this.archive.id).on("change",(async e=>{this.archive.visible=e.target.checked,await i.DFChatArchive.updateChatArchive(this.archive)})),e.find("#edit").on("click",(async()=>{setTimeout((async()=>{const e=new Dialog({title:"DF_CHAT_ARCHIVE.ArchiveViewer_NameEdit_Title".localize(),content:`<input id="name" type="text" value="${this.archive.name}"/>`,buttons:{save:{icon:'<i class="fas fa-save"></i>',label:"DF_CHAT_ARCHIVE.ArchiveViewer_NameEdit_Save".localize(),callback:async t=>{this.archive.name=$(t).find("#name").val(),await e.close(),await i.DFChatArchive.updateChatArchive(this.archive),await this.render(!1)}},close:{icon:'<i class="fas fa-times"></i>',label:"DF_CHAT_ARCHIVE.ArchiveViewer_NameEdit_Cancel".localize(),callback:async()=>{await e.close()}}},default:"save"});e.render(!0)}),1)})),e.find("#print").on("click",(async()=>{const t=e.find("#df-chat-log").clone();t.addClass("df-chat-print"),$("body").hide(),$("html").addClass("df-chat-print"),$("html").append(t),window.print(),t.remove(),$("html").removeClass("df-chat-print"),$("body").show()})),e.find("#merge").on("click",(async()=>{if(1==i.DFChatArchive.getLogs().length)return void ui.notifications.info("DF_CHAT_ARCHIVE.ArchiveViewer_Merge_OnlyOneArchive".localize());const e=new Dialog({title:"DF_CHAT_ARCHIVE.ArchiveViewer_Merge_Title".localize(),default:"merge",content:await renderTemplate("modules/df-chat-enhance/templates/archive-merge.hbs",{name:this.archive.name,archives:i.DFChatArchive.getLogs().filter((e=>e.id!=this.archive.id))}),buttons:{cancel:{icon:'<i class="fas fa-times"></i>',label:"DF_CHAT_ARCHIVE.ArchiveViewer_Merge_Cancel".localize(),callback:async()=>await e.close()},merge:{icon:'<i class="fas fa-sitemap"></i>',label:"DF_CHAT_ARCHIVE.ArchiveViewer_Merge_Merge".localize(),callback:async e=>{const t=$(e).find("#archive").val();if(isNaN(parseInt(t)))return;const a=parseInt(t),r=i.DFChatArchive.getLogs().find((e=>e.id==a)),o=await i.DFChatArchive.getArchiveContents(this.archive),s=await i.DFChatArchive.getArchiveContents(r),n=o.concat(s).sort(((e,t)=>e.timestamp-t.timestamp));i.DFChatArchive.updateChatArchive(this.archive,n),this.render(!1),$(e).find("#delete")[0].checked&&i.DFChatArchive.deleteChatArchive(a)}}}});await e.render(!0)})),e.find("#html").on("click",(()=>{const t=$("<div></div>").append(e.find("#df-chat-log").clone()).html(),a=document.createElement("a");a.download=encodeURI(this.archive.name)+".html",a.href="data:text/html,"+encodeURIComponent(t),a.click()}));const t=e.find("#df-chat-log"),a=[];this.messages=(await i.DFChatArchive.getArchiveContents(this.archive)).filter((e=>game.user.isGM||e.user===game.userId||e.type!==CONST.CHAT_MESSAGE_TYPES.WHISPER||e.whisper.some((e=>e===game.userId))));const r=[],o=e.find("#dfal-save-changes");for(const e of this.messages){const t=e instanceof ChatMessage?e:new ChatMessage(e);try{const e=await t.getHTML();1==this.messages.length&&e.find("a.message-delete").hide(),e.find("a.message-delete").on("click",(e=>{var t,a,i;const s=$(null===(i=null===(a=null===(t=e.target.parentElement)||void 0===t?void 0:t.parentElement)||void 0===a?void 0:a.parentElement)||void 0===i?void 0:i.parentElement),n=$(e.target);s.hasClass("dfal-deleted")?(s.removeClass("dfal-deleted"),n.removeClass("fa-redo-alt"),n.addClass("fa-trash"),r.splice(r.findIndex((e=>e===s.attr("data-message-id"))),1)):(s.addClass("dfal-deleted"),n.removeClass("fa-trash"),n.addClass("fa-redo-alt"),r.push(s.attr("data-message-id"))),r.length>0?o.show():o.hide()})),a.push(e)}catch(e){console.error(`Chat message ${t.id} failed to render.\n${e})`)}}return t.prepend(a),o.hide(),o.on("click",(async()=>{r.length!==this.messages.length?Dialog.confirm({title:"DF_CHAT_ARCHIVE.ArchiveViewer_DeleteTitle".localize(),content:"DF_CHAT_ARCHIVE.ArchiveViewer_DeleteContent".localize(),defaultYes:!1,yes:async()=>{for(const t of r){const a=e.find(`li[data-message-id="${t}"]`);a.hide(500,(()=>a.remove()))}this.messages=this.messages.filter((e=>!r.includes(e._id))),await i.DFChatArchive.updateChatArchive(this.archive,this.messages)}}):ui.notifications.warn("DF_CHAT_ARCHIVE.ArchiveViewer_Error_Delete_All".localize())})),e}))}close(e){return this.onCloseCallBack(this),super.close(e)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFChatEdit});var i=a(4),r=a(8);const o="edit-allowed",s="gm-edit-all",n="edit-ignore-html";class DFChatEdit{static ready(){i.default.register(r.default.PREF_MARKDOWN,{name:"DF_CHAT_EDIT.Settings_MarkdownName",hint:"DF_CHAT_EDIT.Settings_MarkdownHint",type:Boolean,default:!0,config:!0,scope:"world"}),i.default.register(o,{name:"DF_CHAT_EDIT.Settings_AllowEditName",hint:"DF_CHAT_EDIT.Settings_AllowEditHint",type:Boolean,default:!0,scope:"world",config:!0}),i.default.register(s,{name:"DF_CHAT_EDIT.Settings_GMEditAllName",hint:"DF_CHAT_EDIT.Settings_GMEditAllHint",type:Boolean,default:!1,config:!0,scope:"world"}),i.default.register(n,{name:"DF_CHAT_EDIT.Settings_IgnoreHtmlName",hint:"DF_CHAT_EDIT.Settings_IgnoreHtmlHint",type:Boolean,default:!1,config:!0,scope:"world"}),i.default.register(this.PREF_SHOW_EDITED,{name:"DF_CHAT_EDIT.Settings_ShowEditedLabelName",hint:"DF_CHAT_EDIT.Settings_ShowEditedLabelHint",type:Boolean,default:!0,config:!0,scope:"world"}),libWrapper.register(i.default.MOD_NAME,"ChatLog.prototype._onChatKeyDown",((e,...t)=>{const a=t[0];if("ArrowUp"===a.code&&a.ctrlKey){a.preventDefault();let e=[...ui.chat.collection.values()];e=e.sort(((e,t)=>t.data.timestamp-e.data.timestamp));const t=e.find((e=>e.data.user===game.user.id));if(!t)return;DFChatEdit.editChatMessage.bind(t)()}else e(...t)}),"MIXED"),libWrapper.register(i.default.MOD_NAME,"ChatLog.prototype.processMessage",(function(e,t){let a=null;if(i.default.get(r.default.PREF_MARKDOWN))if(t.trim().startsWith("/")){const e=t.split(" ")[0].trim();switch(e){case"/ooc":case"/ic":case"/emote":case"/whisper":case"/w":[a,t]=r.default.processMarkdown(t.substr(e.length)),a=`${e} ${a.trimStart()}`,t=`${e} ${t.trimStart()}`}}else[a,t]=r.default.processMarkdown(t);const o=e(t);return a&&(this._sentMessages.splice(0,1),this._sentMessages.unshift(a)),o}),"WRAPPER")}static appendChatContextMenuOptions(e){e.push({name:"DF_CHAT_EDIT.ContextOption",icon:'<i class="fas fa-pencil-alt"></i>',condition:e=>{const t=ui.chat.collection.get($(e).attr("data-message-id"));return this.processChatMessage(t)},callback:e=>{const t=ui.chat.collection.get($(e).attr("data-message-id"));return DFChatEdit.editChatMessage.bind(t)(),{}}})}static async editChatMessage(){i.default.get(o)?(this.chatEditor?this.chatEditor.bringToTop():(this.chatEditor=new r.default(this),await this.chatEditor._render(!0)),this.chatEditor.element.find("textarea").focus()):ui.notifications.warn("DF_CHAT_EDIT.Error_NoPermission".localize())}static isHTML(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.body.childNodes).some((e=>e instanceof HTMLElement&&!e.classList.contains("df-edited")&&!(e instanceof HTMLBRElement)&&1===e.nodeType))}static processChatMessage(e){return!!ui.chat.collection.has(e.id)&&(!(!i.default.get(o)||e.isRoll||!(e.data.user===game.userId||game.user.isGM&&i.default.get(s)))&&(!i.default.get(n)||!DFChatEdit.isHTML(e.data.content)))}}DFChatEdit.PREF_SHOW_EDITED="DFChatEdit.ShowEditedLable"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFChatEditor});var i=a(4),r=a(7);class DFChatEditor extends FormApplication{constructor(e){super({}),this.chatMessage=e}static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{closeOnSubmit:!0,editable:!0,resizable:!0,width:400,popOut:!0,title:"DF_CHAT_EDIT.Editor_Title",template:"modules/df-chat-enhance/templates/chat-edit.hbs"})}getData(e){const t=Object.keys(CONFIG.Actor.typeLabels).map((e=>({type:e,label:CONFIG.Actor.typeLabels[e],actors:[]})));for(const e of t)e.actors=game.scenes.viewed.tokens.contents.filter((t=>t.actor.type===e.type)).map((e=>({id:"token-"+e.id,name:e.name})));let a="";return this.chatMessage.data.user&&(a="user-"+this.chatMessage.data.user),this.chatMessage.data.speaker.token&&(a="token-"+this.chatMessage.data.speaker.token),mergeObject(e,{selected:a,players:game.users.map((e=>({id:"user-"+e.id,name:e.name}))),actorGroups:t.filter((e=>e.actors.length>0)),messageText:this.chatMessage.data.content.replace(/< *br *\/?>/gm,"\n").replace(/<p +class="df-edited">.+/,"")})}activateListeners(e){super.activateListeners(e),e.find("#cancel").on("click",(async()=>await this.close()))}async _updateObject(e,t){let a,o,s=t.content;s=i.default.get(DFChatEditor.PREF_MARKDOWN)?DFChatEditor.processMarkdown(s)[1]:s.replace(/\r?\n/gm,"<br/>"),i.default.get(r.default.PREF_SHOW_EDITED)&&s.search(/<p +class="df-edited">/)<0&&(s+=`<p class="df-edited">${"DF_CHAT_EDIT.EditedFlag".localize()}</p>`),t.speaker.startsWith("user-")?(o=game.users.get(t.speaker.substring("user-".length)).id,a=ChatMessage._getSpeakerFromUser({user:o})):a=ChatMessage.getSpeaker({token:game.scenes.viewed.tokens.get(t.speaker.substring("token-".length))}),void 0===a.alias&&(a.alias=null),this.chatMessage.update({content:s,speaker:a,user:o})}close(e){return delete this.chatMessage.chatEditor,super.close(e)}static processMarkdown(e){const t=e;(e=marked.parse(e,{headerIds:!1,breaks:!0}).trimEnd()).startsWith("<p>")&&(e=e.substr(3)),e.endsWith("</p>")&&(e=e.substr(0,e.length-4));const a=/(<\/?[ a-z]+>)\n(<\/?[ a-z]+>?)/;for(;a.test(e);)e=e.replace(a,"$1$2");return[t,e]}}DFChatEditor.PREF_MARKDOWN="edit-markdown"},(e,t,a)=>{a.r(t),a.d(t,{init:()=>init,ready:()=>ready});var i=a(10),r=a(4),o=a(11),s=a(12);function init(){const e={event:async function(e,t=!1){s.default.commandProcessor("event "+e,!1,!1,!t)}.bind(s.default),pevent:async function(e,t=!1){s.default.commandProcessor("event "+e,!1,!0,!t)}.bind(s.default),gmevent:async function(e,t=!1){game.user.isGM?s.default.commandProcessor("event "+e,!0,!1,!t):ui.notifications.warn("DF_CHAT_LOG.Error.ApiLog_NotGm".localize())}.bind(s.default),quote:async function(e,t,a=!1){s.default.commandProcessor(`quote "${e}" ${t}`,!1,!1,!a)}.bind(s.default),pquote:async function(e,t,a=!1){s.default.commandProcessor(`quote "${e}" ${t}`,!1,!0,!a)}.bind(s.default),gmquote:async function(e,t,a=!1){game.user.isGM?s.default.commandProcessor(`quote "${e}" ${t}`,!0,!1,!a):ui.notifications.warn("DF_CHAT_LOG.Error.ApiLog_NotGm".localize())}.bind(s.default)};window.AdventureLog=e}function ready(){var e;(null===(e=game.modules.get("lib-wrapper"))||void 0===e?void 0:e.active)&&(o.default.setupSettings(),s.default.setupSettings(),Hooks.on("renderUserConfig",((e,t,a)=>{const i=a.user.getFlag(r.default.MOD_NAME,s.default.PREF_PLAYER_LOG_JOURNAL),o=Handlebars.compile('\n<div class="form-group">\n\t<label for="dfce-player-log">Player Log Journal</label>\n\t<select id="dfce-player-log" name="player-log">\n\t\t{{#each journals}}\n\t\t<option value="{{id}}" {{#if (eq ../selected id)}}selected{{/if}}>{{name}}</option>\n\t\t{{/each}}\n\t</select>\n</div>\n'),n=ui.journal.documents.filter((e=>e.testUserPermission(a.user,CONST.DOCUMENT_PERMISSION_LEVELS.OBSERVER))),l=$(o({selected:null!=i?i:"",journals:[{id:"",name:"---"}].concat(n)},{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0}));t.find('input[name="color"]').parent().after(l)})),i.default.register("UserConfig.prototype._updateObject",(async function(e,t,a){return await this.object.setFlag(r.default.MOD_NAME,s.default.PREF_PLAYER_LOG_JOURNAL,a["player-log"]),await e(t,a)})))}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>libWrapperShared});var i=a(4);class Registration{constructor(){this.nextId=0,this.wrappers=new Map}handler(e,t,...a){let i=t;for(const t of this.wrappers.values()){const a=i;i=(...i)=>t.call(e,a,...i)}return i.call(e,...a)}}class libWrapperShared{static register(e,t){let a=this.registrations.get(e);a||(a=new Registration,libWrapper.register(i.default.MOD_NAME,e,(function(e,...t){return a.handler(this,e,...t)}),"WRAPPER"),this.registrations.set(e,a));const r=a.nextId++;return a.wrappers.set(r,t),r}static unregister(e,t){const a=this.registrations.get(e);return!!a&&(a.wrappers.delete(t),0===a.wrappers.size&&(libWrapper.unregister(i.default.MOD_NAME,e,!1),this.registrations.delete(e)),!0)}}libWrapperShared.registrations=new Map},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFAdventureLogConfig});var i=a(4),r=a(12);class DFAdventureLogConfig extends FormApplication{static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{template:"modules/df-chat-enhance/templates/log-config.hbs",resizable:!1,minimizable:!1,title:"DF_CHAT_LOG.Config_Title".localize()})}static setupSettings(){i.default.register(DFAdventureLogConfig.PREF_JOURNAL,{scope:"world",type:String,default:"",config:!1}),i.default.register(DFAdventureLogConfig.PREF_JOURNAL_GM,{scope:"world",type:String,default:"",config:!1}),i.default.registerMenu(DFAdventureLogConfig.PREF_CONFIG,{restricted:!0,type:DFAdventureLogConfig,label:"DF_CHAT_LOG.Config_Title",icon:"fas fa-edit"})}getData(e){const t=super.getData(e),a=game.journal.keys(),r=i.default.get(DFAdventureLogConfig.PREF_JOURNAL),o=i.default.get(DFAdventureLogConfig.PREF_JOURNAL_GM);let s=[],n=[];for(const e of a)s.push({id:e,name:game.journal.get(e).data.name,selected:e===r}),n.push({id:e,name:game.journal.get(e).data.name,selected:e===o});return s=s.sort(((e,t)=>e.name.localeCompare(t.name))),n=n.sort(((e,t)=>e.name.localeCompare(t.name))),mergeObject(t,{logJournals:s,gmlogJournals:n}),t}async _updateObject(e,t){const a=t["dfal-journal"],r=t["dfal-journal-gm"],o=t["dfal-clear"],s=t["dfal-clear-gm"];i.default.set(DFAdventureLogConfig.PREF_JOURNAL,a),i.default.set(DFAdventureLogConfig.PREF_JOURNAL_GM,r),await DFAdventureLogConfig.initializeJournal(a,o,!1,!1),await DFAdventureLogConfig.initializeJournal(r,s,!0,!1)}static async initializeJournal(e,t,a,i){if(!game.journal.has(e))return;const o=game.journal.get(e);(t||null===o.data.content)&&(o.data.content="");0==$(o.data.content).find('article[class="df-adventure-log"]').length?await o.update({content:o.data.content+`\n\t\t\t<section>\n\t\t\t\t<h2>${game.i18n.localize(a?"DF_CHAT_LOG.GMLog_Header":i?"DF_CHAT_LOG.PLog_Header":"DF_CHAT_LOG.Log_Header")}</h2>\n\t\t\t\t<section class="df-adventure-log"></section>\n\t\t\t\t<hr />\n\t\t\t</section>\n\t\t\t`}):await r.default.resortLog()}}DFAdventureLogConfig.PREF_JOURNAL="log-journal",DFAdventureLogConfig.PREF_JOURNAL_GM="gmlog-journal",DFAdventureLogConfig.PREF_CONFIG="log-config-menu"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFAdventureLogProcessor});var i=a(4),r=a(8),o=a(11);String.prototype.trimStart||(String.prototype.trimStart=function(){const e=[" ","\n","\r"];let t=-1;for(let a=0;a<this.length&&!e.every((e=>e!==this[a]));a++)t=a;return this.substr(t+1)});class DFAdventureLogProcessor{static appendChatContextMenuOptions(e){e.push({name:"DF_CHAT_LOG.ContextMenu_AsEvent",icon:'<i style="color:SeaGreen" class="fas fa-edit"></i>',condition:()=>{const e=i.default.get(DFAdventureLogProcessor.PREF_ENABLE),t=game.user.isGM,a=i.default.get(DFAdventureLogProcessor.PREF_GMONLY);return e&&(!a||t)},callback:e=>{const t=ui.chat.collection.get($(e).attr("data-message-id")).data;return DFAdventureLogProcessor.commandProcessor(t.content,!1,!1),{}}}),e.push({name:"DF_CHAT_LOG.ContextMenu_AsQuote",icon:'<i style="color:SeaGreen" class="fas fa-quote-right"></i>',condition:()=>{const e=i.default.get(DFAdventureLogProcessor.PREF_ENABLE),t=game.user.isGM,a=i.default.get(DFAdventureLogProcessor.PREF_GMONLY);return e&&(!a||t)},callback:e=>{const t=ui.chat.collection.get($(e).attr("data-message-id")).data;return t.content.trimStart().startsWith('"')?DFAdventureLogProcessor.commandProcessor("q "+t.content,!1,!1):DFAdventureLogProcessor.commandProcessor(`q "${game.users.get(t.user).name}" ${t.content}`,!1,!1),{}}}),e.push({name:"DF_CHAT_LOG.ContextMenu_AsGmEvent",icon:'<i style="color:FireBrick" class="fas fa-edit"></i>',condition:()=>{const e=i.default.get(DFAdventureLogProcessor.PREF_ENABLE),t=game.user.isGM;return e&&t},callback:e=>{const t=ui.chat.collection.get($(e).attr("data-message-id")).data;return DFAdventureLogProcessor.commandProcessor(t.content,!0,!1),{}}}),e.push({name:"DF_CHAT_LOG.ContextMenu_AsGmQuote",icon:'<i style="color:FireBrick" class="fas fa-quote-right"></i>',condition:()=>{const e=i.default.get(DFAdventureLogProcessor.PREF_ENABLE),t=game.user.isGM;return e&&t},callback:e=>{const t=ui.chat.collection.get($(e).attr("data-message-id")).data;return t.content.trimStart().startsWith('"')?DFAdventureLogProcessor.commandProcessor("q "+t.content,!0,!1):DFAdventureLogProcessor.commandProcessor(`q "${game.users.get(t.user).name}" ${t.content}`,!0,!1),{}}})}static setupSettings(){var e;i.default.register(DFAdventureLogProcessor.PREF_ENABLE,{scope:"world",name:"DF_CHAT_LOG.Setting.EnableTitle",hint:"DF_CHAT_LOG.Setting.EnableHint",config:!0,type:Boolean,default:!0,onChange:e=>{!e&&DFAdventureLogProcessor.logCommand?DFAdventureLogProcessor.deregisterCommand():DFAdventureLogProcessor.registerCommand()}}),i.default.register(DFAdventureLogProcessor.PREF_GMONLY,{name:"DF_CHAT_LOG.Setting.GmOnlyTitle",hint:"DF_CHAT_LOG.Setting.GmOnlyHint",scope:"world",type:Boolean,default:!1,config:!0,onChange:e=>{e&&!game.user.isGM?DFAdventureLogProcessor.deregisterCommand():DFAdventureLogProcessor.registerCommand()}}),i.default.register(DFAdventureLogProcessor.PREF_GMONLY_WHISPER,{name:"DF_CHAT_LOG.Setting.GmOnlyWhisperName",hint:"DF_CHAT_LOG.Setting.GmOnlyWhisperHint",scope:"world",type:Boolean,default:!1,config:!0}),i.default.register(DFAdventureLogProcessor.PREF_USE_TIME,{scope:"world",type:Boolean,name:"DF_CHAT_LOG.Setting.UseTimeName",hint:"DF_CHAT_LOG.Setting.UseTimeHint",default:!0,config:!0}),i.default.register(DFAdventureLogProcessor.PREF_MESSAGES,{name:"DF_CHAT_LOG.Setting.PrintMessagesName",hint:"DF_CHAT_LOG.Setting.PrintMessagesHint",scope:"world",type:Boolean,default:!0,config:!0}),i.default.register(DFAdventureLogProcessor.PREF_SORTDESC,{name:"DF_CHAT_LOG.Setting.SortDescendingName",hint:"DF_CHAT_LOG.Setting.SortDescendingHint",scope:"world",type:Boolean,default:!1,config:!0,onChange:()=>this.resortLog()}),i.default.register(DFAdventureLogProcessor.PREF_DISABLE_FORMATTING,{name:"DF_CHAT_LOG.Setting.DisableFormatName".localize(),hint:"DF_CHAT_LOG.Setting.DisableFormatHint".localize(),config:!0,scope:"world",type:Boolean,default:!1}),i.default.register(DFAdventureLogProcessor.PREF_DISABLE_AUTHOR,{name:"DF_CHAT_LOG.Setting.DisableEntryAuthorName".localize(),hint:"DF_CHAT_LOG.Setting.DisableEntryAuthorHint".localize(),config:!0,scope:"world",type:Boolean,default:!1}),(null===(e=game.modules.get("foundryvtt-simple-calendar"))||void 0===e?void 0:e.active)&&i.default.register(DFAdventureLogProcessor.PREF_SIMPLE_CALENDAR,{scope:"world",type:Boolean,name:"DF_CHAT_LOG.Setting.SimpleCalendarName",hint:"DF_CHAT_LOG.Setting.SimpleCalendarHint",default:!1,config:!0}),Hooks.on("closeDFAdventureLogConfig",(()=>{DFAdventureLogProcessor.logConfig=null})),game.chatCommands?DFAdventureLogProcessor.registerCommand():Hooks.on("chatCommandsReady",(function(){DFAdventureLogProcessor.registerCommand()}))}static deregisterCommand(){game.chatCommands.deregisterCommand(DFAdventureLogProcessor.logCommand),game.chatCommands.deregisterCommand(DFAdventureLogProcessor.plogCommand),DFAdventureLogProcessor.gmlogCommand&&game.chatCommands.deregisterCommand(DFAdventureLogProcessor.gmlogCommand),DFAdventureLogProcessor.logCommand=null,DFAdventureLogProcessor.plogCommand=null,DFAdventureLogProcessor.gmlogCommand=null}static registerCommand(){i.default.get(DFAdventureLogProcessor.PREF_ENABLE)&&(i.default.get(DFAdventureLogProcessor.PREF_GMONLY)&&!game.user.isGM||DFAdventureLogProcessor.logCommand||(DFAdventureLogProcessor.logCommand=game.chatCommands.createCommandFromData({commandKey:"/log",invokeOnCommand:async(e,t,a)=>await DFAdventureLogProcessor.commandProcessor(t,!1,!1),shouldDisplayToChat:!1,iconClass:"fa-edit",description:"DF_CHAT_LOG.CommandDescription".localize()}),game.chatCommands.registerCommand(DFAdventureLogProcessor.logCommand),DFAdventureLogProcessor.plogCommand=game.chatCommands.createCommandFromData({commandKey:"/plog",invokeOnCommand:async(e,t,a)=>await DFAdventureLogProcessor.commandProcessor(t,!1,!0),shouldDisplayToChat:!1,iconClass:"fa-edit",description:"DF_CHAT_LOG.PCCommandDescription".localize()}),game.chatCommands.registerCommand(DFAdventureLogProcessor.plogCommand),game.user.isGM&&(DFAdventureLogProcessor.gmlogCommand=game.chatCommands.createCommandFromData({commandKey:"/gmlog",invokeOnCommand:async(e,t,a)=>await DFAdventureLogProcessor.commandProcessor(t,!0,!1),shouldDisplayToChat:!1,iconClass:"fa-edit",description:"DF_CHAT_LOG.GMCommandDescription".localize()}),game.chatCommands.registerCommand(DFAdventureLogProcessor.gmlogCommand))))}static _getTimestamp(){var e;const t=i.default.get(DFAdventureLogProcessor.PREF_USE_TIME);if((null===(e=game.modules.get("foundryvtt-simple-calendar"))||void 0===e?void 0:e.active)&&i.default.get(DFAdventureLogProcessor.PREF_SIMPLE_CALENDAR)){const e=SimpleCalendar.api.formatDateTime(SimpleCalendar.api.timestampToDate(SimpleCalendar.api.timestamp()));return t?`${e.date} ${e.time}`:e.date}return t?(new Date).toLocaleString("sv").replace(",","").replace(/ ([AP])/,"$1"):(new Date).toLocaleString("sv").replace(",","").replace(/ ([AP])/,"$1").split(" ")[0]}static async commandProcessor(e,t,a,s=!1){const n=(e=e.trim()).split(" ");if(!i.default.get(DFAdventureLogProcessor.PREF_ENABLE))return game.chatCommands.deregisterCommand(DFAdventureLogProcessor.logCommand),void ui.notifications.warn("DF_CHAT_LOG.Error.Disabled".localize());if(0==e.length||n.every((e=>0==e.length)))return void setTimeout((async()=>{await Dialog.prompt({title:"DF_CHAT_LOG.HelpDialog_Title".localize(),label:"OK",callback:()=>{},content:await renderTemplate(`modules/df-chat-enhance/templates/lang/log-help.${"DF_CHAT_ENHANCE.LANG".localize()}.hbs`,{isGM:game.user.isGM}),options:{width:800}})}),1);const l=ChatMessage.getSpeaker({user:game.user}),c={flavor:"",user:game.user.id,speaker:l,type:CONST.CHAT_MESSAGE_TYPES.OOC,content:""};let d;const g=i.default.get(DFAdventureLogProcessor.PREF_DISABLE_FORMATTING),h=a||i.default.get(DFAdventureLogProcessor.PREF_DISABLE_AUTHOR);switch(n[0].toLowerCase()){case"config":return game.user.isGM?void setTimeout((async()=>{DFAdventureLogProcessor.logConfig?DFAdventureLogProcessor.logConfig.bringToTop():(DFAdventureLogProcessor.logConfig=new o.default({}),DFAdventureLogProcessor.logConfig.render(!0))}),1):void ui.notifications.warn("DF_CHAT_LOG.Error.ConfigGmOnly".localize());case"q":case"quote":let t;if(e=e.replace(n[0],"").trimStart(),'"'===n[1][0]&&'"'!==n[1][n[1].length-1]){let a=-1;for(let t=1;t<e.length;t++)if('"'===e[t]){a=t;break}if(a<0)return ui.notifications.error("DF_CHAT_LOG.Error.MissingQuote".localize().replace("{0}",n[1])),void setTimeout((()=>$("#chat-message").val("/log q "+e)),1);t=e.slice(0,a+1)}else t=n[1];if(e=r.default.processMarkdown(e)[1].replace(t,"").trim(),t=t.replace(/"/gm,""),c.flavor=`${game.user.name} quoted ${t}`,c.content=`<span class="dfal-qu">${e}</span>`,0==e.length)return ui.notifications.error("DF_CHAT_LOG.Error.MissingMessage".localize()),void setTimeout((()=>$("#chat-message").val(`/log q "${t}" ${e}`)),1);d="DF_CHAT_LOG.Log_Quote",g&&(d+="_Bland"),h&&(d+="_NoAuth"),d=d.localize(),d=d.replace("{0}",this._getTimestamp()),d=d.replace("{1}",game.user.name),d=d.replace("{2}",t),e=d.replace("{3}",e);break;case"e":case"event":e=e.replace(n[0],"").trim();default:e=r.default.processMarkdown(e)[1].trim(),c.flavor="Event Logged",c.content=`<span class="dfal-ev">${e}</span>`,d="DF_CHAT_LOG.Log_Event",g&&(d+="_Bland"),h&&(d+="_NoAuth"),d=d.localize(),d=d.replace("{0}",this._getTimestamp()),d=d.replace("{1}",game.user.name),e=d.replace("{2}",e)}const u=a?game.user.getFlag(i.default.MOD_NAME,this.PREF_PLAYER_LOG_JOURNAL):i.default.get(t?o.default.PREF_JOURNAL_GM:o.default.PREF_JOURNAL);if(!game.journal.has(u))return void(a?ui.notifications.error("DF_CHAT_LOG.Error.NoPlayerJournalSet".localize()):game.user.isGM?ui.notifications.error("DF_CHAT_LOG.Error.NoJournalSetGM".localize(),{permanent:!0}):ui.notifications.warn("DF_CHAT_LOG.Error.NoJournalSet".localize()));const _=game.journal.get(u);let m=$(_.data.content);const f=$(e);let p=m.find("section.df-adventure-log");0==p.length&&(await o.default.initializeJournal(u,!1,t,a),m=$(_.data.content),p=m.find("section.df-adventure-log"));i.default.get(this.PREF_SORTDESC)?p.prepend(f):p.append(f),await _.update({content:$("<div></div>").append(m).html()});const C=game.settings.get("core","rollMode");game.user.isGM&&("publicroll"!==C||i.default.get(DFAdventureLogProcessor.PREF_GMONLY)&&i.default.get(DFAdventureLogProcessor.PREF_GMONLY_WHISPER))&&(c.whisper=[game.user.id]),(a||t)&&(c.whisper=[game.user.id]),!s&&i.default.get(DFAdventureLogProcessor.PREF_MESSAGES)&&await ChatMessage.create(c,{})}static async resortLog(){const e=i.default.get(this.PREF_SORTDESC),t=i.default.get(o.default.PREF_JOURNAL),a=i.default.get(o.default.PREF_JOURNAL_GM),journalSort=async t=>{const a=$(t.data.content),i=a.find("article.df-adventure-log"),r=i.find("p").sort((function(t,a){return e?$(a).find("span.dfal-ts").text().localeCompare($(t).find("span.dfal-ts").text()):$(t).find("span.dfal-ts").text().localeCompare($(a).find("span.dfal-ts").text())}));i.html(r),await t.update({content:$("<div></div>").append(a).html()})};game.journal.has(t)&&await journalSort(game.journal.get(t)),game.journal.has(a)&&await journalSort(game.journal.get(a))}}DFAdventureLogProcessor.PREF_ENABLE="enable-command",DFAdventureLogProcessor.PREF_GMONLY="df-log-gmonly",DFAdventureLogProcessor.PREF_GMONLY_WHISPER="df-log-gmonly-whisper",DFAdventureLogProcessor.PREF_MESSAGES="df-log-messages",DFAdventureLogProcessor.PREF_SORTDESC="df-log-sortdesc",DFAdventureLogProcessor.PREF_DISABLE_FORMATTING="df-log-disable-format",DFAdventureLogProcessor.PREF_DISABLE_AUTHOR="df-log-disable-author",DFAdventureLogProcessor.PREF_SIMPLE_CALENDAR="df-log-use-simple-calendar",DFAdventureLogProcessor.PREF_USE_TIME="df-log-use-time",DFAdventureLogProcessor.PREF_PLAYER_LOG_JOURNAL="PlayerAdventureLog",DFAdventureLogProcessor.logCommand=null,DFAdventureLogProcessor.gmlogCommand=null,DFAdventureLogProcessor.plogCommand=null,DFAdventureLogProcessor.logConfig=null},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ChatMerge});var i=a(10),r=a(4),o=a(5);class ChatMerge{static get _enabled(){return r.default.get(this.PREF_ENABLED)}static get _epoch(){return r.default.get(this.PREF_EPOCH)}static get _allowRolls(){return r.default.get(this.PREF_ALLOW_ROLLS)}static get _separateWithBorder(){return r.default.get(this.PREF_SEPARATE)}static get _showHover(){return r.default.get(this.PREF_HOVER)}static get _showHeader(){return r.default.get(this.PREF_SHOW_HEADER)}static init(){r.default.register(this.PREF_ENABLED,{name:"DF_CHAT_MERGE.EnableName",hint:"DF_CHAT_MERGE.EnableHint",config:!0,scope:"client",default:!0,type:Boolean,onChange:()=>this._processAllMessage()}),r.default.register(this.PREF_SHOW_HEADER,{name:"DF_CHAT_MERGE.ShowHeaderName",hint:"DF_CHAT_MERGE.ShowHeaderHint",config:!0,scope:"client",default:!1,type:Boolean,onChange:e=>{const t=document.querySelector(":root").style;t.setProperty("--dfce-cm-header",e?"":"none"),game.user.isGM&&(t.setProperty("--dfce-cm-header-delete",e?"":"0"),t.setProperty("--dfce-cm-header-delete-pad",e?"":"16px"))}}),r.default.register(this.PREF_SPLIT_SPEAKER,{name:"DF_CHAT_MERGE.SplitSpeakerName",hint:"DF_CHAT_MERGE.SplitSpeakerHint",config:!0,scope:"client",default:!0,type:Boolean,onChange:()=>this._processAllMessage()}),r.default.register(this.PREF_ALLOW_ROLLS,{name:"DF_CHAT_MERGE.AllowRollsName",hint:"DF_CHAT_MERGE.AllowRollsHint",config:!0,scope:"client",default:"rolls",type:String,choices:{none:"DF_CHAT_MERGE.AllowRollsOptions.none".localize(),rolls:"DF_CHAT_MERGE.AllowRollsOptions.rolls".localize(),all:"DF_CHAT_MERGE.AllowRollsOptions.all".localize()},onChange:()=>this._processAllMessage()}),r.default.register(this.PREF_SEPARATE,{name:"DF_CHAT_MERGE.SeparateName",hint:"DF_CHAT_MERGE.SeparateHint",config:!0,scope:"client",default:!1,type:Boolean,onChange:e=>{document.querySelector(":root").style.setProperty("--dfce-cm-separation",e?"":"0")}}),r.default.register(this.PREF_HOVER,{name:"DF_CHAT_MERGE.HoverName",hint:"DF_CHAT_MERGE.HoverHint",config:!0,scope:"client",default:!0,type:Boolean,onChange:e=>{const t=document.querySelector(":root").style;e?t.removeProperty("--dfce-cm-hover-shadow"):t.setProperty("--dfce-cm-hover-shadow","0px")}}),r.default.register(this.PREF_EPOCH,{name:"DF_CHAT_MERGE.EpochName",hint:"DF_CHAT_MERGE.EpochHint",config:!0,scope:"client",default:10,type:Number,range:{min:1,max:60,step:1},onChange:()=>this._processAllMessage()}),i.default.register("ChatLog.prototype.deleteMessage",this._deleteMessage.bind(this)),Hooks.on("renderChatMessage",this._renderChatMessage)}static ready(){const e=document.querySelector(":root").style;e.setProperty("--dfce-cm-separation",this._separateWithBorder?"":"0"),this._showHover?e.removeProperty("--dfce-cm-hover-shadow"):e.setProperty("--dfce-cm-hover-shadow","0px"),e.setProperty("--dfce-cm-header",this._showHeader?"":"none"),game.user.isGM&&(e.setProperty("--dfce-cm-header-delete",this._showHeader?"":"0"),e.setProperty("--dfce-cm-header-delete-pad",this._showHeader?"":"16px")),this._processAllMessage(ui.chat.element),Hooks.on("renderChatLog",((e,t)=>this._processAllMessage(t))),Hooks.on("renderDFChatArchiveViewer",((e,t)=>this._processAllMessage(t)))}static _deleteMessage(e,t,{deleteAll:a=!1}={}){var i,r,o;if(!a&&this._enabled){const e=document.querySelector(`li[data-message-id="${t}"`);(null===(i=null==e?void 0:e.classList)||void 0===i?void 0:i.contains("dfce-cm-top"))?(e.classList.remove("dfce-cm-top"),e.nextElementSibling.classList.contains("dfce-cm-middle")?(e.nextElementSibling.classList.remove("dfce-cm-middle"),e.nextElementSibling.classList.add("dfce-cm-top")):e.nextElementSibling.classList.remove("dfce-cm-bottom")):(null===(r=null==e?void 0:e.classList)||void 0===r?void 0:r.contains("dfce-cm-bottom"))?(e.classList.remove("dfce-cm-bottom"),e.previousElementSibling.classList.contains("dfce-cm-middle")?(e.previousElementSibling.classList.remove("dfce-cm-middle"),e.previousElementSibling.classList.add("dfce-cm-bottom")):e.previousElementSibling.classList.remove("dfce-cm-top")):(null===(o=null==e?void 0:e.classList)||void 0===o?void 0:o.contains("dfce-cm-middle"))&&e.classList.remove("dfce-cm-middle")}return e(t,{deleteAll:a})}static _processAllMessage(e){if((e=null!=e?e:$(document.body)).find(".dfce-cm-top").removeClass("dfce-cm-top"),e.find(".dfce-cm-middle").removeClass("dfce-cm-middle"),e.find(".dfce-cm-bottom").removeClass("dfce-cm-bottom"),!ChatMerge._enabled)return;const t=e.find("li.chat-message");if(0!==t.length){t[0].hasAttribute("style")&&t[0].style.setProperty("--dfce-mc-border-color",t[0].style.borderColor);for(let e=1;e<t.length;e++)this._styleChatMessages(game.messages.get(t[e].getAttribute("data-message-id")),t[e],game.messages.get(t[e-1].getAttribute("data-message-id")),t[e-1])}}static _renderChatMessage(e,t,a){if(!ChatMerge._enabled)return;const i=$("li.chat-message").last()[0];if(null==i)return;const r=game.messages.get(i.getAttribute("data-message-id"));ChatMerge._styleChatMessages(e,t[0],r,i)}static _inTimeFrame(e,t){return e>t&&e-t<1e3*this._epoch}static _isValidMessage(e,t){var a,i;const o=this._allowRolls,s=r.default.get(this.PREF_SPLIT_SPEAKER);let n=!1;const l=null!==(a=e.data)&&void 0!==a?a:e,c=null!==(i=t.data)&&void 0!==i?i:t;return!l.flags["midi-qol"]&&!c.flags["midi-qol"]&&(n=s?l.speaker.actor===c.speaker.actor&&!!l.speaker.actor||!l.speaker.actor&&!c.speaker.actor&&l.user===c.user:l.user===c.user,n&&this._inTimeFrame(l.timestamp,c.timestamp)&&("all"===o||"rolls"===o&&e.isRoll===t.isRoll||"none"===o&&!e.isRoll&&!t.isRoll))}static _styleChatMessages(e,t,a,i){if(t.hasAttribute("style")&&t.style.setProperty("--dfce-mc-border-color",t.style.borderColor),void 0===e&&void 0===a){const r=parseInt(/df-chat-log-(\d+)/.exec(t.parentElement.parentElement.id)[1]);if(isNaN(r))return;const s=o.default.chatViewers.get(r);e=s.messages.find((e=>(e._id?e._id:e.id)==t.dataset.messageId)),a=s.messages.find((e=>(e._id?e._id:e.id)==i.dataset.messageId))}ChatMerge._isValidMessage(e,a)&&(i.classList.contains("dfce-cm-bottom")?(i.classList.remove("dfce-cm-bottom"),i.classList.add("dfce-cm-middle")):i.classList.add("dfce-cm-top"),t.classList.add("dfce-cm-bottom"))}}ChatMerge.PREF_ENABLED="chat-merge-enabled",ChatMerge.PREF_SPLIT_SPEAKER="chat-merge-split-speaker",ChatMerge.PREF_EPOCH="chat-merge-epoch",ChatMerge.PREF_ALLOW_ROLLS="chat-merge-allowRolls",ChatMerge.PREF_SEPARATE="chat-merge-separateWithBorder",ChatMerge.PREF_HOVER="chat-merge-showhover",ChatMerge.PREF_SHOW_HEADER="chat-merge-showheader"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ChatRollPrivacy});var i=a(4),r=a(15);const o={publicroll:"fas fa-dice-d20",gmroll:"fas fa-user-secret",blindroll:"fas fa-user-ninja",selfroll:"fas fa-ghost"};class ChatRollPrivacy{static setup(){game.keybindings.register(i.default.MOD_NAME,"roll-mode.publicroll",{name:"Public Roll",editable:[{key:"KeyQ",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],namespace:"Roll Type Shortcuts",onDown:()=>{$('#dfcp-rt-buttons > button[data-id="publicroll"]').trigger("click")}}),game.keybindings.register(i.default.MOD_NAME,"roll-mode.gmroll",{name:"Private GM Roll",editable:[{key:"KeyW",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],namespace:"Roll Type Shortcuts",onDown:()=>{$('#dfcp-rt-buttons > button[data-id="gmroll"]').trigger("click")}}),game.keybindings.register(i.default.MOD_NAME,"roll-mode.blindroll",{name:"Blind GM Roll",editable:[{key:"KeyE",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],namespace:"Roll Type Shortcuts",onDown:()=>{$('#dfcp-rt-buttons > button[data-id="blindroll"]').trigger("click")}}),game.keybindings.register(i.default.MOD_NAME,"roll-mode.selfroll",{name:"Self Roll",editable:[{key:"KeyR",modifiers:[KeyboardManager.MODIFIER_KEYS.ALT]}],namespace:"Roll Type Shortcuts",onDown:()=>{$('#dfcp-rt-buttons > button[data-id="selfroll"]').trigger("click")}})}static init(){i.default.register("enabled",{name:"DF_CHAT_PRIVACY.Settings_EnableTitle",hint:"DF_CHAT_PRIVACY.Settings_EnableHint",scope:"client",type:Boolean,default:!0,config:!0,onChange:r.default.requestReload}),i.default.register("replace-buttons",{name:"DF_CHAT_PRIVACY.Settings_ReplaceButtonsTitle",hint:"DF_CHAT_PRIVACY.Settings_ReplaceButtonsHint",scope:"client",type:Boolean,default:!0,config:!0,onChange:r.default.requestReload}),!1!==i.default.get("enabled")&&Hooks.on("renderChatLog",this._handleChatLogRendering)}static calcColour(e,t){return`rgb(${e/t*255},${255*(1-e/t)},0)`}static async _handleChatLogRendering(e,t,a){const r=Object.keys(a.rollModes),s=[],n=Object.keys(o);for(let e=0;e<r.length;e++){const t=r[e];t in o?s.push({rt:t,name:a.rollModes[t],active:a.rollMode===t,icon:o[t],colour:ChatRollPrivacy.calcColour(n.findIndex((e=>e==t)),n.length)}):console.warn(Error(`Unknown roll type '${t}'`))}const l=$(await renderTemplate("modules/df-chat-enhance/templates/privacy-button.hbs",{buttons:s}));if(l.find("button").on("click",(function(){const e=$(this).attr("data-id");game.settings.set("core","rollMode",e),l.find("button.active").removeClass("active"),$(this).addClass("active")})),t.find("select[name=rollMode]").after(l),t.find("select[name=rollMode]").remove(),!i.default.get("replace-buttons"))return;l.attr("style","margin:0 0 0 0.5em");let c=!0;t.find("#chat-controls div.control-buttons a").each((function(){const e=$(this).html(),t=$(this).attr("class"),a=$(this).attr("title"),i=$(this).attr("style"),r=$._data(this,"events").click[0].handler,o=$(`<button class="${t}" title="${a}" style="${i}">${e}</button>`);o.on("click",r),c&&(o.attr("style","margin-left:0.5em"),c=!1),l.append(o)})),t.find("#chat-controls div.control-buttons").remove()}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>UTIL});class UTIL{static async requestReload(){await Dialog.confirm({title:"DF_CHAT_ENHANCE.ReloadGameTitle".localize(),content:"DF_CHAT_ENHANCE.ReloadGameContent".localize(),defaultYes:!0})&&window.location.reload()}static reloadChatLog(){ui.chat._lastId=null,ui.chat._state=Application.RENDER_STATES.NONE,ui.chat.render(!0)}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ScrollManage});var i=a(10),r=a(4),o=a(17);class ScrollManage{static get enabled(){return r.default.get(this.PREF_ENABLED)}static get scrollToBottomIfYouSendMessage(){return r.default.get(this.PREF_SCROLL_IF_YOU)}static init(){Hooks.on("renderChatLog",this._renderChatLog.bind(this)),r.default.register(this.PREF_ENABLED,{name:"DF_CHAT_SCROLL.EnableName",hint:"DF_CHAT_SCROLL.EnableHint",scope:"world",config:!0,type:Boolean,default:!0,onChange:e=>{e?this.register():this.unregister()}}),r.default.register(this.PREF_SCROLL_IF_YOU,{name:"DF_CHAT_SCROLL.ScrollIfYouName",hint:"DF_CHAT_SCROLL.ScrollIfYouHint",scope:"world",config:!0,type:Boolean,default:!0}),o.default.init()}static ready(){this.enabled&&this.register()}static register(){libWrapper.register(r.default.MOD_NAME,"ChatLog.prototype.postOne",this._ChatLog_postOne,"OVERRIDE"),libWrapper.register(r.default.MOD_NAME,"ChatLog.prototype.scrollBottom",this._ChatLog_scrollBottom,"OVERRIDE"),this._deleteMessageRegistrationID=i.default.register("ChatLog.prototype.deleteMessage",this._ChatLog_deleteMessage)}static unregister(){libWrapper.unregister(r.default.MOD_NAME,"ChatLog.prototype.postOne",!1),libWrapper.unregister(r.default.MOD_NAME,"ChatLog.prototype.scrollBottom",!1),i.default.unregister("ChatLog.prototype.deleteMessage",this._deleteMessageRegistrationID)}static _renderChatLog(e,t){e._scrollToBottomButton=$(`<div id="scrollToBottom" style="display:none">\n\t<span>${"DF_CHAT_SCROLL.NewMessage".localize()}</span> ${"DF_CHAT_SCROLL.ScrollButton".localize()}\n</div>`),e._scrollToBottomButton.on("click",(()=>{const t=e.element,a=t.length?t[0].querySelector("#chat-log"):null;a&&a.scrollTo({behavior:"smooth",top:a.scrollHeight})})),t.find("div#chat-controls").before(e._scrollToBottomButton),t.find("ol#chat-log").on("scroll",(t=>{if(!e._scrollToBottomButton)return;const a=t.currentTarget;a.clientHeight>a.scrollHeight-this.ScrollThreshold||(a.scrollTop<a.scrollHeight-a.clientHeight-this.ScrollThreshold?e._scrollToBottomButton.show():(e._scrollToBottomButton.hide(),e._scrollToBottomButton.removeClass("new")))}))}static _ChatLog_scrollBottom(){const e=this.element,t=e.length?e[0].querySelector("#chat-log"):null;this._scrollToBottomButton.is(":hidden")?setTimeout((()=>t.scrollTo({behavior:"smooth",top:t.scrollHeight})),100):$("#chat #chat-log").trigger("scroll")}static async _ChatLog_postOne(e,t=!1){if(!e.visible)return;this._lastId||(this._lastId=e.id),(e.data.whisper||[]).includes(game.user.id)&&!e.isRoll&&(this._lastWhisper=e);const a=this.element.find("#chat-log"),i=a[0].scrollTop>=a[0].scrollHeight-a[0].clientHeight-ScrollManage.ScrollThreshold,r=await e.getHTML();a.append(r),i||ScrollManage.scrollToBottomIfYouSendMessage&&e.isAuthor?a[0].scrollTo({top:a[0].scrollHeight,behavior:"smooth"}):this._scrollToBottomButton.addClass("new"),t&&this.notify(e),this._popout&&await this._popout.postOne(e,!1),this.popOut&&this.setPosition()}static _ChatLog_deleteMessage(e,t,{deleteAll:a=!1}={}){const i=e(t,{deleteAll:a});return!a||this._scrollToBottomButton.is(":hidden")||(this._scrollToBottomButton.hide(),this._scrollToBottomButton.removeClass("new")),i}}ScrollManage.PREF_ENABLED="scroll-manage-enabled",ScrollManage.PREF_SCROLL_IF_YOU="scroll-manage-scroll-if-you",ScrollManage.ScrollThreshold=50,ScrollManage._deleteMessageRegistrationID=null},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ChatHistoryOptimizer});var i=a(4),r=a(15);class ChatHistoryOptimizer{static init(){i.default.register(this.PREF_ENABLED,{name:"DF_CHAT_SCROLL.HistoryFixEnabledName",hint:"DF_CHAT_SCROLL.HistoryFixEnabledHint",config:!0,type:Boolean,default:!0,scope:"world",onChange:r.default.requestReload}),i.default.register(this.PREF_HISTORY_SIZE,{name:"DF_CHAT_SCROLL.HistorySizeName",hint:"DF_CHAT_SCROLL.HistorySizeHint",config:!0,type:Number,default:CONFIG.ChatMessage.batchSize,range:{min:CONFIG.ChatMessage.batchSize,max:5*CONFIG.ChatMessage.batchSize,step:CONFIG.ChatMessage.batchSize},scope:"world",onChange:()=>$("#chat-log").trigger("scroll")}),i.default.get(this.PREF_ENABLED)&&libWrapper.register(i.default.MOD_NAME,"ChatLog.prototype._onScrollLog",this._ChatLog_onScrollLog,"MIXED")}static _ChatLog_onScrollLog(e,t){if(!this.rendered)return Promise.resolve();const a=i.default.get(ChatHistoryOptimizer.PREF_HISTORY_SIZE);if(this.collection.size<=CONFIG.ChatMessage.batchSize)return e(t);const r=t.target,o=$(r).find("li.chat-message");let s=-1;const n=r.scrollTop/r.scrollHeight,l=r.scrollTop+o[0].offsetTop;let c=Math.trunc(o.length*n);if(o[c].offsetTop<l){for(;c<o.length;c++)if(o[c].offsetTop<=l&&o[c].offsetTop+o[c].offsetHeight>=l||c-1>=0&&o[c].offsetTop>=l&&o[c-1].offsetTop+o[c-1].offsetHeight){s=c;break}}else for(;c>=0;c--)if(o[c].offsetTop<=l&&o[c].offsetTop+o[c].offsetHeight>=l||c-1>=0&&o[c].offsetTop>=l&&o[c-1].offsetTop+o[c-1].offsetHeight){s=c;break}if(s<0)return Promise.resolve();if(s<CONFIG.ChatMessage.batchSize/4&&o.length<this.collection.size)return this._renderBatch(this.element,CONFIG.ChatMessage.batchSize);if(s>a){const e=s-(a-1);this._lastId=o[e].dataset.messageId,o.slice(0,e).remove()}return Promise.resolve()}static _displayMessageCounts(e){ChatHistoryOptimizer._lastFrame+500<e&&(ChatHistoryOptimizer._lastFrame=e,$(".dfce-chat-count").each((function(e,t){const a=$(t).siblings("#chat-log").find("li.chat-message").length;t.innerText=`${a} / ${ui.chat.collection.size}`}))),requestAnimationFrame(ChatHistoryOptimizer._displayMessageCounts)}}ChatHistoryOptimizer.PREF_ENABLED="ChatHistoryOptimizer.Enabled",ChatHistoryOptimizer.PREF_HISTORY_SIZE="ChatHistoryOptimizer.HistorySize",ChatHistoryOptimizer._lastFrame=0},(e,t,a)=>{a.r(t),a.d(t,{default:()=>WhisperTruncation});var i=a(4);const r="&nbsp;".length-1;class WhisperTruncation{static init(){Hooks.on("renderChatMessage",this._messageRender.bind(this)),i.default.register(this.PREF_ENABLED,{name:"DF_CHAT_WHISPER_TRUNC.SettingEnabledName",hint:"DF_CHAT_WHISPER_TRUNC.SettingEnabledHint",config:!0,type:Boolean,default:!0,scope:"world",onChange:async()=>{ui.chat._state=0,ui.chat._lastId=null,await ui.chat.render(!0)}}),i.default.register(this.PREF_CHAR_LIMIT,{name:"DF_CHAT_WHISPER_TRUNC.SettingCharLimitName",hint:"DF_CHAT_WHISPER_TRUNC.SettingCharLimitHint",config:!0,type:Number,default:50,scope:"world",onChange:async()=>{ui.chat._state=0,ui.chat._lastId=null,await ui.chat.render(!0)}})}static _messageRender(e,t,a){if(!i.default.get(this.PREF_ENABLED)||!e.data.whisper||e.data.whisper.length<=1)return;const o=e.data.whisper.map((e=>game.users.get(e)));let s=o[0].data.name,n=this._formatTitle(s,o.length-1),l=1;const c=i.default.get(this.PREF_CHAR_LIMIT);for(;l<o.length;l++){const e=s+", "+o[l].data.name,t=this._formatTitle(e,o.length-l-1);if(t.length-r>c)break;s=e,n=t}if(l===o.length)return;const d=`<span class="whisper-to" title="${o.slice(l).map((e=>e.data.name)).join(", ")}">${n}</span>`;t.find("span.whisper-to").replaceWith(d)}static _formatTitle(e,t){return t>0?"$0: $1 (+$2&nbsp;more)".replace("$0","CHAT.To".localize()).replace("$1",e).replace("$2",t.toString()):e}}WhisperTruncation.PREF_ENABLED="whisper-trunc_enabled",WhisperTruncation.PREF_CHAR_LIMIT="whisper-trunc_char-limit"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>PlayerColor});var i=a(10),r=a(4),o=a(15);class PlayerColor{static init(){r.default.register(PlayerColor.PREF_TINT_BG,{config:!0,name:"DF_CHAT_PLAYER_COLOR.SettingTintBackgroundName",hint:"DF_CHAT_PLAYER_COLOR.SettingTintBackgroundHint",scope:"world",type:Boolean,default:!1,onChange:o.default.reloadChatLog}),r.default.register(PlayerColor.PREF_BORDER_STYLE,{name:"DF_CHAT_PLAYER_COLOR.SettingBorderStyleName",hint:"DF_CHAT_PLAYER_COLOR.SettingBorderStyleHint",config:!0,type:String,choices:{all:"DF_CHAT_PLAYER_COLOR.BorderStyle.all",mine:"DF_CHAT_PLAYER_COLOR.BorderStyle.mine",none:"DF_CHAT_PLAYER_COLOR.BorderStyle.none"},default:"all",scope:"client",onChange:o.default.reloadChatLog}),Hooks.on("renderUserConfig",((e,t,a)=>{var i;const o=null!==(i=a.user.getFlag(r.default.MOD_NAME,PlayerColor.FLAG_CHAT_COLOR))&&void 0!==i?i:"";t.find('input[name="color"]').parent().after(`\n<div class="form-group">\n\t<label for="chat-color">${"DF_CHAT_PLAYER_COLOR.Label".localize()}</label>\n\t<input id="chat-color" type="text" name="chat-color" value="${o}" style="flex:1.35">\n\t<input type="color" value="${o}" data-edit="chat-color">\n</div>`);const s=t.find("#chat-color"),n=t.find('[data-edit="chat-color"]');s.on("change",(()=>n.val(s.val()))),e.element[0].style.height="",e.setPosition({})})),i.default.register("UserConfig.prototype._updateObject",(async function(e,t,a){await this.object.setFlag(r.default.MOD_NAME,PlayerColor.FLAG_CHAT_COLOR,a["chat-color"]),await e(t,a)})),libWrapper.register(r.default.MOD_NAME,"ChatMessage.prototype.getHTML",(async function(e,...t){var a;const i=await e(...t);if(!this.user)return i;let o=null===(a=this.user.getFlag(r.default.MOD_NAME,PlayerColor.FLAG_CHAT_COLOR))||void 0===a?void 0:a.trim();o&&/#[a-fA-F0-9]{6,8}/.test(o)||(o=this.user.color);let s="#6f6c66";switch(r.default.get(PlayerColor.PREF_BORDER_STYLE)){case"none":break;case"mine":if(game.userId!==this.data.user)break;case"all":s=o}return i[0].style.borderColor=s,i[0].style.setProperty("--dfce-mc-border-color",s),r.default.get(PlayerColor.PREF_TINT_BG)&&(i[0].style.backgroundColor=o,i[0].style.backgroundImage="url(../ui/parchment.jpg)",i[0].style.backgroundRepeat="repeat",i[0].style.backgroundBlendMode="screen"),i}),"WRAPPER")}}PlayerColor.PREF_TINT_BG="PlayerColor_TintBackground",PlayerColor.PREF_BORDER_STYLE="PlayerColor.BorderStyle",PlayerColor.FLAG_CHAT_COLOR="chat-color"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>SendButton});var i=a(4);class SendButton{static init(){i.default.register(this.PREF_ENABLED,{name:"DF_CHAT_SEND_BUTTON.EnabledName".localize(),hint:"DF_CHAT_SEND_BUTTON.EnabledHint".localize(),config:!0,scope:"client",type:Boolean,default:!1,onChange:e=>{if(e){this._renderChatLog(ui.chat,$("#sidebar #chat"));const e=$("#chat-popout");e.length>0&&this._renderChatLog(ui.chat,e)}else $(".dfce-send-btn").remove(),$("#chat-message").each(((e,t)=>{$(t).off("input",t.dfce_handler)}))}}),Hooks.on("renderChatLog",this._renderChatLog.bind(this))}static _renderChatLog(e,t){if(!i.default.get(this.PREF_ENABLED))return;const a=$('<button class="dfce-send-btn"><i class="fas fa-paper-plane"></i></button>');a.attr("title","DF_CHAT_SEND_BUTTON.ButtonTitle".localize()),t.find("#chat-form").append(a);const r=t.find("#chat-message");a.prop("disabled",r[0].textLength<=0||r[0].value.trim().length<=0),a.on("click",(async e=>{e.preventDefault(),await ui.chat._onChatKeyDown({code:"Enter",currentTarget:r[0],originalEvent:{isComposing:!1},preventDefault:()=>{}}),setTimeout((()=>r.trigger("input")),100)}));const handler=e=>{const t=e.currentTarget;a.prop("disabled",t.textLength<=0||t.value.trim().length<=0)};r[0].dfce_handler=handler,r.on("input",handler)}}SendButton.PREF_ENABLED="SendButton.Enabled"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>FontSizePatch});var i=a(4);class FontSizePatch{static init(){i.default.register(this.PREF_SIZE,{name:"DF_CHAT_FONT_SIZE.FontSizeName".localize(),hint:"DF_CHAT_FONT_SIZE.FontSizeHint".localize(),config:!0,type:Number,scope:"client",range:{min:10,max:30,step:.5},default:14,onChange:e=>this.updateFontSize(e)}),this.updateFontSize(i.default.get(this.PREF_SIZE))}static updateFontSize(e){document.querySelector(":root").style.setProperty("--dfce-chat-font-size",e.toString()+"px")}}FontSizePatch.PREF_SIZE="FontSizePatch.FontSize"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>ChatTime});var i=a(4),r=a(15);class ChatTime{static get enabled(){return i.default.get(this.PREF_ENABLED)}static get simpleCalendarActive(){var e;return!!(null===(e=game.modules.get("foundryvtt-simple-calendar"))||void 0===e?void 0:e.active)}static ready(){!this.simpleCalendarActive&&game.user.isGM&&this.enabled&&ui.notifications.warn("DF_CHAT_TIME.ErrorSimpleCalendarMissing",{permanent:!0,localize:!0})}static init(){i.default.register(this.PREF_ENABLED,{scope:"world",type:Boolean,name:"DF_CHAT_TIME.EnabledName",hint:"DF_CHAT_TIME.EnabledHint",default:!1,config:!0,onChange:r.default.reloadChatLog}),i.default.register(this.PREF_FORMAT,{scope:"world",type:String,name:"DF_CHAT_TIME.FormatName",hint:"DF_CHAT_TIME.FormatHint",default:"YYYY, MMM DD, HH:mm",config:this.simpleCalendarActive,onChange:r.default.reloadChatLog}),libWrapper.register(i.default.MOD_NAME,"ChatMessage.implementation.create",((e,t,a)=>{var r;return t.flags=null!==(r=t.flags)&&void 0!==r?r:{},t.flags[i.default.MOD_NAME]={},t.flags[i.default.MOD_NAME][this.FLAG_CHAT_TIME]=game.time.worldTime,e(t,a)}),"WRAPPER"),Hooks.on("renderChatMessage",((e,t,a)=>{if(!this.simpleCalendarActive||!this.enabled)return;const r=e.getFlag(i.default.MOD_NAME,this.FLAG_CHAT_TIME);if(void 0===r)return;const o=t.find(".message-timestamp"),s=$(`<time class="dfce-simple-timestamp">${SimpleCalendar.api.formatDateTime(SimpleCalendar.api.timestampToDate(r),i.default.get(this.PREF_FORMAT))}</time>`);o.after(s),o.hide()}))}}ChatTime.PREF_ENABLED="ChatTime.UseSimpleCalender",ChatTime.PREF_FORMAT="ChatTime.SimpleCalendarFormat",ChatTime.FLAG_CHAT_TIME="ChatTime.WorldTime"}],t={};function __webpack_require__(a){var i=t[a];if(void 0!==i)return i.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,__webpack_require__),r.exports}__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};(()=>{__webpack_require__.r(a);var e=__webpack_require__(1),t=__webpack_require__(7),i=__webpack_require__(9),r=__webpack_require__(12),o=__webpack_require__(13),s=__webpack_require__(14),n=__webpack_require__(16),l=__webpack_require__(4),c=__webpack_require__(18),d=__webpack_require__(19),g=__webpack_require__(20),h=__webpack_require__(21),u=__webpack_require__(22);l.default.init("df-chat-enhance"),Application.prototype._recalculateDimensions=function(){this.element[0].style.height="",this.element[0].style.width="",this.setPosition({})},Hooks.once("setup",(function(){s.default.setup()})),Hooks.once("init",(function(){e.init(),s.default.init(),i.init(),o.default.init(),n.default.init(),c.default.init(),d.default.init(),g.default.init(),h.default.init(),u.default.init(),libWrapper.register(l.default.MOD_NAME,"ChatLog.prototype._getEntryContextOptions",(function(e,...a){const i=e(...a);return t.default.appendChatContextMenuOptions(i),r.default.appendChatContextMenuOptions(i),i}),"WRAPPER")})),Hooks.once("ready",(function(){var e;(null===(e=game.modules.get("lib-wrapper"))||void 0===e?void 0:e.active)||(console.error("Missing libWrapper module dependency"),game.user.isGM&&ui.notifications.error("DF_CHAT_LOG.Error.LibWrapperMissing".localize())),i.ready(),t.default.ready(),o.default.ready(),n.default.ready(),u.default.ready()}))})()})();
//# sourceMappingURL=main.js.map