(()=>{"use strict";var e=[,(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFSceneJournal});var n=a(2);class DFSceneJournal{static async displayDialog(e){const t=e.testUserPermission(game.user,"LIMITED"),a=game.user.isGM,i=!!e.journal&&e.journal.testUserPermission(game.user,"OBSERVER");if(!t&&!a&&!i)return ui.notifications.warn(`You do not have permission to view this ${e.documentName}.`);const r={};let o="";a&&(o="config",r.config={icon:'<i class="fas fa-cog"></i>',label:game.i18n.localize("DF-SCENE-ENHANCE.Dialog.JournalConfig"),callback:async()=>e.sheet.render(!0)}),i&&(o="journal",r.journal={icon:'<i class="fas fa-book-open"></i>',label:game.i18n.localize("DF-SCENE-ENHANCE.Dialog.JournalJournal"),callback:async()=>e.journal.sheet.render(!0)}),t&&(o="navigate",r.navigate={icon:'<i class="fas fa-directions"></i>',label:game.i18n.localize("DF-SCENE-ENHANCE.Dialog.JournalNavigate"),callback:async()=>e.view()});return n.default.get(DFSceneJournal.ON_CLICK_JOURNAL_ONLY_ONE)&&1==Object.keys(r).length?r[Object.keys(r)[0]].callback():new Dialog({title:game.i18n.localize("DF-SCENE-ENHANCE.Dialog.JournalTitle")+e.name,content:"<p>"+game.i18n.localize("DF-SCENE-ENHANCE.Dialog.JournalMessage")+"</p>",buttons:r,default:o}).render(!0)}static async _onClickContentLink(e){const t=e.currentTarget;let a=null;const n=t.dataset.id;if(!t.dataset.pack){if(a=game.collections.get(t.dataset.entity).get(n),"Scene"===a.documentName)return e.preventDefault(),DFSceneJournal.displayDialog(a)}return TextEditor._onClickContentLink(e)}static patchTextEditor(e){let t=n.default.get(DFSceneJournal.ON_CLICK_JOURNAL);void 0!==e&&(t=e);const a=$("body");t?(a.off("click","a.content-link",TextEditor._onClickContentLink),a.on("click","a.content-link",DFSceneJournal._onClickContentLink)):(a.off("click","a.content-link",DFSceneJournal._onClickContentLink),a.on("click","a.content-link",TextEditor._onClickContentLink))}static init(){n.default.register(DFSceneJournal.ON_CLICK_JOURNAL,{name:"DF-SCENE-ENHANCE.Nav.SettingOnClickJournal",hint:"DF-SCENE-ENHANCE.Nav.SettingOnClickJournalHint",scope:"world",config:!0,type:Boolean,default:!0,onChange:e=>DFSceneJournal.patchTextEditor(e)}),n.default.register(DFSceneJournal.ON_CLICK_JOURNAL_ONLY_ONE,{name:"DF-SCENE-ENHANCE.Nav.SettingOnClickJournalOnlyOne",hint:"DF-SCENE-ENHANCE.Nav.SettingOnClickJournalOnlyOneHint",scope:"scene",config:!0,type:Boolean,default:!1})}static ready(){DFSceneJournal.patchTextEditor()}}DFSceneJournal.ON_CLICK_JOURNAL="nav-on-click-journal",DFSceneJournal.ON_CLICK_JOURNAL_ONLY_ONE="nav-on-click-journal-only-one"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>SETTINGS});class SETTINGS{static init(e){this.MOD_NAME=e,String.prototype.localize||(String.prototype.localize=function(){return game.i18n.localize(this.valueOf())})}static register(e,t){game.settings.register(SETTINGS.MOD_NAME,e,t)}static registerMenu(e,t){game.settings.registerMenu(SETTINGS.MOD_NAME,e,t)}static get(e){return game.settings.get(SETTINGS.MOD_NAME,e)}static async set(e,t){return await game.settings.set(SETTINGS.MOD_NAME,e,t)}static default(e){return game.settings.settings.get(SETTINGS.MOD_NAME+"."+e).default}static typeOf(){return Object}}},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFSceneNav});var n=a(2);class DFSceneNav{static patchSceneDirectoryClick(e,t){let a=n.default.get(DFSceneNav.ON_CLICK),i=n.default.get(DFSceneNav.ON_CLICK_PLAYER);void 0!==e&&(t?i=e:a=e);game.user.isGM&&a||!game.user.isGM&&i?(libWrapper.register(n.default.MOD_NAME,"SceneDirectory.prototype._onClickDocumentName",this._onClickDocumentName,"MIXED"),libWrapper.register(n.default.MOD_NAME,"SceneDirectory.prototype._getEntryContextOptions",this._getEntryContextOptions,"WRAPPER")):(libWrapper.unregister(n.default.MOD_NAME,"SceneDirectory.prototype._onClickDocumentName",!1),libWrapper.unregister(n.default.MOD_NAME,"SceneDirectory.prototype._getEntryContextOptions",!1))}static _onClickDocumentName(e,t){t.preventDefault();const a=SceneDirectory.collection.get(t.currentTarget.parentElement.dataset.documentId);a instanceof Scene?a.view():e(t)}static _getEntryContextOptions(e,...t){const a=e(...t);return game.user.isGM||a.push({name:"SCENES.View",icon:'<i class="fas fa-eye"></i>',condition:e=>!canvas.ready||e.data("entityId")!==canvas.scene.id,callback:e=>{game.scenes.get(e.data("entityId")).view()}}),a}static patchSceneDirectory(){const e=duplicate(SceneDirectory.defaultOptions);Object.defineProperty(SceneDirectory,"defaultOptions",{get:function(){return mergeObject(e,{template:`modules/${n.default.MOD_NAME}/templates/scene-directory.hbs`})}})}static patchSidebar(){libWrapper.register(n.default.MOD_NAME,"Sidebar.prototype._render",(async function(e,t,a={}){if(!n.default.get(DFSceneNav.ON_CLICK_PLAYER))return e(t,a);this.rendered||await Application.prototype._render.apply(this,[t,a]);(game.user.isGM||n.default.get(DFSceneNav.ON_CLICK_PLAYER))&&["chat","combat","actors","items","journal","tables","cards","playlists","compendium","settings"].push("scenes");for(const[e,t]of Object.entries(this.tabs))t._render(!0).catch((t=>{Hooks.onError("Sidebar#_render",t,{msg:`Failed to render Sidebar tab ${e}`,log:"error",name:e})}))}),"MIXED"),libWrapper.register(n.default.MOD_NAME,"SceneDirectory.prototype._render",(async function(e,...t){return n.default.get(DFSceneNav.ON_CLICK_PLAYER)?SidebarDirectory.prototype._render.apply(this,[...t]):e(...t)}),"MIXED"),libWrapper.register(n.default.MOD_NAME,"Sidebar.prototype.getData",((e,t)=>mergeObject(e(t),{scenesAllowed:game.user.isGM||n.default.get(DFSceneNav.ON_CLICK_PLAYER)})),"WRAPPER");const e=Object.getOwnPropertyDescriptor(Sidebar,"defaultOptions");Object.defineProperty(Sidebar,"defaultOptions",{get:function(){return mergeObject(e.get(),{template:`modules/${n.default.MOD_NAME}/templates/sidebar.hbs`})}})}static init(){n.default.register(DFSceneNav.ON_CLICK,{name:"DF-SCENE-ENHANCE.Nav.SettingOnClick",hint:"DF-SCENE-ENHANCE.Nav.SettingOnClickHint",scope:"world",config:!0,type:Boolean,default:!0,onChange:e=>DFSceneNav.patchSceneDirectoryClick(e,!1)}),n.default.register(DFSceneNav.ON_CLICK_PLAYER,{name:"DF-SCENE-ENHANCE.Nav.SettingOnClickPC",hint:"DF-SCENE-ENHANCE.Nav.SettingOnClickPCHint",scope:"world",config:!0,type:Boolean,default:!0,onChange:e=>DFSceneNav.patchSceneDirectoryClick(e,!0)}),n.default.register(DFSceneNav.SCENE_NAV_REAL_NAME,{name:"DF-SCENE-ENHANCE.Nav.SettingRealName",hint:"DF-SCENE-ENHANCE.Nav.SettingRealNameHint",scope:"world",config:!0,type:Boolean,default:!1,onChange:()=>{DFSceneNav.patchSceneNavGetData(),ui.nav.render(!1)}}),Handlebars.registerHelper("dfCheck",(function(e){return game.user&&game.user.isGM||!e.data.navName?e.data.name:e.data.navName})),DFSceneNav.patchSceneDirectory(),DFSceneNav.patchSidebar(),DFSceneNav.patchSceneNavGetData(),libWrapper.register(n.default.MOD_NAME,"SceneNavigation.prototype.activateListeners",DFSceneNav.SceneNavigation_activateListeners,"WRAPPER"),libWrapper.register(n.default.MOD_NAME,"SceneNavigation.prototype._getContextMenuOptions",DFSceneNav.SceneNavigation_getContextMenuOptions,"WRAPPER")}static ready(){DFSceneNav.patchSceneDirectoryClick()}static patchSceneNavGetData(){n.default.get(DFSceneNav.SCENE_NAV_REAL_NAME)?libWrapper.register(n.default.MOD_NAME,"SceneNavigation.prototype.getData",this.SceneNavigation_getData,"WRAPPER"):libWrapper.unregister(n.default.MOD_NAME,"SceneNavigation.prototype.getData",!1)}static SceneNavigation_getData(e,t){const a=e(t);for(const e of a.scenes)e.name=game.scenes.get(e._id).name;return a}static SceneNavigation_activateListeners(e,t){e(t),t.find("li.scene.nav-item").each(((e,t)=>{var a,i;const r=game.scenes.get(t.getAttribute("data-scene-id"));if(game.user.isGM)r.data.navName&&0!==r.data.navName.trim().length&&(n.default.get(DFSceneNav.SCENE_NAV_REAL_NAME)?t.title="DF-SCENE-ENHANCE.Nav.Tooltip_PC".localize()+r.data.navName:t.title=r.data.name);else{(null!==(a=r.data.navName)&&void 0!==a?a:r.data.name).length>32&&(t.title=null!==(i=r.data.navName)&&void 0!==i?i:r.data.name)}}))}static SceneNavigation_getContextMenuOptions(e){const t=e();return t.push({name:"DF-SCENE-ENHANCE.Nav.ContextOptions.SetView",icon:'<i class="fas fa-crop-alt fa-fw"></i>',condition:e=>game.user.isGM&&game.scenes.get(e.attr("data-scene-id")).isView,callback:async e=>{const t=game.scenes.get(e.attr("data-scene-id"));await t.update({initial:{x:parseInt(canvas.stage.pivot.x),y:parseInt(canvas.stage.pivot.y),scale:canvas.stage.scale.x}}),ui.notifications.info("DF-SCENE-ENHANCE.Nav.ContextOptions.SetViewConfirmation".localize())}},{name:"DF-SCENE-ENHANCE.Nav.ContextOptions.ConfigGrid",icon:'<i class="fas fa-ruler-combined"></i>',condition:e=>game.user.isGM&&game.scenes.get(e.attr("data-scene-id")).isView,callback:e=>{const t=game.scenes.get(e.attr("data-scene-id"));return new GridConfig(t,{maximize:()=>{}}).render(!0)}}),t}}DFSceneNav.ON_CLICK="nav-on-click",DFSceneNav.ON_CLICK_PLAYER="nav-on-click-player",DFSceneNav.SCENE_NAV_REAL_NAME="nav-label-type"},(e,t,a)=>{a.r(t),a.d(t,{default:()=>DFSceneThumb});var n=a(5),i=a(2);class DFSceneThumb{static purge(){if(!game.user.isGM)return;const e=[];for(const t of game.scenes.values())e.push(t.id);const t=JSON.parse(i.default.get(DFSceneThumb.THUMBS));for(const a in t)e.includes(a)||delete t[a];i.default.set(DFSceneThumb.THUMBS,JSON.stringify(t))}static updateThumb(e,t,a=!1){const n=JSON.parse(i.default.get(DFSceneThumb.THUMBS));t?n[e]={url:t,thumb:a}:delete n[e],i.default.set(DFSceneThumb.THUMBS,JSON.stringify(n))}static getThumb(e){var t;return null!==(t=JSON.parse(i.default.get(DFSceneThumb.THUMBS))[e])&&void 0!==t?t:null}static init(){i.default.register(DFSceneThumb.THUMBS,{scope:"world",config:!1,type:String,default:"{}"}),Hooks.on("renderSceneConfig",(async(e,t,a)=>{const i=t.find('input[name ="img"]')[0];if(!i||!i.parentElement||!i.parentElement.parentElement)return;const r=a.document.id,o=DFSceneThumb.getThumb(r),s=$(await renderTemplate(`modules/${DFSceneThumb.MODULE}/templates/scene-thumb.hbs`,{thumbPath:o&&o.url||""})),c=i.parentElement.parentElement;for(let e=0;e<s.length;e++)1==s[e].nodeType&&c.after(s[e]);t.find("#df-thumb-btn").on("click",(()=>{const a=FilePicker.fromButton(t.find("#df-thumb-btn")[0]);e.filepickers.push(a),a.browse("")})),t.find("#df-thumb-img").on("change",(()=>DFSceneThumb.updateThumb(r,t.find("#df-thumb-img").val()))),e.ratioScaler=new n.default,await e.ratioScaler.render(e,t,a)})),Hooks.on("closeSceneConfig",(async(e,t)=>{var a;const n=DFSceneThumb.getThumb(e.document.id),i=e.object;if(n&&n.url)try{const e=null!==(a=n&&n.url)&&void 0!==a?a:i.data.img,t=await ImageHelper.createThumbnail(e,{width:300,height:100});n.thumb=!0,DFSceneThumb.updateThumb(i.id,e,!0),await i.update({thumb:t.thumb},{})}catch(e){console.error("Thumbnail Override generation for Scene failed",e),ui.notifications.error("Thumbnail Override generation for Scene failed: "+e.message)}}))}static ready(){DFSceneThumb.purge()}}DFSceneThumb.MODULE="df-scene-enhance",DFSceneThumb.THUMBS="thumbs"},(e,t,a)=>{function reduce(e,t){let a,n=e,i=t;for(;i;)a=n%i,n=i,i=a;return[e/n,t/n]}function floatVal(e){return parseFloat(e.val())}function intVal(e){return parseInt(e.val())}a.r(t),a.d(t,{default:()=>DFSceneRatio});class DFSceneRatio{constructor(){this.initialWidth=0,this.initialHeight=0,this.widthField=null,this.heightField=null,this.lockRatio=null,this.customRatio=null,this.numerator=null,this.denominator=null,this.applyRatio=null,this.scale=null,this.applyScale=null,this.isLocked=!1,this.useCustom=!1}get _width(){return intVal(this.widthField)}set _width(e){this.widthField.val(e)}get _height(){return intVal(this.heightField)}set _height(e){this.heightField.val(e)}get _numerator(){return floatVal(this.numerator)}set _numerator(e){this.numerator.val(e)}get _denominator(){return floatVal(this.denominator)}set _denominator(e){this.denominator.val(e)}get _scale(){return floatVal(this.scale)}set _scale(e){this.scale.val(e)}_updateRatio(){const[e,t]=reduce(this._width,this._height);this._numerator=e,this._denominator=t}_performDimensionChange(e,t){if(!this.isLocked)return void this._updateRatio();const a=this._numerator,n=this._denominator;isNaN(a)||isNaN(n)||(void 0!==e?this._height=Math.round(e/a*n):void 0!==t?this._width=Math.round(t/n*a):console.error("DFSceneRatio._performDimensionChange(undefined, undefined)"))}_performScale(){const e=this._numerator,t=this._denominator,a=this._scale;isNaN(e)||isNaN(t)||isNaN(a)||(this._width=this._width*a,this._height=this._height*a,this._scale=1)}_performRatio(){const e=this._numerator,t=this._denominator,a=this._width,n=this._height;isNaN(e)||isNaN(t)||(e>t||e==t&&a>n?this._height=Math.round(a/e*t):this._width=Math.round(n/t*e))}async render(e,t,a){const n=a.document;this.initialWidth=n.data.width,this.initialHeight=n.data.height;const i=a.document.dimensions,[r,o]=reduce(i.width,i.height),s={numerator:r,denominator:o},c=$(await renderTemplate(`modules/${DFSceneRatio.MODULE}/templates/scene-ratio.hbs`,s)),l=t.find('input[name="padding"]').parent().parent().prev();this.widthField=l.find('input[name="width"]'),this.heightField=l.find('input[name="height"]'),c.insertAfter(l),this._extractFields(c),this._attachListeners(),await this._updateOriginalImageDimensions(n.img)}_extractFields(e){this.lockRatio=e.find('input[name="lockRatio"]'),this.customRatio=e.find('input[name="customRatio"]'),this.numerator=e.find('input[name="numerator"]'),this.denominator=e.find('input[name="denominator"]'),this.applyRatio=e.find('button[name="applyRatio"]'),this.scale=e.find('input[name="scale"]'),this.applyScale=e.find('button[name="applyScale"]')}_attachListeners(){this.widthField.on("change",(()=>this._performDimensionChange(this._width))),this.heightField.on("change",(()=>this._performDimensionChange(void 0,this._height))),this.lockRatio.on("change",(()=>{this.isLocked=this.lockRatio[0].checked})),this.customRatio.on("change",(()=>{this.useCustom=this.customRatio[0].checked,this.numerator.prop("disabled",0==this.useCustom),this.denominator.prop("disabled",0==this.useCustom),this.applyRatio.prop("disabled",0==this.useCustom)})),this.applyScale.on("click",(()=>this._performScale())),this.applyRatio.on("click",(()=>this._performRatio()))}async _updateOriginalImageDimensions(e){return new Promise(((t,a)=>{const n=$(new Image);n.on("load",(()=>{this.widthField.attr("placeholder",n[0].width),this.heightField.attr("placeholder",n[0].height),t()})).on("error",a).attr("src",e)}))}}DFSceneRatio.MODULE="df-scene-enhance"}],t={};function __webpack_require__(a){var n=t[a];if(void 0!==n)return n.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,__webpack_require__),i.exports}__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};(()=>{__webpack_require__.r(a);var e=__webpack_require__(1),t=__webpack_require__(3),n=__webpack_require__(4);__webpack_require__(2).default.init("df-scene-enhance"),Hooks.once("init",(function(){e.default.init(),t.default.init(),n.default.init()})),Hooks.once("ready",(function(){var a;if(!(null===(a=game.modules.get("lib-wrapper"))||void 0===a?void 0:a.active))return console.error("Missing libWrapper module dependency"),void(game.user.isGM&&ui.notifications.error(game.i18n.localize("DF-SCENE-ENHANCE.errorLibWrapperMissing")));e.default.ready(),t.default.ready(),n.default.ready()}))})()})();
//# sourceMappingURL=main.js.map