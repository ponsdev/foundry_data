import e from"../../systems/dnd5e/module/actor/sheets/npc.js";import t from"../../../../../../systems/dnd5e/module/item/entity.js";const n={appIds:{lootsheet:"lootsheetnpc5e",lootseederSettings:"lootsheetnpc5e-seeder-settings",lootsheetSettings:"lootsheetnpc5e-lootsheet-settings",ruleEditor:"lootsheetnpc5e-rule-editor"},flags:{currencyFormula:"currencyFormula",rolltable:"rolltable",loot:"loot",shopQty:"shopQty",shopQtyFormula:"shopQtyFormula",itemQty:"itemQty",itemQtyLimit:"itemQtyLimit",clearInventory:"clearInventory",priceModifier:"priceModifier",default:{lootsheetnpc5e:{lootsheettype:"Loot",rolltable:"",shopQty:"",itemQty:"",itemQtyLimit:"",currencyFormula:"",clearInventory:!1,permissionsFilter:!1,darkMode:!0,sheettint:{value:"#000000",alpha:.5,style:"none",blendmode:"difference"},avatartint:{value:"#000000",alpha:.5}}}},ns:"lootsheetnpc5e",path:"modules/lootsheetnpc5e",templatePath:"modules/lootsheetnpc5e/templates",templateAppsPath:"modules/lootsheetnpc5e/templates/apps",templatePartialsPath:"modules/lootsheetnpc5e/templates/partials",socket:"module.lootsheetnpc5e",sockettypes:{lootItem:"lootItem",lootAll:"lootAll",distributeCurrency:"distributeCurrency",lootCurrency:"lootCurrency",buyItem:"buyItem",tradeItems:"tradeItems",buyAll:"buyAll",sheetUpdate:"sheetUpdate"},sheets:{loot:"loot",merchant:"merchant",shop:"shop",account:"account",object:"object"},settings:{scopes:{world:"world",client:"client",default:"defaults"},groups:{sheet:{moduleDefaults:"moduleDefaults",ui:"UI",loot:"Loot",merchant:"Merchant"},lootseeder:{fallbacks:"fallbacks",customFallbacks:"customFallbacks",creatureTypeFallbacks:"creatureTypeFallbacks",skiplist:"skiplist",defaults:"creature_defaults",creature:"creature",currency:"currency",rulesets:"rulesets"}},keys:{common:{useBetterRolltables:"useBetterRolltables",autoCheckUpdates:"autoCheckUpdates",addInterfaceButtons:"addInterfaceButtons"},sheet:{advancedOptions:"advancedSheetOptions",buyItem:"buyItem",buyAll:"buyAll",chatGracePeriod:"chatGracePeriod",colorRarity:"colorRarity",convertCurrency:"convertCurrency",distributeCurrency:"distributeCurrency",priceModifier:"priceModifier",filterNaturalWeapons:"filterNaturalWeapons",generateChatMessages:"generateChatMessages",includeCurrencyWeight:"includeCurrencyWeight",lootAll:"lootAll",lootCurrency:"lootCurrency",lootItem:"lootItem",sheetUpdate:"sheetUpdate",maxPriceIncrease:"maxPriceIncrease",reduceUpdateVerbosity:"reduceUpdateVerbosity",stackBuyConfirm:"stackBuyConfirm",showStackWeight:"showStackWeight",tradeItems:"tradeItems"},lootseeder:{seederOptions:"seederOptions",adjustCurrencyWithCR:"adjustCurrencyWithCR",autoSeedTokens:"autoSeedTokens",creatureTypeFallbacks:"creatureTypeFallbacks",customFallbackSwitch:"customFallbackSwitch",customFallbacks:"customFallbacks",rulesets:"rulesets",fallbackRolltable:"fallbackRolltable",fallbackShopQty:"fallbackShopQty",fallbackItemQty:"fallbackItemQty",fallbackItemQtyLimit:"fallbackItemQtyLimit",generateCurrency:"generateCurrency",lootCurrencyDefault:"lootCurrencyDefault",useRulesets:"useRulesets",useSkiplist:"useSkiplist"}}}};class PermissionHelper{static getTargetGM(){return game.users.filter((e=>e.isGM&&e.active))?.[0]||!1}static getPermissionInfo(e=null){const t={0:{class:"fas fa-ban",borderClass:"none",description:game.i18n.localize("lsnpc.permissions.0.desc"),title:game.i18n.localize("lsnpc.permissions.0.title")},2:{class:"fas fa-eye",borderClass:"observer",description:game.i18n.localize("lsnpc.permissions.2.desc"),title:game.i18n.localize("lsnpc.permissions.2.title")},3:{class:"ra ra-player-king",borderClass:"owner",description:game.i18n.localize("lsnpc.permissions.3.desc"),title:game.i18n.localize("lsnpc.permissions.3.title")}};return e||0==e?t[parseInt(e)]:t}static async bulkPermissionsUpdate(e,t){e.preventDefault();const n=t.data,a=e.currentTarget,s=a.dataset.value?parseInt(a.dataset.value):0;let r=duplicate(n.permission);for(let e of game.users)1!==e.data.role&&2!==e.data.role||(r[e.id]=s);await t.update({permission:r})}static async cyclePermissions(e,t,n=null,a=null){e.preventDefault();const s=[0,2,3];let r=duplicate(t.data.permission);r[n=n||e.currentTarget.dataset.playerId]=a||s[(s.indexOf(parseInt(r[n]))+1)%s.length],await t.update({permission:r})}static _updatedUserPermissions(e=canvas.tokens.controlled[0],t=CONST.DOCUMENT_PERMISSION_LEVELS.OBSERVER||0,n=this.getPlayers()){let a=duplicate(e.actor.data.permission);return n.forEach((e=>{a[e.data._id]=t})),a}static getLootPermissionForPlayer(e,t){let n=e.permission.default;return t.data._id in e.permission?e.permission[t.data._id]:void 0!==n?n:0}static getPlayers(){return game.users.filter((e=>e.role==CONST.USER_ROLES.PLAYER||e.role==CONST.USER_ROLES.TRUSTED))}static getEligableActors(e,t=CONST.DOCUMENT_PERMISSION_LEVELS.OBSERVER){let a=this.getEligableIdsByLevel(e),s=game.users.filter((e=>a.includes(e.id)&&e.character)).map((e=>e.id));const r=e.getFlag(n.ns,"permissionsFilter");switch(console.log(`${n.ns} | PermissionsHelper | getEligablePlayerActors | ${s.length} players with eligable characters found.`),r){case"1":s=this.filterByPlayerViewingScene(s,e);break;case"2":s=this.filterByTokenInScene(s),console.log(`${n.ns} |  \\--\x3e  | Filtered for players with a token in the tokens scene. ${s.length} players with eligable characters.`);break;case"3":s=this.filterByPlayerViewingScene(s,e),console.log(`${n.ns} |  \\--\x3e  | Filtered for players that view the scene. ${s.length} players with eligable characters.`),s=this.filterByTokenInScene(s),console.log(`${n.ns} |  \\--\x3e  | Filtered for players with a token in the tokens scene. ${s.length} players with eligable characters.`)}return s}static getEligableIdsByLevel(e,t=[CONST.DOCUMENT_PERMISSION_LEVELS.LIMITED,CONST.DOCUMENT_PERMISSION_LEVELS.OBSERVER]){return Object.entries(e.data.permission).reduce(((e,n)=>{const[a,s]=n;return"default"===a||t.includes(s)&&e.push(a),e}),[])}static filterByTokenInScene(e){return Array.from(canvas.tokens.placeables.reduce(((t,n)=>{if(!n.actor.hasPlayerOwner)return t;for(const a of Object.keys(n.actor.data.permission))e.includes(a)&&t.add(a);return t}),new Set))}static filterByPlayerViewingScene(e,t){const a=game.users.players.filter((e=>e.viewedScene==t.parent.parent.id)).map((e=>e.id));return e=e.filter((e=>a.includes(e))),console.log(`${n.ns} |  \\--\x3e  | Filtered for players that view the scene. ${e.length} players with eligable characters.`),e}}class QuantityDialog extends Dialog{constructor(e,t){"object"!=typeof t&&(t={});let n=!1;super({title:"Quantity",content:'\n            <form>\n                <div class="form-group">\n                    <label>Quantity:</label>\n                    <input type="number" min="1" max="'+t.max+'" step="1" id="quantity" name="quantity" value="1">\n                </div>\n            </form>',buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:t.acceptLabel?t.acceptLabel:"Accept",callback:()=>n=!0},no:{icon:"<i class='fas fa-times'></i>",label:"Cancel"}},default:"yes",close:()=>{if(n){var t=document.getElementById("quantity").value;if(isNaN(t))return console.log("Loot Sheet | Item quantity invalid"),ui.notifications.error("Item quantity invalid.");e(t)}}})}}class ItemHelper{static _getOptionsDefault(e={}){return{breakableRarities:e?.breakableRarities||["none","common"],chanceOfDamagedItems:e?.chanceOfDamagedItems||0,damagedItemsMultiplier:e?.damagedItemsMultiplier||0,removeDamagedItems:e?.removeDamagedItems||!1,filterNaturalWeapons:game.settings.get(n.ns,n.settings.keys.sheet.filterNaturalWeapons),rarityPath:e?.rarityPath||"data.rarity"}}static isItemDamaged(e,t){const n=this._getOptionsDefault(),a=n.breakableRarities;let s=getProperty(e,n.rarityPath);return t=t||n.chanceOfDamagedItems,!(!s||0===t)&&(s=s.toLowerCase(),!!a.includes(s)&&Math.random()<t)}static async moveItemsToDestination(e,t,n){const a=[],s=[],r=[],o=[],i=[];for(let l of n){const n=e.getEmbeddedDocument("Item",l.id);if(!n){ui.notifications.info(`${e.name} does not posess this ${l.name} anymore.`);continue}const c=n.data.data.quantity<l.data.data.quantity?parseInt(n.data.data.quantity):parseInt(l.data.data.quantity),u={_id:n.id,data:{quantity:n.data.data.quantity-c}},d=t.getEmbeddedCollection("Item").find((e=>n.name===e.name&&n.data.data.price===e.data.data.price&&n.data.data.weight===e.data.data.weight));let p={};if(d){let e={_id:d.id,data:{quantity:parseInt(d.data.data.quantity+c)}};o.push(e)}else p=duplicate(n),p.data.quantity=parseInt(c),p.data.equipped=!1,r.push(p);0===u.data.quantity?s.push(n.id):a.push(u),i.push({item:d||p,quantity:c})}return await ItemHelper._updateActorInventory(e,{type:"delete",data:s},a),await ItemHelper._updateActorInventory(t,{type:"create",data:r},o),i}static getLootableItems(e,t={}){return t=this._getOptionsDefault(t),e.filter((e=>{if(e.documentName&&(e=e.data),t?.filterNaturalWeapons&&"weapon"==e.type){return!["natural"].includes(e.data.weaponType)}return"equipment"==e.type?!e.data.armor||"natural"!=e.data.armor.type:!["class","spell","feat"].includes(e.type)})).filter((e=>{if(this.isItemDamaged(e,t.chanceOfDamagedItems)){if(t.removeDamagedItems)return!1;e.name+=" (Damaged)",e.data.price*=t.damagedItemsMultiplier}return!0})).map((e=>(e.data.equipped=!1,e)))}static async _updateActorInventory(e,t,n){if(t.data.length>0){if("create"===t.type)return e.createEmbeddedDocuments("Item",t.data);if("delete"===t.type)return e.deleteEmbeddedDocuments("Item",t.data)}if(n.length>0)return e.updateEmbeddedDocuments("Item",n)}static FormatPrice(e,t="dnd5e"){if("dnd5e"==t){let t=100*e;return{cp:Math.floor(t%100%10),sp:Math.floor(t%100/10),gp:Math.floor(e),ep:0,pp:0}}}static errorMessageToActor(e,t){const a={action:"error",triggerActorId:game.user.character?.id||null,tokenUuid:e.uuid,message:t};game.socket.emit(n.socket,a)}static async applyItemConversions(e,n,a=null){"spell"===e.type&&(e=await t.createScrollFromSpell(e));const s=this.getRandomRarity(),r=Math.floor(twist.random()*(s.priceRange[1]-s.priceRange[0]+1))+s.priceRange[0],o=new Roll("1d"+r),i=await o.roll({async:!0}),l={Actor:{name:`${e.name} Portrait`,img:e?.img||"icons/svg/mystery-man.svg",type:"loot",data:{rarity:s.rarity,price:i.total||.1}},Scene:{name:"Map of "+e.name,img:e.thumb||"icons/svg/direction.svg",data:{rarity:s.rarity,price:i.total||.1},type:"loot"}},c=(a=a||l)[n]??!1;if(c)for(const t in c)e[t]=c[t];return e}static getRandomRarity(e){const t=e||[{rarity:"",priceRange:[0,49],max:30},{rarity:"common",priceRange:[50,100],max:60},{rarity:"uncommon",priceRange:[101,500],max:80},{rarity:"rare",priceRange:[501,5e3],max:98.5},{rarity:"veryrare",priceRange:[5001,5e4],max:99.8},{rarity:"legendary",priceRange:[50001,1e6],max:100}],n=Math.round(99*twist.random())+1;return t.find((e=>n<=e.max))}}class ChatHelper{static async tradeChatMessage(e,t,a,s={chatOutPut:!0,verbose:!1}){if(!s.chatOutPut||!game.settings.get(n.ns,n.settings.keys.sheet.generateChatMessages))return;const r=`${t.id}-${s.type}-${e.id}`,o=this._getItemsFromLootMessage(r,s),i=this._parseMovedItems(a,s),l=this._handleExistingItems(o.items,i,s);let c=await this._renderInnerLootChatMessage(e,t,l,s);return o.id?(c._id=o.id,ChatMessage.updateDocuments([c])):(c.user=game.user.id,c.speaker={actor:t,alias:t.name},c.flags.lootsheetnpc5e.lootId=r,ChatMessage.create(c))}static async _renderInnerLootChatMessage(e,t,a,s={type:"loot",verbose:!0}){const r={templatePath:n.templatePath,colorRarity:game.settings.get(n.ns,"colorRarity"),source:e,sourceId:e.isLinked?e.data_id:e.id,destination:t,flags:"tokens"==e.collectionName?e.actor.data.flags:e.data.flags,items:a,type:s.type,actionMessage:game.i18n.format("lsnpc.chatActionMessages."+s.type,{source:e.name,destination:t.name})};return s.verbose&&console.log(`${n.ns} | ${this.name} | buildChatMessage | pre render messageData: `,r),{content:await renderTemplate(n.templatePath+"/chat/loot-chat-card.hbs",r),flags:{lootsheetnpc5e:{loot:a,lootId:`${t.id}-${s.type}-${e.id}`}}}}static _parseMovedItems(e,t={}){const n=t?.priceModifier||100;return e.map((e=>{const t=(e.item.data.data?.price||e.item.data?.price||0)*n/100,a=t*e.quantity;return{quantity:e.quantity,priceTotal:a.toFixed(2),data:{documentName:e.item.documentName,img:e.item.img,name:e.item.name,id:e.item.id,uuid:e.item.uuid,price:t.toFixed(2),rarity:e.item.data?.data?.rarity||e.item.data?.rarity||"common"}}}))}static _handleExistingItems(e,t,a={priceModifier:1,verbose:!0}){if(e)for(let n of t){let t=e.find((e=>e.data.id===n.data.id));t?t.data.name===n.data.name&&(n.quantity+=t.quantity,n.priceTotal=Number(n.data.price*n.quantity).toFixed(2),t=mergeObject(t,n)):e.push(n)}return a.verbose&&console.log(`${n.ns} | ChatHelper | handleExistingItems | existingItems: `,e),e}static _getItemsFromLootMessage(e,t={verbose:!0}){let a=game.messages.filter((t=>t.data.flags?.lootsheetnpc5e?.lootId==e)).pop(),s={id:0,items:[]};if(!a)return t.verbose&&console.log(`${n.ns} | ChatHelper | getItemsFromLootMessage | No loot message found with interactionId: ${e}`),s;const r=a?.data.timestamp??0,o=Date.now()-r,i=game.settings.get(n.ns,n.settings.keys.sheet.chatGracePeriod),l=o>1e3*i;return t.verbose&&(console.log(`${n.ns} | ChatHelper | getItemsFromLootMessage |`,a,r),console.log(`${n.ns} | ChatHelper | getItemsFromLootMessage | timeSince: ${o} | gracePeriod: ${i} | outOfGrace: ${l}`)),l||(console.log(`${n.ns} | ChatHelper | getItemsFromLootMessage | Found existing message within the grace period of interactionId: ${e}`),s={id:a.id,items:a.getFlag(n.ns,"loot")}),s}static async renderLootCurrencyMessage(e,t,a,s={}){const r=this._getCurrencyMessageData(e,t,a,s);ChatMessage.create({user:game.user._id,speaker:{actor:t,alias:t.name},content:await renderTemplate(n.templatePath+"/chat/currency-chat-card.hbs",r),flags:{lootsheetnpc5e:{type:s.type,lootedCurrency:"lootCurrency"===s.type?a:a.shares}}})}static _getCurrencyMessageData(e,t,n,a={}){let s={source:e,destination:t,flags:"tokens"==e.collectionName?e.actor.data.flags:e.data.flags,actionMessage:game.i18n.format(`lsnpc.chatActionMessages.${a.type}`,{source:e.name,destination:t.name}),movedFunds:!1,shares:!1,receivers:!1};return"lootCurrency"===a.type?s.movedFunds=n:(s.receivers=n.receivers,s.shares=n.shares),s}}class CurrencyHelper{static blankCurrency(){let e={};for(const t in this.getRates())e[t]=0;return e}static async generateCurrency(e){let t={};if(e){const a=e.split(",");for(const e of a){const a=/(.*)\[(.*?)\]/g.exec(e);if(!a||a.length<3){ui.notifications.warn(n.ns+` | Currency loot field contain wrong formatting, currencies need to be define as "diceFormula[currencyType]" => "1d100[gp]" but was ${e}`);continue}const s=a[1],r=a[2],o=await CurrencyHelper.tryRoll(s);t[r]=(t[r]||0)+o}}return t}static async addCurrenciesToActor(e,t){const a=game.settings.get(n.ns,n.settings.keys.lootseeder.adjustCurrencyWithCR);let s=this.blankCurrency();t=t||game.settings.get(n.ns,"lootCurrencyDefault"),e.data.data.currency&&(s=duplicate(e.data.data.currency));for(let n in t)if(s.hasOwnProperty(n))if(a){let a=game.actors.find((t=>t._id===e.data.actorId)).data.data.details.cr||.25;s[n]=Number(s[n]||0)+Number(Math.ceil(a*t[n]))}else s[n]=Number(s[n]||0)+Number(t[n]);await e.update({"data.currency":s})}static async tryRoll(e){try{return(await new Roll(e).roll({async:!0})).total||1}catch(e){return console.error(n.ns+" | currencyHelper :",e),1}}static getFundsAsPlatinum(e){console.warn(n.ns,"| getFundsAsPlatinum | funds |",e);let t=e.pp;for(let n in e)t+="pp"!==n?e[n]*CurrencyHelper.getRates()[n].pp.rate:e[n];return t}static exchange(e,t,n,a=[]){let s=e,r=CurrencyHelper.getRates();for(const e in r)if(!a.length||a.includes(e))if(t===e)n[t]+=s;else{const a=Math.floor(CurrencyHelper._calculateCoin(s,e,t));s=CurrencyHelper._calculateModCoin(s,e,t),n[e]+=a}return n}static getSharesAndRemainder(e,t){let n={},a={};for(let s in e)n[s]=Math.floor(e[s]/t),a[s]=n[s]%t;return{currencyShares:n,remainder:a}}static getSplitByObservers(e,t=1){let n=duplicate(e);if(t<=1)return n;for(let e in n){let a=n[e]??0;n[e]=Math.floor(a/t)}return n}static cleanCurrency(e){let t={};for(const n in e)e[n]>0?t[n]=Number(e[n]):t[n]=0;return t}static getCostObject(e){const t=CurrencyHelper.getRates();let n={};for(const a in t){const s=t[a].gp;Number.isInteger(e*s.rate)&&(n[a]=Math.floor(e*s.rate))}return n}static _calculateCoin(e,t,n){return e*CurrencyHelper.getRates()[n][t].rate}static _calculateModCoin(e,t,n){const a=CurrencyHelper.getRates()[n][t].label;return e%CurrencyHelper.getDenominatorFromRate(a)}static getDenominatorFromRate(e){return e.includes("/")?parseInt(e.split("/")[1]):1}static getRates(){return{pp:{cp:{rate:1e3,label:"1000"},sp:{rate:100,label:"100"},ep:{rate:20,label:"20"},gp:{rate:10,label:"10"},pp:{rate:1,label:"1"}},gp:{cp:{rate:100,label:"100"},sp:{rate:10,label:"10"},ep:{rate:2,label:"2"},gp:{rate:1,label:"1"},pp:{rate:.1,label:"1/10"}},ep:{cp:{rate:50,label:"50"},sp:{rate:5,label:"5"},ep:{rate:1,label:"1"},gp:{rate:.5,label:"1/2"},pp:{rate:.05,label:"1/20"}},sp:{cp:{rate:10,label:"10"},sp:{rate:1,label:"1"},ep:{rate:.2,label:"1/5"},gp:{rate:.1,label:"1/10"},pp:{rate:.01,label:"1/100"}},cp:{cp:{rate:1,label:"1"},sp:{rate:.1,label:"1/10"},ep:{rate:.02,label:"1/50"},gp:{rate:.01,label:"1/100"},pp:{rate:.001,label:"1/1000"}}}}}
/**
 * @Module LootsheetNPC5e.Helpers.TradeHelper
 * @name TradeHelper
 *
 * @classdec Static helper methods for trading
 *
 * @since 3.4.5.3
 * @author Daniel Böttner <daniel@est-in.eu>
 * @license MIT
 */class TradeHelper{static async tradeItems(e,t,a,s={}){for(let r in a)!a[r].length>0||(s.type=r,s.priceModifier=e.getFlag(n.ns,n.flags.priceModifier)||{buy:100,sell:100},this._handleTradyByType(a,t,e,s))}static async lootItems(e,t,n,a){let s=await ItemHelper.moveItemsToDestination(e,t,n);ChatHelper.tradeChatMessage(e,t,s,a)}static async lootAllItems(e,t,n={}){const a=ItemHelper.getLootableItems(e.items).map((e=>({id:e.id,data:{data:{quantity:e.data.data.quantity}}})));this.lootItems(e,t,a,n),this.lootCurrency(e,t,n)}static async transaction(e,t,a,s,r={chatOutPut:!0}){const o=e.getEmbeddedDocument("Item",a),i=e.getFlag(n.ns,n.flags.priceModifier)||{buy:100,sell:100};if(r.priceModifier="buy"===r.type?i.buy:i.sell,!o)return ItemHelper.errorMessageToActor(e,`${e.name} doesn't posses this item anymore.`);let l=!1;s=o.data.data.quantity<s?parseInt(o.data.data.quantity):parseInt(s);let c=o.data.data.price,u=this._getItemPriceInGold(c,i.sell,s);if(!await this._updateFunds(e,t,u))return!1;l=await ItemHelper.moveItemsToDestination(e,t,[{id:a,data:{data:{quantity:s}}}]),r.type="buy",ChatHelper.tradeChatMessage(e,t,l,r)}static async distributeCurrency(e,t,a={verbose:!0}){const s=PermissionHelper.getEligableActors(e),r=CurrencyHelper.cleanCurrency(e.data.data.currency),o=CurrencyHelper.getSharesAndRemainder(r,s.length);let i={shares:o.currencyShares,receivers:[]};if(a.verbose){let t=`${n.ns} | distributeCurrency |`;console.log(t+" actorData:",e.data),console.log(t+" players:",game.users.players),console.log(t+" observers:",s),console.log(t+" currencyShares:",o.currencyShares),console.log(t+" npcRemainingCurrency",o.remainder)}if(0!==s.length){for(let e of game.users.players){let t=e.character;if(!t||!s.includes(e.id))continue;let n=duplicate(t.data.data.currency),a=duplicate(t.data.data.currency);i.receivers.push(t.data.name),console.log(i);for(let e in n)a[e]=parseInt(n[e]||0)+o.currencyShares[e];await t.update({"data.currency":a})}e.update({"data.currency":{cp:0,ep:0,gp:0,pp:0,sp:0}}),a.chatOutPut&&ChatHelper.renderLootCurrencyMessage(e,t,i,a)}}static async lootCurrency(e,t,n={chatOutPut:!0}){const a=e.data;let s=duplicate(a.data.currency),r=duplicate(t.data.data.currency),o=duplicate(t.data.data.currency),i={};for(let e in r)null!=s[e]&&(o[e]=parseInt(r[e]||0)+parseInt(s[e]),i[e]=s[e]);t.update({"data.currency":o}),e.update({"data.currency":{cp:0,ep:0,gp:0,pp:0,sp:0}}),n.chatOutPut&&ChatHelper.renderLootCurrencyMessage(e,t,i,n)}static async _handleTradyByType(e,t,n,a){let s={sell:[],buy:[],give:[],loot:[]};const r=a.type,o=["sell","give"].includes(r),i=o?t:n,l=o?n:t,c=a.priceModifier["sell"===r?"buy":"sell"];a.priceModifier=c;const u=this._prepareTrade(i,e[r],a);if(!await this.moneyExchange(i,l,r,u.tradeSum,a))return!1;s[r]=await ItemHelper.moveItemsToDestination(i,l,u.items),ChatHelper.tradeChatMessage(n,t,s[r],a)}static async moneyExchange(e,t,a,s=0,r={}){let o=!0;return["loot","give"].includes(a)||(console.warn(n.ns,s,r.priceModifier),o=await this._updateFunds(e,t,s,r)),o}static _prepareTrade(e,t,a={}){const s=a.priceModifier.sell||100;let r=0;for(const[a,o]of t.entries()){if(!e.items.find((e=>e.id==o.id))){console.log(`${n.ns} | _prepareTrade | Removed item "${o.name}" (id: ${o.id}) from trade. Item not found in inventory of the source actor.`),delete t[a];continue}const i=o.data.data.price;r+=this._getItemPriceInGold(i,s,o.data.data.quantity),console.info(`${n.ns} | ${this._prepareTrade.name} | tradeSum updated to: `,r)}return{items:t,tradeSum:r}}static _getItemPriceInGold(e,t,a=1){return console.warn(`${n.ns} | 'getItemPriceInGold' | priceModifier: ${t}`),parseFloat((e*t/100*a).toFixed(5))}static _getPriceModifier(e){let t={buy:100,sell:100,give:100,loot:100};"object"==typeof e.getFlag(n.ns,n.flags.priceModifier)?t=e.getFlag(n.ns,n.flags.priceModifier):t.sell=e.getFlag(n.ns,n.flags.priceModifier)||100;for(let e in t)t[e]=parseFloat(t[e]).toPrecision(2);return t}static async _updateFunds(e,t,n,a={}){const s=CurrencyHelper.getRates(),r={pp:CurrencyHelper._calculateCoin(n,"pp","gp"),gp:n,ep:CurrencyHelper._calculateCoin(n,"ep","gp"),sp:CurrencyHelper._calculateCoin(n,"sp","gp"),cp:CurrencyHelper._calculateCoin(n,"cp","gp")};let o=CurrencyHelper.cleanCurrency(t.data.data.currency),i=CurrencyHelper.cleanCurrency(e.data.data.currency),l={buyer:this._getFundsAsPlatinum(o,s),seller:this._getFundsAsPlatinum(i,s)};if(r.pp>l.buyer)return ui.notifications.error(t.name+" does not have enough funds to buy this item."),ItemHelper.errorMessageToActor(t,t.name+` doesn't have enough funds to purchase an item for ${r.gp}gp.`),!1;let c=this._getUpdatedFunds(o,i,r,s,l);return await e.update({data:{currency:c.sellerFunds}}),await t.update({data:{currency:c.buyerFunds}}),!0}static _getUpdatedFunds(e,t,a,s,r){return game.settings.get(n.ns,"convertCurrency")?(r.buyer-=a.pp,r.seller+=a.pp,e=this._updateConvertCurrency(e,r.buyer),t=this._updateConvertCurrency(t,r.seller)):(e.gp>=a.gp?(e.gp-=a.gp,t.gp+=a.gp):(e.pp-=a.pp,t.pp+=a.pp),console.warn(n.ns,"before smoothen",e),e=this._smoothenFunds(e,s),console.warn(n.ns,"after smoothen",e),t=this._smoothenFunds(t,s)),{buyerFunds:e,sellerFunds:t}}static _getFundsAsPlatinum(e){console.warn(n.ns,"getFundsAsPlatinum",e);const t="pp";let a=e.pp;return a+=CurrencyHelper._calculateCoin(e.gp,t,"gp"),a+=CurrencyHelper._calculateCoin(e.ep,t,"ep"),a+=CurrencyHelper._calculateCoin(e.sp,t,"sp"),a+=CurrencyHelper._calculateCoin(e.cp,t,"cp"),console.log(`${n.ns} | _getFundsAsPlatinum | fundsAsPlatinum: `,a),a||0}static _updateConvertCurrency(e,t){for(let t in e)e[t]=0;return e.pp=t,e}static _smoothenFunds(e){const t={pp:"gp",gp:"ep",ep:"sp",sp:"cp"};return["pp","gp","ep","sp","cp"].forEach((n=>{let a=parseFloat(e[n].toFixed(5)),s=parseFloat((a%1).toFixed(5)),r=~~Math.abs(a);a<0?(e[t[n]]+=CurrencyHelper._calculateCoin(a,t[n],n),e[n]=0):0!=s&&(e[t[n]]+=CurrencyHelper._calculateCoin(e[n],t[n],n),e[n]=r)})),e}_isInt(e){return Number(e)===e&&e%1==0}_isFloat(e){return Number(e)===e&&e%1!=0}}class SocketListener{static async handleRequest(e){let t=game.actors.get(e.triggerActorId),a=e.action||e;if(console.log(`${n.ns} | handleRequest | data`,e),game.user.isGM&&!t&&(t={name:game.user.name,data:{img:game.user.avatar}},console.log(t)),"error"===a){const t=e.message||" | socketListener | InvalidData ";return ui.notifications.error(n.ns+" | "+t),void console.log(`${n.ns} | handleRequest | Transaction Error: `,e)}if("sheetUpdate"===a)return this._handleRerender(e.tokenUuid);if(!t&&!game.user.isGM)return ui.notifications.error(`${n.ns} | handleRequest | Exception | Could not get triggering user character. See console. (F12)`),void console.error(`${n.ns} | handleRequest | Exception | Could not get triggering game.user`,e);if(game.user.isGM&&e.processorId===game.user.id){const s=await fromUuid(e.tokenUuid);if(!s)return ui.notifications.error(n.ns+" | socketListener | Exception | Could not find a token with the uuid: "+e.tokenUuid);const r={quantity:e.quantity,verbose:e?.verbose||!1,chatOutPut:!0};switch(a){case"buyItem":r.type="sell",await TradeHelper.transaction(s.actor,t,e.targetItemId,e.quantity,r);break;case"tradeItems":await TradeHelper.tradeItems(s.actor,t,e.trades,r);break;case"lootAll":r.type="loot",await TradeHelper.lootAllItems(s.actor,t);break;case"lootItem":let o=[{id:e.targetItemId,data:{data:{quantity:e.quantity}}}];r.type="loot",await TradeHelper.lootItems(s.actor,t,o,r);break;case"distributeCurrency":r.type="distributeCurrency",await TradeHelper.distributeCurrency(s.actor,t,r);break;case"lootCurrency":r.type="lootCurrency",await TradeHelper.lootCurrency(s.actor,t,r);break;case"sheetUpdate":return this._handleRerender(e.tokenUuid);default:console.warn(`${n.ns} | socketListener | Info | listend to an unhandled action: ${a}`)}}}static async _handleRerender(e){const t=await fromUuid(e);if(!t?.actor?._sheet)return;const a=t.actor.sheet,s=a?a?._state:0;console.log(`${n.ns} | token Helper | handleRerender | Rerendering attempt of the actor sheet for token: ${t.name}`),(a.rendered||s>0&&!game.user.isGM)&&(await a.close(),console.log(`${n.ns} | token Helper | handleRerender | Sanity check - This state should be false: ${a.rendered}`),t.actor._sheet=null,delete t.actor.apps[a.appId],await a.render(!0,t.actor.options),console.log(`${n.ns} | token Helper | handleRerender | Sanity check - This state should be true: ${a.rendered}`))}}class LootSheetNPC5eHelper{static async changeSheetType(e,t){e.preventDefault();const a=e.currentTarget.selectedIndex,s=e.currentTarget[a].value;await t.setFlag(n.ns,"lootsheettype",s),console.log(n.ns+" | "+game.user.name+" ("+game.user.id+") updated the sheet type for ",n.ns+" event | "+e),t?.token&&await this.sendActionToSocket(t.token,e),t.sheet.render(!0)}static getLootableItems(e,t){return ItemHelper.getLootableItems(e,t)}static async sendActionToSocket(e,t){if(t.preventDefault(),null===e)return ui.notifications.error("No target given to send action to socket");const a=PermissionHelper.getTargetGM(),s=t.currentTarget.dataset.action,r={...t.currentTarget.dataset,...t.currentTarget.closest(".item")?.dataset},o=r?.itemId,i={acceptLabel:"Quantity"},l=parseInt(r?.maxQuantity),c=t.currentTarget.closest("section")?.querySelectorAll("ul")||null;let u="true"===r?.getAll?l:1,d=t.currentTarget.closest(".tradegrid")?this._handleTradeStage(c):null;if(!game.user?.character?.id&&"sheetUpdate"!=s&&!game.user.isGM)return ui.notifications.info("You need to assign an actor to your user before you can do this.");const p={action:s,triggerActorId:game.user.character?.id||null,tokenUuid:e.uuid,processorId:a.id,targetItemId:o||null,quantity:u,trades:d};if(s!==n.settings.keys.sheet.sheetUpdate)if(t.shiftKey){i.max=l;new QuantityDialog((e=>{p.quantity=e,this.emitToSocketOrCallMethod(p)}),i).render(!0)}else await this.emitToSocketOrCallMethod(p);else await this.emitToSocketOrCallMethod(p)}static _handleTradeStage(e){const t={buy:[],sell:[],give:[],loot:[]};if(e)for(let n of e){const e=n.parentNode.dataset.eventTarget;if(0!=n.children.length&&e)for(let a of n.querySelectorAll(".item")){const n={id:a.dataset.id,data:{id:a.dataset.id,data:{quantity:parseInt(a.dataset.quantity),price:parseFloat(a.dataset.price)}}};t[e].push(n)}}return t}static async emitToSocketOrCallMethod(e){game.user.isGM?await SocketListener.handleRequest(e):game.socket.emit(n.socket,e)}static sortAndGroupItems(e){let t={weapons:{label:"Weapons",items:[],type:"weapon"},equipment:{label:"Equipment",items:[],type:"equipment"},consumables:{label:"Consumables",items:[],type:"consumable"},tools:{label:"Tools",items:[],type:"tool"},containers:{label:"Containers",items:[],type:"container"},loot:{label:"Loot",items:[],type:"loot"},misc:{label:"Feat",items:[],type:"feat"}};e=e.sort(((e,t)=>e.name.localeCompare(t.name)));for(let n of e)n.img=n.img||"icons/svg/item-bag.svg",n.type&&hasProperty(t,n.type+"s")?t[n.type+"s"].items.push(n):["container","backpack"].includes(n.type)?t.containers.items.push(n):hasProperty(t,n.type)?t[n.type].items.push(n):t.misc.items.push(n);return t}}class TableHelper{static async getGameWorldRolltables(){const e=game.packs.filter((e=>"RollTable"===e.documentName));let t={};game.tables.size>0&&(t.World=[]);for(const e of game.tables)t.World.push({name:e.name,uuid:e.uuid});for(const n of e){const e=await n.getIndex({fields:["name","data.uuid"]}),a=`Compendium.${n.collection}.`;t[n.metadata.label]=[];for(let s of e)t[n.metadata.label].push({name:s.name,uuid:a+s._id})}return t}static async getRolltable(e){const[t,n,a,s]=e.split(".");return s?await game.packs.get(n+"."+a).getDocument(s):game.tables.get(n)}static async _rollSubTables(e,t=0){if(e instanceof RollTable){const n=await e.roll();if("Item"===n.results[t].data.collection)e=game.items.get(n.results[t].data.resultId);else{let a=game.packs.get(n.results[t].data.collection);e=await a.getDocument(n.results[t].data.resultId)}e instanceof RollTable&&(e=await TableHelper._rollSubTables(e,t))}return e}static getLinkedRolltableByCreatureType(e){if(!e||0===e.length)return!1;try{if((Object.keys(CONFIG[game.system.id.toUpperCase()]?.creatureTypes)??[]).includes(e)){const t=`creaturetype_default_${e}_table`,a=game.settings.get(n.ns,t);if(a&&0!=a)return a}}catch(e){return console.error(e),!1}return!1}}var a="top",s="bottom",r="right",o="left",i=[a,s,r,o],l=i.reduce((function(e,t){return e.concat([t+"-start",t+"-end"])}),[]),c=[].concat(i,["auto"]).reduce((function(e,t){return e.concat([t,t+"-start",t+"-end"])}),[]),u=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function getNodeName(e){return e?(e.nodeName||"").toLowerCase():null}function getWindow(e){if(null==e)return window;if("[object Window]"!==e.toString()){var t=e.ownerDocument;return t&&t.defaultView||window}return e}function isElement$1(e){return e instanceof getWindow(e).Element||e instanceof Element}function isHTMLElement(e){return e instanceof getWindow(e).HTMLElement||e instanceof HTMLElement}function isShadowRoot(e){return"undefined"!=typeof ShadowRoot&&(e instanceof getWindow(e).ShadowRoot||e instanceof ShadowRoot)}var d={name:"applyStyles",enabled:!0,phase:"write",fn:function applyStyles(e){var t=e.state;Object.keys(t.elements).forEach((function(e){var n=t.styles[e]||{},a=t.attributes[e]||{},s=t.elements[e];isHTMLElement(s)&&getNodeName(s)&&(Object.assign(s.style,n),Object.keys(a).forEach((function(e){var t=a[e];!1===t?s.removeAttribute(e):s.setAttribute(e,!0===t?"":t)})))}))},effect:function effect$2(e){var t=e.state,n={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,n.popper),t.styles=n,t.elements.arrow&&Object.assign(t.elements.arrow.style,n.arrow),function(){Object.keys(t.elements).forEach((function(e){var a=t.elements[e],s=t.attributes[e]||{},r=Object.keys(t.styles.hasOwnProperty(e)?t.styles[e]:n[e]).reduce((function(e,t){return e[t]="",e}),{});isHTMLElement(a)&&getNodeName(a)&&(Object.assign(a.style,r),Object.keys(s).forEach((function(e){a.removeAttribute(e)})))}))}},requires:["computeStyles"]};function getBasePlacement$1(e){return e.split("-")[0]}var p=Math.max,g=Math.min,m=Math.round;function getBoundingClientRect(e,t){void 0===t&&(t=!1);var n=e.getBoundingClientRect(),a=1,s=1;if(isHTMLElement(e)&&t){var r=e.offsetHeight,o=e.offsetWidth;o>0&&(a=m(n.width)/o||1),r>0&&(s=m(n.height)/r||1)}return{width:n.width/a,height:n.height/s,top:n.top/s,right:n.right/a,bottom:n.bottom/s,left:n.left/a,x:n.left/a,y:n.top/s}}function getLayoutRect(e){var t=getBoundingClientRect(e),n=e.offsetWidth,a=e.offsetHeight;return Math.abs(t.width-n)<=1&&(n=t.width),Math.abs(t.height-a)<=1&&(a=t.height),{x:e.offsetLeft,y:e.offsetTop,width:n,height:a}}function contains(e,t){var n=t.getRootNode&&t.getRootNode();if(e.contains(t))return!0;if(n&&isShadowRoot(n)){var a=t;do{if(a&&e.isSameNode(a))return!0;a=a.parentNode||a.host}while(a)}return!1}function getComputedStyle(e){return getWindow(e).getComputedStyle(e)}function isTableElement(e){return["table","td","th"].indexOf(getNodeName(e))>=0}function getDocumentElement(e){return((isElement$1(e)?e.ownerDocument:e.document)||window.document).documentElement}function getParentNode(e){return"html"===getNodeName(e)?e:e.assignedSlot||e.parentNode||(isShadowRoot(e)?e.host:null)||getDocumentElement(e)}function getTrueOffsetParent(e){return isHTMLElement(e)&&"fixed"!==getComputedStyle(e).position?e.offsetParent:null}function getOffsetParent(e){for(var t=getWindow(e),n=getTrueOffsetParent(e);n&&isTableElement(n)&&"static"===getComputedStyle(n).position;)n=getTrueOffsetParent(n);return n&&("html"===getNodeName(n)||"body"===getNodeName(n)&&"static"===getComputedStyle(n).position)?t:n||function getContainingBlock(e){var t=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");if(-1!==navigator.userAgent.indexOf("Trident")&&isHTMLElement(e)&&"fixed"===getComputedStyle(e).position)return null;for(var n=getParentNode(e);isHTMLElement(n)&&["html","body"].indexOf(getNodeName(n))<0;){var a=getComputedStyle(n);if("none"!==a.transform||"none"!==a.perspective||"paint"===a.contain||-1!==["transform","perspective"].indexOf(a.willChange)||t&&"filter"===a.willChange||t&&a.filter&&"none"!==a.filter)return n;n=n.parentNode}return null}(e)||t}function getMainAxisFromPlacement(e){return["top","bottom"].indexOf(e)>=0?"x":"y"}function within(e,t,n){return p(e,g(t,n))}function mergePaddingObject(e){return Object.assign({},{top:0,right:0,bottom:0,left:0},e)}function expandToHashMap(e,t){return t.reduce((function(t,n){return t[n]=e,t}),{})}var f={name:"arrow",enabled:!0,phase:"main",fn:function arrow(e){var t,n=e.state,l=e.name,c=e.options,u=n.elements.arrow,d=n.modifiersData.popperOffsets,p=getBasePlacement$1(n.placement),g=getMainAxisFromPlacement(p),m=[o,r].indexOf(p)>=0?"height":"width";if(u&&d){var f=function toPaddingObject(e,t){return mergePaddingObject("number"!=typeof(e="function"==typeof e?e(Object.assign({},t.rects,{placement:t.placement})):e)?e:expandToHashMap(e,i))}(c.padding,n),h=getLayoutRect(u),y="y"===g?a:o,b="y"===g?s:r,v=n.rects.reference[m]+n.rects.reference[g]-d[g]-n.rects.popper[m],w=d[g]-n.rects.reference[g],k=getOffsetParent(u),C=k?"y"===g?k.clientHeight||0:k.clientWidth||0:0,T=v/2-w/2,S=f[y],P=C-h[m]-f[b],I=C/2-h[m]/2+T,O=within(S,I,P),A=g;n.modifiersData[l]=((t={})[A]=O,t.centerOffset=O-I,t)}},effect:function effect$1(e){var t=e.state,n=e.options.element,a=void 0===n?"[data-popper-arrow]":n;null!=a&&("string"!=typeof a||(a=t.elements.popper.querySelector(a)))&&contains(t.elements.popper,a)&&(t.elements.arrow=a)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function getVariation(e){return e.split("-")[1]}var h={top:"auto",right:"auto",bottom:"auto",left:"auto"};function mapToStyles(e){var t,n=e.popper,i=e.popperRect,l=e.placement,c=e.variation,u=e.offsets,d=e.position,p=e.gpuAcceleration,g=e.adaptive,f=e.roundOffsets,y=e.isFixed,b=u.x,v=void 0===b?0:b,w=u.y,k=void 0===w?0:w,C="function"==typeof f?f({x:v,y:k}):{x:v,y:k};v=C.x,k=C.y;var T=u.hasOwnProperty("x"),S=u.hasOwnProperty("y"),P=o,I=a,O=window;if(g){var A=getOffsetParent(n),E="clientHeight",L="clientWidth";if(A===getWindow(n)&&"static"!==getComputedStyle(A=getDocumentElement(n)).position&&"absolute"===d&&(E="scrollHeight",L="scrollWidth"),A=A,l===a||(l===o||l===r)&&"end"===c)I=s,k-=(y&&O.visualViewport?O.visualViewport.height:A[E])-i.height,k*=p?1:-1;if(l===o||(l===a||l===s)&&"end"===c)P=r,v-=(y&&O.visualViewport?O.visualViewport.width:A[L])-i.width,v*=p?1:-1}var _,R=Object.assign({position:d},g&&h),x=!0===f?function roundOffsetsByDPR(e){var t=e.x,n=e.y,a=window.devicePixelRatio||1;return{x:m(t*a)/a||0,y:m(n*a)/a||0}}({x:v,y:k}):{x:v,y:k};return v=x.x,k=x.y,p?Object.assign({},R,((_={})[I]=S?"0":"",_[P]=T?"0":"",_.transform=(O.devicePixelRatio||1)<=1?"translate("+v+"px, "+k+"px)":"translate3d("+v+"px, "+k+"px, 0)",_)):Object.assign({},R,((t={})[I]=S?k+"px":"",t[P]=T?v+"px":"",t.transform="",t))}var y={passive:!0};var b={left:"right",right:"left",bottom:"top",top:"bottom"};function getOppositePlacement(e){return e.replace(/left|right|bottom|top/g,(function(e){return b[e]}))}var v={start:"end",end:"start"};function getOppositeVariationPlacement(e){return e.replace(/start|end/g,(function(e){return v[e]}))}function getWindowScroll(e){var t=getWindow(e);return{scrollLeft:t.pageXOffset,scrollTop:t.pageYOffset}}function getWindowScrollBarX(e){return getBoundingClientRect(getDocumentElement(e)).left+getWindowScroll(e).scrollLeft}function isScrollParent(e){var t=getComputedStyle(e),n=t.overflow,a=t.overflowX,s=t.overflowY;return/auto|scroll|overlay|hidden/.test(n+s+a)}function getScrollParent(e){return["html","body","#document"].indexOf(getNodeName(e))>=0?e.ownerDocument.body:isHTMLElement(e)&&isScrollParent(e)?e:getScrollParent(getParentNode(e))}function listScrollParents(e,t){var n;void 0===t&&(t=[]);var a=getScrollParent(e),s=a===(null==(n=e.ownerDocument)?void 0:n.body),r=getWindow(a),o=s?[r].concat(r.visualViewport||[],isScrollParent(a)?a:[]):a,i=t.concat(o);return s?i:i.concat(listScrollParents(getParentNode(o)))}function rectToClientRect(e){return Object.assign({},e,{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height})}function getClientRectFromMixedType(e,t){return"viewport"===t?rectToClientRect(function getViewportRect(e){var t=getWindow(e),n=getDocumentElement(e),a=t.visualViewport,s=n.clientWidth,r=n.clientHeight,o=0,i=0;return a&&(s=a.width,r=a.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(o=a.offsetLeft,i=a.offsetTop)),{width:s,height:r,x:o+getWindowScrollBarX(e),y:i}}(e)):isElement$1(t)?function getInnerBoundingClientRect(e){var t=getBoundingClientRect(e);return t.top=t.top+e.clientTop,t.left=t.left+e.clientLeft,t.bottom=t.top+e.clientHeight,t.right=t.left+e.clientWidth,t.width=e.clientWidth,t.height=e.clientHeight,t.x=t.left,t.y=t.top,t}(t):rectToClientRect(function getDocumentRect(e){var t,n=getDocumentElement(e),a=getWindowScroll(e),s=null==(t=e.ownerDocument)?void 0:t.body,r=p(n.scrollWidth,n.clientWidth,s?s.scrollWidth:0,s?s.clientWidth:0),o=p(n.scrollHeight,n.clientHeight,s?s.scrollHeight:0,s?s.clientHeight:0),i=-a.scrollLeft+getWindowScrollBarX(e),l=-a.scrollTop;return"rtl"===getComputedStyle(s||n).direction&&(i+=p(n.clientWidth,s?s.clientWidth:0)-r),{width:r,height:o,x:i,y:l}}(getDocumentElement(e)))}function getClippingRect(e,t,n){var a="clippingParents"===t?function getClippingParents(e){var t=listScrollParents(getParentNode(e)),n=["absolute","fixed"].indexOf(getComputedStyle(e).position)>=0&&isHTMLElement(e)?getOffsetParent(e):e;return isElement$1(n)?t.filter((function(e){return isElement$1(e)&&contains(e,n)&&"body"!==getNodeName(e)})):[]}(e):[].concat(t),s=[].concat(a,[n]),r=s[0],o=s.reduce((function(t,n){var a=getClientRectFromMixedType(e,n);return t.top=p(a.top,t.top),t.right=g(a.right,t.right),t.bottom=g(a.bottom,t.bottom),t.left=p(a.left,t.left),t}),getClientRectFromMixedType(e,r));return o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}function computeOffsets(e){var t,n=e.reference,i=e.element,l=e.placement,c=l?getBasePlacement$1(l):null,u=l?getVariation(l):null,d=n.x+n.width/2-i.width/2,p=n.y+n.height/2-i.height/2;switch(c){case a:t={x:d,y:n.y-i.height};break;case s:t={x:d,y:n.y+n.height};break;case r:t={x:n.x+n.width,y:p};break;case o:t={x:n.x-i.width,y:p};break;default:t={x:n.x,y:n.y}}var g=c?getMainAxisFromPlacement(c):null;if(null!=g){var m="y"===g?"height":"width";switch(u){case"start":t[g]=t[g]-(n[m]/2-i[m]/2);break;case"end":t[g]=t[g]+(n[m]/2-i[m]/2)}}return t}function detectOverflow(e,t){void 0===t&&(t={});var n=t,o=n.placement,l=void 0===o?e.placement:o,c=n.boundary,u=void 0===c?"clippingParents":c,d=n.rootBoundary,p=void 0===d?"viewport":d,g=n.elementContext,m=void 0===g?"popper":g,f=n.altBoundary,h=void 0!==f&&f,y=n.padding,b=void 0===y?0:y,v=mergePaddingObject("number"!=typeof b?b:expandToHashMap(b,i)),w="popper"===m?"reference":"popper",k=e.rects.popper,C=e.elements[h?w:m],T=getClippingRect(isElement$1(C)?C:C.contextElement||getDocumentElement(e.elements.popper),u,p),S=getBoundingClientRect(e.elements.reference),P=computeOffsets({reference:S,element:k,strategy:"absolute",placement:l}),I=rectToClientRect(Object.assign({},k,P)),O="popper"===m?I:S,A={top:T.top-O.top+v.top,bottom:O.bottom-T.bottom+v.bottom,left:T.left-O.left+v.left,right:O.right-T.right+v.right},E=e.modifiersData.offset;if("popper"===m&&E){var L=E[l];Object.keys(A).forEach((function(e){var t=[r,s].indexOf(e)>=0?1:-1,n=[a,s].indexOf(e)>=0?"y":"x";A[e]+=L[n]*t}))}return A}function computeAutoPlacement(e,t){void 0===t&&(t={});var n=t,a=n.placement,s=n.boundary,r=n.rootBoundary,o=n.padding,u=n.flipVariations,d=n.allowedAutoPlacements,p=void 0===d?c:d,g=getVariation(a),m=g?u?l:l.filter((function(e){return getVariation(e)===g})):i,f=m.filter((function(e){return p.indexOf(e)>=0}));0===f.length&&(f=m);var h=f.reduce((function(t,n){return t[n]=detectOverflow(e,{placement:n,boundary:s,rootBoundary:r,padding:o})[getBasePlacement$1(n)],t}),{});return Object.keys(h).sort((function(e,t){return h[e]-h[t]}))}var w={name:"flip",enabled:!0,phase:"main",fn:function flip(e){var t=e.state,n=e.options,i=e.name;if(!t.modifiersData[i]._skip){for(var l=n.mainAxis,c=void 0===l||l,u=n.altAxis,d=void 0===u||u,p=n.fallbackPlacements,g=n.padding,m=n.boundary,f=n.rootBoundary,h=n.altBoundary,y=n.flipVariations,b=void 0===y||y,v=n.allowedAutoPlacements,w=t.options.placement,k=getBasePlacement$1(w),C=p||(k===w||!b?[getOppositePlacement(w)]:function getExpandedFallbackPlacements(e){if("auto"===getBasePlacement$1(e))return[];var t=getOppositePlacement(e);return[getOppositeVariationPlacement(e),t,getOppositeVariationPlacement(t)]}(w)),T=[w].concat(C).reduce((function(e,n){return e.concat("auto"===getBasePlacement$1(n)?computeAutoPlacement(t,{placement:n,boundary:m,rootBoundary:f,padding:g,flipVariations:b,allowedAutoPlacements:v}):n)}),[]),S=t.rects.reference,P=t.rects.popper,I=new Map,O=!0,A=T[0],E=0;E<T.length;E++){var L=T[E],_=getBasePlacement$1(L),R="start"===getVariation(L),x=[a,s].indexOf(_)>=0,M=x?"width":"height",D=detectOverflow(t,{placement:L,boundary:m,rootBoundary:f,altBoundary:h,padding:g}),H=x?R?r:o:R?s:a;S[M]>P[M]&&(H=getOppositePlacement(H));var N=getOppositePlacement(H),F=[];if(c&&F.push(D[_]<=0),d&&F.push(D[H]<=0,D[N]<=0),F.every((function(e){return e}))){A=L,O=!1;break}I.set(L,F)}if(O)for(var $=function _loop(e){var t=T.find((function(t){var n=I.get(t);if(n)return n.slice(0,e).every((function(e){return e}))}));if(t)return A=t,"break"},B=b?3:1;B>0;B--){if("break"===$(B))break}t.placement!==A&&(t.modifiersData[i]._skip=!0,t.placement=A,t.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function getSideOffsets(e,t,n){return void 0===n&&(n={x:0,y:0}),{top:e.top-t.height-n.y,right:e.right-t.width+n.x,bottom:e.bottom-t.height+n.y,left:e.left-t.width-n.x}}function isAnySideFullyClipped(e){return[a,r,s,o].some((function(t){return e[t]>=0}))}var k={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function offset(e){var t=e.state,n=e.options,s=e.name,i=n.offset,l=void 0===i?[0,0]:i,u=c.reduce((function(e,n){return e[n]=function distanceAndSkiddingToXY(e,t,n){var s=getBasePlacement$1(e),i=[o,a].indexOf(s)>=0?-1:1,l="function"==typeof n?n(Object.assign({},t,{placement:e})):n,c=l[0],u=l[1];return c=c||0,u=(u||0)*i,[o,r].indexOf(s)>=0?{x:u,y:c}:{x:c,y:u}}(n,t.rects,l),e}),{}),d=u[t.placement],p=d.x,g=d.y;null!=t.modifiersData.popperOffsets&&(t.modifiersData.popperOffsets.x+=p,t.modifiersData.popperOffsets.y+=g),t.modifiersData[s]=u}};var C={name:"preventOverflow",enabled:!0,phase:"main",fn:function preventOverflow(e){var t=e.state,n=e.options,i=e.name,l=n.mainAxis,c=void 0===l||l,u=n.altAxis,d=void 0!==u&&u,m=n.boundary,f=n.rootBoundary,h=n.altBoundary,y=n.padding,b=n.tether,v=void 0===b||b,w=n.tetherOffset,k=void 0===w?0:w,C=detectOverflow(t,{boundary:m,rootBoundary:f,padding:y,altBoundary:h}),T=getBasePlacement$1(t.placement),S=getVariation(t.placement),P=!S,I=getMainAxisFromPlacement(T),O=function getAltAxis(e){return"x"===e?"y":"x"}(I),A=t.modifiersData.popperOffsets,E=t.rects.reference,L=t.rects.popper,_="function"==typeof k?k(Object.assign({},t.rects,{placement:t.placement})):k,R="number"==typeof _?{mainAxis:_,altAxis:_}:Object.assign({mainAxis:0,altAxis:0},_),x=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,M={x:0,y:0};if(A){if(c){var D,H="y"===I?a:o,N="y"===I?s:r,F="y"===I?"height":"width",$=A[I],B=$+C[H],q=$-C[N],j=v?-L[F]/2:0,z="start"===S?E[F]:L[F],U="start"===S?-L[F]:-E[F],W=t.elements.arrow,V=v&&W?getLayoutRect(W):{width:0,height:0},G=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},Q=G[H],Y=G[N],X=within(0,E[F],V[F]),J=P?E[F]/2-j-X-Q-R.mainAxis:z-X-Q-R.mainAxis,K=P?-E[F]/2+j+X+Y+R.mainAxis:U+X+Y+R.mainAxis,Z=t.elements.arrow&&getOffsetParent(t.elements.arrow),ee=Z?"y"===I?Z.clientTop||0:Z.clientLeft||0:0,te=null!=(D=null==x?void 0:x[I])?D:0,ne=$+K-te,ae=within(v?g(B,$+J-te-ee):B,$,v?p(q,ne):q);A[I]=ae,M[I]=ae-$}if(d){var se,re="x"===I?a:o,oe="x"===I?s:r,ie=A[O],le="y"===O?"height":"width",ce=ie+C[re],ue=ie-C[oe],de=-1!==[a,o].indexOf(T),pe=null!=(se=null==x?void 0:x[O])?se:0,ge=de?ce:ie-E[le]-L[le]-pe+R.altAxis,me=de?ie+E[le]+L[le]-pe-R.altAxis:ue,fe=v&&de?function withinMaxClamp(e,t,n){var a=within(e,t,n);return a>n?n:a}(ge,ie,me):within(v?ge:ce,ie,v?me:ue);A[O]=fe,M[O]=fe-ie}t.modifiersData[i]=M}},requiresIfExists:["offset"]};function getCompositeRect(e,t,n){void 0===n&&(n=!1);var a=isHTMLElement(t),s=isHTMLElement(t)&&function isElementScaled(e){var t=e.getBoundingClientRect(),n=m(t.width)/e.offsetWidth||1,a=m(t.height)/e.offsetHeight||1;return 1!==n||1!==a}(t),r=getDocumentElement(t),o=getBoundingClientRect(e,s),i={scrollLeft:0,scrollTop:0},l={x:0,y:0};return(a||!a&&!n)&&(("body"!==getNodeName(t)||isScrollParent(r))&&(i=function getNodeScroll(e){return e!==getWindow(e)&&isHTMLElement(e)?function getHTMLElementScroll(e){return{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}}(e):getWindowScroll(e)}(t)),isHTMLElement(t)?((l=getBoundingClientRect(t,!0)).x+=t.clientLeft,l.y+=t.clientTop):r&&(l.x=getWindowScrollBarX(r))),{x:o.left+i.scrollLeft-l.x,y:o.top+i.scrollTop-l.y,width:o.width,height:o.height}}function order(e){var t=new Map,n=new Set,a=[];function sort(e){n.add(e.name),[].concat(e.requires||[],e.requiresIfExists||[]).forEach((function(e){if(!n.has(e)){var a=t.get(e);a&&sort(a)}})),a.push(e)}return e.forEach((function(e){t.set(e.name,e)})),e.forEach((function(e){n.has(e.name)||sort(e)})),a}var T={placement:"bottom",modifiers:[],strategy:"absolute"};function areValidElements(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return!t.some((function(e){return!(e&&"function"==typeof e.getBoundingClientRect)}))}function popperGenerator(e){void 0===e&&(e={});var t=e,n=t.defaultModifiers,a=void 0===n?[]:n,s=t.defaultOptions,r=void 0===s?T:s;return function createPopper(e,t,n){void 0===n&&(n=r);var s,o,i={placement:"bottom",orderedModifiers:[],options:Object.assign({},T,r),modifiersData:{},elements:{reference:e,popper:t},attributes:{},styles:{}},l=[],c=!1,d={state:i,setOptions:function setOptions(n){var s="function"==typeof n?n(i.options):n;cleanupModifierEffects(),i.options=Object.assign({},r,i.options,s),i.scrollParents={reference:isElement$1(e)?listScrollParents(e):e.contextElement?listScrollParents(e.contextElement):[],popper:listScrollParents(t)};var o=function orderModifiers(e){var t=order(e);return u.reduce((function(e,n){return e.concat(t.filter((function(e){return e.phase===n})))}),[])}(function mergeByName(e){var t=e.reduce((function(e,t){var n=e[t.name];return e[t.name]=n?Object.assign({},n,t,{options:Object.assign({},n.options,t.options),data:Object.assign({},n.data,t.data)}):t,e}),{});return Object.keys(t).map((function(e){return t[e]}))}([].concat(a,i.options.modifiers)));return i.orderedModifiers=o.filter((function(e){return e.enabled})),function runModifierEffects(){i.orderedModifiers.forEach((function(e){var t=e.name,n=e.options,a=void 0===n?{}:n,s=e.effect;if("function"==typeof s){var r=s({state:i,name:t,instance:d,options:a}),o=function noopFn(){};l.push(r||o)}}))}(),d.update()},forceUpdate:function forceUpdate(){if(!c){var e=i.elements,t=e.reference,n=e.popper;if(areValidElements(t,n)){i.rects={reference:getCompositeRect(t,getOffsetParent(n),"fixed"===i.options.strategy),popper:getLayoutRect(n)},i.reset=!1,i.placement=i.options.placement,i.orderedModifiers.forEach((function(e){return i.modifiersData[e.name]=Object.assign({},e.data)}));for(var a=0;a<i.orderedModifiers.length;a++)if(!0!==i.reset){var s=i.orderedModifiers[a],r=s.fn,o=s.options,l=void 0===o?{}:o,u=s.name;"function"==typeof r&&(i=r({state:i,options:l,name:u,instance:d})||i)}else i.reset=!1,a=-1}}},update:(s=function(){return new Promise((function(e){d.forceUpdate(),e(i)}))},function(){return o||(o=new Promise((function(e){Promise.resolve().then((function(){o=void 0,e(s())}))}))),o}),destroy:function destroy(){cleanupModifierEffects(),c=!0}};if(!areValidElements(e,t))return d;function cleanupModifierEffects(){l.forEach((function(e){return e()})),l=[]}return d.setOptions(n).then((function(e){!c&&n.onFirstUpdate&&n.onFirstUpdate(e)})),d}}var S=popperGenerator({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function fn(){},effect:function effect(e){var t=e.state,n=e.instance,a=e.options,s=a.scroll,r=void 0===s||s,o=a.resize,i=void 0===o||o,l=getWindow(t.elements.popper),c=[].concat(t.scrollParents.reference,t.scrollParents.popper);return r&&c.forEach((function(e){e.addEventListener("scroll",n.update,y)})),i&&l.addEventListener("resize",n.update,y),function(){r&&c.forEach((function(e){e.removeEventListener("scroll",n.update,y)})),i&&l.removeEventListener("resize",n.update,y)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function popperOffsets(e){var t=e.state,n=e.name;t.modifiersData[n]=computeOffsets({reference:t.rects.reference,element:t.rects.popper,strategy:"absolute",placement:t.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function computeStyles(e){var t=e.state,n=e.options,a=n.gpuAcceleration,s=void 0===a||a,r=n.adaptive,o=void 0===r||r,i=n.roundOffsets,l=void 0===i||i,c={placement:getBasePlacement$1(t.placement),variation:getVariation(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:s,isFixed:"fixed"===t.options.strategy};null!=t.modifiersData.popperOffsets&&(t.styles.popper=Object.assign({},t.styles.popper,mapToStyles(Object.assign({},c,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:o,roundOffsets:l})))),null!=t.modifiersData.arrow&&(t.styles.arrow=Object.assign({},t.styles.arrow,mapToStyles(Object.assign({},c,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:l})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})},data:{}},d,k,w,C,f,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function hide(e){var t=e.state,n=e.name,a=t.rects.reference,s=t.rects.popper,r=t.modifiersData.preventOverflow,o=detectOverflow(t,{elementContext:"reference"}),i=detectOverflow(t,{altBoundary:!0}),l=getSideOffsets(o,a),c=getSideOffsets(i,s,r),u=isAnySideFullyClipped(l),d=isAnySideFullyClipped(c);t.modifiersData[n]={referenceClippingOffsets:l,popperEscapeOffsets:c,isReferenceHidden:u,hasPopperEscaped:d},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":u,"data-popper-escaped":d})}}]}),P={passive:!0,capture:!0},I=function TIPPY_DEFAULT_APPEND_TO(){return document.body};function getValueAtIndexOrReturn(e,t,n){if(Array.isArray(e)){var a=e[t];return a??(Array.isArray(n)?n[t]:n)}return e}function isType(e,t){var n={}.toString.call(e);return 0===n.indexOf("[object")&&n.indexOf(t+"]")>-1}function invokeWithArgsOrReturn(e,t){return"function"==typeof e?e.apply(void 0,t):e}function debounce(e,t){return 0===t?e:function(a){clearTimeout(n),n=setTimeout((function(){e(a)}),t)};var n}function normalizeToArray(e){return[].concat(e)}function pushIfUnique(e,t){-1===e.indexOf(t)&&e.push(t)}function arrayFrom(e){return[].slice.call(e)}function removeUndefinedProps(e){return Object.keys(e).reduce((function(t,n){return void 0!==e[n]&&(t[n]=e[n]),t}),{})}function div(){return document.createElement("div")}function isElement(e){return["Element","Fragment"].some((function(t){return isType(e,t)}))}function getArrayOfElements(e){return isElement(e)?[e]:function isNodeList(e){return isType(e,"NodeList")}(e)?arrayFrom(e):Array.isArray(e)?e:arrayFrom(document.querySelectorAll(e))}function setTransitionDuration(e,t){e.forEach((function(e){e&&(e.style.transitionDuration=t+"ms")}))}function setVisibilityState(e,t){e.forEach((function(e){e&&e.setAttribute("data-state",t)}))}function updateTransitionEndListener(e,t,n){var a=t+"EventListener";["transitionend","webkitTransitionEnd"].forEach((function(t){e[a](t,n)}))}function actualContains(e,t){for(var n=t;n;){var a;if(e.contains(n))return!0;n=null==n.getRootNode||null==(a=n.getRootNode())?void 0:a.host}return!1}var O={isTouch:!1},A=0;function onDocumentTouchStart(){O.isTouch||(O.isTouch=!0,window.performance&&document.addEventListener("mousemove",onDocumentMouseMove))}function onDocumentMouseMove(){var e=performance.now();e-A<20&&(O.isTouch=!1,document.removeEventListener("mousemove",onDocumentMouseMove)),A=e}function onWindowBlur(){var e=document.activeElement;if(function isReferenceElement(e){return!(!e||!e._tippy||e._tippy.reference!==e)}(e)){var t=e._tippy;e.blur&&!t.state.isVisible&&e.blur()}}var E=!!("undefined"!=typeof window&&"undefined"!=typeof document)&&!!window.msCrypto,L=Object.assign({appendTo:I,aria:{content:"auto",expanded:"auto"},delay:0,duration:[300,250],getReferenceClientRect:null,hideOnClick:!0,ignoreAttributes:!1,interactive:!1,interactiveBorder:2,interactiveDebounce:0,moveTransition:"",offset:[0,10],onAfterUpdate:function onAfterUpdate(){},onBeforeUpdate:function onBeforeUpdate(){},onCreate:function onCreate(){},onDestroy:function onDestroy(){},onHidden:function onHidden(){},onHide:function onHide(){},onMount:function onMount(){},onShow:function onShow(){},onShown:function onShown(){},onTrigger:function onTrigger(){},onUntrigger:function onUntrigger(){},onClickOutside:function onClickOutside(){},placement:"top",plugins:[],popperOptions:{},render:null,showOnCreate:!1,touch:!0,trigger:"mouseenter focus",triggerTarget:null},{animateFill:!1,followCursor:!1,inlinePositioning:!1,sticky:!1},{allowHTML:!1,animation:"fade",arrow:!0,content:"",inertia:!1,maxWidth:350,role:"tooltip",theme:"",zIndex:9999}),_=Object.keys(L);function getExtendedPassedProps(e){var t=(e.plugins||[]).reduce((function(t,n){var a,s=n.name,r=n.defaultValue;s&&(t[s]=void 0!==e[s]?e[s]:null!=(a=L[s])?a:r);return t}),{});return Object.assign({},e,t)}function evaluateProps(e,t){var n=Object.assign({},t,{content:invokeWithArgsOrReturn(t.content,[e])},t.ignoreAttributes?{}:function getDataAttributeProps(e,t){return(t?Object.keys(getExtendedPassedProps(Object.assign({},L,{plugins:t}))):_).reduce((function(t,n){var a=(e.getAttribute("data-tippy-"+n)||"").trim();if(!a)return t;if("content"===n)t[n]=a;else try{t[n]=JSON.parse(a)}catch(e){t[n]=a}return t}),{})}(e,t.plugins));return n.aria=Object.assign({},L.aria,n.aria),n.aria={expanded:"auto"===n.aria.expanded?t.interactive:n.aria.expanded,content:"auto"===n.aria.content?t.interactive?null:"describedby":n.aria.content},n}function dangerouslySetInnerHTML(e,t){e.innerHTML=t}function createArrowElement(e){var t=div();return!0===e?t.className="tippy-arrow":(t.className="tippy-svg-arrow",isElement(e)?t.appendChild(e):dangerouslySetInnerHTML(t,e)),t}function setContent(e,t){isElement(t.content)?(dangerouslySetInnerHTML(e,""),e.appendChild(t.content)):"function"!=typeof t.content&&(t.allowHTML?dangerouslySetInnerHTML(e,t.content):e.textContent=t.content)}function getChildren(e){var t=e.firstElementChild,n=arrayFrom(t.children);return{box:t,content:n.find((function(e){return e.classList.contains("tippy-content")})),arrow:n.find((function(e){return e.classList.contains("tippy-arrow")||e.classList.contains("tippy-svg-arrow")})),backdrop:n.find((function(e){return e.classList.contains("tippy-backdrop")}))}}function render(e){var t=div(),n=div();n.className="tippy-box",n.setAttribute("data-state","hidden"),n.setAttribute("tabindex","-1");var a=div();function onUpdate(n,a){var s=getChildren(t),r=s.box,o=s.content,i=s.arrow;a.theme?r.setAttribute("data-theme",a.theme):r.removeAttribute("data-theme"),"string"==typeof a.animation?r.setAttribute("data-animation",a.animation):r.removeAttribute("data-animation"),a.inertia?r.setAttribute("data-inertia",""):r.removeAttribute("data-inertia"),r.style.maxWidth="number"==typeof a.maxWidth?a.maxWidth+"px":a.maxWidth,a.role?r.setAttribute("role",a.role):r.removeAttribute("role"),n.content===a.content&&n.allowHTML===a.allowHTML||setContent(o,e.props),a.arrow?i?n.arrow!==a.arrow&&(r.removeChild(i),r.appendChild(createArrowElement(a.arrow))):r.appendChild(createArrowElement(a.arrow)):i&&r.removeChild(i)}return a.className="tippy-content",a.setAttribute("data-state","hidden"),setContent(a,e.props),t.appendChild(n),n.appendChild(a),onUpdate(e.props,e.props),{popper:t,onUpdate}}render.$$tippy=!0;var R=1,x=[],M=[];function createTippy(e,t){var n,a,s,r,o,i,l,c=evaluateProps(e,Object.assign({},L,getExtendedPassedProps(removeUndefinedProps(t)))),u=!1,d=!1,p=!1,g=!1,m=[],f=debounce(onMouseMove,c.interactiveDebounce),h=R++,y=function unique(e){return e.filter((function(t,n){return e.indexOf(t)===n}))}(c.plugins),b={id:h,reference:e,popper:div(),popperInstance:null,props:c,state:{isEnabled:!0,isVisible:!1,isDestroyed:!1,isMounted:!1,isShown:!1},plugins:y,clearDelayTimeouts:function clearDelayTimeouts(){clearTimeout(n),clearTimeout(a),cancelAnimationFrame(s)},setProps:function setProps(t){if(b.state.isDestroyed)return;invokeHook("onBeforeUpdate",[b,t]),removeListeners();var n=b.props,a=evaluateProps(e,Object.assign({},n,removeUndefinedProps(t),{ignoreAttributes:!0}));b.props=a,addListeners(),n.interactiveDebounce!==a.interactiveDebounce&&(cleanupInteractiveMouseListeners(),f=debounce(onMouseMove,a.interactiveDebounce));n.triggerTarget&&!a.triggerTarget?normalizeToArray(n.triggerTarget).forEach((function(e){e.removeAttribute("aria-expanded")})):a.triggerTarget&&e.removeAttribute("aria-expanded");handleAriaExpandedAttribute(),handleStyles(),k&&k(n,a);b.popperInstance&&(createPopperInstance(),getNestedPopperTree().forEach((function(e){requestAnimationFrame(e._tippy.popperInstance.forceUpdate)})));invokeHook("onAfterUpdate",[b,t])},setContent:function setContent(e){b.setProps({content:e})},show:function show(){var e=b.state.isVisible,t=b.state.isDestroyed,n=!b.state.isEnabled,a=O.isTouch&&!b.props.touch,s=getValueAtIndexOrReturn(b.props.duration,0,L.duration);if(e||t||n||a)return;if(getCurrentTarget().hasAttribute("disabled"))return;if(invokeHook("onShow",[b],!1),!1===b.props.onShow(b))return;b.state.isVisible=!0,getIsDefaultRenderFn()&&(w.style.visibility="visible");handleStyles(),addDocumentPress(),b.state.isMounted||(w.style.transition="none");if(getIsDefaultRenderFn()){var r=getDefaultTemplateChildren(),o=r.box,l=r.content;setTransitionDuration([o,l],0)}i=function onFirstUpdate(){var e;if(b.state.isVisible&&!g){if(g=!0,w.offsetHeight,w.style.transition=b.props.moveTransition,getIsDefaultRenderFn()&&b.props.animation){var t=getDefaultTemplateChildren(),n=t.box,a=t.content;setTransitionDuration([n,a],s),setVisibilityState([n,a],"visible")}handleAriaContentAttribute(),handleAriaExpandedAttribute(),pushIfUnique(M,b),null==(e=b.popperInstance)||e.forceUpdate(),invokeHook("onMount",[b]),b.props.animation&&getIsDefaultRenderFn()&&function onTransitionedIn(e,t){onTransitionEnd(e,t)}(s,(function(){b.state.isShown=!0,invokeHook("onShown",[b])}))}},function mount(){var e,t=b.props.appendTo,n=getCurrentTarget();e=b.props.interactive&&t===I||"parent"===t?n.parentNode:invokeWithArgsOrReturn(t,[n]);e.contains(w)||e.appendChild(w);b.state.isMounted=!0,createPopperInstance()}()},hide:function hide(){var e=!b.state.isVisible,t=b.state.isDestroyed,n=!b.state.isEnabled,a=getValueAtIndexOrReturn(b.props.duration,1,L.duration);if(e||t||n)return;if(invokeHook("onHide",[b],!1),!1===b.props.onHide(b))return;b.state.isVisible=!1,b.state.isShown=!1,g=!1,u=!1,getIsDefaultRenderFn()&&(w.style.visibility="hidden");if(cleanupInteractiveMouseListeners(),removeDocumentPress(),handleStyles(!0),getIsDefaultRenderFn()){var s=getDefaultTemplateChildren(),r=s.box,o=s.content;b.props.animation&&(setTransitionDuration([r,o],a),setVisibilityState([r,o],"hidden"))}handleAriaContentAttribute(),handleAriaExpandedAttribute(),b.props.animation?getIsDefaultRenderFn()&&function onTransitionedOut(e,t){onTransitionEnd(e,(function(){!b.state.isVisible&&w.parentNode&&w.parentNode.contains(w)&&t()}))}(a,b.unmount):b.unmount()},hideWithInteractivity:function hideWithInteractivity(e){getDocument().addEventListener("mousemove",f),pushIfUnique(x,f),f(e)},enable:function enable(){b.state.isEnabled=!0},disable:function disable(){b.hide(),b.state.isEnabled=!1},unmount:function unmount(){b.state.isVisible&&b.hide();if(!b.state.isMounted)return;destroyPopperInstance(),getNestedPopperTree().forEach((function(e){e._tippy.unmount()})),w.parentNode&&w.parentNode.removeChild(w);M=M.filter((function(e){return e!==b})),b.state.isMounted=!1,invokeHook("onHidden",[b])},destroy:function destroy(){if(b.state.isDestroyed)return;b.clearDelayTimeouts(),b.unmount(),removeListeners(),delete e._tippy,b.state.isDestroyed=!0,invokeHook("onDestroy",[b])}};if(!c.render)return b;var v=c.render(b),w=v.popper,k=v.onUpdate;w.setAttribute("data-tippy-root",""),w.id="tippy-"+b.id,b.popper=w,e._tippy=b,w._tippy=b;var C=y.map((function(e){return e.fn(b)})),T=e.hasAttribute("aria-expanded");return addListeners(),handleAriaExpandedAttribute(),handleStyles(),invokeHook("onCreate",[b]),c.showOnCreate&&scheduleShow(),w.addEventListener("mouseenter",(function(){b.props.interactive&&b.state.isVisible&&b.clearDelayTimeouts()})),w.addEventListener("mouseleave",(function(){b.props.interactive&&b.props.trigger.indexOf("mouseenter")>=0&&getDocument().addEventListener("mousemove",f)})),b;function getNormalizedTouchSettings(){var e=b.props.touch;return Array.isArray(e)?e:[e,0]}function getIsCustomTouchBehavior(){return"hold"===getNormalizedTouchSettings()[0]}function getIsDefaultRenderFn(){var e;return!(null==(e=b.props.render)||!e.$$tippy)}function getCurrentTarget(){return l||e}function getDocument(){var e=getCurrentTarget().parentNode;return e?function getOwnerDocument(e){var t,n=normalizeToArray(e)[0];return null!=n&&null!=(t=n.ownerDocument)&&t.body?n.ownerDocument:document}(e):document}function getDefaultTemplateChildren(){return getChildren(w)}function getDelay(e){return b.state.isMounted&&!b.state.isVisible||O.isTouch||r&&"focus"===r.type?0:getValueAtIndexOrReturn(b.props.delay,e?0:1,L.delay)}function handleStyles(e){void 0===e&&(e=!1),w.style.pointerEvents=b.props.interactive&&!e?"":"none",w.style.zIndex=""+b.props.zIndex}function invokeHook(e,t,n){var a;(void 0===n&&(n=!0),C.forEach((function(n){n[e]&&n[e].apply(n,t)})),n)&&(a=b.props)[e].apply(a,t)}function handleAriaContentAttribute(){var t=b.props.aria;if(t.content){var n="aria-"+t.content,a=w.id;normalizeToArray(b.props.triggerTarget||e).forEach((function(e){var t=e.getAttribute(n);if(b.state.isVisible)e.setAttribute(n,t?t+" "+a:a);else{var s=t&&t.replace(a,"").trim();s?e.setAttribute(n,s):e.removeAttribute(n)}}))}}function handleAriaExpandedAttribute(){!T&&b.props.aria.expanded&&normalizeToArray(b.props.triggerTarget||e).forEach((function(e){b.props.interactive?e.setAttribute("aria-expanded",b.state.isVisible&&e===getCurrentTarget()?"true":"false"):e.removeAttribute("aria-expanded")}))}function cleanupInteractiveMouseListeners(){getDocument().removeEventListener("mousemove",f),x=x.filter((function(e){return e!==f}))}function onDocumentPress(t){if(!O.isTouch||!p&&"mousedown"!==t.type){var n=t.composedPath&&t.composedPath()[0]||t.target;if(!b.props.interactive||!actualContains(w,n)){if(normalizeToArray(b.props.triggerTarget||e).some((function(e){return actualContains(e,n)}))){if(O.isTouch)return;if(b.state.isVisible&&b.props.trigger.indexOf("click")>=0)return}else invokeHook("onClickOutside",[b,t]);!0===b.props.hideOnClick&&(b.clearDelayTimeouts(),b.hide(),d=!0,setTimeout((function(){d=!1})),b.state.isMounted||removeDocumentPress())}}}function onTouchMove(){p=!0}function onTouchStart(){p=!1}function addDocumentPress(){var e=getDocument();e.addEventListener("mousedown",onDocumentPress,!0),e.addEventListener("touchend",onDocumentPress,P),e.addEventListener("touchstart",onTouchStart,P),e.addEventListener("touchmove",onTouchMove,P)}function removeDocumentPress(){var e=getDocument();e.removeEventListener("mousedown",onDocumentPress,!0),e.removeEventListener("touchend",onDocumentPress,P),e.removeEventListener("touchstart",onTouchStart,P),e.removeEventListener("touchmove",onTouchMove,P)}function onTransitionEnd(e,t){var n=getDefaultTemplateChildren().box;function listener(e){e.target===n&&(updateTransitionEndListener(n,"remove",listener),t())}if(0===e)return t();updateTransitionEndListener(n,"remove",o),updateTransitionEndListener(n,"add",listener),o=listener}function on(t,n,a){void 0===a&&(a=!1),normalizeToArray(b.props.triggerTarget||e).forEach((function(e){e.addEventListener(t,n,a),m.push({node:e,eventType:t,handler:n,options:a})}))}function addListeners(){getIsCustomTouchBehavior()&&(on("touchstart",onTrigger,{passive:!0}),on("touchend",onMouseLeave,{passive:!0})),function splitBySpaces(e){return e.split(/\s+/).filter(Boolean)}(b.props.trigger).forEach((function(e){if("manual"!==e)switch(on(e,onTrigger),e){case"mouseenter":on("mouseleave",onMouseLeave);break;case"focus":on(E?"focusout":"blur",onBlurOrFocusOut);break;case"focusin":on("focusout",onBlurOrFocusOut)}}))}function removeListeners(){m.forEach((function(e){var t=e.node,n=e.eventType,a=e.handler,s=e.options;t.removeEventListener(n,a,s)})),m=[]}function onTrigger(e){var t,n=!1;if(b.state.isEnabled&&!isEventListenerStopped(e)&&!d){var a="focus"===(null==(t=r)?void 0:t.type);r=e,l=e.currentTarget,handleAriaExpandedAttribute(),!b.state.isVisible&&function isMouseEvent(e){return isType(e,"MouseEvent")}(e)&&x.forEach((function(t){return t(e)})),"click"===e.type&&(b.props.trigger.indexOf("mouseenter")<0||u)&&!1!==b.props.hideOnClick&&b.state.isVisible?n=!0:scheduleShow(e),"click"===e.type&&(u=!n),n&&!a&&scheduleHide(e)}}function onMouseMove(e){var t=e.target,n=getCurrentTarget().contains(t)||w.contains(t);if("mousemove"!==e.type||!n){var a=getNestedPopperTree().concat(w).map((function(e){var t,n=null==(t=e._tippy.popperInstance)?void 0:t.state;return n?{popperRect:e.getBoundingClientRect(),popperState:n,props:c}:null})).filter(Boolean);(function isCursorOutsideInteractiveBorder(e,t){var n=t.clientX,a=t.clientY;return e.every((function(e){var t=e.popperRect,s=e.popperState,r=e.props.interactiveBorder,o=function getBasePlacement(e){return e.split("-")[0]}(s.placement),i=s.modifiersData.offset;if(!i)return!0;var l="bottom"===o?i.top.y:0,c="top"===o?i.bottom.y:0,u="right"===o?i.left.x:0,d="left"===o?i.right.x:0,p=t.top-a+l>r,g=a-t.bottom-c>r,m=t.left-n+u>r,f=n-t.right-d>r;return p||g||m||f}))})(a,e)&&(cleanupInteractiveMouseListeners(),scheduleHide(e))}}function onMouseLeave(e){isEventListenerStopped(e)||b.props.trigger.indexOf("click")>=0&&u||(b.props.interactive?b.hideWithInteractivity(e):scheduleHide(e))}function onBlurOrFocusOut(e){b.props.trigger.indexOf("focusin")<0&&e.target!==getCurrentTarget()||b.props.interactive&&e.relatedTarget&&w.contains(e.relatedTarget)||scheduleHide(e)}function isEventListenerStopped(e){return!!O.isTouch&&getIsCustomTouchBehavior()!==e.type.indexOf("touch")>=0}function createPopperInstance(){destroyPopperInstance();var t=b.props,n=t.popperOptions,a=t.placement,s=t.offset,r=t.getReferenceClientRect,o=t.moveTransition,l=getIsDefaultRenderFn()?getChildren(w).arrow:null,c=r?{getBoundingClientRect:r,contextElement:r.contextElement||getCurrentTarget()}:e,u={name:"$$tippy",enabled:!0,phase:"beforeWrite",requires:["computeStyles"],fn:function fn(e){var t=e.state;if(getIsDefaultRenderFn()){var n=getDefaultTemplateChildren().box;["placement","reference-hidden","escaped"].forEach((function(e){"placement"===e?n.setAttribute("data-placement",t.placement):t.attributes.popper["data-popper-"+e]?n.setAttribute("data-"+e,""):n.removeAttribute("data-"+e)})),t.attributes.popper={}}}},d=[{name:"offset",options:{offset:s}},{name:"preventOverflow",options:{padding:{top:2,bottom:2,left:5,right:5}}},{name:"flip",options:{padding:5}},{name:"computeStyles",options:{adaptive:!o}},u];getIsDefaultRenderFn()&&l&&d.push({name:"arrow",options:{element:l,padding:3}}),d.push.apply(d,(null==n?void 0:n.modifiers)||[]),b.popperInstance=S(c,w,Object.assign({},n,{placement:a,onFirstUpdate:i,modifiers:d}))}function destroyPopperInstance(){b.popperInstance&&(b.popperInstance.destroy(),b.popperInstance=null)}function getNestedPopperTree(){return arrayFrom(w.querySelectorAll("[data-tippy-root]"))}function scheduleShow(e){b.clearDelayTimeouts(),e&&invokeHook("onTrigger",[b,e]),addDocumentPress();var t=getDelay(!0),a=getNormalizedTouchSettings(),s=a[0],r=a[1];O.isTouch&&"hold"===s&&r&&(t=r),t?n=setTimeout((function(){b.show()}),t):b.show()}function scheduleHide(e){if(b.clearDelayTimeouts(),invokeHook("onUntrigger",[b,e]),b.state.isVisible){if(!(b.props.trigger.indexOf("mouseenter")>=0&&b.props.trigger.indexOf("click")>=0&&["mouseleave","mousemove"].indexOf(e.type)>=0&&u)){var t=getDelay(!1);t?a=setTimeout((function(){b.state.isVisible&&b.hide()}),t):s=requestAnimationFrame((function(){b.hide()}))}}else removeDocumentPress()}}function tippy(e,t){void 0===t&&(t={});var n=L.plugins.concat(t.plugins||[]);!function bindGlobalEventListeners(){document.addEventListener("touchstart",onDocumentTouchStart,P),window.addEventListener("blur",onWindowBlur)}();var a=Object.assign({},t,{plugins:n}),s=getArrayOfElements(e).reduce((function(e,t){var n=t&&createTippy(t,a);return n&&e.push(n),e}),[]);return isElement(e)?s[0]:s}tippy.defaultProps=L,tippy.setDefaultProps=function setDefaultProps(e){Object.keys(e).forEach((function(t){L[t]=e[t]}))},tippy.currentInput=O,Object.assign({},d,{effect:function effect(e){var t=e.state,n={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};Object.assign(t.elements.popper.style,n.popper),t.styles=n,t.elements.arrow&&Object.assign(t.elements.arrow.style,n.arrow)}}),tippy.setDefaultProps({render});class TooltipListener{constructor(e){return this.id=e,this.app=document.querySelector(`#${this.id}`),this}get defaultOptions(){return{appendTo:"parent",arrow:!1,animateFill:!1,interactive:!1,flipOnUpdate:!1,placement:"top",touch:["hold",500],delay:[300,0],content:e=>e.dataset.tooltipContent||e.value}}async itemTooltips(e,t={}){const n={theme:"lsn-item",flipOnUpdate:!0,placement:"bottom-end",onShow:e=>this._onShowItemTooltip(e)};tippy(e,this._getOptions(n,t))}helperTooltips(e={}){tippy(this.app.querySelectorAll(".infobox-wrapper .help"),this._getOptions({theme:"lsn-help",allowHTML:!0,content:e=>e.parentNode.querySelector(".sheet-infobox")?.innerHTML},e))}miscTooltips(){tippy(this.app.querySelectorAll(".lsnpc.actor [data-tooltip-content]"),this._getOptions())}formInputTooltips(e={}){tippy(this.app.querySelectorAll(".lsnpc.dialog-price-modifier input"),this._getOptions({allowHTML:!0,hideOnClick:!1,inlinePositioning:!0,onInput:e=>e.value},e))}_getOptions(e={},t={}){let n=this.defaultOptions;return n=mergeObject(n,e),mergeObject(n,t)}async _onShowItemTooltip(e){const t=e.reference,n=t.dataset.price||0,a=t.dataset.weight||"-",s=t.dataset.quantity||1,r=t.dataset.rarity||"common",o=document.createElement("aside");let i=await fromUuid(t.dataset.uuid);o.classList.add("tippy-lsnpc"),o.classList.add(`rarity-${r}`),o.innerHTML=this._buildItemHTML(i,{price:n,weight:a,quantity:s}),e.setContent(o)}_buildItemHTML(e,t={}){let n="";const a={armor:'<i class="ra ra-vest"></i>',damage:'<i class="ra ra-blaster"></i>',toHit:'<i class="ra ra-on-target"></i>',range:'<i class="ra ra-overhead"></i>'};n+=`<header class="flexrow">\n                    <h3 class="item-name">${e.data.name}</h3>\n                    <span class="item-price">${t.price} 🪙 </span>\n                </header>`,n+='<ul class="labels">';for(let[t,s]of Object.entries(e.labels)){if(0==s.length)continue;if("string"!=typeof s)continue;if(s.indexOf("undefined")>=0)continue;n+=`<li class="label">${a[t]||""}<small>${s} ${t}</small></li>`}return n+="</ul>",e.data.data.description.value&&(n+=`<article>${e.data.data.description.value}</article>`),n+=`<footer class="flexrow">\n                    <span class="item-weight"> ${t.weight} <i class="ra ra-kettlebell"></i></span>\n                    <span class="item-quantity">📦×${t.quantity}</span>\n                </footer>`,n}}class PriceModifierDialog extends FormApplication{constructor(e){return super(),this.actor=e.actor,this.data={currentModifier:e.currentModifier,maxModifier:e.maxModifier},loadTemplates([`${n.templateAppsPath}/priceModifier.hbs`]),this}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("Price Modifier"),namespace:n.ns,template:`${n.templateAppsPath}/priceModifier.hbs`,classes:["lsnpc lsnpc-dialog dialog-price-modifier styled"],width:400,jQuery:!1})}getData(){return console.log(n.ns," getData: ",this.actor.data.flags.lootsheetnpc5e.priceModifier),{flags:this.actor.data.flags,currentModifier:this.data.currentModifier,maxModifier:this.data.maxModifier}}activateListeners(e){super.activateListeners(e),new TooltipListener(this.id).formInputTooltips();const t=document.querySelector(".lsnpc.dialog-price-modifier");console.info(n.ns," flags?: ",this.actor.data.flags),t.classList.add(this.actor.getFlag(n.ns,"sheettint").style);let a=`--sheettint: ${Handlebars.helpers.hexToRGB(this.actor.getFlag(n.ns,"sheettint").value,this.actor.getFlag(n.ns,"sheettint").alpha)}; --avatartint: ${Handlebars.helpers.hexToRGB(this.actor.getFlag(n.ns,"avatartint").value,this.actor.getFlag(n.ns,"avatartint").alpha)}; --blendmode: ${this.actor.getFlag(n.ns,"sheettint").blendmode};`;t.querySelector("header").setAttribute("style",a),t.querySelector("form").setAttribute("style",a),t.querySelectorAll("main section input").forEach((e=>{e.addEventListener("change",this._onChange.bind(this))}))}async _onChange(e){e.preventDefault(),e.stopPropagation(),document.querySelector(".lsnpc.dialog-price-modifier");const t=e.currentTarget.closest("section"),a=t.querySelectorAll("input"),s=e.currentTarget.value,r="priceModifier."+t.dataset.modifierType;a.forEach((t=>t.value=e.currentTarget.value)),await this.actor.setFlag(n.ns,r,s)}async _onSubmit(e){e.preventDefault(),super.close(e)}}class Utils{static addRollModeToChatData(e,t){switch(t=t??game.settings.get("core","rollMode")){case"blindroll":e.blind=!0;case"gmroll":e.whisper=[game.users.find((e=>e.isGM)).id];break;case"selfroll":e.whisper=[game.userId]}}static async findInCompendiumByName(e,t){const n=game.packs.get(e);if(n){const e=n.index.getName(t);if(e)return await n.getDocument(e._id)}else switch(e){case"RollTable":return game.tables.getName(t);case"Actor":return game.actors.getName(t);case"Item":return game.items.getName(t);case"JournalEntry":return game.journal.getName(t);case"Playlist":return game.playlists.getName(t);case"Scene":return game.scenes.getName(t);case"Macro":return game.macros.getName(t)}}static async findInCompendiumById(e,t){return await(game.packs.get(e)?.getDocument(t))}static separateIdCompendiumName(e){const t=e.split(".");return{nameOrId:t.pop().trim(),compendiumName:t.join(".").trim()}}static async getItemFromCompendium(e){return this.findInCompendiumByName(e.collection,e.text)}static async getRandomItemFromCompendium(e){const t=game.packs.get(e);if(!t)return;const n=t.index.size;if(0===n)return void ui.notifications.warn(`Compendium ${t.title} is empty.`);const a=Math.floor(Math.random()*n),s=t.index.contents[a];return t.getDocument(s._id)}static getIconByEntityType(e){switch(e){case"RollTable":return"fa-th-list";case"Actor":return"fa-user";case"Item":return"fa-suitcase";case"JournalEntry":return"fa-book-open";case"Playlist":return"fa-music";case"Scene":return"fa-map";case"Macro":return"fa-terminal";default:return""}}}class LootProcessor{constructor(e,t,n={}){return this.actor=t||this._getLootActor(t),this.rawResults=e,this.lootResults=[],this.currencyData=t.data.data?.currency||{cp:0,sp:0,ep:0,gp:0,pp:0},this.defaultConversions={},this.options=n||{currencyString:"",stackSame:!0,tokenUuid:null},this}async buildResults(e={}){const t=e?.customRoll.currencyFormula??"";if(this._setCurrencyData(await CurrencyHelper.generateCurrency(t)),this.rawResults&&Symbol.iterator in Object(this.rawResults))for(const t of this.rawResults){const n=await this._parseResult(t,e);for(const e of n)this.lootResults.push(e)}return{results:this.lootResults,currency:this.currencyData}}async buildItemData(e,t=null){let n={},a=!1;if(e.uuid&&(a=await fromUuid(e.uuid)),a?n=duplicate(a.data):a=e.collection?await Utils.getItemFromCompendium(e):game.items.getName(e.text),Object.getOwnPropertyDescriptor(e,"commands")&&e.commands&&(n=this._applyCommandToItemData(n,e.commands)),n)return n=await this.preItemCreationDataManipulation(n,a),n}async _getLootActor(e=!1){if(!this.actor&&(this.actor=await Actor.create({name:actorName||"New Loot",type:"npc",img:"modules/better-rolltables/artwork/chest.webp",sort:12e3,token:{actorLink:!0}}),e))return this.actor}_addCurrency(e){for(const t in e)this._setCurrencyData((this.currencyData[t]||0)+e[t],t)}getCurrencyData(){return this.currencyData}_setCurrencyData(e,t=null){t?this.currencyData[t]=Number(e):this.currencyData=e}async _parseResult(e,t={}){let n=[];if(e.data.type===CONST.TABLE_RESULT_TYPES.TEXT)n=await this._parseTextResults(e,t);else{const t={};t.img=e.data.img,t.collection=e.data.collection,t.text=e.data.text,e.data.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM?t.uuid=`Compendium.${e.data.collection}.${e.data.resultId}`:t.uuid=`${e.data.collection}.${e.data.resultId}`,n.push(t)}return n}async _parseTextResults(e,t={}){const n=e.data.text.split("|");let a=[];for(let t of n){t=await this._processTextAsCurrency(t),t=await this._rollInlineDice(t);let n=this._getTextResult(t);if(n.table){const e=await this.tryRoll(t),n=new TableRoller(table),a=await n.roll(e);this.tableResults=this.tableResults.concat(a)}else n.textString&&(n.collection&&(betterResult.collection=n.collection),console.log(`results text ${textString.trim()} and commands ${n.commands}`),betterResult.img=e.data.img,betterResult.text=n.textString.trim(),0===n.commands.length&&(betterResult.type=CONST.TABLE_RESULT_TYPES.TEXT),betterResult.commands=commands,a.push(betterResult))}return a}async _getTextResult(e){const t=/(\s*[^\[@]*)@*(\w+)*\[([\w.,*+-\/\(\)]+)\]/g;let a,s={table:!1,textString:!1,commands:[],collection:!1};for(;null!==(a=t.exec(e));){void 0!==a[1]&&""!==a[1].trim()&&(s.textString=a[1]);const e=a[2],t=a[3];if(!e&&t){const e=Utils.separateIdCompendiumName(t),a=e.nameOrId,r=e.compendiumName;s.table=r?await Utils.findInCompendiumByName(r,a):game.tables.getName(a),s.table||ui.notifications.warn(`${n.ns} | no table with name ${a} found in compendium pack ${r}`);break}e&&(s.commands.push({command:e.toLowerCase(),arg:a[3]}),"compendium"===e.toLowerCase()&&(s.collection=a[3]))}return s}async _addLootItem(e,t,a){const s={data:await this.buildItemData(t)},r=[...e.getEmbeddedCollection("Item").values()].find((e=>e.name===s.data?.name));s||console.error(`${n.ns} | _createLootItem: no newItem could be generated from object:`,t);let o=s?.data?.data?.quantity||1,i=0;a?.customRoll&&(o=(await new Roll(a?.customRoll.itemQtyFormula,e.data).roll({async:!0})).total,i=(await new Roll(a?.customRoll.itemQtyLimitFormula,e.data).roll({async:!0})).total);let l=r?.data?.quantity||1,c=this._handleLimitedQuantity(o,l,i);if(r){let t={_id:r.id,data:{quantity:c}};c!=o&&await e.updateEmbeddedDocuments("Item",[t])}else s.data?.name&&(s.data.data.quantity=c,await e.createEmbeddedDocuments("Item",[s.data]))}_handleLimitedQuantity(e,t,n=0){const a=Number(t)+Number(e);return n>0?Number(n)>=Number(a)?a:n:a}async _processTextAsCurrency(e){const t=/{([^}]+)}/g;let n;for(;null!=(n=t.exec(e));)this._addCurrency(await CurrencyHelper.generateCurrency(n[1]));return e.replace(t,"")}async _rollInlineDice(e){const t=/\[{2}(\w*[^\]])\]{2}/g;let n;for(;null!=(n=t.exec(e));)e=e.replace(n[0],await this.tryRoll(n[1]));return e}_applyCommandToItemData(e,t){for(const n of t){let t;try{t=new Roll(n.arg).roll().total}catch(e){continue}setProperty(e,`data.${n.command.toLowerCase()}`,t)}return e}async tryRoll(e){try{return(await new Roll(e).roll({async:!0})).total||1}catch(e){return console.error(n.ns+" | currencyHelper :",e),1}}async addItemsToActor(e,t){const n=this.lootResults.reduce(((e,t)=>{const n=e.find((e=>t.text===e.text&&t.collection===e.collection));if(n){let e=n.quantity||1;n.quantity=e+1}else e.push(t);return e}),[]);for(const a of n)await this._addLootItem(e,a,t)}async preItemCreationDataManipulation(e,t=null){return e=this.createScrollFromSpell(e),t&&t.documentName&&(e=await ItemHelper.applyItemConversions(e,t.documentName)),e}async _getRandomSpell(e){await this.updateSpellCache();const t=this.getSpellCache().filter((t=>getProperty(t,"data.level")===e)),n=t[Math.floor(Math.random()*t.length)];return await Utils.findInCompendiumById(n.collection,n._id)}async updateSpellCache(e){if(game.user.isGM){const t="dnd5e.spells",a=game.packs.get(t);if(!e&&a||e===t){const e=await a.getIndex({fields:["data.level","img"]});this._spellCache=e.filter((e=>"spell"===e.type)).map((e=>mergeObject(e,{collection:a.collection})))}else ui.notifications.error(n.ns+"| Spell cache could not be initialized/updated.")}}getSpellCache(){return this._spellCache}async createScrollFromSpell(e){const t=/\s*Spell\s*Scroll\s*(\d+|cantrip)/gi.exec(e.name);if(e=duplicate(e),!t)return e;const a="cantrip"===t[1].toLowerCase()?0:parseInt(t[1]),s=await this._getRandomSpell(a);if(!s)return ui.notifications.warn(n.ns+` | No spell of level ${a} found in compendium  ${s.collection} `),e;const r=`@Compendium[${s.pack}.${s.data._id}]`;return e.name=e.name.replace(/^(Spell\s)/,""),e.name=e.name.replace(/(Cantrip\sLevel)/,"Cantrip"),e.name+=` (${s.data.name})`,e.data.description.value="<blockquote>"+r+"<br />"+s.data.data.description.value+"<hr />"+e.data.description.value+"</blockquote>",e.type="spell",e.data.level=a,e}}class TableRoller$1{constructor(e){return this.table=e,this.rollOptionDefault={total:1,itemQtyFormula:1,itemQtyLimit:0,currencyFormula:0},this}async roll(e={}){return e=e||this.rollOptionDefault,this.results=await this.rollManyOnTable(this.table,0,e.total,e),this.results}getCurrencyData(){return this.currencyData}async rollManyOnTable(e,t=0,a=1,s={}){let r=[];if(t>5){let t=`maxRecursions:  reached with table ${e.id}`;throw new Error(n.ns+" | "+t)}for(e.data.formula||(e.data.formula=a+"d"+this.table.results.size);a>0;){const n=await this.checkResultsLeft(e,a);if(!n)continue;const o=Math.min(n,a),i=await e.drawMany(o,{displayChat:!1,recursive:!1});r=await this._updateDrawnResults(i,r,t,s),a-=o}return r}async _updateDrawnResults(e,t,n,a){for(const s of e.results){const e=a.customRoll.itemQtyFormula||"1",r=await this.tryRoll(e),o=await this._getInnerTableOrFalse(s);if(o){a.total=r;let e=n+1;const s=await this.rollManyOnTable(o,e,1,a);t=t.concat(s)}else for(let e=0;e<r;e++)t.push(s)}return t}async _getInnerTableOrFalse(e){let t=!1;return e.data.type===CONST.TABLE_RESULT_TYPES.DOCUMENT?t=this._getRolltableFromGameWorld(e):e.data.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM&&(t=await this._getRollTableFromCompendium(e)),t}_getRolltableFromGameWorld(e){return"RollTable"===e.data.collection&&game.tables.get(e.data.resultId)}async _getRollTableFromCompendium(e){let t=`Compendium.${e.data.collection}.${e.data.resultId}`,a=await fromUuid(t);return a?"RollTable"===a.documentName&&a:(console.error(n.ns+" | tableRoller :",`Could not find document with uuid: ${t}`),!1)}async checkResultsLeft(e,t){if(!e.data.replacement){if(0===e.data.results.reduce((function(e,t){return e+!t.drawn}),0))return await e.reset(),!1}return t}async tryRoll(e){try{return(await new Roll(e).roll({async:!0})).total||1}catch(e){return console.error(n.ns+" | tableRoller :",e),1}}}class ActorHelper{static getRollTables(e){const t=e.data.data.details.type.value,a=this.getLinkedRolltable(e),s=this.getLinkedRolltableByCreatureType(t),r=this.getLinkedRolltableByFilters(e),o=game.settings.get(n.ns,n.settings.keys.lootseeder.fallbackRolltable)||!1;let i=[];return a?i.push(a):r?i=i.concat(...r):s?i.push(s):o&&i.push(o),i}static getLinkedRolltable(e){let t=e.getFlag(n.ns,n.flags.rolltable);if(0==t)return!1;if(t&&-1==t.indexOf(".")){let n=game.tables.getName(t);return n?(ui.notifications.warn(`${e.name} had an old (now invalid) rolltable flag.`),ui.notifications.info(`Found a rolltable for "${n.name}" with id "${n.uuid}"`),ui.notifications.info("Reassign a new rolltable or try the runMigarations Macro from the compendium to get rid of this issue."),n.uuid):(ui.notifications.warn(`A rolltable for "${t}" was not found.`),!1)}return t}static getLinkedRolltableByFilters(e){const t=game.settings.get(n.ns,n.settings.keys.lootseeder.rulesets)||!1;let a=!1;for(const n in t)ActorHelper.passesFilter(e,t[n].filters)&&(a||(a=[]),a.push(t[n].rolltable));return a}static getLinkedRolltableByCreatureType(e){if(!e||0===e.length)return!1;try{if((Object.keys(CONFIG[game.system.id.toUpperCase()]?.creatureTypes)??[]).includes(e)){const t=`creaturetype_default_${e}_table`,a=game.settings.get(n.ns,t);if(a&&0!=a)return a}}catch(e){return console.error(e),!1}return!1}static passesFilter(e,t){for(let n of Object.values(t)){let t=getProperty(e,`data.${n.filterpath}`)||getProperty(e,n.filterpath);if(void 0===t)return!1;switch(n.comparison){case"==":if(t==n.value)return!0;break;case"<=":if(t<=n.value)return!0;break;case">=":if(t>=n.value)return!0;break;case"includes":if(t.includes(n.value))return!0;break;default:return!1}}return!1}static async addLootToTarget(e=null,t=null,a={}){e=this.getActorStack(e),a?.verbose&&ui.notifications.info(n.ns+" | ActorHelper | Loot generation started for.");let s=new TableRoller$1(t);for(let t of e){const e=await s.roll(a),n=new LootProcessor(e,t,a),r=await n.buildResults(a);await CurrencyHelper.addCurrenciesToActor(t,r?.currency),n.addItemsToActor(t,a)}if(a?.verbose)return ui.notifications.info(n.ns+" | ActorHelper | Loot generation complete.")}static getActorStack(e=null){let t=[];return e?Array.isArray(e)?t=e:t.push(e):t=canvas.tokens.controlled.map((e=>e.actor)),t}static skipByCreatureType(e){if(!game.settings.get(n.ns,n.settings.keys.lootseeder.useSkiplist))return!1;const t=e.data.data.details.type.value;return!!Object.keys(CONFIG.DND5E.creatureTypes).includes(t)&&game.settings.get(n.ns,"skiplist_"+t)}}class LootSeeder{static async seedItemsToActors(e=null,t={force:!1}){if(e.length)for(const a of e){if(!a||a.data.actorLink&&t.force)continue;const e=ActorHelper.getRollTables(a);if(e&&0!==e.length)for(let s of e){let r=await fromUuid(s);if(!r){ui.notifications.error(n.ns+`: No Rollable Table found with id "${e}".`);continue}let o=await new Roll(this._getShopQtyFormula(a),a.data).roll({async:!0});t=this._prepareOptions(t,this._getFormulas(a),o.total,a.uuid),await ActorHelper.addLootToTarget(a,r,t)}}}static _getShopQtyFormula(e){const t=game.settings.get(n.ns,n.settings.keys.lootseeder.fallbackShopQty);return e.getFlag(n.ns,n.flags.shopQty)||t||"1"}static _prepareOptions(e,t,n,a){return t.total=n,mergeObject(e,{customRoll:t,tokenUuid:a,total:n})}static _getRollTables(e){const t=e.data.data.details.type.value,a=ActorHelper.getLinkedRolltable(e),s=ActorHelper.getLinkedRolltableByCreatureType(t),r=ActorHelper.getLinkedRolltableByFilters(e),o=game.settings.get(n.ns,n.settings.keys.lootseeder.fallbackRolltable)||!1;return a||r||s||o}static _getFormulas(e){const t=e.getFlag(n.ns,n.flags.shopQty)||game.settings.get(n.ns,"fallbackShopQty")||"1";return{itemQtyFormula:e.getFlag(n.ns,n.flags.itemQty)||game.settings.get(n.ns,"fallbackItemQty")||"1",itemQtyLimitFormula:e.getFlag(n.ns,n.flags.itemQtyLimit)||game.settings.get(n.ns,"fallbackItemQtyLimit")||"0",shopQtyFormula:t,currencyFormula:e.getFlag(n.ns,n.flags.currencyFormula)||game.settings.get(n.ns,n.settings.keys.lootseeder.lootCurrencyDefault)||"2d3[sp]"}}}class SheetListener{constructor(e,t,n,a){this.id=e,this.token=t,this.actor=n,this.options=a}async activateListeners(e={}){const t=document.querySelector(`#${this.id}`);if(!t)return;const a=t.querySelectorAll(".lsnpc-action-link"),s=t.querySelectorAll(".tradegrid .item"),r=t.querySelectorAll(".help");this.options.editable&&this._activateOwnerGMListeners(t),this.tradeItemEventListeners(s);let o=new TooltipListener(this.id);o.itemTooltips(s),o.helperTooltips(),o.miscTooltips();for(let e of a){const t="SELECT"===e.nodeName?"change":"click";e.toggleAttribute("disabled",!1),e.addEventListener(t,(e=>LootSheetNPC5eHelper.sendActionToSocket(this.actor,e)))}for(let e of r)e.addEventListener("hover",(e=>SheetListener.toggleHelp(e)));e&&e?.verbose&&console.log(`${n.ns} | Sheet | Listeners activated`)}_activateOwnerGMListeners(e){const t=e.querySelectorAll(".permission-option a"),a=e.querySelectorAll(".permission-proficiency"),s=e.querySelector(".permissions-filter"),r=e.querySelector(".price-modifier"),o=e.querySelector(".gm-settings .sheet-style"),i=e.querySelector(".gm-settings .inventory-settings"),l=e.querySelector(".gm-settings .update-inventory");if(game.user.isGM){for(let e of t)e.addEventListener("click",(e=>PermissionHelper.bulkPermissionsUpdate(e,this.actor)));for(let e of a)e.addEventListener("click",(e=>PermissionHelper.cyclePermissions(e,this.actor)));s.addEventListener("change",(e=>this.actor.setFlag(n.ns,"permissionsFilter",e.target.value)))}r&&r.addEventListener("click",(e=>class SheetHelper{static async renderPriceModifierDialog(e,t){e.preventDefault();const a=game.settings.get(n.ns,"maxPriceIncrease");let s=await t.getFlag(n.ns,"priceModifier");s="number"!=typeof s?1:s,s=Math.round(100*s),new PriceModifierDialog({actor:t,currentModifier:s,maxModifier:a}).render(!0)}getData(e){return e}static toggleHelp(e){e.currentTarget.nextElementSibling.classList.toggle("hidden")}}.renderPriceModifierDialog(e,this.actor))),i.addEventListener("change",(e=>this.inventorySettingChange(e,this.actor))),o.addEventListener("change",(e=>this.sheetStyleChange(e,this.actor))),l.addEventListener("click",(e=>this.inventoryUpdateListener(e)))}tradeItemEventListeners(e){for(let t of e)t.addEventListener("click",(e=>this._onClick(e))),t.addEventListener("contextmenu",(e=>this._onClick(e)))}_onClick(e){if(!e.currentTarget.dataset)return;e.preventDefault(),e.stopPropagation();let t={uuid:e.currentTarget.dataset.uuid,eventAction:e.currentTarget.closest("main").dataset.eventAction,source:e.currentTarget.closest("section"),stack:"click"!=e.type};this._tradeItemStagingHandler(t,e)}static onDrop(e){e.preventDefault();let t=JSON.parse(e.dataTransfer.getData("text/plain"));t&&this._tradeItemStagingHandler(t,e)}async inventoryUpdateListener(e){e.preventDefault(),e.stopPropagation();if(this.actor.getFlag(n.ns,n.flags.clearInventory)){let e=this.actor.data.items.map((e=>e.id));await this.actor.deleteEmbeddedDocuments("Item",e)}await LootSeeder.seedItemsToActors([this.actor],{force:!0})}async inventorySettingChange(e,t){}async sheetStyleChange(e,t){e.preventDefault(),e.stopPropagation();const a=["sheettint","avatartint","customBackground","blendmode","darkMode"];let s=e.target.name.split("."),r=s[2],o=s[3];if(console.log(n.ns+" | key check",e.target.name,a.includes(r)),a.includes(r))if(o)await t.setFlag(n.ns,r+"."+o,e.target.value);else{const a=void 0===e.target.checked?e.target.value:e.target.checked;await t.setFlag(n.ns,r,a)}}_tradeItemStagingHandler(e,t){const n='main[data-event-action="'+e.eventAction+'"] ul',a='main[data-event-target="'+e.eventAction+'"] ul',s=document.querySelector(n),r=document.querySelector(a),o=s.querySelector('.item[data-uuid="'+e.uuid+'"]'),i=r.querySelector('.item[data-uuid="'+e.uuid+'"]');if(!o)return;let l="contextmenu"==t.type?parseInt(o.dataset.quantity):1;const c=o.cloneNode();parseInt(o.dataset.quantity)-1==0||"contextmenu"==t.type?o.remove():o.dataset.quantity=parseInt(o.dataset.quantity)-l,i?i.dataset.quantity=parseInt(i.dataset.quantity)+l:(c.dataset.quantity=l,c.addEventListener("click",(e=>this._onClick(e))),c.addEventListener("contextmenu",(e=>this._onClick(e))),r.appendChild(c))}}class SettingsHelper{static getTabbedSettings(e,t){for(let n of game.settings.settings.values()){if(n?.namespace!==t)continue;const a=duplicate(n);a.name=game.i18n.localize(a.name),a.hint=game.i18n.localize(a.hint),a.value=game.settings.get(a.namespace,a.key),a.type=n.type instanceof Function?n.type.name:"String",a.isCheckbox=n.type===Boolean,a.isSelect=void 0!==a.choices,a.isRange=n.type===Number&&a.range;const s=a.group;let r=e.tabs.find((e=>e.name===s))??!1;r&&r.settings.push(a)}return e}}class LootSheetSettingsConfigApp extends FormApplication{constructor(){return super(),this.app=null,loadTemplates([`${n.templateAppsPath}/settings.hbs`,`${n.templatePartialsPath}/settings/actions.hbs`,`${n.templatePartialsPath}/settings/dropdown_options.hbs`,`${n.templatePartialsPath}/settings/filters.hbs`,`${n.templatePartialsPath}/settings/tabContent.hbs`,`${n.templatePartialsPath}/settings/seederFilters.hbs`,`${n.templatePartialsPath}/settings/menu.hbs`]),this}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("LootsheetNPC5e Advanced Settings"),id:n.appIds.lootsheetSettings,template:`${n.templateAppsPath}/settings.hbs`,width:680,height:"auto",tabs:[{navSelector:".tabs",contentSelector:".content",initial:"general"}]})}getData(){if(!game.user.isGM)return;let e={tabs:[{name:n.settings.groups.sheet.moduleDefaults,i18nName:game.i18n.localize("lsnpc.settings.menu.moduleDefaults"),class:"fas fa-cog",menus:[],settings:[]},{name:n.settings.groups.sheet.ui,i18nName:game.i18n.localize("lsnpc.settings.menu.ui"),class:"fas fa-bag",menus:[],settings:[]},{name:n.settings.groups.sheet.loot,i18nName:game.i18n.localize("lsnpc.settings.menu.loot"),class:"fab fa-grunt",menus:[],settings:[]},{name:n.settings.groups.sheet.merchant,i18nName:`${game.i18n.localize("lsnpc.settings.menu.merchant")}`,class:"fas fa-coins",menus:[],settings:[]}]};return{systemTitle:game.system.data.title,data:SettingsHelper.getTabbedSettings(e,n.ns)}}async activateListeners(e){this.app||(this.app=document.getElementById(n.appIds.lootsheetSettings)),super.activateListeners(e),this.onEntityClick(this.app),this.onActionClick(this.app),e.find(".submenu button").click(this._onClickSubmenu.bind(this)),e.find('button[name="reset"]').click(this._onResetDefaults.bind(this))}async onEntityClick(e=this.app){e.querySelectorAll('*[data-action="openSheet"]').forEach((async e=>{e.addEventListener("click",(async e=>{let t=e.currentTarget.parentNode.dataset?.entityId.split(".");if(t)if(2===t.length)game.tables.get(t[1]).sheet.render(!0);else if(4===t.length){let e=game.packs.find((e=>e.collection===t[1]+"."+t[2]));await e.getEntity(t[3]).then((e=>{e.sheet.render(!0)}))}else console.log("why is this value",t)}))}))}async onActionClick(e=this.app){e.querySelectorAll(".actions button").forEach((async e=>{e.addEventListener("click",(async e=>{if(e.preventDefault(),!e.target.dataset.action)return ui.notifications.error("No action found for the provided key");this._runAction(e)}))}))}_onClickSubmenu(e){e.preventDefault();const t=game.settings.menus.get(e.currentTarget.dataset.key);if(!t)return ui.notifications.error("No submenu found for the provided key");return(new t.type).render(!0)}_onResetDefaults(e){e.preventDefault();const t=e.currentTarget.form.querySelectorAll(".tab.active .settings-list [data-default]");for(let e of t)e&&"checkbox"===e.type?e.checked=e.dataset.default:e&&(e.value=e.dataset.default)}async _updateObject(e,t){e.preventDefault(),t=expandObject(t)[n.ns];const a=Object.keys(t).filter((e=>"object"==typeof t[e]));for(let s of a){if(0!=t[s].name.length){let a=t[s],r=game.settings.get(n.ns,s),o=a.name+"_"+a.rolltable+"_"+Math.random(),i={};a.rolltableName=e.currentTarget.querySelector('select[name="'+n.ns+'.customFallbacks.rolltable"] option:checked').dataset.label,i[o]=a,await game.settings.set(n.ns,s,Object.assign(r,i))}delete t[s]}for(let[e,a]of Object.entries(t))await game.settings.set(n.ns,e,a)}async _runAction(e){switch(e.target.dataset.action){case"addNewFilter":const t=e.target.closest("fieldset"),a=await renderTemplate(`${n.templatePath}/partials/filters.hbs`,{module:n.ns,key:e.target.dataset.settingsKey,index:t.querySelectorAll(".form-group").length});t.insertAdjacentHTML("beforeend",a),t.querySelector('button[data-action="deleteRow"').addEventListener("click",(async e=>{if(e.preventDefault(),!e.target.dataset.action)return ui.notifications.error("No action found for the provided key");this._runAction(e)}));const{refreshPackageConfig:s}=game.modules.get("autocomplete-inline-properties").API;s(this);break;case"deleteRow":const r=!!e.target.dataset?.updateSetting,o=e.target.parentNode.parentNode;if(!await Dialog.confirm({title:game.i18n.localize("Delete row?"),content:"<p>Are you sure you want to delete this row?</p>",defaultYes:!1}))return;if(r&&o.dataset.name){let[e,t,...a]=o.dataset.name.split("."),s=await game.settings.get(n.ns,t);delete s[a.join(".")],await game.settings.set(n.ns,t,s)}o.remove()}}}const AppSettingMixin=e=>class extends e{constructor(...e){super(...e),this._hookHandler=Hooks.on("updateSetting",this._onUpdateSetting.bind(this))}_onUpdateSetting(e,t,n,a){throw new Error("_onUpdateSetting must be defined")}async close(e){return Hooks.off("updateSetting",this._hookHandler),super.close(e)}};class LootSeederRuleEditor extends FormApplication{constructor(e=null,t={}){super(),this.app=null,this.existingRuleId=e,this.rules=game.settings.get(n.ns,n.settings.keys.lootseeder.rulesets),loadTemplates([`${n.templateAppsPath}/ruleEditor.hbs`,`${n.templatePartialsPath}/settings/dropdown_options.hbs`,`${n.templatePartialsPath}/settings/filters.hbs`,`${n.templatePartialsPath}/settings/tabContent.hbs`,`${n.templatePartialsPath}/settings/menu.hbs`])}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("LootsheetNPC5e seeder filterrule editor"),id:n.appIds.ruleEditor,template:`${n.templateAppsPath}/ruleEditor.hbs`,width:650,classes:["lsnpc","rule-editor"],height:"auto",tabs:[{navSelector:".tabs",contentSelector:".content",initial:"general"}],resizeable:!0})}async activateListeners(e){this.app||(this.app=document.getElementById(n.appIds.ruleEditor)),this.onActionClick(this.app),super.activateListeners(e),e.find('button[name="reset"]').click(this._onResetDefaults.bind(this))}async onActionClick(e=this.app){e.querySelectorAll(".actions button").forEach((async e=>{e.addEventListener("click",(async e=>{if(e.preventDefault(),!e.target.dataset.action)return ui.notifications.error("The button itself has no action in its dataset to call.");this._runAction(e)}))}))}async getData(){const e=super.getData();return null!=this.existingRuleId&&(e.rule=this.rules[this.existingRuleId],e.rule.id=this.existingRuleId,e.edit=!0),e.namespace=n.ns,e.key=n.settings.keys.lootseeder.rulesets,e.rolltables=await TableHelper.getGameWorldRolltables(),e}async _updateObject(e,t){e.preventDefault(),t=await this._saveFilterRule(e,expandObject(t)[n.ns]);for(let[e,a]of Object.entries(t))await game.settings.set(n.ns,e,a)}async _saveFilterRule(e,t,a={}){if(t?.rulesets){let a=t?.rulesets,s={};const r=this.existingRuleId||`${a.name}_${randomID(Number(a.name.length))}`,o=`select[name="${n.ns}.${n.settings.keys.lootseeder.rulesets}.rolltable"] option:checked`;a.rolltableName=e.currentTarget.querySelector(o).dataset.label,s[r]=a,await game.settings.set(n.ns,n.settings.keys.lootseeder.rulesets,Object.assign(this.rules,s)),delete t.rulesets}return t}async _addRow(e,t={}){const a=e.target.closest("fieldset").querySelector("main"),s=t?.template||`${n.templatePartialsPath}/settings/filters.hbs`,r=this._getNewRowIndex(),o=t?.templateOptions||{namespace:n.ns,key:e.target.dataset.settingsKey,index:r},i=await renderTemplate(s,o);a.insertAdjacentHTML("beforeend",i);if([...a.querySelectorAll('button[data-action="delete"]')].pop().addEventListener("click",(async e=>{if(e.preventDefault(),!e.target.dataset.action)return ui.notifications.error("No action found for the provided key");this._runAction(e)})),game.modules.get("autocomplete-inline-properties").active){const{refreshPackageConfig:e}=game.modules.get("autocomplete-inline-properties").API;e(this)}}_getNewRowIndex(e){const t=e?.querySelectorAll(".form-group").length||0;let n=0;for(;n<t&&e.querySelector(`[data-filter-index="${n}"]`);)n++;return n}async _deleteRow(e){const t=e.currentTarget.closest(".form-group");await Dialog.confirm({title:game.i18n.localize("Delete row?"),content:"<p>Are you sure you want to delete this row?</p>",defaultYes:!1})&&t.remove()}async _runAction(e){switch(e.target.dataset.action){case"add":this._addRow(e);break;case"delete":this._deleteRow(e)}}_onResetDefaults(e){e.preventDefault();const t=e.currentTarget.form.querySelectorAll(".tab.active .settings-list [data-default]");for(let e of t)e&&"checkbox"===e.type?e.checked=e.dataset.default:e&&(e.value=e.dataset.default)}}function renderRuleEditor(e){new LootSeederRuleEditor(e).render(!0)}class LootSeederSettingsConfigApp extends(AppSettingMixin(FormApplication)){constructor(){return super(),this.app=null,loadTemplates([`${n.templateAppsPath}/settings.hbs`,`${n.templatePartialsPath}/settings/actions.hbs`,`${n.templatePartialsPath}/settings/dropdown_options.hbs`,`${n.templatePartialsPath}/settings/filters.hbs`,`${n.templatePartialsPath}/settings/tabContent.hbs`,`${n.templatePartialsPath}/settings/seederFilters.hbs`,`${n.templatePartialsPath}/settings/menu.hbs`]),this}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("LootSeeder settings"),namespace:n.ns,id:n.appIds.lootseederSettings,template:`${n.templateAppsPath}/settings.hbs`,width:720,resizable:!0,classes:["lsnpc"],height:"auto",tabs:[{navSelector:".tabs",contentSelector:".content",initial:"general"}]})}getData(e){if(!game.user.isGM)return;const t={hasBetterRolltables:void 0!==game.betterTables,tabs:[{name:n.settings.groups.lootseeder.fallbacks,i18nName:game.i18n.localize("lsnpc.settings.menu.fallbacks"),class:"fas fa-cog",menus:[],settings:[]},{name:n.settings.groups.lootseeder.creatureTypeFallbacks,i18nName:game.i18n.localize("lsnpc.settings.menu.creatureTypeFallbacks"),class:"fab fa-grunt",menus:[],settings:[]},{name:n.settings.groups.lootseeder.currency,i18nName:game.i18n.localize("lsnpc.settings.menu.currency"),class:"fas fa-coins",menus:[],settings:[]},{name:n.settings.groups.lootseeder.rulesets,i18nName:game.i18n.localize("lsnpc.settings.menu.rulesets"),class:"fas fa-filter",menus:[],settings:[]},{name:n.settings.groups.lootseeder.skiplist,i18nName:game.i18n.localize("lsnpc.settings.menu.skiplist"),class:"fas fa-ban",menus:[],settings:[]}]};return{systemTitle:game.system.data.title,data:SettingsHelper.getTabbedSettings(t,n.ns)}}async _updateObject(e,t){e.preventDefault(),t=expandObject(t)[n.ns];const a=Object.keys(t).filter((e=>"object"==typeof t[e])),s=n.settings.keys.lootseeder.rulesets+".rolltable",r='select[name="'+n.ns+"."+s+'"] option:checked';for(let s of a){if(t[s].name&&0!=t[s].name.length){let a=t[s],o=game.settings.get(n.ns,s),i=a.name+"_"+a.rolltable+"_"+Math.random().toString().replace(".",""),l={};a.rolltableName=e.currentTarget.querySelector(r).dataset.label,l[i]=a,await game.settings.set(n.ns,s,Object.assign(o,l))}delete t[s]}for(let[e,a]of Object.entries(t))await game.settings.set(n.ns,e,a)}_onUpdateSetting(e,t,a,s){if(s!==game.user.id)return;const r=e.key.split(".");if(r[0]===n.ns){r[1]===n.settings.groups.lootseeder.rulesets&&this.render()}}async activateListeners(e){this.app||(this.app=document.getElementById(n.appIds.lootseederSettings)),super.activateListeners(e),this.onActionClick(this.app),this._onDocumentLink(),e.find('button[name="reset"]').click(this._onResetDefaults.bind(this))}async onActionClick(e=this.app){e.querySelectorAll(".lsn-action-button").forEach((async e=>{e.addEventListener("click",(async e=>{if(e.preventDefault(),!e.target.dataset.action)return ui.notifications.error("No action found for the provided key");this._runAction(e)}))}))}async _onDocumentLink(e=this.app){e.querySelectorAll(".lsnpc-document-link").forEach((async e=>{e.addEventListener("click",(async e=>{if(e.preventDefault(),!e.currentTarget.dataset.uuid)return;const t=await fromUuid(e.currentTarget.dataset.uuid);t&&("tokens"==t.collectionName?await t.actor.sheet.render(!0):await t.sheet.render(!0),e.stopPropagation())}))}))}_onClickSubmenu(e){e.preventDefault();const t=game.settings.menus.get(e.currentTarget.dataset.key);if(!t)return ui.notifications.error("No submenu found for the provided key");return(new t.type).render(!0)}_onResetDefaults(e){e.preventDefault();const t=e.currentTarget.form.querySelectorAll(".tab.active .settings-list [data-default]");for(let e of t)e&&"checkbox"===e.type?e.checked=e.dataset.default:e&&(e.value=e.dataset.default)}async deleteRow(e){const t=!!e.target.dataset?.updateSetting,a=e.target.parentNode.parentNode;if(await Dialog.confirm({title:game.i18n.localize("Delete row?"),content:"<p>Are you sure you want to delete this row?</p>",defaultYes:!1})){if(t&&a.dataset.name){let[e,t,...s]=a.dataset.name.split("."),r=await game.settings.get(n.ns,t);delete r[s.join(".")],await game.settings.set(n.ns,t,r)}a.remove()}}async _runAction(e){const t=e.target.dataset;switch(t.action){case"new":renderRuleEditor();break;case"edit":renderRuleEditor(t.ruleId);break;case"delete":const a=!!t?.updateSetting,s=e.target.parentNode.parentNode;if(!await Dialog.confirm({title:game.i18n.localize("Delete row?"),content:"<p>Are you sure you want to delete this row?</p>",defaultYes:!1}))return;if(a&&s.dataset.name){let[e,t,...a]=s.dataset.name.split("."),r=await game.settings.get(n.ns,t);delete r[a.join(".")],await game.settings.set(n.ns,t,r)}s.remove()}}}class VersionCheck{static _reg(e){this._r||(game.settings.register(e,"version",{name:`${e} Version`,default:"0.0.0",type:String,scope:"client"}),this._r=!0)}static check(e){this._r||this._reg(e);const t=this.get(e),n=game.settings.get(e,"version");return isNewerVersion(t,n)}static set(e,t){this._r||this._reg(e),game.settings.set(e,"version",t)}static get(e){return game.modules.get(e).data.version}static checkForUpdate(e){this._r||this._reg(e);const t=game.modules.get(e).data.version;return function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="json",n.onload=function(){var e=n.status;t(200===e?null:e,n.response)},n.send()}(game.modules.get(e).data.manifest,(function(n,a){null!==n&&console.log(e+" | Something went wrong: "+n),isNewerVersion(t,a.version)&&ui.notifications.info(MODULE.ns+" | "+a.version+" is available. Please update to the latest version.")})),isNewerVersion(t,oV)}}class WelcomeScreen extends Application{static get defaultOptions(){return mergeObject(super.defaultOptions,{template:`${n.templateAppsPath}/welcomeScreen.hbs`,resizable:!0,width:450,height:636,classes:["lsnpc lsnpc-app welcome-screen"],title:game.modules.get(n.ns).data.title+" welcome screen"})}get template(){return loadTemplates([`${n.templateAppsPath}/welcomeScreen.hbs`,`${n.templatePartialsPath}/welcomeScreen/misc.hbs`,`${n.templatePartialsPath}/welcomeScreen/loot.hbs`,`${n.templatePartialsPath}/welcomeScreen/merchant.hbs`,`${n.templatePartialsPath}/welcomeScreen/seeder.hbs`,`${n.templatePartialsPath}/welcomeScreen/patchnotes.hbs`]),`${n.templateAppsPath}/welcomeScreen.hbs`}getData(e){return(e=super.getData(e)).isChecked=!VersionCheck.check(n.ns),e}activateListeners(e){super.activateListeners(e),e.find(".show-again").on("change",(e=>{let t="0.0.0";e.currentTarget.checked&&(t=VersionCheck.get(n.ns)),VersionCheck.set(n.ns,t)}));new Tabs({navSelector:".tabs",contentSelector:".content",initial:"misc",callback:()=>!0}).bind(document.querySelector(".welcome-screen"))}}class API{static async convertToken(e=canvas.tokens.controlled[0],t="loot",n={},a=!1){let s=API._response(200,"success");if(!e)return s.code=403,s.msg="No token selected or supplied",s.error=!0,a&&API._verbose(s),s;if(!game.user.isGM)return;if(!e.actor.sheet)return;const r=e.actor.sheet,o=r._state;let i="icons/svg/chest.svg",l={flags:{core:{sheetClass:"dnd5e.LootSheetNPC5e"},lootsheetnpc5e:{lootsheettype:"Loot"}}};return t&&"merchant"===t.toLowerCase()&&(l.flags.lootsheetnpc5e.lootsheettype="Merchant",i="icons/svg/coins.svg"),await r.close(),l.items=LootSheetNPC5eHelper.getLootableItems(e.actor.items,n),await e.document.actor.deleteEmbeddedDocuments("Item",Array.from(e.actor.items.keys())),await e.document.actor.update(l),await e.document.update({overlayEffect:i,vision:!1,actorData:{actor:{flags:{lootsheetnpc5e:{playersPermission:CONST.DOCUMENT_PERMISSION_LEVELS.OBSERVER}}},permission:PermissionHelper._updatedUserPermissions(e)}}),e.actor._sheet=null,delete e.actor.apps[r.appId],o>0&&e.actor.sheet.render(!0),s.data=e,a&&API._verbose(s),s}static async convertTokens(e,t="loot",n={},a=!1){const s=e?e.length>0?e:[e]:canvas.tokens.controlled;let r=API._response(200,"success");for(let e of s)r.data[e.uuid]=await API.convertToken(e,t,n,a);return a&&API._verbose(r),r}static async addLootToSelectedToken(...e){this.addLootToTarget(...e)}static async addLootToTarget(e=null,t=null,a={}){let s=[];if(null==e&&0===canvas.tokens.controlled.length)return ui.notifications.error("No tokens given or selected");s=e?e.length>=0?e:[e]:canvas.tokens.controlled,a?.verbose&&ui.notifications.info(n.ns+" | API | Loot generation started for.");let r=new TableRoller$1(t);for(let e of s){const t=e.actor?e.actor:e,n=await r.roll(a),s=new LootProcessor(n,t,a),o=await s.buildResults(a);await CurrencyHelper.addCurrenciesToActor(t,o?.currency),s.addItemsToActor(t,a)}return a?.verbose?ui.notifications.info(n.ns+" | API | Loot generation complete."):void 0}static async makeObservable(e=game.canvas.tokens.controlled,t=PermissionHelper.getPlayers(),n=!1){if(!game.user.isGM)return;const a=e?e.length>0?e:[e]:canvas.tokens.controlled;let s=API._response(200,"success");for(let e of a)e.actor&&!e.actor.hasPlayerOwner&&(e.actor.data.permission=PermissionHelper._updatedUserPermissions(e,CONST.DOCUMENT_PERMISSION_LEVELS.OBSERVER,t),await e.document.update({actor:{data:{permission:e.actor.data.permission}}}));return s.data={},n&&API._verbose(s),s}static getPermissionForPlayers(e=canvas.tokens.controlled[0],t=PermissionHelper.getPlayers(),n=!1){let a=API._response(200,"success",{});if(!e)return a.code=403,a.msg="No token selected or supplied",n&&API._verbose(a),a;for(let n of t)a.data[n.data._id]=PermissionHelper.getLootPermissionForPlayer(e.actor.data,n);return n&&API._verbose(a),a}static async updatePermissionForPlayers(){let e=API._response(200,permissions,"success");const t=canvas.tokens.controlled,n=PermissionHelper.getPlayers();for(let a of t){const t=PermissionHelper._updatedUserPermissions(a,n);e.data[a.data.uuid]=t}return verbose&&API._verbose(e),e}static getRegisteredCustomRules(){return game.settings.get(n.ns,n.settings.keys.lootseeder.ruleset)}static addCustomRule(e){let t=game.settings.get(n.ns,n.settings.keys.lootseeder.ruleset);game.settings.set(n.ns,n.settings.keys.lootseeder.ruleset,{...t,rule:e})}static switchPopulatorState(e=null){return this.toggleSeederState(e)}static toggleSeederState(e=null){return null===e&&(e=!game.settings.get(n.ns,n.settings.keys.lootseeder.autoSeedTokens)),game.settings.set(n.ns,n.settings.keys.lootseeder.autoSeedTokens,e),game.settings.get(n.ns,n.settings.keys.lootseeder.autoSeedTokens)}static async seedItemsToTokens(e=null,t=null){const n=e?[e.actor]:canvas.tokens.controlled.map((e=>e.actor));await LootSeeder.seedItemsToActors(n,t)}static _verbose(e=""){console.log(`${n.ns} | API (verbose output) | data, '|--- ' + MODULE.ns + ' API (/verbose output)---|`)}static _response(e,t="",n={},a=!1){return{code:e,data:n,msg:t,error:a}}}class ChatListener{static init(e=null){this.refresh(e)}static refresh(e=null){(e=e||document.getElementById("chat")).querySelectorAll(".lsnpc-document-link").forEach((async e=>{e.addEventListener("click",(async e=>{if(e.preventDefault(),!e.currentTarget.dataset.uuid)return;const t=await fromUuid(e.currentTarget.dataset.uuid);t&&("tokens"==t.collectionName?await t.actor.sheet.render(!0):await t.sheet.render(!0),e.stopPropagation())}))}))}}class LootsheetNPC5eHooks{static init(){Hooks.once("init",this.foundryInit),Hooks.once("ready",this.foundryReady),Hooks.once("devModeReady",this.onDevModeReady),Hooks.once("setup",this.foundrySetup),Hooks.once("aipSetup",this.onAIPSetup),Hooks.on("createToken",this.onCreateToken),Hooks.on("getSceneControlButtons",this.attachSceneControlButtons),Hooks.on("renderTokenHUD",this.attachTokenHudButtons),Hooks.on("renderChatMessage",((e,t)=>ChatListener.refresh(t[0])))}static foundrySetup(){const e=game.modules.get(n.ns);e.public={API},Object.freeze(e.public)}static foundryInit(){(class LootSheetSettings{static registerSettings(){game.settings.registerMenu(n.ns,n.settings.keys.sheet.advancedOptions,{name:game.i18n.localize("lsnpc.settings.menu.advancedOptions.name"),label:game.i18n.localize("lsnpc.settings.menu.advancedOptions.label"),icon:"fas fa-user-cog",type:LootSheetSettingsConfigApp,restricted:!0}),game.settings.register(n.ns,n.settings.keys.sheet.sheetUpdate,{name:game.i18n.localize("lsnpc.settings.sheet.sheetUpdate.name"),hint:game.i18n.localize("lsnpc.settings.sheet.sheetUpdate.hint"),scope:n.settings.scopes.world,config:!0,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.chatGracePeriod,{name:game.i18n.localize("lsnpc.settings.sheet.chatGracePeriod.name"),hint:game.i18n.localize("lsnpc.settings.sheet.chatGracePeriod.hint"),scope:n.settings.scopes.world,config:!0,default:60,range:{min:0,max:300,step:5},type:Number}),game.settings.register(n.ns,n.settings.keys.common.useBetterRolltables,{name:game.i18n.localize("lsnpc.settings.useBetterRolltables.name"),hint:game.i18n.localize("lsnpc.settings.useBetterRolltables.hint"),scope:n.settings.scopes.world,config:!1,default:!1,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.filterNaturalWeapons,{name:game.i18n.localize("lsnpc.settings.sheet.filterNaturalWeapons.name"),hint:game.i18n.localize("lsnpc.settings.sheet.filterNaturalWeapons.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.moduleDefaults,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.colorRarity,{name:game.i18n.localize("lsnpc.settings.sheet.colorRarity.name"),hint:game.i18n.localize("lsnpc.settings.sheet.colorRarity.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.ui,config:!0,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.lootItem,{name:game.i18n.localize("lsnpc.settings.sheet.lootItem.name"),hint:game.i18n.localize("lsnpc.settings.sheet.lootItem.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.loot,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.tradeItems,{name:game.i18n.localize("lsnpc.settings.sheet.tradeItems.name"),hint:game.i18n.localize("lsnpc.settings.sheet.tradeItems.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.moduleDefaults,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.lootAll,{name:game.i18n.localize("lsnpc.settings.sheet.lootAll.name"),hint:game.i18n.localize("lsnpc.settings.sheet.lootAll.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.loot,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.convertCurrency,{name:game.i18n.localize("lsnpc.settings.sheet.convertCurrency.name"),hint:game.i18n.localize("lsnpc.settings.sheet.convertCurrency.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.loot,config:!1,default:!1,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.lootCurrency,{name:game.i18n.localize("lsnpc.settings.sheet.lootCurrency.name"),hint:game.i18n.localize("lsnpc.settings.sheet.lootCurrency.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.loot,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.distributeCurrency,{name:game.i18n.localize("lsnpc.settings.sheet.distributeCurrency.name"),hint:game.i18n.localize("lsnpc.settings.sheet.distributeCurrency.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.loot,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.includeCurrencyWeight,{name:game.i18n.localize("lsnpc.settings.sheet.includeCurrencyWeight.name"),hint:game.i18n.localize("lsnpc.settings.sheet.includeCurrencyWeight.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.loot,config:!1,default:!1,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.generateChatMessages,{name:game.i18n.localize("lsnpc.settings.sheet.generateChatMessages.name"),hint:game.i18n.localize("lsnpc.settings.sheet.generateChatMessages.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.moduleDefaults,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.buyItem,{name:game.i18n.localize("lsnpc.settings.sheet.buyItem.name"),hint:game.i18n.localize("lsnpc.settings.sheet.buyItem.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.merchant,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.stackBuyConfirm,{name:game.i18n.localize("lsnpc.settings.sheet.stackBuyConfirm.name"),hint:game.i18n.localize("lsnpc.settings.sheet.stackBuyConfirm.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.merchant,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.showStackWeight,{name:game.i18n.localize("lsnpc.settings.sheet.showStackWeight.name"),hint:game.i18n.localize("lsnpc.settings.sheet.showStackWeight.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.merchant,config:!1,default:!1,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.reduceUpdateVerbosity,{name:game.i18n.localize("lsnpc.settings.sheet.reduceUpdateVerbosity.name"),hint:game.i18n.localize("lsnpc.settings.sheet.reduceUpdateVerbosity.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.moduleDefaults,config:!1,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.sheet.maxPriceIncrease,{name:game.i18n.localize("lsnpc.settings.sheet.maxPriceIncrease.name"),hint:game.i18n.localize("lsnpc.settings.sheet.maxPriceIncrease.hint"),scope:n.settings.scopes.world,group:n.settings.groups.sheet.merchant,config:!1,default:200,type:Number})}}).registerSettings(),game.socket.on(n.socket,SocketListener.handleRequest)}static foundryReady(){(class LootSeederSettings{static registerSettings(){game.settings.registerMenu(n.ns,n.settings.keys.lootseeder.seederOptions,{name:game.i18n.localize("lsnpc.settings.menu.seederOptions.name"),label:game.i18n.localize("lsnpc.settings.menu.seederOptions.label"),icon:"fas fa-user-cog",type:LootSeederSettingsConfigApp,restricted:!0}),game.settings.register(n.ns,n.settings.keys.lootseeder.autoSeedTokens,{name:game.i18n.localize("lsnpc.settings.seeder.autoSeedTokens.name"),hint:game.i18n.localize("lsnpc.settings.seeder.autoSeedTokens.hint"),scope:n.settings.scopes.world,config:!0,default:!0,type:Boolean}),game.settings.register(n.ns,n.settings.keys.common.addInterfaceButtons,{name:game.i18n.localize("lsnpc.settings.addInterfaceButtons.name"),hint:game.i18n.localize("lsnpc.settings.addInterfaceButtons.hint"),scope:n.settings.scopes.world,config:!0,default:!0,type:Boolean}),this._registerDefaultFallbacks(),this._registerCurrencySettings(),this._registerCustomFallbacks(),this._registerCreatureTypeFallbacks(),this._registerSkiplistSettings()}static async _registerDefaultFallbacks(){const e=await TableHelper.getGameWorldRolltables();game.settings.register(n.ns,n.settings.keys.lootseeder.fallbackRolltable,{name:game.i18n.localize("lsnpc.settings.seeder.fallbackRolltable.name"),hint:game.i18n.localize("lsnpc.settings.seeder.fallbackRolltable.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.fallbacks,config:!1,default:0,type:String,choices:e}),game.settings.register(n.ns,n.settings.keys.lootseeder.fallbackShopQty,{name:game.i18n.localize("lsnpc.settings.seeder.fallbackShopQty.name"),hint:game.i18n.localize("lsnpc.settings.seeder.fallbackShopQty.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.fallbacks,config:!1,default:"1d2",type:String}),game.settings.register(n.ns,n.settings.keys.lootseeder.fallbackItemQty,{name:game.i18n.localize("lsnpc.settings.seeder.fallbackItemQty.name"),hint:game.i18n.localize("lsnpc.settings.seeder.fallbackItemQty.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.fallbacks,config:!1,default:"1d2",type:String}),game.settings.register(n.ns,n.settings.keys.lootseeder.fallbackItemQtyLimit,{name:game.i18n.localize("lsnpc.settings.seeder.fallbackItemQtyLimit.name"),hint:game.i18n.localize("lsnpc.settings.seeder.fallbackItemQtyLimit.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.fallbacks,config:!1,default:"1d2",type:String})}static async _registerCreatureTypeFallbacks(){const e=this.creatureTypes;if(e&&e.length>0){game.settings.register(n.ns,n.settings.keys.lootseeder.creatureTypeFallbacks,{name:game.i18n.localize("lsnpc.settings.seeder.creatureTypeFallbacks.name"),hint:game.i18n.localize("lsnpc.settings.seeder.creatureTypeFallbacks.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.creatureTypeFallbacks,config:!1,default:!0,type:Boolean});const t=await TableHelper.getGameWorldRolltables();e.forEach(((e,a)=>{game.settings.register(n.ns,"creaturetype_default_"+e+"_table",{name:game.i18n.localize(e+"s"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.creatureTypeFallbacks,config:!1,default:0,type:String,choices:t})}))}}static async _registerCustomFallbacks(){game.settings.register(n.ns,n.settings.keys.lootseeder.useRulesets,{name:game.i18n.localize("lsnpc.settings.seeder.useRulesets.name"),hint:game.i18n.localize("lsnpc.settings.seeder.useRulesets.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.rulesets,config:!1,default:!0,type:Boolean});const e=await TableHelper.getGameWorldRolltables(),t=this.customFallbackDefaults;game.settings.register(n.ns,n.settings.keys.lootseeder.rulesets,{name:"-Rulesets-",scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.rulesets,config:!1,actions:{new:{data:e}},default:t,type:Object})}static _registerCurrencySettings(){game.settings.register(n.ns,n.settings.keys.lootseeder.generateCurrency,{name:game.i18n.localize("lsnpc.settings.seeder.generateCurrency.name"),hint:game.i18n.localize("lsnpc.settings.seeder.generateCurrency.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.currency,config:!1,default:!1,type:Boolean}),game.settings.register(n.ns,n.settings.keys.lootseeder.adjustCurrencyWithCR,{name:game.i18n.localize("lsnpc.settings.seeder.adjustCurrencyWithCR.name"),hint:game.i18n.localize("lsnpc.settings.seeder.adjustCurrencyWithCR.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.currency,config:!1,default:!1,type:Boolean}),game.settings.register(n.ns,n.settings.keys.lootseeder.lootCurrencyDefault,{name:game.i18n.localize("lsnpc.settings.seeder.lootCurrencyDefault.name"),hint:game.i18n.localize("lsnpc.settings.seeder.lootCurrencyDefault.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.currency,config:!1,default:"1d4[gp], 1d20[sp], 1d50[cp]",type:String})}static _registerSkiplistSettings(){const e=this.creatureTypes;game.settings.register(n.ns,n.settings.keys.lootseeder.useSkiplist,{name:game.i18n.localize("lsnpc.settings.seeder.useSkiplist.name"),hint:game.i18n.localize("lsnpc.settings.seeder.useSkiplist.hint"),scope:n.settings.scopes.world,group:n.settings.groups.lootseeder.skiplist,config:!1,default:!1,type:Boolean}),e.forEach(((e,t)=>{let a="skiplist_"+e;game.settings.register(n.ns,a,{name:game.i18n.format(e),label:game.i18n.format("Skiplist"),group:n.settings.groups.lootseeder.skiplist,config:!1,default:!1,scope:n.settings.scopes.world,type:Boolean})}))}static get customFallbackDefaults(){return{"data.data.details.cr_<=_1":{name:"Example_CR1",filters:[{path:"data.data.details.cr",comparison:"<=",value:1}],rolltable:"uuid_reference_to_rolltable",tags:"",state:!1},"data.data.details.cr_>=_4":{name:"Example_CR_4_or_higher",filters:[{path:"actor.labels.name",comparison:"!=",value:"Lorem"}],rolltable:"uuid_reference_to_rolltable",tags:"",state:!1}}}static get creatureTypes(){return Object.keys(CONFIG[game.system.id.toUpperCase()]?.creatureTypes)??[]}}).registerSettings(),class HandlebarsHelper{static register(){Handlebars.registerHelper("ifeq",(function(e,t,n){return e==t?n.fn(this):n.inverse(this)})),Handlebars.registerHelper("uneq",((e,t,n)=>this.uneq(e,t,n))),Handlebars.registerHelper("hexToRGB",((e,t)=>this.hexToRGB(e,t))),Handlebars.registerHelper("lootsheetprice",((e,t,n)=>this.lootsheetPrice(e,t,n))),Handlebars.registerHelper("lootsheetstackweight",((e,t)=>this.lootsheetStackWeight(e,t))),Handlebars.registerHelper("lootsheetweight",(function(e){return(Math.round(1e5*e)/1e5).toString()})),Handlebars.registerHelper("truncate",(function(e,t){if(e.length>t&&e.length>0){var n=e+" ";return n=e.substr(0,t),n=(n=e.substr(0,n.lastIndexOf(" "))).length>0?n:e.substr(0,t),new Handlebars.SafeString(n+"...")}return e})),Handlebars.registerHelper("dynamicFontSize",(function(e,t,n){let a=t;return(e=e.toString()).length>t?a=t-(e.length-t):e.length<t&&(a=t-e.length),"em"==n?a/10+n:a+n})),Handlebars.registerHelper("approximateNumber",((e,t)=>this.approximateNumber(e,t)))}static uneq(e,t,n){return e!=t?n.fn(this):n.inverse(this)}static hexToRGB(e,t){if(!e)return"rgba(0,0,0,0)";let n=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16);return t?"rgba("+n+", "+a+", "+s+", "+t+")":"rgb("+n+", "+a+", "+s+")"}static approximateNumber(e,t=1){if(isNaN(e)||0===e)return 0;let n=Math.floor(Math.log10(e));n<1&&(n=1);let a=Math.floor(n/3),s=["","k","M","B","T","P","E","Z","Y"][a],r=e/Math.pow(10,3*a);return parseFloat(r.toFixed(t))+s}static lootsheetStackWeight(e,t){return game.settings.get(n.ns,"showStackWeight")?`/${(e*t).toLocaleString()}`:""}static lootsheetPrice(e,t=100,n=!0){return parseFloat((e*t/100).toFixed(5))+(n?" GP":"")}}.register(),game.user.isGM&&VersionCheck.check(n.ns)&&function renderWelcomeScreen(){(new WelcomeScreen).render(!0)}(),LootsheetNPC5eHooks._handleMigrations(),ChatListener.init()}static refreshChatListeners(e){(e=e??document.getElementById("chat")).querySelectorAll(".lsnpc-document-link").forEach((async e=>{e.addEventListener("click",(async e=>{if(e.preventDefault(),!e.currentTarget.dataset.uuid)return;const t=await fromUuid(e.currentTarget.dataset.uuid);t&&("tokens"==t.collectionName?await t.actor.sheet.render(!0):await t.sheet.render(!0),e.stopPropagation())}))}))}static async onAIPSetup(){const e=game.modules.get("autocomplete-inline-properties").API,t=e.CONST.DATA_MODE,a={packageName:n.ns,sheetClasses:[{name:"LootSeederRuleEditor",fieldConfigs:[{selector:".data-path-input",showButton:!0,allowHotkey:!0,dataMode:t.OWNING_ACTOR_DATA}]}]};e.PACKAGE_CONFIG.push(a)}static async onCreateToken(e,t,a,s){if(!game.user.isGM)return;if(!game.settings.get(n.ns,n.settings.keys.lootseeder.autoSeedTokens))return;if(!e.actor||e.data.actorLink)return;const r=e.actor;ActorHelper.skipByCreatureType(r)||await LootSeeder.seedItemsToActors([r])}static attachSceneControlButtons(e){let t=e.find((e=>"token"==e.name));t&&t.tools.push({name:"lsnpc-loot-seeder",title:"Generate Loot for selected token(s)",icon:"fas fa-gem",visible:game.user.isGm,onClick:()=>LootSeeder.seedItemsToActors(function getActorStack(e=null){return ActorHelper.getActorStack(e)}()),button:!0})}static attachTokenHudButtons(e){if(!game.settings.get(n.ns,n.settings.keys.common.addInterfaceButtons))return;const t=e.object.document;if(!t.actor)return;if(!t.actor.isToken)return;if(t.actorLink)return;const a=document.querySelector("#token-hud .left");let s=document.createElement("nav"),r=document.createElement("div"),o=document.createElement("img"),i=game.i18n.localize("Make Lootable");s.classList.add("lsnpc5e-nav"),game.user.isGM&&(r.classList.add("lsnpc5e-hud-make-observable","control-icon"),r.dataset.action="makeObservable",r.addEventListener("click",(async e=>{if(game.user.isGM){ui.notifications.info("Lootsheet: Converting token(s) to lootable.");const e=game.modules.get("lootsheetnpc5e").public.API;await e.convertTokens()}})),o.src="icons/svg/eye.svg",o.alt=i,r.title=i,r.appendChild(o),s.appendChild(r)),a&&a.appendChild(s)}static onDevModeReady({registerPackageDebugFlag:e}){e(n.ns)}static _handleMigrations(e=""){const t=game.actors.filter((e=>"npc"===e.data.type&&"dnd5e.LootSheet5eNPC"===e?.data?.flags?.core?.sheetClass));for(let e of t)e.update({data:{flags:{core:{sheetClass:"dnd5e.LootSheetNPC5e"}}}})}static _skipTokenByType(e){if(!game.settings.get(n.ns,n.settings.keys.lootseeder.useSkiplist))return!1;const t=e.actor.data.data.details.type.value;return!!Object.keys(CONFIG.DND5E.creatureTypes).includes(t)&&game.settings.get(n.ns,"skiplist_"+t)}}Actors.registerSheet("dnd5e",class LootSheetNPC5e extends e{get template(){let e=[n.templateAppsPath+"/lootsheet.hbs",n.templatePartialsPath+"/body.hbs",n.templatePartialsPath+"/footer.hbs",n.templatePartialsPath+"/header.hbs",n.templatePartialsPath+"/buttons/lootAll.hbs",n.templatePartialsPath+"/buttons/lootCurrency.hbs",n.templatePartialsPath+"/buttons/splitCurrency.hbs",n.templatePartialsPath+"/header/navigation.hbs",n.templatePartialsPath+"/list/default.hbs",n.templatePartialsPath+"/list/currency.hbs",n.templatePartialsPath+"/list/actions.hbs",n.templatePartialsPath+"/trade/index.hbs",n.templatePartialsPath+"/trade/currency.hbs",n.templatePartialsPath+"/trade/inventory.hbs"];return game.user.isGM&&(e.push(n.templatePartialsPath+"/gm/gm-settings.hbs"),e.push(n.templatePartialsPath+"/gm/inventory.hbs"),e.push(n.templatePartialsPath+"/gm/lootsheet-type.hbs"),e.push(n.templatePartialsPath+"/gm/permissions.hbs"),e.push(n.templatePartialsPath+"/gm/styling.hbs")),loadTemplates(e),!game.user.isGM&&this.actor.limited?"systems/dnd5e/templates/actors/limited-sheet.html":n.templateAppsPath+"/lootsheet.hbs"}static get defaultOptions(){const e=super.defaultOptions;let t={classes:["dnd5e","sheet","actor","lsnpc","npc","npc-sheet"]};return game.user.isGM&&t.classes.push("lsnpc-gmview"),mergeObject(e,t)}async getData(){const e=await this._prepareSheetType("lootsheettype");let t=super.getData(),a=t.actor.items;t.lootsheettype=e,t.priceModifier=1,t.currency=CurrencyHelper.cleanCurrency(t.data.currency),game.user.isGM&&(t=await this._prepareGMSettings(t)),t=await this._enrichByType(t,e),a=this._enrichItems(a),a=LootSheetNPC5eHelper.getLootableItems(a);let s=this._getTotals(a,t.priceModifier);return t.isGM=!!game.user.isGM,t.isToken=!!this?.token,t.items=a,t.interactingActor=game.user?.character?.name||"No Character selected",game.user?.character?.data?.data?.currency?t.interactingActorFunds={currency:CurrencyHelper.cleanCurrency(game.user?.character?.data?.data?.currency)}:t.interactingActorFunds={currency:[]},t.totalItems=a.length,t.totalWeight=s.weight.toLocaleString("en"),t.totalPrice=s.price.toLocaleString("en")+" gp",t.totalQuantity=s.quantity,t.observerCount=PermissionHelper.getEligableActors(this.actor).length,t.distributeCoins=game.settings.get(n.ns,"distributeCurrency"),t.lootCurrency=game.settings.get(n.ns,"lootCurrency"),t.lootAll=game.settings.get(n.ns,"lootAll"),t.colorRarity=game.settings.get(n.ns,"colorRarity"),t}render(e=!1,t={}){let a=this.options.classes;const s=this.actor.getFlag(n.ns,"sheettint.style"),r=this.actor.getFlag(n.ns,"darkMode")||!1,o=a.findIndex((e=>e.indexOf("styled")>=0)),i=a.findIndex((e=>e.indexOf("darkMode")>=0));o>0&&a.splice(o,1),i>0&&a.splice(i,1),"true"===r&&a.push("lsnpc-darkMode"),s&&s.length&&a.push("styled "+s),this.options.classes=[...new Set(a)],super.render(e,t)}async _enrichByType(e,t){const a={buy:100,sell:100};if("Merchant"===t)e.priceModifier=await this.actor.getFlag(n.ns,n.flags.priceModifier),"object"!=typeof e.priceModifier&&await this.actor.setFlag(n.ns,n.flags.priceModifier,a),e.priceModifier=await this.actor.getFlag(n.ns,n.flags.priceModifier);return e}_enrichItems(e){for(let t of this.actor.getEmbeddedCollection("Item")){let n=e.find((e=>e._id==t.id));n&&(n.uuid=t.uuid)}return e}_getTotals(e,t=1){let a=0,s=0,r=0;return e.forEach((e=>s+=Math.round(e.data.quantity*(e.data.price*t.sell/100)))),e.forEach((e=>r+=Math.round(100*e.data.quantity/100))),e.forEach((e=>a+=Math.round(e.data.quantity*e.data.weight*100/100))),game.settings.get(n.ns,"includeCurrencyWeight")&&(a+=(Object.values(this.actor.data.data.currency).reduce((function(e,t){return e+t}),0)/50).toNearest(.01)),{weight:a,price:s,quantity:r}}async _prepareSheetType(e){let t=this.actor.getFlag(n.ns,e);return t||this.actor.data.flags.lootsheetnpc5e||await this.actor.update({flags:n.flags.default}),t}async _onSubmit(e){e.preventDefault(),super._onSubmit(e)}async activateListeners(e){super.activateListeners(e);const t=new SheetListener(this.id,this.token,this.actor,this.options);await t.activateListeners()}_prepareItems(e){const t=e.items,n=LootSheetNPC5eHelper.getLootableItems(t),a=game.user?.character;for(let e of this.actor.getEmbeddedCollection("Item"))t.find((t=>t._id==e.id)).uuid=e.uuid;if(e.actor.actions=LootSheetNPC5eHelper.sortAndGroupItems(t),e.actor.lootableItems=LootSheetNPC5eHelper.sortAndGroupItems(n),a){const t=this._getTradeablePlayerInventory(a);e.actor.playerInventory=LootSheetNPC5eHelper.sortAndGroupItems(t)}}_getTradeablePlayerInventory(e){let t=duplicate(e.data.items);for(let n of e.getEmbeddedCollection("Item"))t.find((e=>e._id==n.id)).uuid=n.uuid;return t=t.filter((e=>!!(e.data?.equipped&&e.data.quantity>1)||!e.data?.equipped)),t=t.map((e=>(e.data?.equipped&&(e.data.quantity-=1),e))),LootSheetNPC5eHelper.getLootableItems(t)}async _prepareGMSettings(e){const t=PermissionHelper.getEligableActors(this.actor),n=PermissionHelper.getPermissionInfo(),a=this._playerPermissions(e),s=CurrencyHelper.getSplitByObservers(e.data.currency,t.length),r=await TableHelper.getGameWorldRolltables();let o={};return o.players=a.playerData,o.observerCount=t.length,o.currency=s,o.permissions=n,o.playersPermission=a.playersPermission,o.playersPermissionIcon=PermissionHelper.getPermissionInfo(a.playersPermission),o.playersPermissionDescription=PermissionHelper.getPermissionInfo(a.playersPermission)?.description,e.rolltables=r,e.actor.flags.lootsheetnpc5e={...this.actor.data.flags?.lootsheetnpc5e,...o},e}_playerPermissions(e){const t=game.users.players;game.user.isGM&&game.user.character&&t.push(game.user);let n=[],a=-1;for(let s of t){const t=game.actors.get(s.data.character);if(t){s.actor=t.data.name,s.actorId=t.data._id,s.playerId=s.data._id,s.lootPermission=PermissionHelper.getLootPermissionForPlayer(e.actor,s),a=a<0?s.lootPermission:a;const r=PermissionHelper.getPermissionInfo(s.lootPermission);s.class=r.class,s.borderClass=r.borderClass,s.lootPermissionDescription=r.description,n.push(s)}}return{playerData:n,commonPlayersPermission:a}}},{types:["npc"],makeDefault:!1}),LootsheetNPC5eHooks.init();
//# sourceMappingURL=lootsheetnpc5e.js.map
