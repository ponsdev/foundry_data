(()=>{"use strict";var e={561:(e,t,a)=>{a.r(t)},323:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.overrideItemSheet=void 0,t.overrideItemSheet=function(){const e=Items.registeredSheets.find((e=>"ItemSheetPF2e"===e.name));function t(e){const{item:t}=e;return t.flags.persistent&&(e.detailsTemplate=()=>"modules/pf2e-persistent-damage/templates/persistent-details.html",e.hasDetails=!0),e}const a=e.prototype.getData;e.prototype.getData=function(...e){const s=a.bind(this)(...e);return s instanceof Promise?s.then((e=>t(e))):t(s)},console.log("PF2E Persistent | Registered Item Sheet Modification")}},420:(e,t)=>{function a(e){var t,a,s;const n=e.flags.persistent;if(n){let e=null!==(t=n.damageType)&&void 0!==t?t:null===(a=n.type)||void 0===a?void 0:a.toLowerCase();return"bleeding"===e&&(e="bleed"),{damageType:e,dc:null!==(s=n.dc)&&void 0!==s?s:15,value:n.value}}}function s(e){const{damageType:t,value:a,dc:s}=e,n=game.i18n.localize(CONFIG.PF2E.damageTypes[t]),i=15===s?"":` DC${String(s)}`;return`${game.i18n.localize("PF2E.condition.persistent-damage.name")} [${n} ${String(a)}${i}]`}Object.defineProperty(t,"__esModule",{value:!0}),t.createPersistentEffect=t.createPersistentTitle=t.getPersistentData=t.typeImages=void 0,t.typeImages={bleed:"systems/pf2e/icons/spells/blade-barrier.webp",piercing:"systems/pf2e/icons/equipment/weapons/throwing-knife.webp",bludgeoning:"systems/pf2e/icons/equipment/weapons/bola.webp",slashing:"systems/pf2e/icons/equipment/weapons/scimitar.webp",fire:"systems/pf2e/icons/spells/flaming-sphere.webp",acid:"systems/pf2e/icons/spells/blister.webp",cold:"systems/pf2e/icons/spells/chilling-spray.webp",electricity:"systems/pf2e/icons/spells/chain-lightning.webp",sonic:"systems/pf2e/icons/spells/cry-of-destruction.webp",force:"systems/pf2e/icons/spells/magic-missile.webp",mental:"systems/pf2e/icons/spells/modify-memory.webp",poison:"systems/pf2e/icons/spells/acidic-burst.webp",lawful:"systems/pf2e/icons/equipment/adventuring-gear/merchant-scale.webp",chaotic:"systems/pf2e/icons/spells/dinosaur-form.webp",good:"systems/pf2e/icons/spells/angelic-wings.webp",evil:"systems/pf2e/icons/spells/daemonic-pact.webp",positive:"systems/pf2e/icons/spells/moment-of-renewal.webp",negative:"systems/pf2e/icons/spells/grim-tendrils.webp"},t.getPersistentData=a,Hooks.on("preUpdateItem",((e,t)=>{var n,i;if(null===(n=null==t?void 0:t.flags)||void 0===n?void 0:n.persistent){const n=null===(i=e.data.flags)||void 0===i?void 0:i.persistent,o=a({flags:{persistent:mergeObject({...n},t.flags.persistent)}});t.flags.persistent=o,t.name=s(o);const r=`persistent-damage-${o.damageType}`;mergeObject(t,{data:{slug:r}})}})),t.createPersistentTitle=s,t.createPersistentEffect=function(e){return{type:"effect",name:s(e),data:{slug:`persistent-damage-${e.damageType}`,description:{value:"Persistent Damage from some source. Deals damage at the end of each turn and needs a check to remove."},duration:{expiry:"turn-end",unit:"unlimited",value:0,sustained:!1},rules:[],tokenIcon:{show:!0}},flags:{persistent:e},img:t.typeImages[e.damageType]}}},611:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PersistentDamagePF2e=void 0;const s=a(420),n=a(83),i=a(421);function o(e){return{damageType:e,name:CONFIG.PF2E.damageTypes[e],img:s.typeImages[e]}}t.PersistentDamagePF2e=class{async showDialog({actor:e}={}){const t=t=>{var a;const s=t.find("[name=Type]:checked").val(),n=t.find("[name=Damage]").val(),i=Number(t.find("[name=DC]").val())||15;if(canvas.ready){const t=null!=e?e:null===(a=canvas.tokens.controlled)||void 0===a?void 0:a.map((e=>e.actor));this.addPersistentDamage(t,s,n,isNaN(i)?15:i)}return!1},a=game.i18n.localize(e?"PF2E-PD.Dialog.Apply":"PF2E-PD.Dialog.Add"),n=Object.keys(s.typeImages).map(o),i=new Dialog({title:game.i18n.localize("PF2E-PD.Dialog.Title"),content:await renderTemplate("modules/pf2e-persistent-damage/templates/persistent-damage-dialog.html",{types:n}),buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:a,callback:t},no:{icon:"<i class='fas fa-times'></i>",label:game.i18n.localize("PF2E-PD.Dialog.Close")}},default:"yes",render:a=>{a.find(".types label").on("click",(()=>{setTimeout((()=>a.find("input[name=Damage]").trigger("focus")),0)})),e||a.find(".dialog-button.yes").off().on("click",(()=>t(a)))}},{id:"pf2e-persistent-dialog"});return i.render(!0),i}async addPersistentDamage(e,t,a,n=15){var o;const r=[];if(t||r.push("Missing damage type"),a||r.push("Missing damage value"),r.length>0)return void ui.notifications.error("Persistent Damage Errors: "+r.join("; "));try{new Roll(a).evaluate({async:!1})}catch(e){return void ui.notifications.error(e)}const l=Array.isArray(e)?e:[e];if(0==l.length)return void ui.notifications.warn(game.i18n.localize("PF2E-PD.Notification.MissingActor"));const c=s.createPersistentEffect({damageType:t,value:a,dc:n});for(const e of l){const s=PF2EPersistentDamage.getPersistentDamage(e,t),{average:n}=i.calculateRoll(null===(o=null==s?void 0:s.data.flags.persistent)||void 0===o?void 0:o.value),{average:r}=i.calculateRoll(a);!s||r>=n?(s&&await this.removePersistentDamage(e,t),await e.createEmbeddedDocuments("Item",[c]),s?ui.notifications.info(game.i18n.localize("PF2E-PD.Notification.Overwritten")):ui.notifications.info(game.i18n.format("PF2E-PD.Notification.Created",{damageType:t}))):s&&ui.notifications.info(game.i18n.localize("PF2E-PD.Notification.NotOverwritten"))}}async removePersistentDamage(e,t){const a=e.items.filter((e=>{var a;return(null===(a=e.data.flags.persistent)||void 0===a?void 0:a.damageType)===t}));await(null==e?void 0:e.deleteEmbeddedDocuments("Item",a.map((e=>e.id))))}getPersistentDamage(e,t){return e.items.find((e=>{var a;return(null===(a=e.data.flags.persistent)||void 0===a?void 0:a.damageType)===t}))}async rollRecoveryCheck(e,t){const a=t instanceof Item?t:PF2EPersistentDamage.getPersistentDamage(e,t),s=null==a?void 0:a.data.flags.persistent;if(!s)return;const i=await new Roll("1d20").evaluate({async:!0}),o=i.total>=s.dc,r=game.i18n.localize(CONFIG.PF2E.damageTypes[s.damageType]),l=await i.toMessage({speaker:ChatMessage.getSpeaker({actor:e}),flavor:await renderTemplate("modules/pf2e-persistent-damage/templates/chat/recover-persistent-card.html",{data:s,typeName:r,success:o})});return o&&game.settings.get(n.MODULE_NAME,"auto-resolve")&&await a.delete(),l}async processPersistentDamage(e){const t=game.settings.get(n.MODULE_NAME,"auto-recover"),a=game.settings.get(n.MODULE_NAME,"auto-resolve"),i=game.settings.get(n.MODULE_NAME,"hide-rolls"),o=[];for(const{actor:l,token:c}of(r=e,(Array.isArray(r)?r:[r]).map((e=>{var t,a;return e instanceof Actor?{actor:e,token:null===(t=e.token)||void 0===t?void 0:t.object}:(null===(a=null==e?void 0:e.data)||void 0===a?void 0:a.actorId)&&!e.actor?(ui.notifications.warn("TOKEN.WarningNoActor",{localize:!0}),null):{actor:e.actor,token:e}})).filter((e=>e)))){const e=l.itemTypes.effect.filter((e=>e.data.data.rules.some((e=>"PF2E.RuleElement.PersistentDamage"===e.key))||e.data.flags.persistent));if(!e)continue;const r=l.hasPlayerOwner,d=t===n.AutoRecoverMode.Always||t===n.AutoRecoverMode.NPCOnly&&!r;for(const t of e){const e=s.getPersistentData(t.data),{damageType:r,value:m,dc:g}=e,p=game.i18n.localize(CONFIG.PF2E.damageTypes[r]),u=await new Roll(m,{item:t.data}).evaluate({async:!0}),f=d&&TextEditor.enrichHTML("[[1d20]]"),v=d&&Number($(f).text())>=g,y="modules/pf2e-persistent-damage/templates/chat/persistent-card.html",P=CONFIG.ChatMessage.documentClass,E=P.getSpeaker({actor:l,token:c}),D=c?`${c.scene.id}.${c.id}`:void 0,T=await renderTemplate(y,{actor:l,token:c,effect:t,data:e,inlineCheck:f,typeName:p,autoCheck:d,success:v,tokenId:D}),h=i===n.RollHideMode.Never?"publicroll":i===n.RollHideMode.Always?"blindroll":game.settings.get("core","rollMode"),w=await P.create({speaker:E,flavor:T,flags:{persistent:e},type:CONST.CHAT_MESSAGE_TYPES.ROLL,roll:u,sound:CONFIG.sounds.dice},{rollMode:h});d&&a&&v&&l.deleteEmbeddedDocuments("Item",[t.id]),o.push(w)}}var r;return o}async _startDrag(e){e.stopPropagation();const t=e.dataTransfer;if(!t)return;const a=e.target,n=a.dataset.value,i=a.dataset.damageType,o=Number(a.dataset.dc)||15,r=s.createPersistentEffect({value:n,damageType:i,dc:o});t.setData("text/plain",JSON.stringify({type:"Item",data:r}))}}},83:(e,t)=>{function a(){const e=game.modules.get(t.MODULE_NAME);if(e.active)return e.data.version}var s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.registerSettings=t.RollHideMode=t.AutoRecoverMode=t.MODULE_NAME=void 0,t.MODULE_NAME="pf2e-persistent-damage",function(e){e[e.Always=1]="Always",e[e.NPCOnly=2]="NPCOnly",e[e.Never=3]="Never"}(s=t.AutoRecoverMode||(t.AutoRecoverMode={})),(n=t.RollHideMode||(t.RollHideMode={}))[n.Never=1]="Never",n[n.Normal=2]="Normal",n[n.Always=3]="Always",t.registerSettings=function(){game.settings.register(t.MODULE_NAME,"migration",{name:"Migration Version",hint:"Used to perform migrations",config:!1,default:{version:a()},scope:"world",type:Object}),game.settings.register(t.MODULE_NAME,"auto-roll",{name:game.i18n.localize("PF2E-PD.SETTINGS.AutoProcess.name"),hint:game.i18n.localize("PF2E-PD.SETTINGS.AutoProcess.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(t.MODULE_NAME,"auto-recover",{name:game.i18n.localize("PF2E-PD.SETTINGS.AutoRecover.name"),hint:game.i18n.localize("PF2E-PD.SETTINGS.AutoRecover.hint"),scope:"world",config:!0,type:Number,choices:{[s.Always]:game.i18n.localize("PF2E-PD.SETTINGS.AutoRecover.option1"),[s.NPCOnly]:game.i18n.localize("PF2E-PD.SETTINGS.AutoRecover.option2"),[s.Never]:game.i18n.localize("PF2E-PD.SETTINGS.AutoRecover.option3")},default:s.NPCOnly}),game.settings.register(t.MODULE_NAME,"auto-resolve",{name:game.i18n.localize("PF2E-PD.SETTINGS.AutoResolve.name"),hint:game.i18n.localize("PF2E-PD.SETTINGS.AutoResolve.hint"),scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(t.MODULE_NAME,"hide-rolls",{name:game.i18n.localize("PF2E-PD.SETTINGS.HideRolls.name"),hint:game.i18n.localize("PF2E-PD.SETTINGS.HideRolls.hint"),scope:"world",config:!0,type:Number,choices:{1:game.i18n.localize("PF2E-PD.SETTINGS.HideRolls.option1"),2:game.i18n.localize("PF2E-PD.SETTINGS.HideRolls.option2"),3:game.i18n.localize("PF2E-PD.SETTINGS.HideRolls.option3")},default:1})}},421:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.calculateRoll=void 0,t.calculateRoll=function(e){if(!e)return{max:0,min:0,average:0};const t=new Roll(e).evaluate({maximize:!0}).total,a=new Roll(e).evaluate({minimize:!0}).total;return{min:a,average:(t-a)/2+a,max:t}}}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var i=t[s]={exports:{}};return e[s](i,i.exports,a),i.exports}a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=a(611),t=a(83),s=a(323),n=a(420);a(561),Hooks.on("init",(()=>{t.registerSettings(),loadTemplates(["modules/pf2e-persistent-damage/templates/persistent-details.html"]),window.PF2EPersistentDamage=new e.PersistentDamagePF2e})),Hooks.on("ready",(()=>{s.overrideItemSheet()})),Hooks.on("renderChatMessage",(async(e,t)=>{e.data.flags.persistent&&t.find("button[data-action=check][data-check=flat]").off().on("click",(e=>{e.preventDefault();const a=t.find(".chat-card"),s=a.attr("data-effect-id");let n=null;const i=a.attr("data-token-id");if(i){const[e,t]=i.split("."),a=game.scenes.get(e),s=null==a?void 0:a.data.tokens.get(t);if(!s)return;n=s.actor}else n=game.actors.get(a.attr("data-actor-id"));const o=null==n?void 0:n.items.get(s);PF2EPersistentDamage.rollRecoveryCheck(n,o)})),t.find(".token-link").on("click",(e=>{const t=e.target.closest(".token-link"),a=null==t?void 0:t.dataset.tokenId;if(a&&canvas.ready){const e=canvas.tokens.get(a);null==e||e.control({releaseOthers:!0})}}))})),Hooks.on("pf2e.endTurn",((e,a,s)=>{var n;game.settings.get(t.MODULE_NAME,"auto-roll")&&game.user.id===s&&window.PF2EPersistentDamage.processPersistentDamage(null!==(n=e.token)&&void 0!==n?n:e.actor)})),Hooks.on("renderTokenHUD",((e,t,a)=>{setTimeout((()=>{t.find("div.status-effects img[data-effect=persistent-damage]").off().on("click",(e=>{if(0!==e.button||!canvas.ready)return;e.preventDefault(),e.stopPropagation();const t=canvas.tokens.get(a._id);t&&PF2EPersistentDamage.showDialog({actor:t.actor})}))}),0)}));const i=TextEditor.enrichHTML;TextEditor.enrichHTML=function(...e){const t=i.call(this,...e),a=document.createElement("div");return a.innerHTML=String(t),a.querySelectorAll(".inline-roll:not(.inline-result)").forEach((e=>{const t=function(e){var t;const a=e.dataset.formula;try{const s=new Roll(a);if(1===s.terms.length&&"flavor"in s.terms[0].options&&s.terms[0].options.flavor){const e=s.terms[0],t=e.options.flavor,a=new Set(t.split(",").map((e=>e.trim().toLowerCase())));if(e instanceof PoolTerm&&a.has("persistent")){const t=e.terms[0].toString(),s=[...a.values()].find((e=>e in n.typeImages));if(s)return{formula:t,damageType:s}}}const i=e.dataset.flavor;if(!i)return;const o=i.match(/^persistent ([A-Za-z]+)/i);if(!o)return;const r=null===(t=o[1])||void 0===t?void 0:t.toLowerCase();if(r in n.typeImages)return{formula:e.dataset.formula,damageType:r}}catch(e){console.error(`PF2E Persistent | Error parsing formula in inline formula ${a}`,e)}}(e);if(!t)return;const{formula:a,damageType:s}=t,i=$(e).next();i.hasClass("entity-link")&&"lDVqvLKA6eF3Df60"===i.attr("data-id")&&i.remove();const o=n.createPersistentTitle({damageType:s,value:a,dc:15});e.classList.add("persistent-link"),e.draggable=!0,e.dataset.value=a,e.dataset.damageType=s,e.innerHTML=`<i class="fas fa-suitcase"></i> ${o}`,e.setAttribute("ondragstart","PF2EPersistentDamage._startDrag(event)")})),a.innerHTML},Hooks.on("renderChatMessage",((e,t)=>{t.find(".persistent-link:not([ondragstart])").attr("ondragstart","PF2EPersistentDamage._startDrag(event)")}))})()})();