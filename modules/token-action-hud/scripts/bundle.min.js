!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";class Logger{static info(...t){console.log("Token Action HUD info |",...t)}static error(...t){console.error("Token Action HUD error |",...t)}static debug(...t){game.settings.get("token-action-hud","debug")&&Logger.info("debug:",...t)}}const t="tokenactionhud.settings.itemMacroReplace.showBoth",e="tokenactionhud.settings.itemMacroReplace.showItemMacro",i="tokenactionhud.settings.itemMacroReplace.showOriginal",updateFunc$1=t=>{Logger.debug("Settings updated. Refreshing HUD"),game.tokenActionHUD&&game.tokenActionHUD.updateSettings()};let a;function get(t){return game.settings.get(a,t)}class TagDialog extends Dialog{i18n=t=>game.i18n.localize(t);tagify=null;constructor(t,e){super(e),this.data=t}static showDialog(t,e,i,a,s,n){TagDialog._prepareHook(t,e,i);let o=Handlebars.compile("{{> modules/token-action-hud/templates/tagdialog.hbs}}")(s);new TagDialog({title:a,content:o,buttons:{accept:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("tokenactionhud.accept"),callback:async t=>{let e,i=TagDialog.tagify.value.map((t=>({id:t.id,value:t.value,type:t.type}))),a=t.find('select[id="token-action-hud-index"]');a.length>0&&(e=a[0]?.value),await n(i,e,t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("tokenactionhud.cancel")}},default:"accept"}).render(!0)}static _prepareHook(t,e,i){Hooks.once("renderTagDialog",((a,s,n)=>{s.css("height","auto");var o=s.find('select[id="token-action-hud-index"]');o.length>0&&(i&&o.val(i),o.css("background","#fff"),o.css("color","#000"));var r=s.find('input[class="token-action-hud-taginput"]');if(r.length>0){let i={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:20,classname:"tags-look",enabled:0,closeOnSelect:!1}};t&&(i.whitelist=t),TagDialog.tagify=new Tagify(r[0],i);var l=$(document).find(".tagify");l.css("background","#fff"),l.css("color","#000"),e&&TagDialog.tagify.addTags(e);let a=s.find('button[class="tags--removeAllBtn"]');a.on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify)),a.css("float","right"),a.css("width","auto")}}))}_onKeyDown(t){if("Escape"===t.key&&!t.target.className.includes("tagify"))return t.preventDefault(),t.stopPropagation(),this.close();if("Enter"===t.key&&this.data.default&&!t.target.className.includes("tagify")){t.preventDefault(),t.stopPropagation();const e=this.data.buttons[this.data.default];return this.submit(e)}}}class CompendiumHelper{constructor(){}static getCompendiumChoicesAsTagifyEntries(){return("filter"in game.packs.entries?game.packs.entries:game.packs).filter((t=>["JournalEntry","Macro","RollTable","Playlist"].includes(t.documentName))).filter((t=>game.user.isGM||!t.private)).map((t=>({id:`${t.metadata.package}.${t.metadata.name}`,value:t.metadata.label,type:"comp"})))}static exists(t){return!!game.packs.get(t)}static async getEntriesForActions(t,e){let i=await CompendiumHelper.getCompendiumEntries(t),a=CompendiumHelper.getCompendiumMacroType(t);return i.map((i=>{let s=[a,t,i._id].join(e),n=CompendiumHelper.getImage(i);return{name:i.name,encodedValue:s,id:i._id,img:n}}))}static getCompendiumMacroType(t){let e=game?.packs?.get(t);if(!e)return"";switch(e.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}static async getCompendiumEntriesForFilter(t){return(await CompendiumHelper.getCompendiumEntries(t)).map((t=>({value:t.name,id:t._id})))}static async getCompendiumEntries(t){let e=game.packs.get(t);if(!e)return[];let i=e.index.size>0?e.index:await e.getIndex();if("Playlist"===e.documentName){return await CompendiumHelper._getPlaylistEntries(e)}return i}static async _getPlaylistEntries(t){return(await t.getContent()).reduce(((t,e)=>(e.sounds.forEach((i=>{t.push({_id:`${e._id}>${i._id}`,name:i.name})})),t)),[])}static getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}}class TagDialogHelper{static showFilterDialog(t,e){TagDialogHelper._showFilterDialog(t,e)}static showSubcategoryDialogue(t,e,i){TagDialogHelper._showSubcategoryDialogue(t,e,i)}static showCategoryDialog(t){TagDialogHelper._showCategoryDialog(t)}static async submitCategories(t,e,i){await t.submitCategories(e,i),Hooks.callAll("forceUpdateTokenActionHUD")}static async submitSubcategories(t,e,i){await t.submitSubcategories(e,i),Hooks.callAll("forceUpdateTokenActionHUD")}static async submitFilter(t,e,i,a){await t.setFilteredElements(e,i,a),Hooks.callAll("forceUpdateTokenActionHUD")}static _showFilterDialog(t,e){let i=t.getSuggestions(e),a=t.getFilteredElements(e),s=t.isBlocklist(e)?1:0,n=game.i18n.localize("tokenactionhud.filterTitle"),o={topLabel:game.i18n.localize("tokenactionhud.filterTagExplanation"),placeholder:game.i18n.localize("tokenactionhud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenactionhud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenactionhud.blocklistLabel"),index:[{value:0,text:game.i18n.localize("tokenactionhud.allowlist")},{value:1,text:game.i18n.localize("tokenactionhud.blocklist")}]};TagDialog.showDialog(i,a,s,n,o,(async(i,a)=>{let s=0!=parseInt(a);await TagDialogHelper.submitFilter(t,e,i,s)}))}static _showSubcategoryDialogue(t,e,i){let a=CompendiumHelper.getCompendiumChoicesAsTagifyEntries(),s=t.getCategorySubcategoriesAsTagifyEntries(e),n=game.i18n.localize("tokenactionhud.subcategoryTagTitle")+` (${i})`,o={topLabel:game.i18n.localize("tokenactionhud.subcategoryTagExplanation"),placeholder:game.i18n.localize("tokenactionhud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenactionhud.clearButton"),advancedCategoryOptions:game.user.getFlag("token-action-hud",`categories.${e}.advancedCategoryOptions`)};TagDialog.showDialog(a,s,null,n,o,(async(i,a,s)=>{let n=i.map((t=>({id:t.id,title:t.value,type:t.type})));await TagDialogHelper.submitSubcategories(t,e,n);const o={customWidth:parseInt(s.find('input[name="custom-width"]').val()),compactView:s.find('input[name="compact-view"]').prop("checked"),characterCount:parseInt(s.find('input[name="character-count"]').val())};await game.user.setFlag("token-action-hud",`categories.${e}.advancedCategoryOptions`,o)}))}static _showCategoryDialog(t){let e=t.getExistingCategories(),i=t.arePush()?1:0,a=game.i18n.localize("tokenactionhud.categoryTagTitle"),s={topLabel:game.i18n.localize("tokenactionhud.categoryTagExplanation"),placeholder:game.i18n.localize("tokenactionhud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenactionhud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenactionhud.pushLabelExplanation"),index:[{value:0,text:game.i18n.localize("tokenactionhud.unshift")},{value:1,text:game.i18n.localize("tokenactionhud.push")}]};TagDialog.showDialog(null,e,i,a,s,(async(e,i)=>{let a=0!=parseInt(i);await TagDialogHelper.submitCategories(t,e,a)}))}}class CategoryResizer{static resizeHoveredCategory(t){let e=function jq(t){return"#"+t.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")}(t),i=$(e);if(!i[0])return;let a=i.find(".tah-content"),s=i.hasClass("oneLine"),n=i.find(".tah-actions");if(0===n.length)return;const o=t.replace("tah-category-",""),r=game.user.getFlag("token-action-hud",`categories.${o}.advancedCategoryOptions.customWidth`);if(r)return CategoryResizer.resizeActions(n,r);CategoryResizer.resizeActions(n,300);let l=$(document).find("#hotbar").offset().top-20,c=$(document).find("#sidebar").offset().left-20,d=CategoryResizer.calculateMaxRequiredWidth(n);for(;CategoryResizer.shouldIncreaseWidth(a,n,d,l,c,s);){let t=n[0].getBoundingClientRect().width,e=n.width();if(t>d)return;let i=e+30;CategoryResizer.resizeActions(n,i)}for(;CategoryResizer.shouldShrinkWidth(a,n,200,l,c,s);){let t=n[0].getBoundingClientRect().width,e=n.width();if(t<200)return;let i=e-30;CategoryResizer.resizeActions(n,i)}}static calculateMaxRequiredWidth(t){let e=0;return t.each((function(){let t=$(this);if(t.hasClass("excludeFromWidthCalculation"))return;let i=0;Array.from(t.children()).forEach((t=>{let e=$(t),a=e.width(),s=parseInt(e.css("marginLeft"))+parseInt(e.css("marginRight"));i+=a+s})),i>e&&(e=i)})),e}static shouldIncreaseWidth(t,e,i,a,s,n){let o=t[0].getBoundingClientRect(),r=e[0].getBoundingClientRect();if(r.right>=s)return!1;if(r.width>=i)return!1;let l=Array.from(t.find(".tah-action")).sort(((t,e)=>$(t).offset().top-$(e).offset().top)),c=CategoryResizer.calculateRows(l),d=CategoryResizer.calculateMaxRowButtons(l);return!(o.bottom<=a&&d>=c&&!n)}static shouldShrinkWidth(t,e,i,a,s,n){let o=t[0].getBoundingClientRect(),r=e[0].getBoundingClientRect();if(o.bottom>=a)return!1;if(r.width<=i)return!1;let l=Array.from(t.find(".tah-action")).sort(((t,e)=>$(t).offset().top-$(e).offset().top)),c=CategoryResizer.calculateRows(l),d=CategoryResizer.calculateMaxRowButtons(l);return!(r.right<=s&&(c>=d-1||n))}static calculateRows(t){var e=0;let i=0;return t.forEach((t=>{let a=$(t).offset().top;Math.abs(i-a)>=5&&(e++,i=a)})),e}static calculateMaxRowButtons(t){if(t.length<2)return t.length;var e=[];let i=0,a=0;return t.forEach((s=>{let n=$(s).offset().top;Math.abs(i-n)>=5?(a>=1&&e.push(a),i=n,a=1):a++,a>=1&&t.indexOf(s)===t.length-1&&e.push(a)})),Math.max(...e)}static resizeActions(t,e){t.map((function(){$(this).css({width:e+"px","min-width":e+"px"})}))}}class TokenActionHUD extends Application{i18n=t=>game.i18n.localize(t);refresh_timeout=null;tokens=null;rendering=!1;categoryHovered="";defaultLeftPos=150;defaultTopPos=80;constructor(t){super(),this.systemManager=t}async init(t){this.actions=await this.systemManager.getActionHandler(t),this.rollHandler=this.systemManager.getRollHandler(),this.filterManager=this.systemManager.getFilterManager(),this.categoryManager=this.systemManager.getCategoryManager()}updateSettings(){this.updateRollHandler(),this.update()}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokensReference(t){this.tokens=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"/modules/token-action-hud/templates/template.hbs",id:"token-action-hud",classes:[],width:200,height:20,left:150,top:80,scale:1,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[]})}getScale(){const t=parseFloat(get("scale"));return t<.5?.5:t>2?2:t}getBackground(){return get("background")}getData(t={}){const e=super.getData();e.actions=this.targetActions,e.id="token-action-hud",e.hovering=get("onTokenHover"),e.scale=this.getScale(),e.background=this.getBackground(),Logger.debug("HUD data:",e);for(const t of e.actions.categories){const e=game.user.getFlag("token-action-hud",`categories.${t.id}.advancedCategoryOptions`);if(!e?.compactView)continue;const i=e.characterCount??2;function subcatRecursion(t){for(const e of t.subcategories){for(const t of e.actions)t.title=t.name,t.name.length<2||(t.name=0===i?"":t.name.split(" ").map((t=>t.slice(0,i))).join(" "));e.subcategories.length&&e.subcategories.forEach((t=>subcatRecursion(t)))}}subcatRecursion(t)}return e}activateListeners(t){const e=".tah-action",handleClick=t=>{let e=t.target;"BUTTON"!==e.tagName&&(e=t.currentTarget.children[0]);let i=e.value;try{this.rollHandler.handleActionEvent(t,i),e.blur()}catch(e){Logger.error(t)}};function handlePossibleFilterSubtitleClick(t){let e=t.target;if(0===e.id.length)return;let i=e.id;TagDialogHelper.showFilterDialog(game.tokenActionHUD.filterManager,i)}function closeCategory(t){if(game.tokenActionHUD.rendering)return;let e=$(this)[0];$(e).removeClass("hover");let i=e.id;game.tokenActionHUD.clearHoveredCategory(i)}function openCategory(e){let i=$(this)[0];!function closeAllCategories(e){t.find(".tah-category").removeClass("hover")}(),$(i).addClass("hover");let a=i.id;game.tokenActionHUD.setHoveredCategory(a),CategoryResizer.resizeHoveredCategory(a)}t.find(e).on("click",(t=>{handleClick(t)})),t.find(e).contextmenu((t=>{handleClick(t)})),t.find(".tah-title-button").contextmenu("click",(t=>function handlePossibleFilterButtonClick(t){let e=t.target;if(0===e.value.length)return;let i=e.value,a=e.innerText??e.outerText;game.tokenActionHUD.categoryManager.isCompendiumCategory(i)?TagDialogHelper.showSubcategoryDialogue(game.tokenActionHUD.categoryManager,i,a):TagDialogHelper.showFilterDialog(game.tokenActionHUD.filterManager,i)}(t))),t.find(".tah-subtitle").click("click",(t=>handlePossibleFilterSubtitleClick(t))),t.find(".tah-subtitle").contextmenu("click",(t=>handlePossibleFilterSubtitleClick(t))),get("clickOpenCategory")?t.find(".tah-title-button").click("click",(function toggleCategory(t){let e,i=$(this.parentElement);$(i).hasClass("hover")?(e=closeCategory.bind(this.parentElement),e(t)):(e=openCategory.bind(this.parentElement),e(t))})):t.find(".tah-category").hover(openCategory,closeCategory),t.find("#tah-categories").mousedown((t=>{t.preventDefault(),t=t||window.event,TagDialogHelper._showCategoryDialog(this.categoryManager)})),t.find("#tah-reposition").mousedown((t=>{t.preventDefault(),t=t||window.event;let e=$(document.body).find("#token-action-hud"),i=parseInt(e.css("marginLeft").replace("px","")),a=parseInt(e.css("marginTop").replace("px",""));!function dragElement(t){function elementDrag(e){(e=e||window.event).preventDefault(),s=o-e.clientX,n=r-e.clientY,o=e.clientX,r=e.clientY,t.style.top=t.offsetTop-n-a+"px",t.style.left=t.offsetLeft-s-i+"px",t.style.position="fixed",t.style.zIndex=100}function closeDragElement(){t.onmousedown=null,document.onmouseup=null,document.onmousemove=null;let e=t.offsetLeft-s>window.innerWidth?window.innerWidth:t.offsetLeft-s,i=t.offsetTop-n>window.innerHeight-20?window.innerHeight-100:t.offsetTop-n;e=e<0?0:e,i=i<0?0:i,e==t.offsetLeft-s&&i==t.offsetTop-n||(t.style.top=i+"px",t.style.left=e+"px"),Logger.info(`Setting position to x: ${e}px, y: ${i}px, and saving in user flags.`),game.user.update({flags:{"token-action-hud":{hudPos:{top:i,left:e}}}})}t.onmousedown=function dragMouseDown(t){(t=t||window.event).preventDefault(),o=t.clientX,r=t.clientY,document.onmouseup=closeDragElement,document.onmousemove=elementDrag}}(document.getElementById("token-action-hud"));let s=0,n=0,o=0,r=0})),$(document).find(".tah-filterholder").parents(".tah-subcategory").css("cursor","pointer")}applySettings(){get("dropdown")||$(document).find(".tah-content").css({bottom:"40px","flex-direction":"column-reverse"})}trySetPos(){if(!this.targetActions||!this.targetActions.tokenId)return;let t=$(document).find("#tah-hudTitle");t.length>0&&t.css("top",-t[0].getBoundingClientRect().height);let e=canvas?.tokens?.placeables.find((t=>t.data._id===this.targetActions?.tokenId));get("onTokenHover")&&e?this.setHoverPos(e):this.setUserPos(),this.restoreCategoryHoverState(),this.rendering=!1}setUserPos(){if(!game.user.data.flags["token-action-hud"]||!game.user.data.flags["token-action-hud"].hudPos)return;let t=game.user.data.flags["token-action-hud"].hudPos,e=this.defaultLeftPos,i=this.defaultTopPos;return new Promise((a=>{!function check(){let s=document.getElementById("token-action-hud");s?(s.style.bottom=null,s.style.top=t.top<5||t.top>window.innerHeight+5?i+"px":t.top+"px",s.style.left=t.left<5||t.left>window.innerWidth+5?e+"px":t.left+"px",s.style.position="fixed",s.style.zIndex=100,a()):setTimeout(check,30)}()}))}setHoverPos(t){return new Promise((e=>{!function check(t){let i=$("#token-action-hud");i?(i.css("bottom",null),i.css("left",t.worldTransform.tx+(t.data.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),i.css("top",t.worldTransform.ty+0+"px"),i.css("position","fixed"),i.css("zIndex",100),e()):setTimeout(check,30)}(t)}))}setHoveredCategory(t){this.categoryHovered=t}clearHoveredCategory(t){this.categoryHovered===t&&(this.categoryHovered="")}restoreCategoryHoverState(){if(""===this.categoryHovered)return;let t=`#${this.categoryHovered}`,e=$(t);if(e[0])if(get("clickOpenCategory")){e.find(".tah-title-button")[0].click()}else e.mouseenter()}async resetHud(){await this.resetFlags(),this.resetPosition()}resetPosition(){Logger.info("Resetting HUD position to x: 80px, y: 150px, and saving in user flags. \nIf HUD is still not visible, something else may be wrong.\nFeel free to contact Drental#7416 on Discord"),game.user.update({flags:{"token-action-hud":{hudPos:{top:80,left:150}}}}),this.update()}async resetFlags(){Logger.info("Resetting Token Action HUD filter and category flags"),await this.categoryManager.reset(),await this.filterManager.reset(),this.update()}update(){this.refresh_timeout&&clearTimeout(this.refresh_timeout),this.refresh_timeout=setTimeout(this.updateHud.bind(this),100)}async updateHud(){Logger.debug("Updating HUD");let t=this._getTargetToken(this.tokens?.controlled),e=this.tokens?.controlled.length>1&&!t;this.targetActions=await this.actions.buildActionList(t,e),this.showHudEnabled()?(this.rendering=!0,this.render(!0)):this.close()}validTokenChange(t){return get("alwaysShowHud")?this.isRelevantToken(t)||t.actorId===game.user.character?.id:this.isRelevantToken(t)}isRelevantToken(t){let e=this.tokens?.controlled;return e?.some((e=>e.id===this.getTokenId(t)))||0===e?.length&&canvas?.tokens?.placeables?.some((t=>t.id===this.targetActions?.tokenId))}getTokenId(t){return t.id??t.id}validTokenHover(t,e){return e&&get("onTokenHover")&&t.id===this.targetActions?.tokenId}validActorOrItemUpdate(t){if(t)return Logger.debug("actor change, comparing actors"),Logger.debug(`actor.id: ${t.id}; this.targetActions.actorId: ${this.targetActions?.actorId}`),t?this.targetActions&&t.id===this.targetActions.actorId?(Logger.debug("Same actor IDs, should update HUD."),!0):(Logger.debug("Different actor, no need to update HUD."),!1):(Logger.debug("No actor, possibly deleted, should update HUD."),!0)}showHudEnabled(){return Logger.debug("showHudEnabled()",`isGM: ${game.user.isGM}`,`enabledForUser: ${get("enabledForUser")}`,`playerPermission: ${get("playerPermission")}`),!!get("enabledForUser")&&(get("playerPermission")||game.user.isGM)}isLinkedCompendium(t){return Logger.debug("Compendium hook triggered. Checking if compendium is linked."),this.categoryManager.isLinkedCompendium(t)}_getTargetToken(t=[]){if(t.length>1)return null;if(0===t.length&&canvas.tokens?.placeables&&game.user.character){if(!get("alwaysShowHud"))return null;let t=game.user.character,e=canvas?.tokens?.placeables.find((e=>e.actor?.id===t?.id));return e||null}let e=t[0];return e&&this._userHasPermission(e)?e:null}_userHasPermission(t=""){let e=t.actor,i=game.user;return game.user.isGM||e?.testUserPermission(i,"OWNER")}}class Filter{id="";isBlocklist=!1;filteredElements=[];possibleChoices=[];constructor(t){this.id=t}async setFilteredElements(t,e){Array.isArray(t)&&(this.filteredElements=t,this.isBlocklist=e),await this.updateFlag()}getSuggestions(){return this.possibleChoices}getFilteredElements(){return this.filteredElements}getFilteredNames(){return this.filteredElements.map((t=>t.value))}getFilteredIds(){return this.filteredElements.map((t=>t.id))}setSuggestions(t){Array.isArray(t)&&(this.possibleChoices=t)}async updateFlag(){let t={isBlocklist:this.isBlocklist,elements:this.filteredElements};await game.user.setFlag("token-action-hud",`filters.${this.id}`,t)}async clearFlag(){await game.user.setFlag("token-action-hud","filters",{[`-=${this.id}`]:null})}}class FilterManager{filters=[];user=null;constructor(t){this.user=t;let e=t.getFlag("token-action-hud","filters");e&&(Logger.debug("saved filters:",e),Object.entries(e).forEach((t=>{let e=new Filter(t[0]);e.setFilteredElements(t[1].elements,t[1].isBlocklist),this.filters.push(e)})))}async reset(){this.filters=[],await game.user.unsetFlag("token-action-hud","filters")}createOrGetFilter(t){if(this.filters.some((e=>e.id===t)))return this.filters.find((t=>t.id));let e=new Filter(t);return this.filters.push(e),e}getSuggestions(t){return this._getFilter(t).getSuggestions()}setSuggestions(t,e){this._getFilter(t).setSuggestions(e)}getFilteredElements(t){return this._getFilter(t).getFilteredElements()}getFilteredNames(t){return this._getFilter(t).getFilteredNames()}getFilteredIds(t){return this._getFilter(t).getFilteredIds()}async setFilteredElements(t,e,i){let a=this._getFilter(t);await a.setFilteredElements(e,i)}async clearFilter(t){let e=this.filters.find((e=>e.id===t));e&&(await e.clearFlag(),this.filters.splice(this.filters.indexOf(e),1))}isBlocklist(t){return this._getFilter(t).isBlocklist}_getFilter(t){return this.filters.find((e=>e.id===t))??this.createOrGetFilter(t)}}const s="macro",n="comp";class FilterSubcategory{constructor(t,e){this.filterManager=t,this.title=e}async updateFlag(t){let e=this.getFlagContents();await game.user.setFlag("token-action-hud",`categories.${t}.subcategories.${this.id}`,e)}async unsetFlag(t){t&&await game.user.setFlag("token-action-hud",`categories.${t}.subcategories`,{[`-=${this.id}`]:null})}createFilter(){this.filterManager.createOrGetFilter(this.id)}clearFilter(){this.filterManager.clearFilter(this.id)}async setFilteredElements(t,e){await this.filterManager.setFilteredElements(this.id,t,e)}asTagifyEntry(){return{id:this.id,value:this.title,type:this.type}}async addToCategory(t,e){let i=t.initializeEmptySubcategory(this.id);i.actions=await this._getActions(t.delimiter),i.canFilter=!0,t._combineSubcategoryWithCategory(e,this.title,i)}getFlagContents(){return{id:this.id,title:this.title,type:this.type}}async _getActions(){return[]}}class CompendiumSubcategory extends FilterSubcategory{constructor(t,e,i,a){super(t,a),this.id=`${e}_${i}`.slugify({replacement:"_",strict:!0}),this.compendiumId=i,this.type=n}async submitFilterSuggestions(){let t=await CompendiumHelper.getCompendiumEntriesForFilter(this.compendiumId);this.filterManager.setSuggestions(this.id,t)}async _getActions(t){let e=await CompendiumHelper.getEntriesForActions(this.compendiumId,t),i=this.filterManager.getFilteredIds(this.id),a=this.filterManager.isBlocklist(this.id),s=e;return i.length>0&&(s=e.filter((t=>i.includes(t.id)!==a))),s}getFlagContents(){return{id:this.compendiumId,title:this.title,type:this.type}}}class MacroHelper{constructor(){}static exists(t,e){if(e)return e.some((e=>e.data._id===t));return!!("some"in game.macros.entries?game.macros.entries:game.macros).some((e=>e.data._id===t))}static getEntriesForActions(t){let e="macro";return MacroHelper.getMacros().map((i=>{let a=[e,e,i.data._id].join(t),s=MacroHelper.getImage(i);return{name:i.data.name,encodedValue:a,id:i.data._id,img:s}}))}static getMacrosForFilter(){return MacroHelper.getMacros().map((t=>({id:t.data._id,value:t.data.name})))}static getMacros(){return("filter"in game.macros.entries?game.macros.entries:game.macros).filter((t=>{let e=t.data.permission;return e[game.userId]?e[game.userId]>0:e.default>0}))}static getImage(t){let e="";return get("showIcons")&&(e=t.data.img),e?.includes("icons/svg/mystery-man.svg")?"":e}}class MacroSubcategory extends FilterSubcategory{constructor(t,e,i){super(t,i),this.id=`${e}_${i}`.slugify({replacement:"_",strict:!0}),this.type=s}submitFilterSuggestions(){let t=MacroHelper.getMacrosForFilter();this.filterManager.setSuggestions(this.id,t)}_getActions(t){let e=MacroHelper.getEntriesForActions(t),i=this.filterManager.getFilteredIds(this.id),a=this.filterManager.isBlocklist(this.id);return 0===i.length?[]:e.filter((t=>i.includes(t.id)!==a))}}class FilterCategory{subcategories=[];id="";key="";title="";push=!1;core=!1;constructor(t,e,i,a,s){this.filterManager=t,this.id=e,this.key=e.slugify({replacement:"_",strict:!0}),this.title=i,this.push=a,this.core=s??!1}async addToActionList(t,e){if(e.categories.some((t=>t.name===this.title))){let i=e.categories.find((t=>t.name===this.title));if(!i.subcategories.length)return;await this.addSubcategoriesToCategory(t,i)}else await this.doAddToActionList(t,e)}async doAddToActionList(t,e){if(this.core)return;let i=t.initializeEmptyCategory(this.id);i.core=this.core,await this.addSubcategoriesToCategory(t,i),t._combineCategoryWithList(e,this.title,i,this.push)}async addSubcategoriesToCategory(t,e){for(let i of this.subcategories)await i.addToCategory(t,e)}async selectSubcategories(t){for(let e of t)e.type===n?await this.addCompendiumSubcategory(e):this.addMacroSubcategory(e);if(0===this.subcategories.length)return;let e=t.map((t=>t.title));for(var i=this.subcategories.length-1;i>=0;i--){let t=this.subcategories[i];e.includes(t.title)||await this.removeSubcategory(i)}await this.updateFlag()}async addCompendiumSubcategory(t){if(this.subcategories.some((e=>e.compendiumId===t.id)))return;if(!CompendiumHelper.exists(t.id))return;let e=new CompendiumSubcategory(this.filterManager,this.key,t.id,t.title);e.createFilter(),await e.submitFilterSuggestions(),this.subcategories.push(e)}addMacroSubcategory(t){if(this.subcategories.some((e=>e.title===t.title)))return;let e=new MacroSubcategory(this.filterManager,this.key,t.title);e.createFilter(),e.submitFilterSuggestions(),this.subcategories.push(e)}async updateFlag(){let t={categories:{[this.key]:{title:this.title,id:this.id,push:this.push,core:this.core}}};await game.user.update({flags:{"token-action-hud":t}});for(let t of this.subcategories)await t.updateFlag(this.key)}async removeSubcategory(t){let e=this.subcategories[t];await e.clearFilter(),await e.unsetFlag(this.key),this.subcategories.splice(t,1)}async prepareForDelete(){await this.clearFilters(),await this.unsetFlag()}async clearFilters(){for(let t of this.subcategories)await t.clearFilter()}async unsetFlag(){await game.user.setFlag("token-action-hud","categories",{[`-=${this.key}`]:null})}asTagifyEntry(){return{id:this.id,value:this.title}}getSubcategoriesAsTagifyEntries(){return this.subcategories.map((t=>t.asTagifyEntry()))}}class CategoryManager{categories=[];user=null;constructor(t,e){this.user=t,this.filterManager=e}async reset(){this.categories=[],await game.user.unsetFlag("token-action-hud","categories")}async init(){let t=this.user.getFlag("token-action-hud","categories");if(t){Logger.debug("saved categories:",t);for(let e of Object.values(t)){let t=e.id,i=e.title,a=e.push??!1,s=e.core??!1;if(!t&&!i)continue;let n=new FilterCategory(this.filterManager,t,i,a,s),o=e.subcategories;o&&(o=Object.values(o),await n.selectSubcategories(o)),this.categories.push(n)}}}async addCategoriesToActionList(t,e){get("alwaysShowAdditionalCategories")&&(e.tokenId||(e.tokenId="categoryManager"),e.actorId||(e.actorId="categoryManager")),e.tokenId&&await this.doAddCategories(t,e)}async doAddCategories(t,e){for(let i of this.categories)await i.addToActionList(t,e)}async submitCategories(t,e){t=t.map((t=>({id:t.value.slugify({replacement:"_",strict:!0}),value:t.value})));for(let i of t){let t=this.categories.find((t=>t.id===i.id));t?await this._updateCategory(t,e):await this._createCategory(i,e)}let i=t.map((t=>t.id));if(0!==this.categories.length)for(var a=this.categories.length-1;a>=0;a--){let t=this.categories[a];i.includes(t.id)||t.core||await this.deleteCategory(a)}}async addCoreCategories(t){for(let e of t){let t=this.categories.find((t=>t.id===e.id));!t||t.core?t||await this._createCategory({id:e.id,value:e.name},!1,!0):(t.core=!0,await t.updateFlag())}}async _createCategory(t,e,i=!1){let a=new FilterCategory(this.filterManager,t.id,t.value,e,i);await a.updateFlag(),this.categories.push(a)}async _updateCategory(t,e){t.push=e,await t.updateFlag()}async deleteCategory(t){let e=this.categories[t];await e.prepareForDelete(),this.categories.splice(t,1)}async submitSubcategories(t,e){let i=this.categories.find((e=>e.id===t));i&&await i.selectSubcategories(e)}getExistingCategories(){return this.categories.filter((t=>!t.core)).map((t=>t.asTagifyEntry()))}isCompendiumCategory(t){return this.categories.some((e=>e.id===t))}isLinkedCompendium(t){return this.categories.some((e=>e.subcategories?.some((e=>e.compendiumId===t))))}arePush(){let t=this.categories.filter((t=>!t.core));return t.filter((t=>t.push)).length>=t.length/2}getCategorySubcategoriesAsTagifyEntries(t){let e=this.categories.find((e=>e.id===t));if(e)return e.getSubcategoriesAsTagifyEntries()}}class ActionList{constructor(){this.hudTitle="",this.tokenId="",this.actorId="",this.categories=[]}}class ActionCategory{constructor(){this.id="",this.name="",this.cssClass="",this.subcategories=[]}}class ActionSubcategory{constructor(){this.id="",this.name="",this.info1="",this.canFilter=!1,this.actions=[],this.subcategories=[]}}class ActionSet{constructor(){this.set=!0,this.actions=[],this.cssClass=""}}class Action{constructor(){this.id="",this.name="",this.encodedValue="",this.info1="",this.info2="",this.info3="",this.cssClass="",this.icon="",this.img=""}}class GenericActionHandler{baseHandler;constructor(t){this.baseHandler=t}addGenericCategories(t,e,i){this._addConditions(t,e,i),this._addUtilities(t,e,i)}_addConditions(t,e,i){}_addUtilities(t,e,i){let a=e.categories.find((t=>"utility"===t.id));if(a||(a=this.baseHandler.initializeEmptyCategory("utility"),a.name=this.baseHandler.i18n("tokenactionhud.utility"),e.categories.push(a)),i){const t=canvas.tokens.controlled;this._addMultiUtilities(a,t)}else this._getUtilityList(a,t.id)}_getUtilityList(t,e){let i="utility",a=this.baseHandler.initializeEmptySubcategory(),s={id:"toggleCombat",encodedValue:[i,e,"toggleCombat"].join(this.baseHandler.delimiter),name:this.baseHandler.i18n("tokenactionhud.toggleCombatState")};if(s.cssClass=canvas.tokens.placeables.find((t=>t.data._id===e)).inCombat?"active":"",a.actions.push(s),game.user.isGM){let t={id:"toggleVisibility",encodedValue:[i,e,"toggleVisibility"].join(this.baseHandler.delimiter),name:this.baseHandler.i18n("tokenactionhud.toggleVisibility")};t.cssClass=canvas.tokens.placeables.find((t=>t.data._id===e)).data.hidden?"":"active",a.actions.push(t)}this.baseHandler._combineSubcategoryWithCategory(t,this.baseHandler.i18n("tokenactionhud.token"),a)}_addMultiUtilities(t,e){let i="utility",a="multi",s=this.baseHandler.initializeEmptySubcategory(),n={id:"toggleCombat",encodedValue:[i,a,"toggleCombat"].join(this.baseHandler.delimiter),name:this.baseHandler.i18n("tokenactionhud.toggleCombatState")};if(n.cssClass=e.every((t=>t.inCombat))?"active":"",s.actions.push(n),game.user.isGM){let t={id:"toggleVisibility",encodedValue:[i,a,"toggleVisibility"].join(this.baseHandler.delimiter),name:this.baseHandler.i18n("tokenactionhud.toggleVisibility")};t.cssClass=e.every((t=>!t.data.hidden))?"active":"",s.actions.push(t)}this.baseHandler._combineSubcategoryWithCategory(t,this.baseHandler.i18n("tokenactionhud.token"),s)}}class ActionHandler{i18n=t=>game.i18n.localize(t);linkedCompendiumsGm=[];linkedCompendiumsPlayer=[];furtherActionHandlers=[];delimiter="|";filterManager=null;constructor(t,e){this.filterManager=t,this.categoryManager=e,this.genericActionHandler=new GenericActionHandler(this)}async registerCoreCategories(t){await this.categoryManager.addCoreCategories(t)}async buildActionList(t,e){let i=await this.doBuildActionList(t,e);return this._addGenericCategories(t,i,e),this._doBuildFurtherActions(t,i,e),await this.registerCoreCategories(i.categories),await this.categoryManager.addCategoriesToActionList(this,i),i}doBuildActionList(t){}_addGenericCategories(t,e,i){(t||i)&&this.genericActionHandler.addGenericCategories(t,e,i)}_doBuildFurtherActions(t,e,i){this.furtherActionHandlers.forEach((t=>t.extendActionList(e,i)))}addFurtherActionHandler(t){Logger.debug(`Adding further action handler: ${t.constructor.name}`),this.furtherActionHandlers.push(t)}initializeEmptyActionList(){return new ActionList}initializeEmptyActionSet(){return new ActionSet}initializeEmptyAction(){return new Action}initializeEmptyCategory(t){let e=new ActionCategory;return e.id=t,e}initializeEmptySubcategory(t="",e=null){let i=new ActionSubcategory;return i.id=t,e&&(i.name=this.i18n(e)),i}_combineCategoryWithList(t,e,i,a=!0){i&&(0!==i.subcategories.length||!i.core&&void 0!==i.core)&&(e?.length>0&&(i.name=e),a?t.categories.push(i):t.categories.unshift(i))}_combineSubcategoryWithCategory(t,e,i){i&&(e?.length>0&&(i.name=e),i.subcategories.length>0||i.actions.length>0||i.canFilter?t.subcategories.push(i):Logger.debug("subcategory criteria not met, disposing of",e))}_foundrySort(t,e){return t?.data?.sort||e?.data?.sort?t.data.sort-e.data.sort:0}}class ActionListExtender extends ActionHandler{constructor(){super()}extendActionList(t,e){}}class ItemMacroActionListExtender extends ActionListExtender{constructor(){super()}static isModuleActive(t){let e=game.modules.get(t);return e&&e.active}extendActionList(t,e){if(e)return;let i=t.tokenId;if(!t.actorId)return;let a,s=this.getActor(i).items.filter((t=>t.hasMacro()));if(a=ItemMacroActionListExtender.isModuleActive("midi-qol")?s.filter(this.isUnsupportedByMidiQoL).map((t=>t.data._id)):s.map((t=>t.data._id)),!a)return;if(0===a.length)return;let n=get("itemMacroReplace");if("showOriginal"===n)return t;let o="showItemMacro"===n;return t.categories.forEach((t=>{t.subcategories.forEach((t=>{this.addSubcategoryActions(a,t,o)}))})),t}addSubcategoryActions(t,e,i){e.subcategories&&e.subcategories.length>0&&e.subcategories.forEach((e=>this.addSubcategoryActions(t,e,i)));let a=[];e.actions.forEach((e=>{if(!t.includes(e.id))return;let s=this.createItemMacroAction(e,i);i||a.push(s)})),this.addActionsToSubcategory(e,a)}createItemMacroAction(t,e){let i=e?t:{},a=t.encodedValue.substr(t.encodedValue.indexOf(this.delimiter));return i.encodedValue="itemMacro"+a,i.name=e?t.name:`(M) ${t.name}`,i.id=t.id,i.img=t.img,i.icon=t.icon,i.info1=t.info1,i.info2=t.info2,i.info3=t.info3,i}addActionsToSubcategory(t,e){e.forEach((e=>{let i=t.actions.findIndex((t=>t.id===e.id))+1;t.actions.splice(i,0,e)}))}isUnsupportedByMidiQoL(t){return!t.getFlag("midi-qol","onUseMacroName")}getActor(t){return canvas.tokens.placeables.find((e=>e.data._id===t))?.actor}}class RollHandler{preRollHandlers=[];constructor(){}i18n=t=>game.i18n.localize(t);getActor(t){return canvas.tokens.placeables.find((e=>e.data._id===t))?.actor}getItem(t,e){return t.items.get(e)}getToken(t){return canvas.tokens.placeables.find((e=>e.data._id===t))}throwInvalidValueErr(t){throw new Error("Error handling button click: unexpected button value/payload")}async handleActionEvent(t,e){Logger.debug(e),this.registerKeyPresses(t);let i=!1;this.preRollHandlers.forEach((a=>{i||(i=a.prehandleActionEvent(t,e))})),i||(this._isMultiGenericAction(e)?await this._doMultiGenericAction(e):this.doHandleActionEvent(t,e))}doHandleActionEvent(t,e){}addPreRollHandler(t){Logger.debug(`Adding pre-roll handler: ${t.constructor.name}`),this.preRollHandlers.push(t)}registerKeyPresses(t){this.rightClick=this.isRightClick(t),this.ctrl=this.isCtrl(t),this.alt=this.isAlt(t),this.shift=this.isShift(t)}doRenderItem(t,e){let i=this.getActor(t);this.getItem(i,e).sheet.render(!0)}isRenderItem(){return get("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(t){return 2===t?.originalEvent?.button}isAlt(t){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)}isCtrl(t){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)}isShift(t){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)}_isMultiGenericAction(t){let e=t.split("|"),i=e[0],a=e[2];return"utility"===i&&a.includes("toggle")}async _doMultiGenericAction(t){let e=t.split("|")[2];"toggleVisibility"===e&&await canvas.tokens.controlled[0].toggleVisibility(),"toggleCombat"===e&&await canvas.tokens.controlled[0].toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD")}}class PreRollHandler extends RollHandler{constructor(){super()}prehandleActionEvent(t,e){return!1}}class CompendiumMacroPreHandler extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){let i=game.tokenActionHUD.actions.delimiter,a=e.split(i);if(3!=a.length)return!1;let s=a[0],n=a[1],o=a[2];if(!["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"].includes(s))return!1;switch(s){case"compendiumEntry":this.handleCompendium(s,t,n,o);break;case"compendiumMacro":this.handleMacroCompendium(s,t,n,o);break;case"compendiumPlaylist":this.handlePlaylistCompendium(s,t,n,o);break;case"macro":this.handleMacro(s,t,n,o);break;default:return!1}return!0}handleCompendium(t,e,i,a){game.packs.get(i).getDocument(a).then((t=>t.sheet.render(!0)))}handleMacroCompendium(t,e,i,a){game.packs.get(i).getDocument(a).then((t=>t.execute()))}async handlePlaylistCompendium(t,e,i,a){let s=game.packs.get(i),n=a.split(">"),o=n[0],r=n[1],l=(await s.getDocument(o)).sounds.find((t=>t._id===r));AudioHelper.play({src:l.path},{})}handleMacro(t,e,i,a){game.macros.find((t=>t.data._id===a)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){this.registerKeyPresses(t);let i=e.split("|");if(3!=i.length)return!1;let a=i[0],s=i[1],n=i[2];return"itemMacro"==a&&(this.isRenderItem()?(this.doRenderItem(s,n),!0):this._tryExecuteItemMacro(t,s,n))}_tryExecuteItemMacro(t,e,i){let a=super.getActor(e),s=super.getItem(a,i);try{s.executeMacro()}catch(t){return Logger.error("ItemMacro error: ",t),!1}return!0}}class SystemManager{i18n=t=>game.i18n.localize(t);appName;constructor(t){this.appName=t}doGetActionHandler(){}doGetRollHandler(t){}getAvailableRollHandlers(){}doRegisterSettings(t,e){}async getActionHandler(t){this.filterManager=new FilterManager(t),this.categoryManager=new CategoryManager(t,this.filterManager),await this.categoryManager.init();let e=this.doGetActionHandler(this.filterManager,this.categoryManager);return this.addActionExtenders(e),e}doGetActionHandler(){}addActionExtenders(t){SystemManager.isModuleActive("itemacro")&&t.addFurtherActionHandler(new ItemMacroActionListExtender)}filterManager;getFilterManager(){return this.filterManager}categoryManager;getCategoryManager(){return this.categoryManager}getRollHandler(){let t=get("rollHandler");"core"===t||SystemManager.isModuleActive(t)||(Logger.error(t,this.i18n("tokenactionhud.handlerNotFound")),t="core",function set(t,e){game.settings.set(a,t,e)}("rollHandler",t));let e=this.doGetRollHandler(t);return this.addPreHandlers(e),e}doGetRollHandler(t){}addPreHandlers(t){t.addPreRollHandler(new CompendiumMacroPreHandler),SystemManager.isModuleActive("itemacro")&&t.addPreRollHandler(new ItemMacroPreRollHandler)}getAvailableRollHandlers(){}registerSettings(){let s=this.getAvailableRollHandlers();!function(s,n,o){a=s,game.settings.register(a,"rollHandler",{name:game.i18n.localize("tokenactionhud.settings.rollHandler.name"),hint:game.i18n.localize("tokenactionhud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:o,default:"core",onChange:t=>{updateFunc$1()}}),game.settings.register(a,"dorakoUI",{name:game.i18n.localize("tokenactionhud.settings.dorakoUI.name"),hint:game.i18n.localize("tokenactionhud.settings.dorakoUI.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"enabledForUser",{name:game.i18n.localize("tokenactionhud.settings.enabledForUser.name"),hint:game.i18n.localize("tokenactionhud.settings.enabledForUser.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"alwaysShowHud",{name:game.i18n.localize("tokenactionhud.settings.alwaysShowHud.name"),hint:game.i18n.localize("tokenactionhud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"showHudTitle",{name:game.i18n.localize("tokenactionhud.settings.showHudTitle.name"),hint:game.i18n.localize("tokenactionhud.settings.showHudTitle.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"showIcons",{name:game.i18n.localize("tokenactionhud.settings.showIcons.name"),hint:game.i18n.localize("tokenactionhud.settings.showIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"alwaysShowAdditionalCategories",{name:game.i18n.localize("tokenactionhud.settings.alwaysShowAdditionalCategories.name"),hint:game.i18n.localize("tokenactionhud.settings.alwaysShowAdditionalCategories.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"onTokenHover",{name:game.i18n.localize("tokenactionhud.settings.onTokenHover.name"),hint:game.i18n.localize("tokenactionhud.settings.onTokenHover.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"clickOpenCategory",{name:game.i18n.localize("tokenactionhud.settings.clickOpenCategory.name"),hint:game.i18n.localize("tokenactionhud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),n.doRegisterSettings(a,updateFunc$1),game.modules.get("itemacro")?.active&&game.settings.register(a,"itemMacroReplace",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.itemMacroReplace.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.itemMacroReplace.hint"),scope:"client",config:!0,type:String,choices:{showBoth:game.i18n.localize(t),showItemMacro:game.i18n.localize(e),showOriginal:game.i18n.localize(i)},default:"showBoth",onChange:t=>{updateFunc$1()}}),game.settings.register(a,"playerPermission",{name:game.i18n.localize("tokenactionhud.settings.playerPermission.name"),hint:game.i18n.localize("tokenactionhud.settings.playerPermission.hint"),scope:"world",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"renderItemOnRightClick",{name:game.i18n.localize("tokenactionhud.settings.renderItemOnRightClick.name"),hint:game.i18n.localize("tokenactionhud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"scale",{name:game.i18n.localize("tokenactionhud.settings.scale.name"),hint:game.i18n.localize("tokenactionhud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"background",{name:game.i18n.localize("tokenactionhud.settings.background.name"),hint:game.i18n.localize("tokenactionhud.settings.background.hint"),scope:"client",config:!0,type:String,default:"none",onChange:t=>{updateFunc$1()}}),game.settings.register(a,"activeCssAsText",{name:game.i18n.localize("tokenactionhud.settings.activeCssAsText.name"),hint:game.i18n.localize("tokenactionhud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"dropdown",{name:game.i18n.localize("tokenactionhud.settings.dropdown.name"),hint:game.i18n.localize("tokenactionhud.settings.dropdown.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(a,"debug",{name:game.i18n.localize("tokenactionhud.settings.debug.name"),hint:game.i18n.localize("tokenactionhud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),Logger.debug("available rollHandlers: ",o)}(this.appName,this,s)}static addHandler(t,e){if(SystemManager.isModuleActive(e)){let i=SystemManager.getModuleTitle(e);mergeObject(t,{[e]:i})}}static isModuleActive(t){let e=game.modules.get(t);return e&&e.active}static getModuleTitle(t){return game.modules.get(t)?.data.title??""}}class ActionHandlerBitD extends ActionHandler{constructor(t,e){super(t,e),this.filterManager.createOrGetFilter("skills")}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.data._id;let n=this._getActions(s,a),o=this._getResistances(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.actions"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.resistance"),o),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getActions(t,e){let i=this.initializeEmptyCategory("actions");for(let a in t.data.data.attributes){let s=this.initializeEmptySubcategory();for(let i in t.data.data.attributes[a].skills){let n=t.data.data.attributes[a].skills[i],o=this.i18n(n.label),r=["action",e,i].join(this.delimiter);s.actions.push({name:o,encodedValue:r})}let n=this.i18n(t.data.data.attributes[a].label);this._combineSubcategoryWithCategory(i,n,s)}return i}_getResistances(t,e){let i=this.initializeEmptyCategory("actions"),a=this.initializeEmptySubcategory();for(let i in t.data.data.attributes){let s=this.i18n(t.data.data.attributes[i].label),n=["resistance",e,i].join(this.delimiter);a.actions.push({name:s,encodedValue:n})}let s=this.i18n("tokenactionhud.resistance");return this._combineSubcategoryWithCategory(i,s,a),i}}class RollHandlerBaseBitD extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr(),i[0];let a=i[1],s=i[2];super.getActor(a).rollAttributePopup(s)}rollItemMacro(t,e,i){e.item.find((t=>t.data.id===i)).roll(t)}}class BitDSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerBitD(t,e)}getAvailableRollHandlers(){return{core:"Core BitD"}}doGetRollHandler(t){return new RollHandlerBaseBitD}doRegisterSettings(t,e){}}class ActionHandler5e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}async _buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.data?.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){return[this._buildItemsCategory(t),this._buildSpellsCategory(t),this._buildFeaturesCategory(t),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildAbilitiesCategory(t){const e=t.actor.data.data.abilities;if(get("splitAbilities")){const i=this.i18n("tokenactionhud.saves"),a=this._getAbilityList(t.id,e,"saves",i,"abilitySave");a.name=i;const s=this.i18n("tokenactionhud.checks"),n=this._getAbilityList(t.id,e,"checks",this.i18n("tokenactionhud.checks"),"abilityCheck");return n.name=s,[a,n]}return this._getAbilityList(t.id,e,"abilities",this.i18n("tokenactionhud.abilities"),"ability")}_buildMultipleTokenList(){const t=this.initializeEmptyActionList();t.tokenId="multi",t.actorId="multi";const e=["npc","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const a=t.tokenId;if(this._addMultiSkills(t,a),get("splitAbilities")){let e=this.i18n("tokenactionhud.saves"),i=this.i18n("tokenactionhud.checks");this._addMultiAbilities(t,a,"saves",e,"abilitySave"),this._addMultiAbilities(t,a,"checks",i,"abilityCheck")}else{let e=this.i18n("tokenactionhud.abilities");this._addMultiAbilities(t,a,"abilities",e,"ability")}return get("showConditionsCategory")&&this._addMultiConditions(t,a),this._addMultiUtilities(t,a,i),t}_buildItemsCategory(t){const e=t.actor,i=t.id;let a,s=this._filterLongerActions(e.data.items.filter((t=>this._getDocumentData(t).quantity>0))),n=this._sortByItemSort(s),o="item";a="npc"===e.data.type&&get("showAllNpcItems")?n.filter((t=>"consumable"!==t.type&&"spell"!==t.type&&"feat"!==t.type)):n.filter((t=>"consumable"!==t.type&&this._getDocumentData(t).equipped));let r=this._getActiveEquipment(a),l=r.filter((t=>"weapon"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),c=this.initializeEmptySubcategory();c.actions=l;let d=r.filter((t=>"equipment"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),h=this.initializeEmptySubcategory();h.actions=d;let u=r.filter((t=>"weapon"!=t.type&&"equipment"!=t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),g=this.initializeEmptySubcategory();g.actions=u;let m=this._getActiveEquipment(n.filter((t=>"consumable"==t.type))),y=this._filterExpendedItems(m).map((t=>this._buildEquipmentItem(i,e,o,t))),p=this.initializeEmptySubcategory();p.actions=y;let b=s.filter((t=>"tool"===t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenactionhud.weapons"),_=this.i18n("tokenactionhud.equipment"),C=this.i18n("tokenactionhud.other"),S=this.i18n("tokenactionhud.consumables"),v=this.i18n("tokenactionhud.tools"),A=this.initializeEmptyCategory("inventory");return A.name=this.i18n("tokenactionhud.inventory"),this._combineSubcategoryWithCategory(A,k,c),this._combineSubcategoryWithCategory(A,_,h),this._combineSubcategoryWithCategory(A,C,g),this._combineSubcategoryWithCategory(A,S,p),this._combineSubcategoryWithCategory(A,v,f),A}_getActiveEquipment(t){let e=[];if(get("showItemsWithoutAction"))e=t;else{const i=Object.keys(game.dnd5e.config.abilityActivationTypes).filter((t=>"none"!==t));e=t.filter((t=>{const e=this._getDocumentData(t);return!!e.activation&&i.includes(e.activation.type)}))}return e}_buildSpellsCategory(t){const e=t.actor;if("vehicle"===e.data.type)return;let i=this._filterLongerActions(e.data.items.filter((t=>"spell"===t.type)));i=this._filterExpendedItems(i),"character"!==e.data.type&&get("showAllNpcItems")||(i=this._filterNonpreparedSpells(i));let a=this._sortSpellsByLevel(i);return this._categoriseSpells(e,t.id,a)}_sortSpellsByLevel(t){let e=Object.values(t);return e.sort(((t,e)=>{const i=this._getDocumentData(t),a=this._getDocumentData(e);return i.level===a.level?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):i.level-a.level})),e}_categoriseSpells(t,e,i){const a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=Object.entries(t.data.data.spells).sort(((t,e)=>e[0].toUpperCase().localeCompare(t[0].toUpperCase(),void 0,{sensitivity:"base"})));var o=n.find((t=>"pact"===t[0])),r=!1;n.forEach((t=>{t[0].startsWith("spell")?(!r&&t[1].max>0&&t[1].value>0&&(r=!0),r||t[0]!=="spell"+o[1]?.level||o[1].max>0&&o[1].value>0&&(r=!0),t[1].slotsAvailable=r):(t[1]||(t[1]={}),t[1].slotsAvailable=!t[1].max||t[1].value>0)}));let l=n.findIndex((t=>"pact"===t[0]));if(!n[l][1].slotsAvailable){var c=n.findIndex((t=>t[0]==="spell"+o[1].level));n[l][1].slotsAvailable=n[c][1].slotsAvailable}i.reduce(function(i,o){const r=this._getDocumentData(o);let l=r.preparation.mode;const c=game.dnd5e.config.spellPreparationModes[l];var d=r.level;let h="pact"===l||"atwill"===l||"innate"===l;var u,g,m,y,p;h?y=l:(y="spell"+d,m=d?`${this.i18n("tokenactionhud.level")} ${d}`:this.i18n("tokenactionhud.cantrips")),p=n.find((t=>t[0]===y))?.[1],g=p?.value,u=p?.max;let b=get("showEmptyItems");if(u&&!p?.slotsAvailable&&!b)return;let f,k=this._buildItem(e,t,"spell",o);return get("showSpellInfo")&&this._addSpellInfo(o,k),f=h?a.subcategories.find((t=>t.name===c)):s.subcategories.find((t=>t.name===m)),f||(f=this.initializeEmptySubcategory(),u>0&&(f.info1=`${g}/${u}`)),f.actions.push(k),h&&a.subcategories.indexOf(f)<0?this._combineSubcategoryWithCategory(a,c,f):!h&&s.subcategories.indexOf(f)<0&&this._combineSubcategoryWithCategory(s,m,f),i}.bind(this),{});let d=this.initializeEmptyCategory("spells");d.name=this.i18n("tokenactionhud.spells");let h=this.i18n("tokenactionhud.powers"),u=this.i18n("tokenactionhud.books");return this._combineSubcategoryWithCategory(d,h,a),this._combineSubcategoryWithCategory(d,u,s),d}_addSpellInfo(t,e){let i=this._getDocumentData(t).components;e.info1="",e.info2="",e.info3="",i?.vocal&&(e.info1+=this.i18n("DND5E.ComponentVerbal").charAt(0).toUpperCase()),i?.somatic&&(e.info1+=this.i18n("DND5E.ComponentSomatic").charAt(0).toUpperCase()),i?.material&&(e.info1+=this.i18n("DND5E.ComponentMaterial").charAt(0).toUpperCase()),i?.concentration&&(e.info2+=this.i18n("DND5E.Concentration").charAt(0).toUpperCase()),i?.ritual&&(e.info3+=this.i18n("DND5E.Ritual").charAt(0).toUpperCase())}_buildFeaturesCategory(t){let e=this._filterLongerActions(t.actor.data.items.filter((t=>"feat"==t.type))),i=this._sortByItemSort(e);return this._categoriseFeats(t.id,t.actor,i)}_categoriseFeats(t,e,i){let a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();i.reduce(function(i,r){const l=this._getDocumentData(r).activation.type;let c=this._buildEquipmentItem(t,e,"feat",r);l&&""!==l?"lair"!=l?"legendary"!=l?a.actions.push(c):o.actions.push(c):n.actions.push(c):s.actions.push(c)}.bind(this),{});let r=this.initializeEmptyCategory("feats");r.name=this.i18n("tokenactionhud.features");let l=this.i18n("tokenactionhud.active"),c=this.i18n("tokenactionhud.legendary"),d=this.i18n("tokenactionhud.lair");if(this._combineSubcategoryWithCategory(r,l,a),this._combineSubcategoryWithCategory(r,c,o),this._combineSubcategoryWithCategory(r,d,n),!get("ignorePassiveFeats")){let t=this.i18n("tokenactionhud.passive");this._combineSubcategoryWithCategory(r,t,s)}return r}_buildSkillsCategory(t){const e=t.actor;if("vehicle"===e.data.type)return;const i=e.data.data.skills;let a=this.initializeEmptyCategory("skills");a.name=this.i18n("tokenactionhud.skills");let s="skill",n=get("abbreviateSkills"),o=Object.entries(i).map((e=>{try{let a=e[0],o=n?a:game.dnd5e.config.skills[a];o=o.charAt(0).toUpperCase()+o.slice(1);let r=[s,t.id,e[0]].join(this.delimiter),l=this._getProficiencyIcon(i[a].value);return{name:o,id:e[0],encodedValue:r,icon:l}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenactionhud.skills");return this._combineSubcategoryWithCategory(a,l,r),a}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=Object.entries(game.dnd5e.config.skills).map((t=>{let i=s?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,a,s){let n=this.initializeEmptyCategory(i);n.name=a;let o=get("abbreviateSkills"),r=Object.entries(game.dnd5e.config.abilities).map((a=>{if(0===e[a[0]].value)return;let n=o?a[0]:a[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[s,t,a[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[a[0]].proficient),{name:n,id:a[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l),n}_addMultiAbilities(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(game.dnd5e.config.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,a,l),this._combineCategoryWithList(t,a,n,!0)}_buildUtilityCategory(t){const e=t.actor;let i=this.initializeEmptyCategory("utility");i.name=this.i18n("tokenactionhud.utility");let a="utility",s=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory();if(this._addIntiativeSubcategory(a,i,t.id),"character"===e.data.type){let i=[a,t.id,"shortRest"].join(this.delimiter);s.actions.push({id:"shortRest",encodedValue:i,name:this.i18n("tokenactionhud.shortRest")});let o=[a,t.id,"longRest"].join(this.delimiter);if(s.actions.push({id:"longRest",encodedValue:o,name:this.i18n("tokenactionhud.longRest")}),e.data.data.attributes.hp.value<=0){let e={id:"deathSave",encodedValue:[a,t.id,"deathSave"].join(this.delimiter),name:this.i18n("tokenactionhud.deathSave")};n.actions.push(e)}let r={id:"inspiration",encodedValue:[a,t.id,"inspiration"].join(this.delimiter),name:this.i18n("tokenactionhud.inspiration")};r.cssClass=e.data.data.attributes?.inspiration?"active":"",n.actions.push(r)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.rests"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.utility"),n),i}_buildEffectsCategory(t){let e=this.initializeEmptyCategory("effects");return e.name=this.i18n("tokenactionhud.effects"),this._addEffectsSubcategories(t.actor,t.id,e),e}_buildConditionsCategory(t){if(!get("showConditionsCategory"))return;let e=this.initializeEmptyCategory("conditions");return e.name=this.i18n("tokenactionhud.conditions"),this._addConditionsSubcategory(t.actor,t.id,e),e}_addEffectsSubcategories(t,e,i){const a="effect",s="find"in t.effects.entries?t.effects.entries:t.effects;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this._getDocumentData(t),s=i.label,r=[a,e,t.id].join(this.delimiter),l=i.disabled?"":"active",c=i.icon;let d={name:s,id:t.id,encodedValue:r,img:c,cssClass:l};t.isTemporary?n.actions.push(d):o.actions.push(d)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!s)return;let o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this.i18n(t.label),s=[a,e,t.id].join(this.delimiter),r=n.every((e=>{("some"in e.effects.entries?e.effects.entries:e.effects).some((e=>e.data.flags.core?.statusId===t.id))}))?"active":"",l=t.icon,c={name:i,id:t.id,encodedValue:s,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenactionhud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id));if(!s)return;let n=this.initializeEmptySubcategory();s.forEach((i=>{const s=this.i18n(i.label),o=[a,e,i.id].join(this.delimiter),r=("some"in t.effects.entries?t.effects.entries:t.effects).some((t=>t.data.flags.core?.statusId===i.id))?"active":"",l=i.icon,c={name:s,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.conditions"),n)}_addIntiativeSubcategory(t,e,i){const a=game.combat;let s,n;a&&(s=a.combatants.find((t=>t.tokenId===i)),n=s?.initiative);let o=this.initializeEmptySubcategory(),r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};n&&(r.info1=n),r.cssClass=n?"active":"",o.actions.push(r),this._combineSubcategoryWithCategory(e,this.i18n("tokenactionhud.initiative"),o)}_addMultiIntiativeSubcategory(t,e,i){const a=game.combat;let s,n=this.initializeEmptySubcategory(),o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};if(a){s=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=s?"active":"",n.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.initiative"),n)}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s="utility";this._addMultiIntiativeSubcategory(s,e,a);let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.data.type))){let t=[s,e,"shortRest"].join(this.delimiter);n.actions.push({id:"shortRest",encodedValue:t,name:this.i18n("tokenactionhud.shortRest")});let a=[s,e,"longRest"].join(this.delimiter);n.actions.push({id:"longRest",encodedValue:a,name:this.i18n("tokenactionhud.longRest")});let r={id:"inspiration",encodedValue:[s,e,"inspiration"].join(this.delimiter),name:this.i18n("tokenactionhud.inspiration")};r.cssClass=i.every((t=>t.data.data.attributes?.inspiration))?"active":"",o.actions.push(r)}this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rests"),n),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.utility"),o),this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_buildEquipmentItem(t,e,i,a){let s=this._buildItem(t,e,i,a);return this._addItemInfo(e,a,s),s}_buildItem(t,e,i,a){const s=this._getDocumentData(a),n=a.id;let o=[i,t,n].join(this.delimiter),r=this._getImage(a),l=this._getActionIcon(a.data?.data?.activation?.type),c={name:a.name,id:n,encodedValue:o,img:r,icon:l};return s.recharge&&!s.recharge.charged&&s.recharge.value&&(c.name+=` (${this.i18n("tokenactionhud.recharge")})`),c}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e),i.info2=this._getUsesData(e),i.info3=this._getConsumeData(e,t)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="",i=this._getDocumentData(t).quantity;return i>1&&(e=i),e}_getUsesData(t){let e="",i=this._getDocumentData(t).uses;return i?(e=0===i.value&&i.max?"0":i.value,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){const i=this._getDocumentData(t);let a="",s=i.consume?.type;if(s&&""!==s){let t=i.consume.target,n=t.substr(0,t.lastIndexOf("."));if("attribute"===s){let t=getProperty(e,`data.data.${n}`);t&&(a=t.value??0,t.max&&(a+=`/${t.max}`))}if("charges"===s){let t=i.consume.target,s=e.items.get(t)?.data.data.uses;s?.value&&(a=s.value,s.max&&(a+=`/${s.max}`))}if("attribute"!==s&&"charges"!==s){let t=i.consume.target,s=e.items.get(t)?.data.data.quantity;s&&(a=s)}}return a}_filterLongerActions(t){var e;return get("hideLongerActions")&&(e=t.filter((t=>{const e=this._getDocumentData(t);return!e.activation||!("minute"===e.activation.type||"hour"===e.activation.type||"day"===e.activation.type)}))),e||t}_filterNonpreparedSpells(t){const e=Object.keys(game.dnd5e.config.spellPreparationModes).filter((t=>"prepared"!=t));let i=t;return i=get("showAllNonpreparableSpells")?t.filter((t=>{const i=this._getDocumentData(t);return i.preparation.prepared||e.includes(i.preparation.mode)||0===i.level})):t.filter((t=>this._getDocumentData(t).preparation.prepared)),i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=this._getDocumentData(t).uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{bonus:'<i class="fas fa-plus"></i>',crew:'<i class="fas fa-users"></i>',legendary:'<i class="fas fa-dragon"></i>',reaction:'<i class="fas fa-bolt"></i>',special:'<i class="fas fa-star"></i>',lair:'<i class="fas fa-home"></i>',minute:'<i class="fas fa-hourglass-start"></i>',hour:'<i class="fas fa-hourglass-half"></i>',day:'<i class="fas fa-hourglass-end"></i>'}[t]}_getDocumentData(t){return t.data.data??t.data}}class ActionHandler5eGroupByType extends ActionHandler5e{async _buildCategories(t){const e=game.modules.get("character-actions-list-5e").api,i=await e.getActorActionsData(t.actor);return[this._buildActionCategory(t,"actions",i.action),this._buildActionCategory(t,"bonusActions",i.bonus),this._buildActionCategory(t,"reactions",i.reaction),this._buildActionCategory(t,"crewActions",i.crew),this._buildActionCategory(t,"legendaryActions",i.legendary),this._buildActionCategory(t,"lairActions",i.lair),this._buildActionCategory(t,"specialActions",i.other),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildActionCategory(t,e,i){const a=this.initializeEmptyCategory(e);a.name=this.i18n(`tokenactionhud.${e}`);let s=[];for(const t of i)"spell"==t.type&&(s.push(t),i.delete(t));"character"!==t.actor.data.type&&get("showAllNpcItems")||(s=this._filterNonpreparedSpells(s)),s=this._sortSpellsByLevel(s),s=this._categoriseSpells(t.actor,t.id,s),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.weapons"),(t=>"weapon"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.equipment"),(t=>"equipment"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.consumables"),(t=>"consumable"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.tools"),(t=>"tool"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.other"),(t=>!0));for(const t of s.subcategories)this._combineSubcategoryWithCategory(a,t.name,t);return a}_subCategorizeEquipment(t,e,i,a,s){const n=this.initializeEmptySubcategory(),o=new Set;for(const t of i)s(t)&&(o.add(t),i.delete(t));o.size>0&&(n.actions=[...o].map((e=>this._buildEquipmentItem(t.id,t.actor,"item",e))),this._combineSubcategoryWithCategory(e,a,n))}}class MagicItemsPreRollHandler$1 extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){let i=e.split("|");if(3!=i.length)return!1;let a=i[0],s=i[1],n=i[2];return"magicItem"==a&&(this._magicItemMacro(t,s,n),!0)}_magicItemMacro(t,e,i){let a=super.getActor(e),s=i.split(">"),n=s[0],o=s[1];MagicItems.actor(a.id).roll(n,o),Hooks.callAll("forceUpdateTokenActionHUD")}}class MagicItemActionListExtender extends ActionListExtender{constructor(){super()}extendActionList(t,e){if(e)return;let i=t.tokenId,a=t.actorId;if(!a)return;let s=t.categories.find((t=>"inventory"===t.id)),n=MagicItems.actor(a);if(!n||!s)return;let o=n.items??[];if(0===o.length)return;let r=this.initializeEmptyCategory("magicItemsModule");r.name=this.i18n("tokenactionhud.magicItems");let l=o.map((t=>t.id));s.subcategories.forEach((t=>{t.actions.forEach((t=>{if(!l.includes(t.id))return;let e=o.find((e=>e.id===t.id));if(e.attuned&&!this._isItemAttuned(e))return;if(e.equipped&&!this._isItemEquipped(e))return;let a=this.initializeEmptySubcategory();a.info1=`${e.uses}/${e.charges}`,e.ownedEntries.forEach((e=>{let s=e.item,n=["magicItem",i,`${t.id}>${s.id}`].join("|"),o=this._getImage(s),r={name:s.name,id:s.id,encodedValue:n,img:o};r.info1=s.consumption,s.baseLevel&&(r.info2=`${this.i18n("tokenactionhud.levelAbbreviation")} ${s.baseLevel}`),a.actions.push(r)})),a.actions.unshift(t),this._combineSubcategoryWithCategory(r,t.name,a)}))})),this._combineCategoryWithList(t,r.name,r,!1)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_isItemEquipped(t){return t.item.data.data.equipped}_isItemAttuned(t){var e=t.item.data.data;if(e.attunement){const t=CONFIG.DND5E.attunementTypes?.ATTUNED??2;return e.attunement===t}return!!e.attuned&&e.attuned}}class RollHandlerBase5e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];if("multi"===s)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,a,i,n)}else await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"ability":this.rollAbilityMacro(t,i,a);break;case"skill":this.rollSkillMacro(t,i,a);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,a);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,a);break;case"item":case"spell":case"feat":this.isRenderItem()?this.doRenderItem(i,a):this.rollItemMacro(t,i,a);break;case"utility":await this.performUtilityMacro(t,i,a);break;case"effect":await this.toggleEffect(t,i,a);break;case"condition":await this.toggleCondition(t,i,a)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollAbilitySave(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){let a=super.getActor(e),s=super.getItem(a,i);if(!this.needsRecharge(s))return"spell"===s.data.type?a.useSpell(s):s.roll({event:t});s.rollRecharge()}needsRecharge(t){const e=this._getDocumentData(t);return e.recharge&&!e.recharge.charged&&e.recharge.value}async performUtilityMacro(t,e,i){let a=super.getActor(e),s=super.getToken(e);switch(i){case"shortRest":a.shortRest();break;case"longRest":a.longRest();break;case"inspiration":let i=!a.data.data.attributes.inspiration;a.update({"data.attributes.inspiration":i});break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":s.toggleVisibility();break;case"deathSave":a.rollDeathSave({event:t});break;case"initiative":await this.performInitiativeMacro(e)}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const a=super.getActor(e),s=("find"in a.effects.entries?a.effects.entries:a.effects).find((t=>t.id===i));if(!s)return;const n=s.data.flags.core?.statusId;n?await this.toggleCondition(t,e,n):(await s.update({disabled:!s.data.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i){const a=super.getToken(e),s=this.isRightClick(t);if(i.includes("combat-utility-belt.")&&game.cub&&!s){const t=this.findCondition(i)?.label;if(!t)return;game.cub.hasCondition(t,a)?await game.cub.removeCondition(t,a):await game.cub.addCondition(t,a)}else{const t=this.findCondition(i);if(!t)return;s?await a.toggleOverlay(t):await a.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}_getDocumentData(t){return t.data.data??t.data}}class RollHandlerMinorQol5e extends RollHandlerBase5e{constructor(){super()}rollItemMacro(t,e,i){let a=super.getActor(e),s=a.items.get(i);var n;this.needsRecharge(s)?s.rollRecharge():this.rightClick&&this.ctrl?s.rollAttack():this.rightClick&&this.alt?s.rollDamage():(s.data.data.properties?.ver&&(n=this.rightClick),MinorQOL.doCombinedRoll({actor:a,item:s,event:t,versatile:n}))}}class RollHandlerObsidian extends RollHandlerBase5e{constructor(){super()}rollAbilityCheckMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"abl",abl:i})}rollAbilitySaveMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"save",save:i})}rollSkillMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"skl",skl:i})}rollItemMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"item",id:i})}}class Dnd5eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){let i;return i=SystemManager.isModuleActive("character-actions-list-5e")&&get("useActionList")?new ActionHandler5eGroupByType(t,e):new ActionHandler5e(t,e),SystemManager.isModuleActive("magicitems")&&i.addFurtherActionHandler(new MagicItemActionListExtender),i}getAvailableRollHandlers(){let t="Core D&D5e";SystemManager.isModuleActive("midi-qol")&&(t+=` [supports ${SystemManager.getModuleTitle("midi-qol")}]`);let e={core:t};return SystemManager.addHandler(e,"minor-qol"),SystemManager.addHandler(e,"obsidian"),e}doGetRollHandler(t){let e;switch(t){case"minor-qol":e=new RollHandlerMinorQol5e;break;case"obsidian":e=new RollHandlerObsidian;break;case"core":default:e=new RollHandlerBase5e}return SystemManager.isModuleActive("magicitems")&&e.addPreRollHandler(new MagicItemsPreRollHandler$1),e}doRegisterSettings(t,e){!function register$c(t,e){game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showSpellInfo",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showSpellInfo.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showSpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNonpreparableSpells",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showAllNonpreparableSpells.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showAllNonpreparableSpells.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideLongerActions",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.hideLongerActions.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.hideLongerActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"splitAbilities",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.splitAbilities.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.splitAbilities.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNpcItems",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showAllNpcItems.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showAllNpcItems.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showEmptyItems.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showConditionsCategory",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showConditionsCategory.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showConditionsCategory.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showItemsWithoutAction",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showItemsWithoutAction.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showItemsWithoutAction.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.modules.get("character-actions-list-5e")?.active&&game.settings.register(t,"useActionList",{name:game.i18n.localize("tokenactionhud.settings.useActionList.name"),hint:game.i18n.localize("tokenactionhud.settings.useActionList.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerDemonlord extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id;let n=this._getAttributes(s,a),o=this._getItemsList(s,a),r=this._getTalents(s,a),l=this._getSpells(s,a),c=this._getUtilityList(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.settings.demonlord.challenge"),n),"character"===s.data.type?this._combineCategoryWithList(i,this.i18n("tokenactionhud.weapons"),o):this._combineCategoryWithList(i,this.i18n("tokenactionhud.settings.demonlord.attackoptions"),o),"character"===s.data.type?this._combineCategoryWithList(i,this.i18n("tokenactionhud.talents"),r):this._combineCategoryWithList(i,this.i18n("tokenactionhud.settings.demonlord.specialattacks"),r),this._combineCategoryWithList(i,this.i18n("tokenactionhud.spells"),l),this._combineCategoryWithList(i,this.i18n("tokenactionhud.utility"),c),this._setFilterSuggestions(s),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getItemsList(t,e){let i="weapon",a=this.initializeEmptyCategory("items"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,t.items.filter((t=>t.type==i)).map((t=>({name:t.name,encodedValue:[t.type,e,t.id].join(this.delimiter)}))),i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.weapons"),s),a}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory(),s="challenge",n=Object.entries(t.data.data.attributes).map((t=>({name:this.i18n("tokenactionhud.attribute."+t[0]),encodedValue:[s,e,t[0]].join(this.delimiter),id:t[0]})));return a.actions=this._produceMap(e,n,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.demonlord.challenge"),a),i}_addMultiAttributes(t,e,i){let a=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory(),n="challenge",o=null;i.every((t=>{let i=Object.entries(t.data.data.attributes);o=i.map((t=>({name:this.i18n("tokenactionhud.attribute."+t[0]),encodedValue:[n,e,t[0]].join(this.delimiter),id:t[0]})))})),null!=o&&(s.actions=this._produceMap(e,o,n),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.settings.demonlord.challenge"),s),this._combineCategoryWithList(t,this.i18n("tokenactionhud.settings.demonlord.challenge"),a))}_getTalents(t,e){let i="talent",a=this.initializeEmptyCategory("talents"),s=t.items.filter((t=>t.type==i));return[...new Set(s.map((t=>t.data.data.groupname)))].sort().forEach((t=>{if(null!=t){let n=this.initializeEmptySubcategory();n.name=t,a.subcategories.push(n);let o=this.initializeEmptySubcategory();s.forEach((a=>{if(a.data.data.groupname==t){let t=[i,e,a.id].join(this.delimiter),s={name:a.name,encodedValue:t,id:a.id};s.img=this._getImage(a),s.info2=this._getUsesData(a),o.actions.push(s)}})),this._combineSubcategoryWithCategory(n,t,o)}})),a}_getSpells(t,e){let i=this.initializeEmptyCategory("spells"),a=t.items.filter((t=>"spell"===t.type)),s=this._sortSpellsByRank(a),n=this._categoriseSpells(e,s);return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.spells"),n),i}_sortSpellsByRank(t){let e=Object.values(t);return e.sort(((t,e)=>t.data.rank===e.data.rank?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):t.data.rank-e.data.rank)),e}_categoriseSpells(t,e){const i="spell";let a=this.initializeEmptySubcategory();return[...new Set(e.map((t=>t.data.data.tradition)))].sort().forEach((s=>{if(null!=s){let n=this.initializeEmptySubcategory();n.name=s,a.subcategories.push(n);let o=this.initializeEmptySubcategory();e.forEach((e=>{if(e.data.data.tradition==s){let a=[i,t,e.id].join(this.delimiter),s={name:e.name,encodedValue:a,id:e.id};s.img=this._getImage(e),s.info2=this._getCastingsData(e),o.actions.push(s)}})),this._combineSubcategoryWithCategory(n,s,o)}})),a}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["creature","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));this._addMultiAttributes(t,t.tokenId,i),this._addMultiUtilities(t,t.tokenId,i)}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),a="utility",s=this.initializeEmptySubcategory();if("character"===t.data.type){let t=[a,e,"rest"].join(this.delimiter);s.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenactionhud.settings.demonlord.rest")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.demonlord.rest"),s),i}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s="utility",n=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.data.type))){let t=[s,e,"rest",""].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenactionhud.settings.demonlord.rest")})}this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.settings.demonlord.rest"),n),this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),a=e.filter((t=>!!t));return i.length>0&&(a=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),a}_produceMap(t,e,i){return e.map((t=>{let e=this._getImage(t),a={name:t.name,encodedValue:t.encodedValue,id:t.id,icon:e};return"talent"===i&&(a.info2=this._getUsesData(t)),a}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getUsesData(t){let e="",i=t.data.data.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_getCastingsData(t){let e="",i=t.data.data.castings;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}}class RollHandlerBaseDemonlord extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];"multi"===s?canvas.tokens.controlled.forEach((e=>{let i=e.data._id;this._handleMacros(t,a,i,n)})):this._handleMacros(t,a,s,n)}_handleMacros(t,e,i,a){let s=super.getActor(i),n=null;switch(["weapon","specialaction","spell","talent"].includes(e)&&(n=s.items.get(a)),e){case"challenge":const e=s?s.data.data.attributes[a]:null;s.rollChallenge(e,a);break;case"weapon":s.rollWeaponAttack(n.id,null);break;case"talent":case"specialaction":s.rollTalent(n.id,null);break;case"spell":s.rollSpell(n.id,null);break;case"utility":this.performUtilityMacro(t,i,a)}}performUtilityMacro(t,e,i){let a=super.getActor(e),s=super.getToken(e);switch(i){case"rest":a.restActor(s);break;case"toggleVisibility":s.toggleVisibility();break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD")}}}class DemonlordSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDemonlord(t,e)}getAvailableRollHandlers(){return{core:"Core Demonlord"}}doGetRollHandler(t){return new RollHandlerBaseDemonlord}doRegisterSettings(t,e){}}class ActionHandlerDw extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(get("showGmCompendiums")&&(i.tokenId="gm",i.actorId="gm",await this.addGmCompendiumsToList(i)),!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id;let n=s.data.type;if("npc"===n){let t=this._getDamage(s,a),e=this._getTags(s,a),n=this._getSpecialQualities(s,a);this.moves=this._getMovesNpc(s,a),this._combineCategoryWithList(i,this.i18n("tokenactionhud.damage"),t),this._combineCategoryWithList(i,this.i18n("tokenactionhud.tags"),e),this._combineCategoryWithList(i,this.i18n("tokenactionhud.specialQualities"),n)}else if("character"===n){let t=this._getDamage(s,a),e=this._getMovesByType(s,a,"starting"),n=this._getMovesByType(s,a,"advanced"),o=this._getMovesByType(s,a,"basic"),r=this._getMovesByType(s,a,"special"),l=this._getMovesByType(s,a,""),c=this._getSpells(s,a,"spells",this.i18n("tokenactionhud.spells"),"spell"),d=this._getSubcategoryByType(s,a,"equipment",this.i18n("tokenactionhud.equipment"),"equipment"),h=this._getAbilities(s,a);this._combineCategoryWithList(i,this.i18n("tokenactionhud.damage"),t),this._combineCategoryWithList(i,this.i18n("tokenactionhud.starting"),e),this._combineCategoryWithList(i,this.i18n("tokenactionhud.advanced"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.special"),r),this._combineCategoryWithList(i,this.i18n("tokenactionhud.basic"),o),this._combineCategoryWithList(i,this.i18n("tokenactionhud.other"),l),this._combineCategoryWithList(i,this.i18n("tokenactionhud.spells"),c),this._combineCategoryWithList(i,this.i18n("tokenactionhud.equipment"),d),this._combineCategoryWithList(i,this.i18n("tokenactionhud.abilities"),h)}return get("showHudTitle")&&(i.hudTitle=t.data?.name),i}async addGmCompendiumsToList(t){let e=this.initializeEmptyCategory("gm"),i=this.initializeEmptySubcategory();i.actions=await CompendiumHelper.getEntriesForActions("dungeonworld.gm-movesprincipals",this.delimiter);let a=this.i18n("tokenactionhud.moves");this._combineSubcategoryWithCategory(e,a,i);let s=this.initializeEmptySubcategory();s.actions=await CompendiumHelper.getEntriesForActions("dungeonworld.charts",this.delimiter);let n=this.i18n("tokenactionhud.charts");this._combineSubcategoryWithCategory(e,n,s);let o=this.initializeEmptySubcategory();o.actions=await CompendiumHelper.getEntriesForActions("dungeonworld.rollable-tables",this.delimiter);let r=this.i18n("tokenactionhud.treasure");this._combineSubcategoryWithCategory(e,r,o);let l=this.i18n("tokenactionhud.gm");this._combineCategoryWithList(t,l,e)}_getDamage(t,e){let i=this.initializeEmptyCategory("damage"),a=this.initializeEmptySubcategory(),s=["damage",e,"damage"].join(this.delimiter);return a.actions.push({name:this.i18n("DW.Damage"),encodedValue:s,id:"damage"}),this._combineSubcategoryWithCategory(i,this.i18n("DW.Damage"),a),i}_getMovesByType(t,e,i){let a=t.itemTypes.move.filter((t=>t.data.data.moveType===i)),s=this.initializeEmptyCategory("moves"),n=this._getRollMoves(a,e),o=this._getBookMoves(a,e);return this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.roll"),n),this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.book"),o),s}_getRollMoves(t,e){let i=t.filter((t=>""!==t.data.data.rollType)),a=this._produceMap(e,i,"move"),s=this.initializeEmptySubcategory();return s.actions=a,s}_getBookMoves(t,e){let i=t.filter((t=>""===t.data.data.rollType)),a=this._produceMap(e,i,"move"),s=this.initializeEmptySubcategory();return s.actions=a,s}_getSubcategoryByType(t,e,i,a,s){let n=t.itemTypes[s],o=this.initializeEmptyCategory(i),r=this._produceMap(e,n,s),l=this.initializeEmptySubcategory();return l.actions=r,this._combineSubcategoryWithCategory(o,a,l),o}_getSpells(t,e,i,a,s){let n=t.itemTypes[s].filter((t=>t.data.data.prepared)).sort(((t,e)=>parseInt(t.data.data.spellLevel)-parseInt(e.data.data.spellLevel))).reduce(((t,i)=>{let a,n=i.data.data.spellLevel,o=0==n?"Rotes":`${this.i18n("tokenactionhud.level")} ${n}`;t.some((t=>t.name===o))?a=t.find((t=>t.name===o)):(a=this.initializeEmptySubcategory(),a.name=o,t.push(a));let r=this._produceMap(e,[i],s);return a.actions.push(...r),t}),[]),o=this.initializeEmptyCategory(i);return n.forEach((t=>{this._combineSubcategoryWithCategory(o,t.name,t)})),o}_getAbilities(t,e){let i=this.initializeEmptyCategory("abilities"),a=Object.entries(t.data.data.abilities).map((t=>({data:{_id:t[0]},name:t[1].label}))),s=this._produceMap(e,a,"ability"),n=this.initializeEmptySubcategory();return n.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.abilities"),n),i}_getMovesNpc(t,e){let i=this.initializeEmptyCategory("moves"),a=t.data.data.details.biography,s=this.initializeEmptySubcategory(),n=new RegExp("<p(|s+[^>]*)>(Instinct:.*?)</ps*>","g"),o=Array.from(a.matchAll(n)).map((t=>{let e=t[2];return{data:{_id:encodeURIComponent(e)},name:e}})),r=this._produceMap(e,o,"instinct");s.actions=r;let l=this.initializeEmptySubcategory();var c=new RegExp("<li(|s+[^>]*)>(.*?)</lis*>","g"),d=Array.from(a.matchAll(c)).map((t=>{let e=t[2];return{data:{_id:encodeURIComponent(e)},name:e}}));let h=this._produceMap(e,d,"move");return l.actions=h,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.instinct"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.monsterMoves"),l),i}_getTags(t,e){let i=this.initializeEmptyCategory("tags"),a=t.data.data.tagsString.split(",").map((t=>{let e=t.trim();if(0!==e.length)return{data:{_id:encodeURIComponent(e)},name:e}})),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,a,"tag"),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.tags"),s),i}_getSpecialQualities(t,e){let i=this.initializeEmptyCategory("qualities"),a=t.data.data.attributes.specialQualities.value.split(",").map((t=>{let e=t.trim();if(0!==e.length)return{data:{_id:encodeURIComponent(e)},name:e}})),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,a,"quality"),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.specialQualities"),s),i}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let a=[i,t,e.data._id].join(this.delimiter),s={name:e.name,encodedValue:a,id:e.data._id};return this._addItemInfo(e,s),s}))}_addItemInfo(t,e){let i=t.data.data?.uses;e.info1=i??"";let a=t.data.data?.quantity;e.info2=a>1?a:""}}class RollHandlerBaseDw extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s),r=o.data.type;if("character"===r)switch(a){case"damage":this._handleDamage(a,t,o,n);break;case"move":case"spell":case"equipment":this._handleMove(a,t,s,o,n);break;case"ability":this._handleAbility(a,t,o,n)}else if("npc"===r)switch(a){case"damage":this._handleDamage(a,t,o,n);break;case"move":this._handleMoveNpc(a,t,o,n);break;case"tag":case"quality":case"instinct":this._handleTextNpc(a,t,o,n)}}_handleDamage(t,e,i,a){let s=i.data.data.attributes.damage,n=`${s.value}`,o=s.misc.value>0?s.misc.value:0,r=s.piercing,l=o>0?`${n}+${o}`:n,c={title:this.i18n("tokenactionhud.damage"),flavor:`${r}`};i.rollMove(l,i,{},c)}_handleMove(t,e,i,a,s){let n=a.items.get(s);this.isRenderItem()?this.doRenderItem(i,s):n.roll()}_handleAbility(t,e,i,a){let s=i.data.data.abilities[a],n=`2d6+${s.mod}`,o={title:`${s.label} ${game.i18n.localize("tokenactionhud.roll")}`,flavor:`Made a move using ${s.label.toLowerCase()}!`};i.rollMove(n,i,{},o)}_handleTextNpc(t,e,i,a){let s=decodeURIComponent(a),n={title:t.charAt(0).toUpperCase()+t.slice(1),details:s};i.rollMove(null,i,{},n)}}class DungeonWorldSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDw(t,e)}getAvailableRollHandlers(){return{core:"Core DungeonWorld"}}doGetRollHandler(t){return new RollHandlerBaseDw}doRegisterSettings(t,e){!function register$b(t,e){game.settings.register(t,"showGmCompendiums",{name:game.i18n.localize("tokenactionhud.settings.dungeonworld.showGmCompendiums.name"),hint:game.i18n.localize("tokenactionhud.settings.dungeonworld.showGmCompendiums.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerPf1 extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;return s?(i.actorId=s.id,this._addAttacksList(i,s,a),this._addBuffsList(i,s,a),this._addConditionsList(i,s,a),this._addItemsList(i,s,a),this._addSpellBooksList(i,s,a),this._addFeatsList(i,s,a),this._addSkillsList(i,s,a),this._addSavesList(i,s,a),this._addChecksList(i,s,a),this._addUtilityList(i,s,a),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const a=t.tokenId;this._addMultiSkills(t,a);let s=this.i18n("tokenactionhud.saves"),n=this.i18n("tokenactionhud.checks");this._addMultiSaves(t,a,"saves",s,"abilitySave"),this._addMultiAbilities(t,a,"checks",n,"abilityCheck"),this._addMultiUtilities(t,a,i)}_addAttacksList(t,e,i){let a=this._getAttacksList(e,i),s=this.i18n("tokenactionhud.attack");this._combineCategoryWithList(t,s,a)}_addBuffsList(t,e,i){let a=this._getBuffsList(e,i),s=this.i18n("tokenactionhud.buffs");this._combineCategoryWithList(t,s,a)}_addConditionsList(t,e,i){let a=this.i18n("tokenactionhud.conditions"),s=this._getConditionsList(i,e.data.data.attributes.conditions,"conditions",a,"condition");this._combineCategoryWithList(t,a,s)}_addItemsList(t,e,i){let a=this._getItemList(e,i),s=this.i18n("tokenactionhud.inventory");this._combineCategoryWithList(t,s,a)}_addSpellBooksList(t,e,i){this._getSpellsList(e,i).forEach((e=>{this._combineCategoryWithList(t,e.label,e.category)}))}_addFeatsList(t,e,i){let a=this._getFeatsList(e,i),s=this.i18n("tokenactionhud.features");this._combineCategoryWithList(t,s,a)}_addSkillsList(t,e,i){let a=this._getSkillsList(e.data.data.skills,i),s=this.i18n("tokenactionhud.skills");this._combineCategoryWithList(t,s,a)}_addSavesList(t,e,i){let a=this.i18n("tokenactionhud.saves"),s=this._getSavesList(i,e,"saves",a,"abilitySave");this._combineCategoryWithList(t,a,s)}_addChecksList(t,e,i){let a=this.i18n("tokenactionhud.checks"),s=this._getAbilityList(i,e.data.data.abilities,"checks",a,"abilityCheck");this._combineCategoryWithList(t,a,s)}_addUtilityList(t,e,i){let a=this._getUtilityList(e,i),s=this.i18n("tokenactionhud.utility");this._combineCategoryWithList(t,s,a)}_getAttacksList(t,e){let i=t.items.filter((t=>"attack"===t.type)).map((t=>t.data)),a=this._sortByItemSort(i),s=this.initializeEmptyCategory("attacks"),n="cmb",o={name:this.i18n("tokenactionhud.cmb"),encodedValue:[n,e,n].join(this.delimiter),id:n},r="bab",l={name:this.i18n("tokenactionhud.bab"),encodedValue:[r,e,r].join(this.delimiter),id:r},c=this.initializeEmptySubcategory();c.actions=Array.of(o,l),this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.bonuses"),c);let d="melee",h={name:this.i18n("tokenactionhud.melee"),encodedValue:[d,e,d].join(this.delimiter),id:d},u="ranged",g={name:this.i18n("tokenactionhud.ranged"),encodedValue:[u,e,u].join(this.delimiter),id:u},m=a.map((i=>this._buildItem(e,t,"attack",i))),y=this.initializeEmptySubcategory();m.unshift(g),m.unshift(h),y.actions=m;let p=this.i18n("tokenactionhud.attack");return this._combineSubcategoryWithCategory(s,p,y),s}_getBuffsList(t,e){let i=t.items.filter((t=>"buff"===t.type)).map((t=>t.data)),a=this._sortByItemSort(i),s=a.map((i=>{var a=this._buildItem(e,t,"buff",i);return a.cssClass=i.data.active?"active":"",a})),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.buffs"),r=this.initializeEmptyCategory("buffs");return this._combineSubcategoryWithCategory(r,o,n),r}_getItemList(t,e){let i=t.items.filter((t=>t.data.data.quantity>0)).map((t=>t.data)),a=this._sortByItemSort(i),s="item",n=a.filter((t=>"consumable"!==t.type&&t.data.equipped)),o=n.filter((t=>"weapon"==t.type)).map((i=>this._buildItem(e,t,s,i))),r=this.initializeEmptySubcategory();r.actions=o;let l=n.filter((t=>"equipment"==t.type)).map((i=>this._buildItem(e,t,s,i))),c=this.initializeEmptySubcategory();c.actions=l;let d=n.filter((t=>"weapon"!=t.type&&"equipment"!=t.type)).map((i=>this._buildItem(e,t,s,i))),h=this.initializeEmptySubcategory();h.actions=d;let u=a.filter((t=>"consumable"==t.type)),g=this._filterExpendedItems(u).filter((t=>t.data.uses?.value&&t.data.uses?.value>=0||t.data.uses?.max&&t.data.uses?.max>=0)).map((i=>this._buildItem(e,t,s,i))),m=this.initializeEmptySubcategory();m.actions=g;let y=u.filter((t=>!(t.data.uses?.max||t.data.uses?.value)&&"ammo"!=t.data.consumableType)).map((i=>this._buildItem(e,t,s,i))),p=this.initializeEmptySubcategory();p.actions=y;let b=i.filter((t=>"tool"===t.type)).map((i=>this._buildItem(e,t,s,i))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenactionhud.weapons"),_=this.i18n("tokenactionhud.equipment"),C=this.i18n("tokenactionhud.other"),S=this.i18n("tokenactionhud.consumables"),v=this.i18n("tokenactionhud.inconsumables"),A=this.i18n("tokenactionhud.tools"),w=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(w,k,r),this._combineSubcategoryWithCategory(w,_,c),this._combineSubcategoryWithCategory(w,C,h),this._combineSubcategoryWithCategory(w,S,m),this._combineSubcategoryWithCategory(w,v,p),this._combineSubcategoryWithCategory(w,A,f),w}_getSpellsList(t,e){let i=t.items.filter((t=>"spell"===t.type)).map((t=>t.data));return i=this._filterExpendedItems(i),this._categoriseSpells(t,e,i)}_categoriseSpells(t,e,i){let a=[];const s="spell";return[...new Set(i.map((t=>t.data.spellbook)))].sort().forEach((n=>{const o=this.initializeEmptySubcategory(`spells-${n}`),r=this.initializeEmptySubcategory("concentration","tokenactionhud.checks"),l=t.data.data.attributes.spells.spellbooks[n],c=l.spontaneous,toUpperFirstChar=t=>t.charAt(0).toUpperCase()+t.slice(1);let d=l.altName||toUpperFirstChar(l.class)||toUpperFirstChar(n);r.actions.push(this._createConcentrationAction(e,n,this.i18n("tokenactionhud.concentration"))),r.actions.push(this._createCasterlevelCheckAction(e,n,this.i18n("tokenactionhud.casterlevel")));const h=i.filter((t=>t.data.spellbook===n)).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}))).sort(((t,e)=>t.data.level-e.data.level)).reduce(((t,e)=>(t.hasOwnProperty(e.data.level)||(t[e.data.level]=[]),t[e.data.level].push(e),t)),{});Object.entries(h).forEach((i=>{var a=this.initializeEmptySubcategory(),r=i[0]>0?`${this.i18n("tokenactionhud.level")} ${i[0]}`:this.i18n("tokenactionhud.cantrips"),l=t.data.data.attributes?.spells?.spellbooks[n].spells["spell"+i[0]];if(l&&l.max>0){var d=`${l.value}/${l.max}`;a.info1=d}i[1].forEach((i=>{if(!this._isSpellCastable(t,i))return;let n=i.name;n=n.charAt(0).toUpperCase()+n.slice(1);let o=i._id,r=[s,e,o].join(this.delimiter);var l={name:n,id:o,encodedValue:r,info2:""};l.img=this._getImage(i),this._addSpellInfo(i,c,l),a.actions.push(l)})),this._combineSubcategoryWithCategory(o,r,a)})),r.actions?.length>0&&o.subcategories.unshift(r),a.push({label:d,category:o})})),a}_addSpellInfo(t,e,i){let a=t.data.components;if(!e&&t.data.preparation){let e=t.data.preparation;e.maxAmount&&(i.info1=`${e.preparedAmount}/${e.maxAmount}`)}a?.verbal&&(i.info2+=this.i18n("PF1.SpellComponentVerbal").charAt(0).toUpperCase()),a?.somatic&&(i.info2+=this.i18n("PF1.SpellComponentSomatic").charAt(0).toUpperCase()),a?.material&&(i.info2+=this.i18n("PF1.SpellComponentMaterial").charAt(0).toUpperCase()),a?.focus&&(i.info3=this.i18n("PF1.SpellComponentFocus").charAt(0).toUpperCase())}_isSpellCastable(t,e){const i=e.data.spellbook,a=t.data.data.attributes.spells.spellbooks[i].spontaneous;return"character"!==t.data.type||(!!e.data.atWill||(!(!a||!e.data.preparation.spontaneousPrepared)||0!==e.data.preparation.preparedAmount))}_createCasterlevelCheckAction(t,e,i){let a="casterLevel";return{name:i,encodedValue:[a,t,e.toLowerCase()].join(this.delimiter),id:a}}_createConcentrationAction(t,e,i){let a="concentration";return{name:i,encodedValue:[a,t,e.toLowerCase()].join(this.delimiter),id:a}}_getFeatsList(t,e){let i=t.items.filter((t=>"feat"==t.type)).map((t=>t.data)),a=this._sortByItemSort(i);return this._categoriseFeats(e,t,a)}_categoriseFeats(t,e,i){let a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory();i.reduce(function(i,o){const r=o.data.activation?.type??o.data.actions[0]?.activation.type;let l=this._buildItem(t,e,"feat",o);o.document.isActive?r&&""!==r&&"passive"!==r?a.actions.push(l):s.actions.push(l):n.actions.push(l)}.bind(this),{});let o=this.initializeEmptyCategory("feats"),r=this.i18n("tokenactionhud.active");if(this._combineSubcategoryWithCategory(o,r,a),!get("ignorePassiveFeats")){let t=this.i18n("tokenactionhud.passive");this._combineSubcategoryWithCategory(o,t,s)}if(!get("ignoreDisabledFeats")){let t=this.i18n("tokenactionhud.pf1.disabled");this._combineSubcategoryWithCategory(o,t,n)}return o}_getSkillsList(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=new Set;Object.entries(t).forEach((t=>{t[0].startsWith("skill")&&(t[1].isCustomSkill=!0),n.add(t),t[1].subSkills&&Object.entries(t[1].subSkills).forEach((e=>{e[1].isCustomSkill=!0,e[1].mainSkill=t[0],n.add(e)}))}));let o=[...n].map((t=>{let i=t[0],n=t[1];if(n.rt&&!n.rank)return null;let o=s?i:CONFIG.PF1.skills[i];!n.isCustomSkill&&o||(o=n.name??"?",i=`${n.mainSkill}.subSkills.${i}`),o=o.charAt(0).toUpperCase()+o.slice(1);let r=[a,e,i].join(this.delimiter);return{name:o,id:i,encodedValue:r,info1:this._getSkillRankInfo(n.rank)}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenactionhud.skills");return this._combineSubcategoryWithCategory(i,l,r),i}_getSkillRankInfo(t){return t<=0?"":`R${t}`}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=Object.entries(CONFIG.PF1.skills).map((t=>{let i=s?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.PF1.abilities).map((a=>{if(0===e[a[0]].value)return;let n=o?a[0]:a[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[s,t,a[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[a[0]].proficient),{name:n,id:a[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l),n}_getSavesList(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.PF1.savingThrows).map((e=>{let i=o?e[0]:e[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,t,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l);let c=this.initializeEmptySubcategory(),d="defenses",h=[{name:this.i18n("tokenactionhud.defenses"),encodedValue:[d,t,d].join(this.delimiter),id:d}];return c.actions=h,this._combineSubcategoryWithCategory(n,this.i18n("tokenactionhud.defenses"),c),n}_getConditionsList(t,e,i,a,s){if(!e)return;let n=this.initializeEmptyCategory(i),o=this.initializeEmptySubcategory();return Object.entries(e).forEach((e=>{const i=e[0],a=e[1];let n,r=CONFIG.PF1.conditions[i];get("showIcons")&&(n=CONFIG.PF1.conditionTextures[i]);let l=[s,t,i].join(this.delimiter),c={name:r,id:i,encodedValue:l,img:n};c.cssClass=a?"active":"",o.actions.push(c)})),o.actions=o.actions.sort(((t,e)=>t.name<e.name?-1:t.name>e.name?1:0)),this._combineSubcategoryWithCategory(n,a,o),n}_addMultiAbilities(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.PF1.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,a,l),this._combineCategoryWithList(t,a,n,!0)}_addMultiSaves(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=this.initializeEmptySubcategory(),r=get("abbreviateSkills"),l=Object.entries(CONFIG.PF1.savingThrows).map((t=>{let i=r?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}}));o.actions=l.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,o),this._combineCategoryWithList(t,a,n,!0)}_addIntiativeSubcategory(t,e,i){const a=game.combat;let s,n;a&&(s=a.combatants.find((t=>t.tokenId===i)),n=s?.initiative);let o=this.initializeEmptySubcategory(),r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};n&&(r.info1=n),r.cssClass=n?"active":"",o.actions.push(r),this._combineSubcategoryWithCategory(e,this.i18n("tokenactionhud.initiative"),o)}_addMultiIntiativeSubcategory(t,e,i){const a=game.combat;let s,n=this.initializeEmptySubcategory(),o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};if(a){s=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=s?"active":"",n.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.initiative"),n)}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),a="utility";this._addIntiativeSubcategory(a,i,e);let s=this.initializeEmptySubcategory();if("character"===t.data.type){let t=[a,e,"rest"].join(this.delimiter);s.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenactionhud.rest")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.rests"),s),i}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s="utility";this._addMultiIntiativeSubcategory(s,e,a);let n=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.data.type))){let t=[s,e,"rest"].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenactionhud.rest")})}this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rests"),n),this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_buildItem(t,e,i,a){let s=[i,t,a._id].join(this.delimiter),n=this._getImage(a),o=this._getActionIcon(a.data?.activation?.type),r={name:this._getItemName(a),id:a._id,encodedValue:s,img:n,icon:o};return a.data.recharge&&!a.data.recharge.charged&&a.data.recharge.value&&(r.name+=` (${this.i18n("tokenactionhud.recharge")})`),r.info1=this._getQuantityData(a),r.info2=this._getUsesData(a),r.info3=this._getConsumeData(a,e),r}_getItemName(t){let e;return e=t.data.identified||game.user.isGM?t.data.identifiedName:t.data.unidentified?.name,e||(e=t.name),e}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="";return t.data.quantity>1&&(e=t.data.quantity),e}_getUsesData(t){let e="",i=t.data.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){let i="",a=t.data.consume?.type;if(a&&""!==a){let s=t.data.consume.target,n=s.substr(0,s.lastIndexOf("."));if("attribute"===a){let t=getProperty(e,`data.data.${s}`);if(t){let a=getProperty(e,`data.data.${n}`);i=t,a.max&&(i+=`/${a.max}`)}}if("charges"===a){let a=t.data.consume.target,s=e.items.get(a)?.data.data.uses;s?.value&&(i=s.value,s.max&&(i+=`/${s.max}`))}if("attribute"!==a&&"charges"!==a){let a=t.data.consume.target,s=e.items.get(a)?.data.data.quantity;s&&(i=s)}}return i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.data.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{immediate:'<i class="fas fa-bolt"></i>',reaction:'<i class="fas fa-bolt"></i>',free:'<i class="fas fa-plus"></i>',swift:'<i class="fas fa-plus"></i>',full:'<i class="far fa-circle"></i>',round:'<i class="fas fa-hourglass-start"></i>',minute:'<i class="fas fa-hourglass-half"></i>',hour:'<i class="fas fa-hourglass-end"></i>',special:'<i class="fas fa-star"></i>'}[t]}}class RollHandlerBasePf1 extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];"multi"===s?canvas.tokens.controlled.forEach((e=>{let i=e.data._id;this._handleMacros(t,a,i,n)})):await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"ability":this.rollAbilityMacro(t,i,a);break;case"casterLevel":this.rollcasterLevelMacro(t,i,a);break;case"concentration":this.rollConcentrationMacro(t,i,a);break;case"cmb":this.rollCmbMacro(t,i,a);break;case"melee":this.rollMeleeAttackMacro(t,i,a);break;case"ranged":this.rollRangedAttackMacro(t,i,a);break;case"bab":this.rollBAB(t,i,a);break;case"skill":this.rollSkillMacro(t,i,a);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,a);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,a);break;case"buff":await this.adjustBuff(t,i,a);break;case"condition":await this.adjustCondition(t,i,a);break;case"item":case"spell":case"feat":case"attack":this.isRenderItem()?this.doRenderItem(i,a):this.rollItemMacro(t,i,a);break;case"defenses":this.rollDefenses(t,i,a);break;case"utility":await this.performUtilityMacro(t,i,a)}}rollCmbMacro(t,e,i){super.getActor(e).rollCMB(t)}rollMeleeAttackMacro(t,e,i){super.getActor(e).rollAttack({event:t,melee:!0})}rollRangedAttackMacro(t,e,i){super.getActor(e).rollAttack({event:t,melee:!1})}rollBAB(t,e,i){super.getActor(e).rollBAB({event:t})}rollcasterLevelMacro(t,e,i){super.getActor(e).rollCL(i)}rollConcentrationMacro(t,e,i){super.getActor(e).rollConcentration(i)}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollSavingThrow(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){const a=super.getActor(e);super.getItem(a,i).use({ev:t,skipDialog:!1})}rollDefenses(t,e,i){super.getActor(e).rollDefenses()}async adjustBuff(t,e,i){let a=super.getActor(e),s=super.getItem(a,i),n={data:{active:!s.data.data.active}};await s.update(n)}async adjustCondition(t,e,i){let a=super.getActor(e);const s=a.data.data.attributes.conditions[i];let n={data:{attributes:{conditions:{}}}};n.data.attributes.conditions[i]=!s,await a.update(n)}async performUtilityMacro(t,e,i){let a=super.getActor(e),s=super.getToken(e);switch(i){case"rest":a.sheet._onRest(t);break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":s.toggleVisibility();break;case"initiative":await this.performInitiativeMacro(e)}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}}class Pf1SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerPf1(t,e)}getAvailableRollHandlers(){return{core:"Core PF1"}}doGetRollHandler(t){return new RollHandlerBasePf1}doRegisterSettings(t,e){!function register$a(t,e){game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showEmptyItems.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"ignoreDisabledFeats",{name:game.i18n.localize("tokenactionhud.settings.pf1.showDisabled.name"),hint:game.i18n.localize("tokenactionhud.settings.pf1.showDisabled.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerD35E extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;return s?(i.actorId=s.id,this._addAttacksList(i,s,a),this._addBuffsList(i,s,a),this._addItemsList(i,s,a),this._addSpellsList(i,s,a),this._addFeatsList(i,s,a),this._addSkillsList(i,s,a),this._addSavesList(i,s,a),this._addChecksList(i,s,a),this._addUtilityList(i,s,a),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const a=t.tokenId;this._addMultiSkills(t,a);let s=this.i18n("tokenactionhud.saves"),n=this.i18n("tokenactionhud.checks");this._addMultiSaves(t,a,"saves",s,"abilitySave"),this._addMultiAbilities(t,a,"checks",n,"abilityCheck"),this._addMultiUtilities(t,a,i)}_addAttacksList(t,e,i){let a=this._getAttacksList(e,i),s=this.i18n("tokenactionhud.attack");this._combineCategoryWithList(t,s,a)}_addBuffsList(t,e,i){let a=this._getBuffsList(e,i),s=this.i18n("tokenactionhud.buffs");this._combineCategoryWithList(t,s,a)}_addItemsList(t,e,i){let a=this._getItemList(e,i),s=this.i18n("tokenactionhud.inventory");this._combineCategoryWithList(t,s,a)}_addSpellsList(t,e,i){let a=this._getSpellsList(e,i),s=this.i18n("tokenactionhud.spells");this._combineCategoryWithList(t,s,a)}_addFeatsList(t,e,i){let a=this._getFeatsList(e,i),s=this.i18n("tokenactionhud.features");this._combineCategoryWithList(t,s,a)}_addSkillsList(t,e,i){let a=this._getSkillsList(e.data.data.skills,i),s=this.i18n("tokenactionhud.skills");this._combineCategoryWithList(t,s,a)}_addSavesList(t,e,i){let a=this.i18n("tokenactionhud.saves"),s=this._getSavesList(i,e,"saves",a,"abilitySave");this._combineCategoryWithList(t,a,s)}_addChecksList(t,e,i){let a=this.i18n("tokenactionhud.checks"),s=this._getAbilityList(i,e.data.data.abilities,"checks",a,"abilityCheck");this._combineCategoryWithList(t,a,s)}_addUtilityList(t,e,i){let a=this._getUtilityList(e,i),s=this.i18n("tokenactionhud.utility");this._combineCategoryWithList(t,s,a)}_getAttacksList(t,e){let i=t.data.items.filter((t=>"attack"===t.type)),a=this._sortByItemSort(i),s="attack",n=this.initializeEmptyCategory("attacks"),o=this.initializeEmptySubcategory(),r="cmb",l=[{name:this.i18n("tokenactionhud.d35e.grapple"),encodedValue:[r,e,r].join(this.delimiter),id:r}];o.actions=l,this._combineSubcategoryWithCategory(n,this.i18n("tokenactionhud.d35e.grapple"),o);let c=a.map((i=>this._buildItem(e,t,s,i))),d=this.initializeEmptySubcategory();d.actions=c;let h=this.i18n("tokenactionhud.attack");this._combineSubcategoryWithCategory(n,h,d);let u=t.data.items.filter((t=>"full-attack"===t.type)),g=this._sortByItemSort(u).map((i=>this._buildItem(e,t,s,i))),m=this.initializeEmptySubcategory();m.actions=g;let y=this.i18n("tokenactionhud.fullAttack");return this._combineSubcategoryWithCategory(n,y,m),n}_getBuffsList(t,e){let i=t.data.items.filter((t=>"buff"===t.type)),a=this._sortByItemSort(i),s=a.map((i=>{var a=this._buildItem(e,t,"buff",i);return a.cssClass=i.data.data.active?"active":"",a})),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.buffs"),r=this.initializeEmptyCategory("buffs");return this._combineSubcategoryWithCategory(r,o,n),r}_getItemList(t,e){let i=t.data.items.filter((t=>t.data.data.quantity>0)),a=this._sortByItemSort(i),s="item",n=a.filter((t=>"consumable"!==t.type&&t.data.data.equipped)),o=n.filter((t=>"weapon"==t.type)).map((i=>this._buildItem(e,t,s,i))),r=this.initializeEmptySubcategory();r.actions=o;let l=n.filter((t=>"equipment"==t.type)).map((i=>this._buildItem(e,t,s,i))),c=this.initializeEmptySubcategory();c.actions=l;let d=n.filter((t=>"weapon"!=t.type&&"equipment"!=t.type)).map((i=>this._buildItem(e,t,s,i))),h=this.initializeEmptySubcategory();h.actions=d;let u=a.filter((t=>"consumable"==t.type)),g=this._filterExpendedItems(u).filter((t=>t.data.data.uses?.value&&t.data.data.uses?.value>=0||t.data.data.uses?.max&&t.data.data.uses?.max>=0)).map((i=>this._buildItem(e,t,s,i))),m=this.initializeEmptySubcategory();m.actions=g;let y=u.filter((t=>!(t.data.data.uses?.max||t.data.data.uses?.value)&&"ammo"!=t.data.data.consumableType)).map((i=>this._buildItem(e,t,s,i))),p=this.initializeEmptySubcategory();p.actions=y;let b=i.filter((t=>"tool"===t.type)).map((i=>this._buildItem(e,t,s,i))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenactionhud.weapons"),_=this.i18n("tokenactionhud.equipment"),C=this.i18n("tokenactionhud.other"),S=this.i18n("tokenactionhud.consumables"),v=this.i18n("tokenactionhud.inconsumables"),A=this.i18n("tokenactionhud.tools"),w=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(w,k,r),this._combineSubcategoryWithCategory(w,_,c),this._combineSubcategoryWithCategory(w,C,h),this._combineSubcategoryWithCategory(w,S,m),this._combineSubcategoryWithCategory(w,v,p),this._combineSubcategoryWithCategory(w,A,f),w}_getSpellsList(t,e){let i=t.data.items.filter((t=>"spell"===t.type));return i=this._filterExpendedItems(i),this._categoriseSpells(t,e,i)}_categoriseSpells(t,e,i){const a="spell";let s=this.initializeEmptySubcategory("spells"),n=this.initializeEmptySubcategory("concentration");n.name=this.i18n("tokenactionhud.concentration");return[...new Set(i.map((t=>t.data.data.spellbook)))].sort().forEach((o=>{const r=t.data.data.attributes.spells.spellbooks[o].spontaneous;let l=o.charAt(0).toUpperCase()+o.slice(1);n.actions.push(this._createConcentrationAction(e,l));const c=i.filter((t=>t.data.data.spellbook===o)).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}))).sort(((t,e)=>t.data.data.level-e.data.data.level)).reduce(((t,e)=>(t.hasOwnProperty(e.data.data.level)||(t[e.data.data.level]=[]),t[e.data.data.level].push(e),t)),{});var d=!0;Object.entries(c).forEach((i=>{var n=this.initializeEmptySubcategory(),c=i[0]>0?`${this.i18n("tokenactionhud.level")} ${i[0]}`:this.i18n("tokenactionhud.cantrips"),h=t.data.data.attributes?.spells?.spellbooks[o].spells["spell"+i[0]];if(h&&h.max>0){var u=`${h.value?h.value+"/":""}${h.max}`;n.info1=u}d&&(c=`${l} - ${c}`,d=!1),i[1].forEach((i=>{if(!this._isSpellCastable(t,i))return;let s=i.name;s=s.charAt(0).toUpperCase()+s.slice(1);let o=i.id,l=[a,e,o].join(this.delimiter);var c={name:s,id:o,encodedValue:l,info2:""};c.img=this._getImage(i),this._addSpellInfo(i,r,c),n.actions.push(c)})),this._combineSubcategoryWithCategory(s,c,n)}))})),n.actions?.length>0&&s.subcategories.unshift(n),s}_addSpellInfo(t,e,i){let a=t.data.data.components;if(!e&&t.data.data.preparation){let e=t.data.data.preparation;(e.maxAmount||e.preparedAmount)&&(i.info1=`${e.preparedAmount}/${e.maxAmount}`)}a?.verbal&&(i.info2+=this.i18n("D35E.SpellComponentVerbal").charAt(0).toUpperCase()),a?.somatic&&(i.info2+=this.i18n("D35E.SpellComponentSomatic").charAt(0).toUpperCase()),a?.material&&(i.info2+=this.i18n("D35E.SpellComponentMaterial").charAt(0).toUpperCase()),a?.focus&&(i.info3=this.i18n("D35E.SpellComponentFocus").charAt(0).toUpperCase())}_isSpellCastable(t,e){const i=e.data.data.spellbook,a=t.data.data.attributes.spells.spellbooks[i].spontaneous;return!!e.data.data.atWill||(!!a||0!==e.data.data.preparation.preparedAmount)}_createConcentrationAction(t,e){let i="concentration";return{name:e,encodedValue:[i,t,e.toLowerCase()].join(this.delimiter),id:i}}_getFeatsList(t,e){let i=t.data.items.filter((t=>"feat"==t.type)),a=this._sortByItemSort(i);return this._categoriseFeats(e,t,a)}_categoriseFeats(t,e,i){let a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory();i.reduce(function(i,n){const o=n.data.data.activation.type;let r=this._buildItem(t,e,"feat",n);o&&""!==o&&"passive"!==o?a.actions.push(r):s.actions.push(r)}.bind(this),{});let n=this.initializeEmptyCategory("feats"),o=this.i18n("tokenactionhud.active");if(this._combineSubcategoryWithCategory(n,o,a),!get("ignorePassiveFeats")){let t=this.i18n("tokenactionhud.passive");this._combineSubcategoryWithCategory(n,t,s)}return n}_getSkillsList(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=new Set;Object.entries(t).forEach((t=>{let e=duplicate(t);e[0].startsWith("skill")&&(e[1].isCustomSkill=!0),(!e[1].rt||e[1].rank||e[1].subSkills)&&(e[1].subSkills||n.add(e),e[1].subSkills&&Object.entries(e[1].subSkills).forEach((t=>{t[1].rt&&!t[1].rank||(t[1].isCustomSkill=!0,t[1].mainSkill=e[0],t[1].name=`${CONFIG.D35E.skills[e[0]]} - ${t[1].name}`,n.add(t))})))}));let o=[...n].map((t=>{let i=t[0],n=t[1],o=s?i:CONFIG.D35E.skills[i];!n.isCustomSkill&&o||(o=n.name??"?",i=`${n.mainSkill}.subSkills.${i}`),o=o.charAt(0).toUpperCase()+o.slice(1);let r=[a,e,i].join(this.delimiter);return{name:o,id:i,encodedValue:r,info1:this._getSkillRankInfo(n.rank),info2:[n.rt?"RT":"",n.acp?"ACP":""].filter((t=>""!==t)).join(",")}})),r=this.initializeEmptySubcategory();r.actions=o.sort((function(t,e){return t.name>e.name?1:t.name<e.name?-1:0}));let l=this.i18n("tokenactionhud.skills");return this._combineSubcategoryWithCategory(i,l,r),i}_getSkillRankInfo(t){return t<=0?"":`R${t}`}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=Object.entries(CONFIG.D35E.skills).map((t=>{let i=s?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.D35E.abilities).map((a=>{if(0===e[a[0]].value)return;let n=o?a[0]:a[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[s,t,a[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[a[0]].proficient),{name:n,id:a[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l),n}_getSavesList(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.D35E.savingThrows).map((e=>{let i=o?e[0]:e[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,t,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l);let c=this.initializeEmptySubcategory(),d="defenses",h=[{name:this.i18n("tokenactionhud.defenses"),encodedValue:[d,t,d].join(this.delimiter),id:d}];return c.actions=h,this._combineSubcategoryWithCategory(n,this.i18n("tokenactionhud.defenses"),c),n}_addMultiAbilities(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.D35E.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,a,l),this._combineCategoryWithList(t,a,n,!0)}_addMultiSaves(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=this.initializeEmptySubcategory(),r=get("abbreviateSkills"),l=Object.entries(CONFIG.D35E.savingThrows).map((t=>{let i=r?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}}));o.actions=l.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,o),this._combineCategoryWithList(t,a,n,!0)}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),a="utility",s=this.initializeEmptySubcategory();if("character"===t.data.type){let t=[a,e,"rest"].join(this.delimiter);s.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenactionhud.rest")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.rests"),s),i}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s="utility",n=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.data.type))){let t=[s,e,"rest"].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenactionhud.rest")})}this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rests"),n)}_buildItem(t,e,i,a){let s=[i,t,a.id].join(this.delimiter),n=this._getImage(a),o=this._getActionIcon(a.data?.activation?.type),r={name:this._getItemName(a),id:a.id,encodedValue:s,img:n,icon:o};return a.data.data.recharge&&!a.data.data.recharge.charged&&a.data.data.recharge.value&&(r.name+=` (${this.i18n("tokenactionhud.recharge")})`),r.info1=this._getQuantityData(a),r.info2=this._getUsesData(a),r.info3=this._getConsumeData(a,e),r}_getItemName(t){let e;return e=t.data.data.identified||game.user.isGM?t.data.data.identifiedName:t.data.data.unidentified?.name,e||(e=t.name),e}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="";return t.data.data.quantity>1&&(e=t.data.data.quantity),e}_getUsesData(t){let e="",i=t.data.data.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){let i="",a=t.data.data.consume?.type;if(a&&""!==a){let s=t.data.data.consume.target,n=s.substr(0,s.lastIndexOf("."));if("attribute"===a){let t=getProperty(e,`data.data.${s}`);if(t){let a=getProperty(e,`data.data.${n}`);i=t,a.max&&(i+=`/${a.max}`)}}if("charges"===a){let a=t.data.data.consume.target,s=e.items.get(a)?.data.data.uses;s?.value&&(i=s.value,s.max&&(i+=`/${s.max}`))}if("attribute"!==a&&"charges"!==a){let a=t.data.data.consume.target,s=e.items.get(a)?.data.data.quantity;s&&(i=s)}}return i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.data.data.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{immediate:'<i class="fas fa-bolt"></i>',swift:'<i class="fas fa-plus"></i>',full:'<i class="far fa-circle"></i>',round:'<i class="fas fa-hourglass-start"></i>',minute:'<i class="fas fa-hourglass-half"></i>',hour:'<i class="fas fa-hourglass-end"></i>'}[t]}}class RollHandlerBaseD35E extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];"multi"===s?canvas.tokens.controlled.forEach((e=>{let i=e.data._id;this._handleMacros(t,a,i,n)})):await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"ability":this.rollAbilityMacro(t,i,a);break;case"concentration":this.rollConcentrationMacro(t,i,a);break;case"cmb":this.rollCmbMacro(t,i,a);break;case"skill":this.rollSkillMacro(t,i,a);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,a);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,a);break;case"buff":await this.adjustBuff(t,i,a);break;case"item":case"spell":case"feat":case"attack":this.isRenderItem()?this.doRenderItem(i,a):this.rollItemMacro(t,i,a);break;case"defenses":this.rollDefenses(t,i,a);break;case"utility":this.performUtilityMacro(t,i,a)}}rollCmbMacro(t,e,i){super.getActor(e).rollCMB(t)}rollConcentrationMacro(t,e,i){super.getActor(e).rollConcentration(i)}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollSavingThrow(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){const a=super.getActor(e);super.getItem(a,i).use({ev:t,skipDialog:!1})}rollDefenses(t,e,i){super.getActor(e).rollDefenses()}async adjustBuff(t,e,i){let a=super.getActor(e),s=super.getItem(a,i),n={"data.active":!s.data.data.active};await s.update(n)}performUtilityMacro(t,e,i){let a=super.getActor(e);switch(super.getToken(e),i){case"rest":a.sheet._onRest(t)}}}class D35ESystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerD35E(t,e)}getAvailableRollHandlers(){return{core:"Core D35E"}}doGetRollHandler(t){return new RollHandlerBaseD35E}doRegisterSettings(t,e){!function register$9(t,e){game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showEmptyItems.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class PcActionHandlerPf2e{i18n=t=>game.i18n.localize(t);constructor(t){this.baseHandler=t}buildActionList(t,e,i){"familiar"===i.data.type?this._forFamiliar(t,e,i):this._forCharacter(t,e,i);let a=this.baseHandler._getSkillsList(i,e),s=this.baseHandler._getSaveList(i,e),n=this._getAttributeList(i,e),o=this.baseHandler._getUtilityList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.skills"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.saves"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.attributes"),n),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),o)}_forFamiliar(t,e,i){let a=this._getFamiliarAttack(i,e),s=this.baseHandler._getItemsList(i,e),n=this.baseHandler._getEffectsList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.inventory"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.attack"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.effects"),n)}_forCharacter(t,e,i){let a=this._getTogglesCategory(i,e),s=this._getStrikesList(i,e),n=this.baseHandler._getActionsList(i,e),o=this.baseHandler._getItemsList(i,e),r=this.baseHandler._getSpellsList(i,e),l=this.baseHandler._getEffectsList(i,e),c=this.baseHandler._getFeatsList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.toggles"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.strikes"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.actions"),n),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.effects"),l),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.inventory"),o),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.spells"),r),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.features"),c)}_getTogglesCategory(t,e){if(!get("separateTogglesCategory"))return;let i=this.baseHandler.initializeEmptyCategory("toggles");return this._addTogglesCategories(t,e,i),i}_getStrikesList(t,e){let i=this.baseHandler.initializeEmptyCategory("strikes");return i.cssClass="oneLine",get("separateTogglesCategory")||this._addTogglesCategories(t,e,i),this.baseHandler._addStrikesCategories(t,e,i),i}_addTogglesCategories(t,e,i){const a="toggle",s=t.data.data.toggles;if(!s.length)return;let n=this.baseHandler.initializeEmptySubcategory();n.actionsClass="excludeFromWidthCalculation",s.forEach((t=>{const i=[t.domain,t.option].join("."),{delimiter:s}=this.baseHandler,o=[a,e,JSON.stringify(t)].join(s),r=game.i18n.localize(t.label),l=t.checked?"active":"";n.actions.push({id:i,encodedValue:o,name:r,cssClass:l})})),this.baseHandler._combineSubcategoryWithCategory(i,this.baseHandler.i18n("tokenactionhud.toggles"),n)}_getFamiliarAttack(t,e){let i="familiarAttack",a=this.baseHandler.initializeEmptyCategory("attack"),s=this.baseHandler.initializeEmptySubcategory();const n=t.data.data.attack;if(n){const t=n.totalModifier<0?n.totalModifier:`+${n.totalModifier}`;let a=n.name.charAt(0).toUpperCase()+n.name.slice(1),o=[i,e,n.name].join(this.baseHandler.delimiter),r={name:a,encodedValue:o,encodedValue:o,info1:t};s.actions=[r]}return this.baseHandler._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.attack"),s),a}_getAttributeList(t,e){let i=this.baseHandler.initializeEmptyCategory("attributes"),a=this.baseHandler.initializeEmptySubcategory(),s=Object.entries(t.data.data.attributes).filter((t=>!!t[1]?.roll)).map((t=>{let e=t[0],i=t[1],a=i.label?i.label:e.charAt(0).toUpperCase()+e.slice(1);return{id:t[0],name:a}}));return a.actions=this.baseHandler._produceActionMap(e,s,"attribute"),this.baseHandler._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a),i}_foundrySort(t,e){return t?.data?.sort||e?.data?.sort?t.data.sort-e.data.sort:0}}class NpcActionHandlerPf2e{i18n=t=>game.i18n.localize(t);constructor(t){this.baseHandler=t}buildActionList(t,e,i){let a=this._getStrikesListNpc(i,e),s=this.baseHandler._getActionsList(i,e),n=this.baseHandler._getItemsList(i,e),o=this.baseHandler._getSpellsList(i,e),r=this.baseHandler._getFeatsList(i,e),l=this.baseHandler._getSkillsList(i,e),c=this.baseHandler._getSaveList(i,e),d=this._getAttributeListNpc(i,e),h=this.baseHandler._getEffectsList(i,e),u=this.baseHandler._getUtilityList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.strikes"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.actions"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.effects"),h),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.inventory"),n),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.spells"),o),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.features"),r),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.skills"),l),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.saves"),c),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.attributes"),d),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),u)}_getStrikesListNpc(t,e){let i=this.baseHandler.initializeEmptyCategory("strikes");return i.cssClass="oneLine",get("separateTogglesCategory")||this._addTogglesCategories(t,e,i),this.baseHandler._addStrikesCategories(t,e,i),i}_addTogglesCategories(t,e,i){const a="toggle",s=t.data.data.toggles;if(!s.length)return;let n=this.baseHandler.initializeEmptySubcategory();n.actionsClass="excludeFromWidthCalculation",s.forEach((t=>{const i=[t.domain,t.option].join("."),{delimiter:s}=this.baseHandler,o=[a,e,JSON.stringify(t)].join(s),r=game.i18n.localize(t.label),l=t.checked?"active":"";n.actions.push({id:i,encodedValue:o,name:r,cssClass:l})})),this.baseHandler._combineSubcategoryWithCategory(i,this.baseHandler.i18n("tokenactionhud.toggles"),n)}_getAttributeListNpc(t,e){let i=this.baseHandler.initializeEmptyCategory("attributes"),a=this.baseHandler.initializeEmptySubcategory();return a.actions=this.baseHandler._produceActionMap(e,[{id:"perception",name:"Perception"},{id:"initiative",name:"Initiative"}],"attribute"),this.baseHandler._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a),i}_foundrySort(t,e){return t?.data?.sort||e?.data?.sort?t.data.sort-e.data.sort:0}}const o={acrobatics:"acr",arcana:"arc",athletics:"ath",crafting:"cra",deception:"dec",diplomacy:"dip",intimidation:"itm",medicine:"med",nature:"nat",occultism:"occ",performance:"prf",religion:"rel",society:"soc",stealth:"ste",survival:"sur",thievery:"thi"};class ActionHandlerPf2e extends ActionHandler{constructor(t,e){super(t,e),this.pcActionHandler=new PcActionHandlerPf2e(this),this.npcActionHandler=new NpcActionHandlerPf2e(this)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;let n=s.data.type;return["character","npc","familiar"].includes(n)?(i.actorId=s.id,"character"!==n&&"familiar"!==n||this.pcActionHandler.buildActionList(i,a,s),"npc"===n&&this.npcActionHandler.buildActionList(i,a,s),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character","familiar"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const a=t.tokenId;this._addMultiSkills(t,a,i),this._addMultiSaves(t,a,i),this._addMultiAttributes(t,a,i),this._addMultiUtilities(t,a,i)}_addMultiSkills(t,e,i){const a="skill",s=this.initializeEmptyCategory(a),n=this.initializeEmptySubcategory(a),o=i.map((t=>Object.entries(t.data.data.skills).filter((t=>!!t[1].roll)))),r=Math.min(...o.map((t=>t.length)));o.find((t=>t.length===r)).filter((t=>o.every((e=>e.some((e=>e[0]===t[0])))))).forEach((t=>{const i=t[0],s=t[1];let o=CONFIG.PF2E.skills[i];o||(o=s.name);const r=[a,e,i].join(this.delimiter),l={name:game.i18n.localize(o),encodedValue:r,id:i};n.actions.push(l)}));const l=this.i18n("tokenactionhud.commonSkills");this._combineSubcategoryWithCategory(s,l,n),this._combineCategoryWithList(t,l,s)}_addMultiSaves(t,e,i){const a="save",s=this.initializeEmptyCategory(a),n=this.initializeEmptySubcategory(a);Object.entries(CONFIG.PF2E.saves).forEach((t=>{const i=t[0],s=t[1],o=[a,e,i].join(this.delimiter),r={name:game.i18n.localize(s),encodedValue:o,id:i};n.actions.push(r)}));const o=this.i18n("tokenactionhud.saves");this._combineSubcategoryWithCategory(s,o,n),this._combineCategoryWithList(t,o,s)}_addMultiAttributes(t,e,i){let a=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory();s.actions=this._produceActionMap(e,[{id:"perception",name:"Perception"},{id:"initiative",name:"Initiative"}],"attribute");const n=this.i18n("tokenactionhud.attributes");this._combineSubcategoryWithCategory(a,n,s),this._combineCategoryWithList(t,n,a)}_addMultiUtilities(t,e,i){if(!i.every((t=>"character"===t.data.type)))return;let a=this.initializeEmptyCategory("utility"),s=this.initializeEmptySubcategory(),n=[],o=["utility",e,"treatWounds"].join(this.delimiter),r={id:"treatWounds",name:this.i18n("tokenactionhud.treatWounds"),encodedValue:o};n.push(r);let l=["utility",e,"longRest"].join(this.delimiter),c={id:"longRest",name:this.i18n("tokenactionhud.restNight"),encodedValue:l};if(n.push(c),game.settings.get("pf2e","staminaVariant")){let t=["utility",e,"takeABreather"].join(this.delimiter),i={id:"takeABreather",name:this.i18n("tokenactionhud.takeBreather"),encodedValue:t};n.push(i)}s.actions=n;const d=this.i18n("tokenactionhud.utility");this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rests"),s),this._combineCategoryWithList(t,d,a)}_getItemsList(t,e){let i="item",a=this.initializeEmptyCategory("items"),s=["weapon","equipment","consumable","armor","backpack"],n=(t.items??[]).filter((t=>["held","worn"].includes(t.data.data.equipped?.carryType)&&!t.data.data.containerId?.value?.length)).filter((t=>s.includes(t.data.type))).sort(this._foundrySort),o=n.filter((t=>"weapon"===t.type));"character"===t.data.type&&(o=o.filter((t=>["held","worn"].includes(t.data.data.equipped?.carryType))));let r=this._buildItemActions(e,i,o),l=this.initializeEmptySubcategory();l.actions=r;let c=n.filter((t=>"armor"===t.type));"character"===t.data.type&&(c=c.filter((t=>["held","worn"].includes(t.data.data.equipped?.carryType))));let d=this._buildItemActions(e,i,c),h=this.initializeEmptySubcategory();h.actions=d;let u=n.filter((t=>"equipment"===t.type||"backpack"===t.type)),g=this._buildItemActions(e,i,u),m=this.initializeEmptySubcategory();m.actions=g;let y=n.filter((t=>"consumable"===t.type)),p=this._buildItemActions(e,i,y),b=this.initializeEmptySubcategory();return b.actions=p,this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.weapons"),l),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.armour"),h),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.equipment"),m),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.consumables"),b),this._addContainerSubcategories(e,i,a,t,n),a}_addContainerSubcategories(t,e,i,a,s){const n=[...new Set(a.items.filter((t=>t.data.data.containerId?.value)).map((t=>t.data.data.containerId.value)))];(s??[]).filter((t=>n.includes(t.id))).forEach((s=>{const n=s.id,o=a.items.filter((t=>t.data.data.containerId?.value===n)).sort(this._foundrySort);if(0===o.length)return;const r=this.initializeEmptySubcategory(n);let l=this._buildItemActions(t,e,o);r.actions=l,r.info1=s.data.data.bulkCapacity.value,this._combineSubcategoryWithCategory(i,s.name,r)}))}_getEffectsList(t,e){let i=this.initializeEmptyCategory("effects"),a=["effect"],s=(t.items??[]).filter((t=>a.includes(t.data.type))).sort(this._foundrySort).filter((t=>"effect"===t.type)),n=this._buildItemActions(e,"item",s),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.weapons"),o),i}_addStrikesCategories(t,e,i){let a=t.data.data.actions?.filter((t=>"strike"===t.type));a&&a.forEach((a=>{this._buildStrikeSubcategory(a,i,"",e,t)}))}_buildStrikeSubcategory(t,e,i,a,s){let n="strike",o=get("calculateAttackPenalty"),r=this.initializeEmptySubcategory(),l=t.glyph;if(l&&(r.icon=`<span style='font-family: "Pathfinder2eActions"'>${l}</span>`),t.ready){let e=Math.abs(parseInt(t.variants[1].label.split(" ")[1])),l=t.totalModifier,c=0,d=l,h=o,u=t.variants.map(function(t){let a;return a=d===l||h?d>=0?`+${d}`:`${d}`:c>=0?`+${c}`:`${c}`,c-=e,d-=e,{id:encodeURIComponent(`${this.name}>${this.variants.indexOf(t)}>`+i),name:a}}.bind(t));u[0].img=t.imageUrl,r.actions=this._produceActionMap(a,u,n);let g=[n,a,encodeURIComponent(t.name+">damage>"+i)].join(this.delimiter),m=[n,a,encodeURIComponent(t.name+">critical>"+i)].join(this.delimiter);r.actions.push({name:this.i18n("tokenactionhud.damage"),encodedValue:g,id:encodeURIComponent(t.name+">damage>"+i)}),r.actions.push({name:this.i18n("tokenactionhud.critical"),encodedValue:m,id:encodeURIComponent(t.name+">critical>"+i)});let y=this._ammoInfo(a,s,t);y&&r.actions.push(y)}if(t.auxiliaryActions){const e=t.auxiliaryActions.map(function(t){return{id:encodeURIComponent(`${this.name}>${this.auxiliaryActions.indexOf(t)}>`+i),name:t.label}}.bind(t));!t.ready&&e[0]&&(e[0].img=t.imageUrl);this._produceActionMap(a,e,"auxAction").forEach((t=>{r.actions.push(t)}))}this._combineSubcategoryWithCategory(e,t.name,r),t.meleeUsage&&this._buildStrikeSubcategory(t.meleeUsage,e,"meleeUsage",a,s)}_ammoInfo(t,e,i){if(!i.selectedAmmoId||!i.ammunition)return;const a=e.items.get(i.selectedAmmoId);if(!a)return{name:this.i18n("tokenactionhud.noammo"),encodedValue:"noammo",id:"noammo"};let s=["ammo",t,a.id].join(this.delimiter),n=this._getImage(a),o={name:a.name,encodedValue:s,id:a.id,img:n};return o.info1=a.data.data.quantity?.value,o}_getSkillsList(t,e){let i=this.initializeEmptyCategory("skills"),a=get("abbreviateSkills"),s=Object.entries(t.skills).filter((t=>!!t[1].label&&t[1].label.length>1)),n=s.filter((t=>!t[1].lore)).map((t=>this.createSkillMap(e,"skill",t,a))),o=this.initializeEmptySubcategory();o.actions=n;let r=s.filter((t=>t[1].lore)).sort(this._foundrySort).map((t=>this.createSkillMap(e,"skill",t,a))),l=this.initializeEmptySubcategory();return l.actions=r,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.skills"),o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.lore"),l),i}_getActionsList(t,e){let i="action",a=this.initializeEmptyCategory("actions"),s=(t.items??[]).filter((t=>t.type===i||"feat"===t.type)).sort(this._foundrySort);get("ignorePassiveActions")&&(s=s.filter((t=>"passive"!==t.data.data.actionType.value)));let n=this.initializeEmptySubcategory();n.actions=this._produceActionMap(e,(s??[]).filter((t=>"action"===t.data.data.actionType?.value&&this._actionIsShort(t))),i);let o=this.initializeEmptySubcategory();o.actions=this._produceActionMap(e,(s??[]).filter((t=>"reaction"===t.data.data.actionType?.value&&this._actionIsShort(t))),i);let r=this.initializeEmptySubcategory();r.actions=this._produceActionMap(e,(s??[]).filter((t=>"free"===t.data.data.actionType?.value&&this._actionIsShort(t))),i);let l=this.initializeEmptySubcategory();l.actions=this._produceActionMap(e,(s??[]).filter((t=>"passive"===t.data.data.actionType?.value&&this._actionIsShort(t)&&"feat"!==t.type)),i);let c=this.initializeEmptySubcategory();c.actions=this._produceActionMap(e,(s??[]).filter((t=>t.data.data.traits?.value.includes("exploration"))),i);let d=this.initializeEmptySubcategory();return d.actions=this._produceActionMap(e,(s??[]).filter((t=>t.data.data.traits?.value.includes("downtime"))),i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.actions"),n),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.reactions"),o),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.free"),r),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.passive"),l),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.exploration"),c),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.downtime"),d),a}_actionIsShort(t){return!(t.data.data.traits?.value.includes("exploration")||t.data.data.traits?.value.includes("downtime"))}_getSpellsList(t,e){let i=this.initializeEmptyCategory("spells"),a=["spellcastingEntry"],s=(t.items??[]).filter((t=>a.includes(t.type)));const n="spell";let o=this.initializeEmptySubcategory();for(const i of s){const a=i.name;let s=this.initializeEmptySubcategory(a);s.name=a,o.subcategories.push(s);const r=i.getSpellData(),l=r.levels.filter((t=>t.active.length>0));for(const[o,c]of Object.entries(l)){const l=0===Number(o);let d=String(game.i18n.localize(c.label)),h=this.initializeEmptySubcategory();this._setSpellSlotInfo(t,e,h,c,r,l),l&&(d=`${a} - ${d}`,h.info2=this._getSpellDcInfo(i));const u=c.active.filter((t=>!t?.expended&&t));for(const{spell:t,uses:i}of u){let a=[n,e,`${r.id}>${c.level}>${t.data._id}`].join(this.delimiter);const s={name:t.name,encodedValue:a,id:t.data._id,img:this._getImage(t),icon:this._getActionIcon(t.data.data?.time?.value),spellLevel:c.level,info2:i?`${i.value}/${i.max}`:null};this._addSpellInfo(t,s),h.actions.push(s)}this._combineSubcategoryWithCategory(s,d,h)}}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.spells"),o),i}_getSpellDcInfo(t){let e="";const i=t.statistic;let a="function"==typeof i.dc?i.dc().value:i.dc.value,s=i.check.mod;return e=`${s>=0?`${this.i18n("tokenactionhud.atk")} +${s}`:`${this.i18n("tokenactionhud.atk")} ${s}`} ${`${this.i18n("tokenactionhud.dc")}${a}`}`,e}_setSpellSlotInfo(t,e,i,a,s,n){let o,r,l,c;if(n&&s.isFocusPool){let a=t.data.data.resources.focus;if(o=a.max,r=a.value,o>0){i.info1=`${r}/${o}`,l=`${s.id}>focus>slotIncrease`;let t=["spellSlot",e,l].join(this.delimiter);i.actions.unshift({id:l,name:"+",encodedValue:t,cssClass:"shrink"}),c=`${s.id}>focus>slotDecrease`;let a=["spellSlot",e,c].join(this.delimiter);i.actions.unshift({id:c,encodedValue:a,name:"-",cssClass:"shrink"})}}if(!0!==a.isCantrip&&a.uses?.max>0&&(!s.isPrepared||s.isFlexible)&&!s.isFocusPool){let t=a.uses,n=`slot${a.level}`;if(o=t.max,r=t.value,o>0){i.info1=`${r}/${o}`,l=`${s.id}>${n}>slotIncrease`;let t=["spellSlot",e,l].join(this.delimiter);i.actions.unshift({encodedValue:t,name:"+",id:l,cssClass:"shrink"}),c=`${s.id}>${n}>slotDecrease`;let a=["spellSlot",e,c].join(this.delimiter);i.actions.unshift({encodedValue:a,name:"-",id:l,cssClass:"shrink"})}}}_addSpellInfo(t,e){this._addComponentsInfo(t,e)}_addComponentsInfo(t,e){let i=t.components;i?e.info1=i.value:(i=t.data.data.components?.value.split(","),e.info1=i.map((t=>t.trim().charAt(0).toUpperCase())).join(""))}_getFeatsList(t,e){let i="feat",a=this.initializeEmptyCategory("feats"),s=[i],n=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort),o=this.initializeEmptySubcategory();o.actions=this._produceActionMap(e,(n??[]).filter((t=>"passive"!==t.data.data.actionType.value)),i);let r=this.initializeEmptySubcategory();return r.actions=this._produceActionMap(e,(n??[]).filter((t=>"passive"===t.data.data.actionType.value)),i,!0),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.active"),o),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.passive"),r),a}_getSaveList(t,e){let i=this.initializeEmptyCategory("saves"),a=Object.values(t.saves).map((t=>({id:t.slug,name:t.label}))),s=this.initializeEmptySubcategory();return s.actions=this._produceActionMap(e,a,"save"),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.saves"),s),i}createSkillMap(t,e,i,a){let s=i[0],n=i[1];const r=game.i18n.localize(n.label),l=a?o[n.slug]??r:r;let c=n.check.mod,d="";0!=c&&(d=c>0?`+${c}`:`${c}`);let h=this._produceActionMap(t,[{id:s,name:l}],e);return h[0].info1=d,h[0]}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility");if("character"===t.data.type){let a=this.initializeEmptySubcategory(),s=[],n=t.data.data.resources?.heroPoints;n&&s.push(this._getAttributeAction(e,"heroPoint",this.i18n("tokenactionhud.heroPoints"),n.value,n.max));let o=t.data.data.attributes?.doomed,r=t.data.data.attributes?.dying;if(r){let t=r.value,i=r.max;o&&(i-=o.value),s.push(this._getAttributeAction(e,"dying",this.i18n("tokenactionhud.dying"),t,i))}if(r?.value>=1){let t={id:"recoveryCheck",encodedValue:["recoveryCheck",e,"recoveryCheck"].join(this.delimiter),name:this.i18n("tokenactionhud.pf2e.recoveryCheck")};s.push(t)}let l=t.data.data.attributes?.wounded;l&&s.push(this._getAttributeAction(e,"wounded",this.i18n("tokenactionhud.wounded"),l.value,l.max)),o&&s.push(this._getAttributeAction(e,"doomed",this.i18n("tokenactionhud.doomed"),o.value,o.max)),a.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a);let c=this.initializeEmptySubcategory(),d=[],h=["utility",e,"treatWounds"].join(this.delimiter),u={id:"treatWounds",name:this.i18n("tokenactionhud.treatWounds"),encodedValue:h};d.push(u);let g=["utility",e,"longRest"].join(this.delimiter),m={id:"longRest",name:this.i18n("tokenactionhud.restNight"),encodedValue:g};if(d.push(m),game.settings.get("pf2e","staminaVariant")){let t=["utility",e,"takeABreather"].join(this.delimiter),i={id:"takeABreather",name:this.i18n("tokenactionhud.takeBreather"),encodedValue:t};d.push(i)}c.actions=d,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.rests"),c)}return i}_getAttributeAction(t,e,i,a,s){let n=i.slugify({replacement:"_",strict:!0}),o={name:i,encodedValue:[e,t,n].join(this.delimiter),id:n};return o.info1=`${a}/${s}`,o}_buildItemActions(t,e,i,a=!1){let s=this._produceActionMap(t,i,e,a);return s.forEach((t=>this._addItemInfo(i.find((e=>e.data._id===t.id)),t))),s}_addItemInfo(t,e){e.info1=this._getQuantityData(t)}_getQuantityData(t){let e="",i=t.data.data.quantity?.value;return i>1&&(e=i),e}_produceActionMap(t,e,i,a=!1){return e.map((e=>this._produceAction(t,e,i,a)))}_produceAction(t,e,i,a=!1){let s,n=[i,t,e.id].join(this.delimiter),o=e.data?.data?.actions,r=e.data?.data?.actionType?.value;if(["free","reaction","passive"].includes(r))s=this._getActionIcon(r);else if(o&&!a){let t=parseInt((o||{}).value,10)||1;s=this._getActionIcon(t)}let l=this._getImage(e);return{name:e.name,encodedValue:n,id:e.id,img:l,icon:s}}_getActionIcon(t){return{1:"<span style='font-family: \"Pathfinder2eActions\"'>A</span>",2:"<span style='font-family: \"Pathfinder2eActions\"'>D</span>",3:"<span style='font-family: \"Pathfinder2eActions\"'>T</span>",free:"<span style='font-family: \"Pathfinder2eActions\"'>F</span>",reaction:"<span style='font-family: \"Pathfinder2eActions\"'>R</span>",passive:""}[t]}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}}class RollHandlerBasePf2e extends RollHandler{BLIND_ROLL_MODE="blindroll";constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");Logger.debug(e),3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];if(["item","feat","action","lore","ammo"].includes(a)&&this.isRenderItem())return this.doRenderItem(s,n);try{const e=["character","familiar","npc"];if("multi"===s){const i=canvas.tokens.controlled.filter((t=>e.includes(t.actor?.data.type)));for(let e of i){let i=e.data._id;await this._handleMacros(t,a,i,n)}}else await this._handleMacros(t,a,s,n)}catch(t){throw t}}async _handleMacros(t,e,i,a){let s,n=super.getActor(i);n&&(s=n.data.type);if(!["ability","spell","item","skill","lore","utility","toggle","strike"].includes(e))switch(s){case"npc":await this._handleUniqueActionsNpc(e,t,i,n,a);break;case"character":case"familiar":await this._handleUniqueActionsChar(e,t,i,n,a)}switch(e){case"ability":this._rollAbility(t,n,a);break;case"skill":await this._rollSkill(t,n,a);break;case"action":case"feat":case"item":this._rollItem(t,n,a);break;case"spell":await this._rollSpell(t,i,n,a);break;case"utility":this._performUtilityMacro(t,i,a);break;case"toggle":await this._performToggleMacro(t,i,a);break;case"strike":this._rollStrikeChar(t,i,n,a)}}async _handleUniqueActionsChar(t,e,i,a,s){switch(t){case"save":this._rollSave(e,a,s);break;case"attribute":this._rollAttributeChar(e,a,s);break;case"spellSlot":await this._adjustSpellSlot(e,a,s);break;case"heroPoint":await this._adjustResources(e,a,"heroPoints","value",s);break;case"doomed":case"wounded":case"dying":await this._adjustCondition(e,a,t);break;case"recoveryCheck":a.rollRecovery({event:e});break;case"familiarAttack":this._rollFamiliarAttack(e,a);break;case"auxAction":this._performAuxAction(e,i,a,s)}}async _handleUniqueActionsNpc(t,e,i,a,s){switch(t){case"save":this._rollSave(e,a,s);break;case"npcStrike":this._rollStrikeNpc(e,i,a,s);break;case"attribute":await this._rollAttributeNpc(e,i,a,s)}}_rollSkill(t,e,i){e.skills[i].check.roll({event:t})}_rollAbility(t,e,i){e.rollAbility(t,i)}_rollAttributeChar(t,e,i){let a=e.data.data.attributes[i];if(a){const i=e.getRollOptions(["all",a]);a.roll({event:t,options:i})}else e.rollAttribute(t,i)}async _rollAttributeNpc(t,e,i,a){"initiative"===a?await i.rollInitiative({createCombatants:!0}):i.rollAttribute(t,a)}async _adjustSpellSlot(t,e,i){let a,s,n,o=decodeURIComponent(i).split(">"),r=o[0],l=o[1],c=o[2],d=e.items.get(r);if("focus"===l)a=e.data.data.resources.focus.value,s=e.data.data.resources.focus.max;else{let t=d.data.data.slots;a=t[l].value,s=t[l].max}switch(c){case"slotIncrease":if(a>=s)break;a++;break;case"slotDecrease":if(a<=0)break;a--}"focus"===l?e.update({"data.resources.focus.value":a}):(n=[{_id:d.id,data:{slots:{[l]:{value:a}}}}],await Item.updateDocuments(n,{parent:e})),Hooks.callAll("forceUpdateTokenActionHUD")}_rollSave(t,e,i){e.saves[i].check.roll({event:t})}async _updateRollMode(t){await game.settings.set("core","rollMode",t)}_rollStrikeChar(t,e,i,a){let s,n=decodeURIComponent(a).split(">"),o=n[0],r=n[1],l=n[2],c=i.data.data.actions.filter((t=>"strike"===t.type)).find((t=>t.name===o));if(this.isRenderItem()){let t=i.data.data.actions.filter((t=>"strike"===t.type)).find((t=>t.name===o)).origin;if(t)return this.doRenderItem(e,t.data.id)}switch(""!==l&&(c=c[l]),r){case"damage":s=i.getRollOptions(["all","damage-roll"]),c.damage({event:t,options:s});break;case"critical":s=i.getRollOptions(["all","damage-roll"]),c.critical({event:t,options:s});break;default:s=i.getRollOptions(["all","attack-roll"]),c.variants[r]?.roll({event:t,options:s})}}_performAuxAction(t,e,i,a){let s=decodeURIComponent(a).split(">"),n=s[0],o=s[1],r=s[2],l=i.data.data.actions.filter((t=>"strike"===t.type)).find((t=>t.name===n));if(this.isRenderItem()){let t=i.data.data.actions.filter((t=>"strike"===t.type)).find((t=>t.name===n)).origin;if(t)return this.doRenderItem(e,t.data.id)}""!==r&&(l=l[r]),l.auxiliaryActions[o]?.execute()}_rollStrikeNpc(t,e,i,a){let s=decodeURIComponent(a).split(">"),n=s[0],o=s[1];if("plus"===n){let t=i.items.find((t=>0===o.toUpperCase().localeCompare(t.name.toUpperCase(),void 0,{sensitivity:"base"})));return this.isRenderItem()?this.doRenderItem(e,t.id):void t.toChat()}if(this.isRenderItem())return this.doRenderItem(e,n);let r=i.items.get(n);switch(o){case"damage":r.rollNPCDamage(t);break;case"critical":r.rollNPCDamage(t,!0);break;case"0":r.rollNPCAttack(t);break;case"1":r.rollNPCAttack(t,2);break;case"2":r.rollNPCAttack(t,3)}}_rollItem(t,e,i){e.items.get(i).toChat()}_rollFamiliarAttack(t,e){const i=e.getRollOptions(["all","attack"]);e.data.data.attack.roll(t,i)}async _rollSpell(t,e,i,a){let s=decodeURIComponent(a).split(">"),[n,o,r,l]=s;if(this.isRenderItem())return this.doRenderItem(e,r);const c=i.items.get(n),d=i.items.get(r);c&&d&&(await c.cast(d,{message:!l,consume:!0,level:Number(o)}),Hooks.callAll("forceUpdateTokenActionHUD"))}_performUtilityMacro(t,e,i){super.getActor(e);let a=super.getToken(e);switch(i){case"treatWounds":this._executeMacroById("6duZj0Ygiqv712rq");break;case"longRest":this._executeMacroById("0GU2sdy3r2MeC56x");break;case"takeABreather":this._executeMacroById("aS6F7PSUlS9JM5jr");break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":a.toggleVisibility()}}async _executeMacroById(t){game.packs.get("pf2e.pf2e-macros").getDocument(t).then((t=>t.execute()))}async _adjustResources(t,e,i,a,s){let n=e.data.data.resources[i][a],o=e.data.data.resources[i].max;if(this.rightClick){if(n<=0)return;n--}else{if(n>=o)return;n++}let r=[{_id:e.id,data:{resources:{[i]:{[a]:n}}}}];await Actor.updateDocuments(r),Hooks.callAll("forceUpdateTokenActionHUD")}async _adjustCondition(t,e,i){let a=e.data.data.attributes[i].max;this.rightClick?await e.decreaseCondition(i):await e.increaseCondition(i,{max:a}),Hooks.callAll("forceUpdateTokenActionHUD")}async _performToggleMacro(t,e,i){const a=super.getActor(e),s=JSON.parse(i);s.domain&&s.option&&await a.toggleRollOption(s.domain,s.option,s.itemId)}}class Pf2eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerPf2e(t,e)}getAvailableRollHandlers(){return{core:"Core PF2E"}}doGetRollHandler(t){return new RollHandlerBasePf2e}doRegisterSettings(t,e){!function register$8(t,e){game.settings.register(t,"ignorePassiveActions",{name:game.i18n.localize("tokenactionhud.settings.pf2e.ignorePassiveActions.name"),hint:game.i18n.localize("tokenactionhud.settings.pf2e.ignorePassiveActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"separateTogglesCategory",{name:game.i18n.localize("tokenactionhud.settings.pf2e.separateTogglesCategory.name"),hint:game.i18n.localize("tokenactionhud.settings.pf2e.separateTogglesCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"calculateAttackPenalty",{name:game.i18n.localize("tokenactionhud.settings.pf2e.calculateAttackPenalty.name"),hint:game.i18n.localize("tokenactionhud.settings.pf2e.calculateAttackPenalty.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenactionhud.settings.pf2e.abbreviateSkills.name"),hint:game.i18n.localize("tokenactionhud.settings.pf2e.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerSfrpg extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;return s?(i.actorId=s.id,"starship"!==s.data.type?(this._buildItemCategory(t,i),this._buildSpellsCategory(t,i),this._buildFeatsCategory(t,i),this._buildSkillCategory(t,s,i),this._buildAbilitiesCategory(t,i),this._buildSavesCategory(t,i)):(this._addStarshipWeapons(t,s,i),await this._addCrewActions(t,s,i),this._addShields(t,s,i)),Logger.debug("SFRPG ActionList:",i),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_buildItemCategory(t,e){var i=t.actor.data.items;let a=t.data._id;var s=this.i18n("tokenactionhud.equipment"),n="item";let o=this.initializeEmptyCategory("equipment");o=this._addSubcategoryByType(this.i18n("tokenactionhud.weapons"),"weapon",n,i,a,o),o=this._addSubcategoryByType(this.i18n("tokenactionhud.consumables"),"consumable",n,i,a,o),this._combineCategoryWithList(e,s,o)}_buildFeatsCategory(t,e){var i=t.actor.data.items.filter((t=>"feat"==t.type));let a=t.data._id;var s=this.i18n("tokenactionhud.features"),n="feat";let o=this.initializeEmptyCategory(s);if(this._addSubcategoryByActionType(this.i18n("tokenactionhud.mwa"),"mwak",n,i,a,o),this._addSubcategoryByActionType(this.i18n("tokenactionhud.rwa"),"rwak",n,i,a,o),this._addSubcategoryByActionType(this.i18n("tokenactionhud.msa"),"msak",n,i,a,o),this._addSubcategoryByActionType(this.i18n("tokenactionhud.rsa"),"rsak",n,i,a,o),this._addSubcategoryByActionType(this.i18n("tokenactionhud.healing"),"heal",n,i,a,o),get("showMiscFeats")){const t=i.filter((t=>!["mwak","rwak","msak","rsak","heal"].includes(t.data.actionType)));this._addSubcategoryByItemList(this.i18n("tokenactionhud.misc"),n,t,a,o)}this._combineCategoryWithList(e,s,o)}_buildSpellsCategory(t,e){var i=t.actor.data.items.filter((t=>"spell"==t.type));let a=t.data._id;var s=this.i18n("tokenactionhud.spellbook");let n=this.initializeEmptyCategory(s);for(let t=0;t<6;t++)n=this._addSubcategoryByLevel(`${this.i18n("tokenactionhud.level")} `+t,t,"spell",i,a,n);this._combineCategoryWithList(e,s,n)}_buildSkillCategory(t,e,i){if(!e.data.data.skills)return i;let a=this.initializeEmptyCategory("skills"),s="skill";const n=Object.entries(e.data.data.skills),o=CONFIG.SFRPG.skills;let r=n.map((e=>{let i,a=e[0],n=e[1];a.startsWith("pro")?(i=o.pro,n.subname&&(i+=` (${n.subname})`)):i=o[a];let r=[s,t.data._id,a].join(this.delimiter);return{name:i,id:a,encodedValue:r,icon:this._getClassSkillIcon(n.value)}})).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}))),l=this.initializeEmptySubcategory();l.actions=r;let c=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(a,c,l),this._combineCategoryWithList(i,c,a)}_buildAbilitiesCategory(t,e){let i=this.initializeEmptyCategory("abilities"),a="ability",s=Object.entries(CONFIG.SFRPG.abilities).map((e=>{let i=e[1],s=[a,t.data._id,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:s}})),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.abilities");this._combineSubcategoryWithCategory(i,o,n),this._combineCategoryWithList(e,o,i)}_buildSavesCategory(t,e){let i=this.initializeEmptyCategory("saves"),a="save",s=Object.entries(CONFIG.SFRPG.saves).map((e=>{let i=e[1],s=[a,t.data._id,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:s}})),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.saves");this._combineSubcategoryWithCategory(i,o,n),this._combineCategoryWithList(e,o,i)}_addSubcategoryByActionType(t,e,i,a,s,n){let o=this.initializeEmptySubcategory(),r=a.filter((t=>t.data.data.actionType==e));return o.actions=r.map((t=>this._buildItemAction(s,i,t))),this._combineSubcategoryWithCategory(n,t,o),n}_addSubcategoryByItemList(t,e,i,a,s){let n=this.initializeEmptySubcategory();return n.actions=i.map((t=>this._buildItemAction(a,e,t))),this._combineSubcategoryWithCategory(s,t,n),s}_addSubcategoryByType(t,e,i,a,s,n){let o=this.initializeEmptySubcategory(),r=a.filter((t=>t.type==e));return o.actions=r.map((t=>this._buildItemAction(s,i,t))),this._combineSubcategoryWithCategory(n,t,o),n}_addSubcategoryByLevel(t,e,i,a,s,n){let o=this.initializeEmptySubcategory(),r=a.filter((t=>t.data.data.level===e));return o.actions=r.map((t=>{let e=this._buildItemAction(s,i,t);return get("showSpellInfo")&&this._addSpellInfo(t,e),e})),this._combineSubcategoryWithCategory(n,t,o),n}_addSpellInfo(t,e){let i=t.data;if(i?.sr&&(e.info2+="Sr"),i?.dismissible&&(e.info2+="D"),i?.concentration&&(e.info2+="C"),i?.save?.type){let t=i.save.type;e.info3+=t?.charAt(0).toUpperCase()+t?.slice(1)}}_buildItemAction(t,e,i){let a=[e,t,i.id].join(this.delimiter),s=this._getImage(i),n=this._getActionIcon(i.data.data.activation?.type),o={name:i.name,id:i.id,encodedValue:a,img:s,icon:n};return o.info1=this._getQuantityData(i),o.info2=this._getUsesOrUsageData(i),o.info3=this._getCapacityData(i),o}_getQuantityData(t){let e="";return t.data.data.quantity>1&&(e=t.data.data.quantity),e}_getUsesOrUsageData(t){let e="",i=t.data.data.uses;if(i?.max||i?.value)return e=i.value??"",i.max>0&&(e+=`/${i.max}`),e;let a=t.data.usage;return a?.value?(e=a.value??"",a.value>0&&(e+=`/${a.per}`),e):e}_getCapacityData(t){let e="",i=t.data.data.capacity;return i?(e=i.value??"",i.max&&(e+=`/${i.max}`),e):e}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getClassSkillIcon(t){return{3:'<i class="fas fa-check"></i>'}[t]}_getActionIcon(t){return{move:'<i class="fas fa-shoe-prints"></i>',swift:'<i class="fas fa-bolt"></i>',full:'<i class="fas fa-circle"></i>',other:'<i class="far fa-circle"></i>',reaction:'<i class="fas fa-undo-alt"></i>',special:'<i class="fas fa-atom"></i>',min:'<i class="fas fa-hourglass-start"></i>',hour:'<i class="fas fa-hourglass-half"></i>',day:'<i class="fas fa-hourglass-end"></i>'}[t]}_addStarshipWeapons(t,e,i){const a="starshipWeapon",s=e.data.items.filter((t=>t.type===a));if(0===s.length)return;const n=this.initializeEmptyCategory(a),o=s.reduce(((t,e)=>{const i=e.data.data.mount.arc;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{}),r="item";["forward","starboard","port","aft","turret"].forEach((e=>{const i=o[e];if(!i)return;const a=this.initializeEmptySubcategory(e);i.forEach((e=>{const i={name:e.name,encodedValue:[r,t.id,e.id].join(this.delimiter),id:e.id,img:this._getImage(e)};i.info1=e.data.data.pcu??"",a.actions.push(i)}));const s=e.charAt(0).toUpperCase()+e.slice(1),l=this.i18n("SFRPG.ShipSystems.StarshipArcs."+s);this._combineSubcategoryWithCategory(n,l,a)}));var l=this.i18n("tokenactionhud.weapons");this._combineCategoryWithList(i,l,n)}async _addCrewActions(t,e,i){if(!e.useStarshipAction)return;const a="crewAction",s=this.initializeEmptyCategory(a),n=(await game.packs.get("sfrpg.starship-actions").getDocuments()).reduce(((t,e)=>{const i=e.data.data.role;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{});["captain","pilot","gunner","engineer","scienceOfficer","chiefMate","magicOfficer","openCrew","minorCrew"].forEach((i=>{const o=e.data.data.crew,r=o[i],l=o.npcData[i];if(!this._shouldShowCrewOptions(o,r,l))return;const c=n[i],d=this.initializeEmptySubcategory(i);c.forEach((e=>{const i={name:e.name,encodedValue:[a,t.id,e.id].join(this.delimiter),id:e.id,img:this._getImage(e)};i.info1=e.data.data.resolvePointCost??"",d.actions.push(i)})),r&&(o.useNPCCrew?d.info1=o.npcData[i].numberOfUses:d.info1=r.limit>0?`${r.actors.length}/${r.limit}`:r.actors.length);const h=i.charAt(0).toUpperCase()+i.slice(1),u=this.i18n("SFRPG.StarshipSheet.Role."+h);this._combineSubcategoryWithCategory(s,u,d)}));const o=this.i18n("tokenactionhud.crewActions");this._combineCategoryWithList(i,o,s)}_shouldShowCrewOptions(t,e,i){return!e||(e.actors?.length>0&&!t.useNPCCrew||!!(t.useNPCCrew&&i?.numberOfUses>0))}_addShields(t,e,i){const a="shields",s=this.initializeEmptySubcategory(a),n=e.data.data.attributes?.shields;if(!n)return i;s.info1=`${n.value}/${n.max}`;const o=[{name:"-10",value:"-10"},{name:"-5",value:"-5"},{name:"-1",value:"-1"},{name:"+1",value:"+1"},{name:"+5",value:"+5"},{name:"+10",value:"+10"}],r=e.data.data.quadrants;["forward","starboard","aft","port"].forEach((e=>{const i=r[e].shields;if(!i)return;const l=this.initializeEmptySubcategory(e);l.info1=`${i.value}/${n.limit}`,o.forEach((i=>{const s=[a,t.id,`${e}.${i.value}`].join(this.delimiter),n={name:i.name,encodedValue:s,id:i.value,cssClass:"shrink"};l.actions.push(n)}));const c=e.charAt(0).toUpperCase()+e.slice(1),d=this.i18n("SFRPG.StarshipSheet.Sides."+c);this._combineSubcategoryWithCategory(s,d,l)}));const l=this.i18n("tokenactionhud.shields");this._combineCategoryWithList(i,l,s)}}class RollHandlerBaseSfrpg extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];switch(a){case"ability":this.rollAbilityMacro(t,s,n);break;case"skill":this.rollSkillMacro(t,s,n);break;case"save":this.rollSaveMacro(t,s,n);break;case"abilitySave":this.rollAbilitySaveMacro(t,s,n);break;case"abilityCheck":this.rollAbilityCheckMacro(t,s,n);break;case"item":case"spell":case"feat":case"starshipWeapon":this.isRenderItem()?this.doRenderItem(s,n):this.rollItemMacro(t,s,n);break;case"shields":this._handleShields(t,s,n);break;case"crewAction":this._handleCrewAction(t,s,n)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollAbilitySave(i,{event:t})}rollSaveMacro(t,e,i){super.getActor(e).rollSave(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){let a=super.getActor(e),s=a.items.get(i);if(!this.needsRecharge(s))return"spell"===s.data.type?a.useSpell(s):s.roll();s.rollRecharge()}needsRecharge(t){return t.data.data.recharge&&!t.data.data.recharge.charged&&t.data.data.recharge.value}async _handleShields(t,e,i){const a=super.getActor(e);let s=i.split(".");const n=s[0];let o=parseInt(s[1]);if(NaN===o)return;const r=a.data.data.attributes.shields,l=a.data.data.quadrants[n].shields;let c;if(c=o<0?Math.clamped(l.value+o,0,r.max):this._calcPossibleIncrease(r,l,o),c===l.value)return;const d={data:{quadrants:{}}};d.data.quadrants[n]={shields:{value:c}},await a.update(d)}_calcPossibleIncrease(t,e,i){const a=t.max-t.value>=0?t.max-t.value:0,s=t.limit-e.value>=0?t.limit-e.value:0;let n=i;return i>a&&(n=a),i>s&&(n=s),e.value+n}_handleCrewAction(t,e,i){super.getActor(e).useStarshipAction(i)}}class SfrpgSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSfrpg(t,e)}getAvailableRollHandlers(){return{core:"Core Starfinder"}}doGetRollHandler(t){return new RollHandlerBaseSfrpg}doRegisterSettings(t,e){!function register$7(t,e){game.settings.register(t,"showSpellInfo",{name:game.i18n.localize("tokenactionhud.settings.sfrpg.showSpellInfo.name"),hint:game.i18n.localize("tokenactionhud.settings.sfrpg.showSpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showMiscFeats",{name:game.i18n.localize("tokenactionhud.settings.sfrpg.showMiscFeats.name"),hint:game.i18n.localize("tokenactionhud.settings.sfrpg.showMiscFeats.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerSW5e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}async _buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.data?.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){return[this._buildItemsCategory(t),this._buildPowersCategory(t),this._buildFeaturesCategory(t),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildAbilitiesCategory(t){const e=t.actor.data.data.abilities;if(get("splitAbilities")){const i=this.i18n("tokenactionhud.saves"),a=this._getAbilityList(t.id,e,"saves",i,"abilitySave");a.name=i;const s=this.i18n("tokenactionhud.checks"),n=this._getAbilityList(t.id,e,"checks",this.i18n("tokenactionhud.checks"),"abilityCheck");return n.name=s,[a,n]}return this._getAbilityList(t.id,e,"abilities",this.i18n("tokenactionhud.abilities"),"ability")}_buildMultipleTokenList(){const t=this.initializeEmptyActionList();t.tokenId="multi",t.actorId="multi";const e=canvas.tokens.controlled.every((t=>"starship"===t.data.type))?["starship"]:["npc","character"],i=e===["starships"];let a=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const s=t.tokenId;if(i?this._addMultiStarshipSkills(t,s):this._addMultiSkills(t,s),get("splitAbilities")){let e=this.i18n("tokenactionhud.saves"),i=this.i18n("tokenactionhud.checks");this._addMultiAbilities(t,s,"saves",e,"abilitySave"),this._addMultiAbilities(t,s,"checks",i,"abilityCheck")}else{let e=this.i18n("tokenactionhud.abilities");this._addMultiAbilities(t,s,"abilities",e,"ability")}return get("showConditionsCategory")&&this._addMultiConditions(t,s),this._addMultiUtilities(t,s,a),t}_buildItemsCategory(t){const e=t.actor,i=t.id;let a,s=this._filterLongerActions(e.data.items.filter((t=>this._getDocumentData(t).quantity>0))),n=this._sortByItemSort(s),o="item";a="npc"===e.data.type&&get("showAllNpcItems")?n.filter((t=>"consumable"!==t.type&&"power"!==t.type&&"feat"!==t.type)):n.filter((t=>"consumable"!==t.type&&this._getDocumentData(t).equipped));let r=this._getActiveEquipment(a),l=r.filter((t=>"weapon"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),c=this.initializeEmptySubcategory();c.actions=l;let d=r.filter((t=>"equipment"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),h=this.initializeEmptySubcategory();h.actions=d;let u=r.filter((t=>"weapon"!=t.type&&"equipment"!=t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),g=this.initializeEmptySubcategory();g.actions=u;let m=this._getActiveEquipment(n.filter((t=>"consumable"==t.type))),y=this._filterExpendedItems(m).map((t=>this._buildEquipmentItem(i,e,o,t))),p=this.initializeEmptySubcategory();p.actions=y;let b=s.filter((t=>"tool"===t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenactionhud.weapons"),_=this.i18n("tokenactionhud.equipment"),C=this.i18n("tokenactionhud.other"),S=this.i18n("tokenactionhud.consumables"),v=this.i18n("tokenactionhud.tools"),A=this.initializeEmptyCategory("inventory");return A.name=this.i18n("tokenactionhud.inventory"),this._combineSubcategoryWithCategory(A,k,c),this._combineSubcategoryWithCategory(A,_,h),this._combineSubcategoryWithCategory(A,C,g),this._combineSubcategoryWithCategory(A,S,p),this._combineSubcategoryWithCategory(A,v,f),A}_getActiveEquipment(t){const e=Object.keys(game.sw5e.config.abilityActivationTypes).filter((t=>"none"!==t));return t.filter((t=>{const i=this._getDocumentData(t);return!!i.activation&&e.includes(i.activation.type)}))}_buildPowersCategory(t){const e=t.actor;if(["vehicle","starship"].includes(e.data.type))return;let i=this._filterLongerActions(e.data.items.filter((t=>"power"===t.type)));i=this._filterExpendedItems(i),"character"!==e.data.type&&get("showAllNpcItems")||(i=this._filterNonpreparedPowers(i));let a=this._sortPowersByLevel(i);return this._categorisePowers(e,t.id,a)}_sortPowersByLevel(t){let e=Object.values(t);return e.sort(((t,e)=>{const i=this._getDocumentData(t),a=this._getDocumentData(e);return i.level===a.level?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):i.level-a.level})),e}_categorisePowers(t,e,i){const a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=Object.entries(t.data.data.powers).sort(((t,e)=>e[0].toUpperCase().localeCompare(t[0].toUpperCase(),void 0,{sensitivity:"base"})));var o=!1;n.forEach((t=>{t[0].startsWith("power")?(!o&&t[1].max>0&&t[1].value>0&&(o=!0),o||"power"!==t[0]||(o=!0),t[1].slotsAvailable=o):(t[1]||(t[1]={}),t[1].slotsAvailable=!t[1].max||t[1].value>0)})),i.reduce(function(i,o){const r=this._getDocumentData(o);let l=r.preparation.mode;const c=game.sw5e.config.powerPreparationModes[l];var d=r.level;let h="atwill"===l||"innate"===l;var u,g,m,y,p;h?y=l:(y="power"+d,m=d?`${this.i18n("tokenactionhud.level")} ${d}`:this.i18n("tokenactionhud.at-will")),p=n.find((t=>t[0]===y))?.[1],g=p?.value,u=p?.max;let b=get("showEmptyItems");if(u&&!p?.slotsAvailable&&!b)return;let f,k=this._buildItem(e,t,"power",o);return get("showPowerInfo")&&this._addPowerInfo(o,k),f=h?a.subcategories.find((t=>t.name===c)):s.subcategories.find((t=>t.name===m)),f||(f=this.initializeEmptySubcategory(),u>0&&(f.info1=`${g}/${u}`)),f.actions.push(k),h&&a.subcategories.indexOf(f)<0?this._combineSubcategoryWithCategory(a,c,f):!h&&s.subcategories.indexOf(f)<0&&this._combineSubcategoryWithCategory(s,m,f),i}.bind(this),{});let r=this.initializeEmptyCategory("powers");r.name=this.i18n("tokenactionhud.powers");let l=this.i18n("tokenactionhud.natPowers"),c=this.i18n("tokenactionhud.books");return this._combineSubcategoryWithCategory(r,l,a),this._combineSubcategoryWithCategory(r,c,s),r}_addPowerInfo(t,e){let i=this._getDocumentData(t).components;e.info1="",e.info2="",e.info3="",i?.vocal&&(spell.info1+=this.i18n("SW5E.ComponentVerbal").charAt(0).toUpperCase()),i?.somatic&&(spell.info1+=this.i18n("SW5E.ComponentSomatic").charAt(0).toUpperCase()),i?.material&&(spell.info1+=this.i18n("SW5E.ComponentMaterial").charAt(0).toUpperCase()),i?.concentration&&(e.info2+=this.i18n("SW5E.Concentration").charAt(0).toUpperCase()),i?.ritual&&(e.info3+=this.i18n("SW5E.Ritual").charAt(0).toUpperCase())}_buildFeaturesCategory(t){let e=this._filterLongerActions(t.actor.data.items.filter((t=>"feat"==t.type))),i=this._sortByItemSort(e);return this._categoriseFeats(t.id,t.actor,i)}_categoriseFeats(t,e,i){let a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();i.reduce(function(i,r){const l=this._getDocumentData(r).activation.type;let c=this._buildEquipmentItem(t,e,"feat",r);l&&""!==l?"lair"!=l?"legendary"!=l?a.actions.push(c):o.actions.push(c):n.actions.push(c):s.actions.push(c)}.bind(this),{});let r=this.initializeEmptyCategory("feats");r.name=this.i18n("tokenactionhud.features");let l=this.i18n("tokenactionhud.active"),c=this.i18n("tokenactionhud.legendary"),d=this.i18n("tokenactionhud.lair");if(this._combineSubcategoryWithCategory(r,l,a),this._combineSubcategoryWithCategory(r,c,o),this._combineSubcategoryWithCategory(r,d,n),!get("ignorePassiveFeats")){let t=this.i18n("tokenactionhud.passive");this._combineSubcategoryWithCategory(r,t,s)}return r}_buildSkillsCategory(t){const e=t.actor;if("vehicle"===e.data.type)return;const i=e.data.data.skills;let a=this.initializeEmptyCategory("skills");a.name=this.i18n("tokenactionhud.skills");let s="skill",n=get("abbreviateSkills"),o=Object.entries(i).map((a=>{try{let o=a[0];const r="starship"!==e.data.type?game.sw5e.config.skills:game.sw5e.config.starshipSkills;let l=n?o:r[o];l=l.charAt(0).toUpperCase()+l.slice(1);let c=[s,t.id,a[0]].join(this.delimiter),d=this._getProficiencyIcon(i[o].value);return{name:l,id:a[0],encodedValue:c,icon:d}}catch(t){return Logger.error(a),null}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenactionhud.skills");return this._combineSubcategoryWithCategory(a,l,r),a}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=Object.entries(game.sw5e.config.skills).map((t=>{let i=s?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_addMultiStarshipSkills(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=Object.entries(game.sw5e.config.starshipSkills).map((t=>{let i=s?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,a,s){let n=this.initializeEmptyCategory(i);n.name=a;let o=get("abbreviateSkills"),r=Object.entries(game.sw5e.config.abilities).map((a=>{if(0===e[a[0]].value)return;let n=o?a[0]:a[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[s,t,a[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[a[0]].proficient),{name:n,id:a[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l),n}_addMultiAbilities(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(game.sw5e.config.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,a,l),this._combineCategoryWithList(t,a,n,!0)}_buildUtilityCategory(t){const e=t.actor;let i=this.initializeEmptyCategory("utility");i.name=this.i18n("tokenactionhud.utility");let a="utility",s=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();if(this._addIntiativeSubcategory(a,i,t.id),"character"===e.data.type){let i=[a,t.id,"shortRest"].join(this.delimiter);s.actions.push({id:"shortRest",encodedValue:i,name:this.i18n("tokenactionhud.shortRest")});let n=[a,t.id,"longRest"].join(this.delimiter);if(s.actions.push({id:"longRest",encodedValue:n,name:this.i18n("tokenactionhud.longRest")}),e.data.data.attributes.hp.value<=0){let e={id:"deathSave",encodedValue:[a,t.id,"deathSave"].join(this.delimiter),name:this.i18n("tokenactionhud.deathSave")};o.actions.push(e)}let r={id:"inspiration",encodedValue:[a,t.id,"inspiration"].join(this.delimiter),name:this.i18n("tokenactionhud.inspiration")};r.cssClass=e.data.data.attributes?.inspiration?"active":"",o.actions.push(r)}if("starship"===e.data.type){let i=[a,t.id,"rechargeRepair"].join(this.delimiter);n.actions.push({id:"rechargeRepair",encodedValue:i,name:this.i18n("tokenactionhud.rechargeRepair")});let s=[a,t.id,"refittingRepair"].join(this.delimiter);n.actions.push({id:"refittingRepair",encodedValue:s,name:this.i18n("tokenactionhud.refittingRepair")});let r=[a,t.id,"regenRepair"].join(this.delimiter);if(n.actions.push({id:"regenRepair",encodedValue:r,name:this.i18n("tokenactionhud.regenRepair")}),e.data.data.attributes.hp.value<=0){let e={id:"destructionSave",encodedValue:[a,t.id,"destructionSave"].join(this.delimiter),name:this.i18n("tokenactionhud.destructionSave")};o.actions.push(e)}}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.rests"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.repairs"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.utility"),o),i}_buildEffectsCategory(t){let e=this.initializeEmptyCategory("effects");return e.name=this.i18n("tokenactionhud.effects"),this._addEffectsSubcategories(t.actor,t.id,e),e}_buildConditionsCategory(t){if(!get("showConditionsCategory"))return;let e=this.initializeEmptyCategory("conditions");return e.name=this.i18n("tokenactionhud.conditions"),this._addConditionsSubcategory(t.actor,t.id,e),e}_addEffectsSubcategories(t,e,i){const a="effect",s="find"in t.effects.entries?t.effects.entries:t.effects;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this._getDocumentData(t),s=i.label,r=[a,e,t.id].join(this.delimiter),l=i.disabled?"":"active",c=i.icon;let d={name:s,id:t.id,encodedValue:r,img:c,cssClass:l};t.isTemporary?n.actions.push(d):o.actions.push(d)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!s)return;let o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this.i18n(t.label),s=[a,e,t.id].join(this.delimiter),r=n.every((e=>{("some"in e.effects.entries?e.effects.entries:e.effects).some((e=>e.data.flags.core?.statusId===t.id))}))?"active":"",l=t.icon,c={name:i,id:t.id,encodedValue:s,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenactionhud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id));if(!s)return;let n=this.initializeEmptySubcategory();s.forEach((i=>{const s=this.i18n(i.label),o=[a,e,i.id].join(this.delimiter),r=("some"in t.effects.entries?t.effects.entries:t.effects).some((t=>t.data.flags.core?.statusId===i.id))?"active":"",l=i.icon,c={name:s,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.conditions"),n)}_addIntiativeSubcategory(t,e,i){const a=game.combat;let s,n;a&&(s=a.combatants.find((t=>t.tokenId===i)),n=s?.initiative);let o=this.initializeEmptySubcategory(),r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};n&&(r.info1=n),r.cssClass=n?"active":"",o.actions.push(r),this._combineSubcategoryWithCategory(e,this.i18n("tokenactionhud.initiative"),o)}_addMultiIntiativeSubcategory(t,e,i){const a=game.combat;let s,n=this.initializeEmptySubcategory(),o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};if(a){s=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=s?"active":"",n.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.initiative"),n)}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s="utility";this._addMultiIntiativeSubcategory(s,e,a);let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory(),r=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.data.type))){let t=[s,e,"shortRest"].join(this.delimiter);n.actions.push({id:"shortRest",encodedValue:t,name:this.i18n("tokenactionhud.shortRest")});let a=[s,e,"longRest"].join(this.delimiter);n.actions.push({id:"longRest",encodedValue:a,name:this.i18n("tokenactionhud.longRest")});let o={id:"inspiration",encodedValue:[s,e,"inspiration"].join(this.delimiter),name:this.i18n("tokenactionhud.inspiration")};o.cssClass=i.every((t=>t.data.data.attributes?.inspiration))?"active":"",r.actions.push(o)}if(i.every((t=>"starship"===t.data.type))){let t=[s,e,"rechargeRepair"].join(this.delimiter);o.actions.push({id:"rechargeRepair",encodedValue:t,name:this.i18n("tokenactionhud.rechargeRepair")});let i=[s,e,"refittingRepair"].join(this.delimiter);o.actions.push({id:"refittingRepair",encodedValue:i,name:this.i18n("tokenactionhud.refittingRepair")});let a=[s,e,"regenRepair"].join(this.delimiter);o.actions.push({id:"regenRepair",encodedValue:a,name:this.i18n("tokenactionhud.regenRepair")})}this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rests"),n),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.repairs"),o),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.utility"),r),this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_buildEquipmentItem(t,e,i,a){let s=this._buildItem(t,e,i,a);return this._addItemInfo(e,a,s),s}_buildItem(t,e,i,a){const s=this._getDocumentData(a),n=a.id;let o=[i,t,n].join(this.delimiter),r=this._getImage(a),l=this._getActionIcon(a.data?.data?.activation?.type),c={name:a.name,id:n,encodedValue:o,img:r,icon:l};return s.recharge&&!s.recharge.charged&&s.recharge.value&&(c.name+=` (${this.i18n("tokenactionhud.recharge")})`),c}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e),i.info2=this._getUsesData(e),i.info3=this._getConsumeData(e,t)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="",i=this._getDocumentData(t).quantity;return i>1&&(e=i),e}_getUsesData(t){let e="",i=this._getDocumentData(t).uses;return i?(e=0===i.value&&i.max?"0":i.value,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){const i=this._getDocumentData(t);let a="",s=i.consume?.type;if(s&&""!==s){let t=i.consume.target,n=t.substr(0,t.lastIndexOf("."));if("attribute"===s){let t=getProperty(e,`data.data.${n}`);t&&(a=t.value??0,t.max&&(a+=`/${t.max}`))}if("charges"===s){let t=i.consume.target,s=e.items.get(t)?.data.data.uses;s?.value&&(a=s.value,s.max&&(a+=`/${s.max}`))}if("attribute"!==s&&"charges"!==s){let t=i.consume.target,s=e.items.get(t)?.data.data.quantity;s&&(a=s)}}return a}_filterLongerActions(t){var e;return get("hideLongerActions")&&(e=t.filter((t=>{const e=this._getDocumentData(t);return!e.activation||!("minute"===e.activation.type||"hour"===e.activation.type||"day"===e.activation.type)}))),e||t}_filterNonpreparedPowers(t){const e=Object.keys(game.sw5e.config.powerPreparationModes).filter((t=>"prepared"!=t));let i=t;return i=get("showAllNonpreparablePowers")?t.filter((t=>{const i=this._getDocumentData(t);return i.preparation.prepared||e.includes(i.preparation.mode)||0===i.level})):t.filter((t=>this._getDocumentData(t).preparation.prepared)),i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=this._getDocumentData(t).uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{bonus:'<i class="fas fa-plus"></i>',crew:'<i class="fas fa-users"></i>',legendary:'<i class="fas fa-dragon"></i>',reaction:'<i class="fas fa-bolt"></i>',special:'<i class="fas fa-star"></i>',lair:'<i class="fas fa-home"></i>',minute:'<i class="fas fa-hourglass-start"></i>',hour:'<i class="fas fa-hourglass-half"></i>',day:'<i class="fas fa-hourglass-end"></i>'}[t]}_getDocumentData(t){return t.data.data??t.data}}class ActionHandlerSW5eGroupByType extends ActionHandlerSW5e{async _buildCategories(t){const e=game.modules.get("character-actions-list-5e").api,i=await e.getActorActionsData(t.actor);return[this._buildActionCategory(t,"actions",i.action),this._buildActionCategory(t,"bonusActions",i.bonus),this._buildActionCategory(t,"reactions",i.reaction),this._buildActionCategory(t,"crewActions",i.crew),this._buildActionCategory(t,"legendaryActions",i.legendary),this._buildActionCategory(t,"lairActions",i.lair),this._buildActionCategory(t,"specialActions",i.other),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildActionCategory(t,e,i){const a=this.initializeEmptyCategory(e);a.name=this.i18n(`tokenactionhud.${e}`);let s=[];for(const t of i)"power"==t.type&&(s.push(t),i.delete(t));"character"!==t.actor.data.type&&get("showAllNpcItems")||(s=this._filterNonpreparedPowers(s)),s=this._sortPowersByLevel(s),s=this._categorisePowers(t.actor,t.id,s),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.weapons"),(t=>"weapon"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.equipment"),(t=>"equipment"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.consumables"),(t=>"consumable"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.tools"),(t=>"tool"==t.type)),this._subCategorizeEquipment(t,a,i,this.i18n("tokenactionhud.other"),(t=>!0));for(const t of s.subcategories)this._combineSubcategoryWithCategory(a,t.name,t);return a}_subCategorizeEquipment(t,e,i,a,s){const n=this.initializeEmptySubcategory(),o=new Set;for(const t of i)s(t)&&(o.add(t),i.delete(t));o.size>0&&(n.actions=[...o].map((e=>this._buildEquipmentItem(t.id,t.actor,"item",e))),this._combineSubcategoryWithCategory(e,a,n))}}class MagicItemsPreRollHandler extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){let i=e.split("|");if(3!=i.length)return!1;let a=i[0],s=i[1],n=i[2];return"magicItem"==a&&(this._magicItemMacro(t,s,n),!0)}_magicItemMacro(t,e,i){let a=super.getActor(e),s=i.split(">"),n=s[0],o=s[1];MagicItems.actor(a.id).roll(n,o),Hooks.callAll("forceUpdateTokenActionHUD")}}class RollHandlerBaseSW5e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];if("multi"===s)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,a,i,n)}else await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"ability":this.rollAbilityMacro(t,i,a);break;case"skill":this.rollSkillMacro(t,i,a);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,a);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,a);break;case"item":case"power":case"feat":this.isRenderItem()?this.doRenderItem(i,a):this.rollItemMacro(t,i,a);break;case"utility":await this.performUtilityMacro(t,i,a);break;case"effect":await this.toggleEffect(t,i,a);break;case"condition":await this.toggleCondition(t,i,a)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollAbilitySave(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){let a=super.getActor(e),s=super.getItem(a,i);if(!this.needsRecharge(s))return"power"===s.data.type?a.usePower(s):s.roll({event:t});s.rollRecharge()}needsRecharge(t){const e=this._getDocumentData(t);return e.recharge&&!e.recharge.charged&&e.recharge.value}async performUtilityMacro(t,e,i){let a=super.getActor(e),s=super.getToken(e);switch(i){case"shortRest":a.shortRest();break;case"longRest":a.longRest();break;case"inspiration":let i=!a.data.data.attributes.inspiration;a.update({"data.attributes.inspiration":i});break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":s.toggleVisibility();break;case"deathSave":a.rollDeathSave({event:t});break;case"rechargeRepair":a.rechargeRepair();break;case"refittingRepair":a.refittingRepair();break;case"regenRepair":a.regenRepair();break;case"destructionSave":a.rollDestructionSave({event:t});break;case"initiative":await this.performInitiativeMacro(e)}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const a=super.getActor(e),s=("find"in a.effects.entries?a.effects.entries:a.effects).find((t=>t.id===i));if(!s)return;const n=s.data.flags.core?.statusId;n?await this.toggleCondition(t,e,n):(await s.update({disabled:!s.data.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i){const a=super.getToken(e),s=this.isRightClick(t);if(i.includes("combat-utility-belt.")&&game.cub&&!s){const t=this.findCondition(i)?.label;if(!t)return;game.cub.hasCondition(t,a)?await game.cub.removeCondition(t,a):await game.cub.addCondition(t,a)}else{const t=this.findCondition(i);if(!t)return;s?await a.toggleOverlay(t):await a.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}_getDocumentData(t){return t.data.data??t.data}}class RollHandlerMidiQolSW5e extends RollHandlerBaseSW5e{constructor(){super()}rollItemMacro(t,e,i){let a=super.getActor(e),s=a.items.get(i);var n;this.needsRecharge(s)?s.rollRecharge():this.rightClick&&this.ctrl?s.rollAttack():this.rightClick&&this.alt?s.rollDamage():(s.data.data.properties?.ver&&(n=this.rightClick),MidiQOL.doCombinedRoll({actor:a,item:s,event:t,versatile:n}))}}class RollHandlerObsidianSW5e extends RollHandlerBaseSW5e{constructor(){super()}rollAbilityCheckMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"abl",abl:i})}rollAbilitySaveMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"save",save:i})}rollSkillMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"skl",skl:i})}rollItemMacro(t,e,i){let a=super.getActor(e);OBSIDIAN.Items.roll(a,{roll:"item",id:i})}}class SW5eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){let i;return i=SystemManager.isModuleActive("character-actions-list-5e")&&get("useActionList")?new ActionHandlerSW5eGroupByType(t,e):new ActionHandlerSW5e(t,e),SystemManager.isModuleActive("magicitems")&&i.addFurtherActionHandler(new MagicItemActionListExtender),i}getAvailableRollHandlers(){let t="Core SW5e";SystemManager.isModuleActive("midi-qol")&&(t+=` [supports ${SystemManager.getModuleTitle("midi-qol")}]`);let e={core:t};return SystemManager.addHandler(e,"midi-qol"),SystemManager.addHandler(e,"obsidian"),e}doGetRollHandler(t){let e;switch(t){case"midi-qol":e=new RollHandlerMidiQolSW5e;break;case"obsidian":e=new RollHandlerObsidianSW5e;break;case"core":default:e=new RollHandlerBaseSW5e}return SystemManager.isModuleActive("magicitems")&&e.addPreRollHandler(new MagicItemsPreRollHandler),e}doRegisterSettings(t,e){!function register$6(t,e){game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenactionhud.settings.sw5e.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showPowerInfo",{name:game.i18n.localize("tokenactionhud.settings.sw5e.showPowerInfo.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.showPowerInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNonpreparablePowers",{name:game.i18n.localize("tokenactionhud.settings.sw5e.showAllNonpreparablePowers.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.showAllNonpreparablePowers.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideLongerActions",{name:game.i18n.localize("tokenactionhud.settings.sw5e.hideLongerActions.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.hideLongerActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenactionhud.settings.sw5e.abbreviateSkills.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"splitAbilities",{name:game.i18n.localize("tokenactionhud.settings.sw5e.splitAbilities.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.splitAbilities.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNpcItems",{name:game.i18n.localize("tokenactionhud.settings.sw5e.showAllNpcItems.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.showAllNpcItems.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenactionhud.settings.sw5e.showEmptyItems.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showConditionsCategory",{name:game.i18n.localize("tokenactionhud.settings.sw5e.showConditionsCategory.name"),hint:game.i18n.localize("tokenactionhud.settings.sw5e.showConditionsCategory.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.modules.get("character-actions-list-5e")?.active&&game.settings.register(t,"useActionList",{name:game.i18n.localize("tokenactionhud.settings.useActionList.name"),hint:game.i18n.localize("tokenactionhud.settings.useActionList.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerWfrp extends ActionHandler{constructor(t,e){super(t,e),this.filterManager.createOrGetFilter("skills")}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id;let n=this._getItemsList(s,a,"weapon"),o=this._getCharacteristics(s,a),r=this._getSkills(s,a),l=this._getSpells(s,a),c=this._getPrayers(s,a),d=this._getTalents(s,a),h=this._getTraits(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.weapons"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.characteristics"),o),this._combineCategoryWithList(i,this.i18n("tokenactionhud.skills"),r),this._combineCategoryWithList(i,this.i18n("tokenactionhud.magic"),l),this._combineCategoryWithList(i,this.i18n("tokenactionhud.religion"),c),this._combineCategoryWithList(i,this.i18n("tokenactionhud.talents"),d),this._combineCategoryWithList(i,this.i18n("tokenactionhud.traits"),h),this._setFilterSuggestions(s),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getItemsList(t,e,i){let a=i+"s",s=this.initializeEmptyCategory("items"),n=this._getBasicActions(t,e);this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.basic"),n);let o=this.initializeEmptySubcategory(),r=t.getItemTypes(i),l="character"===t.data.type?r.filter((t=>t.data.data.equipped)):r;return o.actions=this._produceMap(e,l,i),this._combineSubcategoryWithCategory(s,a,o),s}_getBasicActions(t,e){let i=this.initializeEmptySubcategory(),a=["unarmed",e,"unarmed"].join(this.delimiter);const s={id:"unarmed",name:this.i18n("tokenactionhud.unarmed"),encodedValue:a};i.actions.push(s);let n=["stomp",e,"stomp"].join(this.delimiter);const o={id:"stomp",name:this.i18n("tokenactionhud.stomp"),encodedValue:n};i.actions.push(o);let r=["improvise",e,"improvise"].join(this.delimiter);const l={id:"improvise",name:this.i18n("tokenactionhud.improvisedWeapon"),encodedValue:r};i.actions.push(l);let c=["dodge",e,"dodge"].join(this.delimiter);const d={id:"dodge",name:this.i18n("tokenactionhud.dodge"),encodedValue:c};return i.actions.push(d),i}_getCharacteristics(t,e){let i=this.initializeEmptyCategory("characteristics"),a="characteristic",s=Object.entries(t.characteristics),n=this.initializeEmptySubcategory();return n.actions=s.map((t=>{let i=[a,e,t[0]].join(this.delimiter);return{name:this.i18n(t[1].abrev),encodedValue:i,id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.characteristics"),n),i}_getSkills(t,e){let i="skills",a="skill",s=this.initializeEmptyCategory(i),n=t.getItemTypes("skill").filter((t=>t.id));s.choices=n.length;let o=game.i18n.localize("tokenactionhud.wfrp.meleeSkillPrefix"),r=game.i18n.localize("tokenactionhud.wfrp.rangedSkillPrefix"),l=n.filter((t=>t.data.name.startsWith(o))),c="skills_melee";this._setFilterSuggestions(c,l);let d=this.initializeEmptySubcategory(c);d.canFilter=l.length>0;let h=this._filterElements(c,l);d.actions=this._produceMap(e,h,a);let u=n.filter((t=>t.data.name.startsWith(r))),g="skills_ranged";this._setFilterSuggestions(g,u);let m=this.initializeEmptySubcategory(g);m.canFilter=u.length>0;let y=this._filterElements(g,u);m.actions=this._produceMap(e,y,a);let p=n.filter((t=>!(t.data.name.startsWith(o)||t.data.name.startsWith(r))&&"adv"!==t.data.data.advanced.value)),b="skills_basic";this._setFilterSuggestions(b,p);let f=this.initializeEmptySubcategory(b),k=this._filterElements(b,p);f.canFilter=p.length>0,f.actions=this._produceMap(e,k,a);let _=n.filter((t=>!(t.data.name.startsWith(o)||t.data.name.startsWith(r))&&"adv"===t.data.data.advanced.value)),C="skills_advanced";this._setFilterSuggestions(C,_);let S=this.initializeEmptySubcategory(C);S.canFilter=_.length>0;let v=this._filterElements(C,_);return S.actions=this._produceMap(e,v,a),this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.melee"),d),this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.ranged"),m),this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.basic"),f),this._combineSubcategoryWithCategory(s,this.i18n("tokenactionhud.advanced"),S),s}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),a=e.filter((t=>!!t));return i.length>0&&(a=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),a}_getSpells(t,e){let i="spell",a=this.initializeEmptyCategory("spells"),s=t.getItemTypes("spell"),n=s.filter((t=>"petty"===t.data.data.lore.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.petty"),o);let r=s.filter((t=>"petty"!==t.data.data.lore.value)).reduce(((t,e)=>{let i=e.data.data.lore.value;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{});return Object.entries(r).forEach((t=>{let s=this.initializeEmptySubcategory();s.actions=this._produceMap(e,t[1],i),this._combineSubcategoryWithCategory(a,t[0],s)})),a}_getPrayers(t,e){let i="prayer",a=this.initializeEmptyCategory("prayers"),s=t.getItemTypes("prayer"),n=s.filter((t=>"blessing"===t.type.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.blessing"),o);let r=s.filter((t=>"blessing"!==t.type.value)).reduce(((t,e)=>{let i=e.data.data.type.value;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{});return Object.entries(r).forEach((t=>{let s=this.initializeEmptySubcategory();s.actions=this._produceMap(e,t[1],i),this._combineSubcategoryWithCategory(a,t[0],s)})),a}_getTalents(t,e){let i="talent",a=this.initializeEmptyCategory("talents"),s=t.getItemTypes("talent"),n=s.filter((t=>t.rollable?.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i);let r=s.filter((t=>!t.rollable?.value)),l=this.initializeEmptySubcategory();return l.actions=this._produceMap(e,r,i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rollable"),o),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.unrollable"),l),a}_getTraits(t,e){let i="trait",a=this.initializeEmptyCategory("traits"),s=t.getItemTypes("trait").filter((t=>t.included)),n=s.filter((t=>t.rollable?.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i);let r=s.filter((t=>!t.rollable?.value)),l=this.initializeEmptySubcategory();return l.actions=this._produceMap(e,r,i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rollable"),o),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.unrollable"),l),a}_produceMap(t,e,i){return e.map((e=>{let a=[i,t,e.id].join(this.delimiter),s=this._getImage(e);return{name:e.name,encodedValue:a,id:e.id,img:s}})).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"})))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")||e?.includes("systems/wfrp4e/icons/blank.png")?"":e}}class RollHandlerBaseWfrp4e extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s),r={bypass:!!t.shiftKey};if("characteristic"===a)return o.setupCharacteristic(n,r).then((t=>o.basicTest(t)));if(this.isRenderItem())return this.doRenderItem(s,n);let l=o.items.get(n);if(this.rightClick)return l.postItem();switch(a){case"dodge":return this.dodge(o);case"unarmed":return this.unarmed(o);case"stomp":return this.stomp(o);case"improvise":return this.improvise(o);case"weapon":{let t=o.setupWeapon(l,r);if(!l.loading||l.loaded.value)return t.then((t=>o.weaponTest(t)));break}case"spell":return this.castSpell(o,l,r);case"prayer":return o.setupPrayer(l,r).then((t=>o.prayerTest(t)));case"trait":case"talent":return l.rollable?.value?o.setupTrait(l,r).then((t=>o.traitTest(t))):l.postItem();case"skill":return o.setupSkill(l,r).then((t=>o.basicTest(t)))}}dodge(t){let e=t.getItemTypes("skill").find((t=>t.name==game.i18n.localize("NAME.Dodge")));e?t.setupSkill(e).then((e=>{t.basicTest(e)})):t.setupCharacteristic("ag",{dodge:!0}).then((e=>{t.basicTest(e)}))}unarmed(t){let e=game.wfrp4e.config.systemItems.unarmed;t.setupWeapon(e).then((e=>{t.weaponTest(e)}))}stomp(t){let e=game.wfrp4e.config.systemItems.stomp;t.setupTrait(e).then((e=>{t.traitTest(e)}))}improvise(t){let e=game.wfrp4e.config.systemItems.improv;t.setupWeapon(e).then((e=>{t.weaponTest(e)}))}castSpell(t,e,i){return t.spellDialog?t.spellDialog(e,i):t.sheet.spellDialog(e,i)}}class Wfrp4eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerWfrp(t,e)}getAvailableRollHandlers(){return{core:"Core WFRP4e"}}doGetRollHandler(t){return new RollHandlerBaseWfrp4e}doRegisterSettings(t,e){}}class ActionHandlerLancer extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.actor.id;i.actorId=a;let s=t.actor,n=await s.data.data.derived.mm;if(!s)return i;switch(s.data.type){case"pilot":this._combineCategoryWithList(i,this.i18n("tokenactionhud.pilot"),this._pilotCategory(n,a));break;case"mech":this._combineCategoryWithList(i,this.i18n("tokenactionhud.pilot"),this._pilotCategory(n.Pilot,n.Pilot.RegistryID)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.mech"),this._mechCategory(n,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.weapons"),this._weaponsCategory(n.Loadout.WepMounts,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.systems"),this._systemsCategory(n.Loadout.SysMounts,a));break;case"npc":this._combineCategoryWithList(i,this.i18n("tokenactionhud.stats"),this._npcBaseCategory(s,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.features"),this._npcFeatureCategory(s,a))}return get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_makeAction(t,e,i,a,s){let n=this.initializeEmptyAction();return n.name=t,n.encodedValue=[e,i,a,JSON.stringify(s||{})].join(this.delimiter),n}_makeItemSubCat(t,e,i,a){let s=this.initializeEmptySubcategory();return s.name=t,s.actions=i.filter((t=>{if(null!=t)return t.Type===e})).map((t=>this._makeAction(t.Name,"item",a,t.RegistryID))),s}_makeNPCItemSubCat(t,e,i,a){let s=this.initializeEmptySubcategory();return s.name=t,s.actions=i.data.items.filter((t=>{if(null!=t)return"npc_feature"===t.data.type})).filter((t=>t.data.data.type===e)).map((t=>this._makeAction(t.name,"item",a,t.id))),s}_pilotCategory(t,e){let i=this.initializeEmptyCategory("pilot");return[this._skillsSubCategory(t,e),this._talentsSubCategory(t,e),this._pilotGearSubCategory(t,e),this._pilotWeaponSubCategory(t,e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_npcBaseCategory(t,e){let i=this.initializeEmptyCategory("mech");return[this._haseSubCategory(e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_npcFeatureCategory(t,e){let i=this.initializeEmptyCategory("feature");return[this._npcWeaponSubCat(t,e),this._npcTechSubCat(t,e),this._npcReactionSubCat(t,e),this._npcSystemSubCat(t,e),this._npcTraitSubCat(t,e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_npcWeaponSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenactionhud.weapons"),"Weapon",t,e)}_npcTraitSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenactionhud.traits"),"Trait",t,e)}_npcSystemSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenactionhud.systems"),"System",t,e)}_npcTechSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenactionhud.techs"),"Tech",t,e)}_npcReactionSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenactionhud.reactions"),"Reaction",t,e)}_skillsSubCategory(t,e){return this._makeItemSubCat(this.i18n("tokenactionhud.skilltriggers"),"skill",t._skills,e)}_talentsSubCategory(t,e){let i=this.initializeEmptySubcategory();i.id="talent",i.name=this.i18n("tokenactionhud.talents");let a=t._talents.filter((t=>{if(null!=t)return"talent"===t.Type})).map((t=>{let i=this.initializeEmptySubcategory();i.name=t.Name;for(let a=0;a<t.CurrentRank;a++){let s={rank:`${a}`},n=this._makeAction(`${this.i18n("tokenactionhud.rank")} ${a+1}`,"item",e,t.RegistryID,s);i.actions.push(n)}return i}));return this._combineSubcategoryWithCategory,i.subcategories=a,i}_pilotWeaponSubCategory(t,e){return this._makeItemSubCat(this.i18n("tokenactionhud.weapons"),"pilot_weapon",t.Loadout.Weapons,e)}_pilotGearSubCategory(t,e){return this._makeItemSubCat(this.i18n("tokenactionhud.gear"),"pilot_gear",t.Loadout.Gear,e)}_mechCategory(t,e){let i=this.initializeEmptyCategory("mech");return[this._haseSubCategory(e),this._statSubCategory(e),this._coreBonSubCategory(t,e),this._corePowerSubCategory(t.Loadout.Frame,e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_haseSubCategory(t){let e=this.initializeEmptySubcategory();e.id="hase",e.name=this.i18n("tokenactionhud.hase");let i=[{name:this.i18n("tokenactionhud.hull"),id:"Hull"},{name:this.i18n("tokenactionhud.attribute.agility"),id:"Agi"},{name:this.i18n("tokenactionhud.systems"),id:"Sys"},{name:this.i18n("tokenactionhud.engineering"),id:"Eng"}].map((e=>this._makeAction(e.name,"hase",t,e.id)));return e.actions=i,e}_statSubCategory(t){let e=this.initializeEmptySubcategory();e.id="stat",e.name=this.i18n("tokenactionhud.stat");let i=[{name:this.i18n("tokenactionhud.grit"),data:"Pilot.Grit"},{name:this.i18n("tokenactionhud.techattack"),data:"TechAttack"}].map((e=>this._makeAction(e.name,"stat",t,e.data)));return e.actions=i,e}_coreBonSubCategory(t,e){let i=this.initializeEmptySubcategory(),a=t.Pilot.CoreBonuses;return i.name="Core Bonuses",i.actions=a.map((i=>{let a={};return a.pilot=t.Pilot.RegistryID,this._makeAction(i.Name,"coreBonus",e,i.RegistryID,a)})),i}_corePowerSubCategory(t,e){let i=this.initializeEmptySubcategory(),a=t.CoreSystem;return i.name=a.Name,"Core Passive"!=a.PassiveName&&i.actions.push(this._makeAction(a.PassiveName,"corePassive",e,"")),a.ActiveName&&i.actions.push(this._makeAction(a.ActiveName,"coreActive",e,"")),i}_weaponsCategory(t,e){let i=this.initializeEmptyCategory();return i.id="weapons",i.name=this.i18n("tokenactionhud.weapons"),t.map(((t,i)=>{let a=this.initializeEmptySubcategory("Mount_"+i);return a.name=t.MountType,a.actions=t.Slots.filter((t=>null!==t.Weapon)).map((t=>this._makeAction(t.Weapon.Name,"item",e,t.Weapon.RegistryID))),a})).forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_systemsCategory(t,e){let i=this.initializeEmptyCategory();return i.id="systems",i.name=this.i18n("tokenactionhud.systems"),t.flatMap((t=>t.System)).map((t=>{let i=this.initializeEmptySubcategory(t.RegistryID);i.name=t.Name;let a=t.Actions.map(((i,a)=>{let s={Type:"Action"};return s.Index=a,this._makeAction(i.Name,"activation",e,t.RegistryID,s)})),s=t.Deployables.map(((i,a)=>{let s={Type:"Deployable"};return s.Index=a,this._makeAction(i.Name,"activation",e,t.RegistryID,s)}));return i.actions=a.concat(s),i})).forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}}class RollHandlerBaseLancer extends RollHandler{constructor(){super()}getActor(t){return game.actors.get(t)}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&4!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=JSON.parse(i[3]);if(this.isRenderItem()&&["item"].includes(a))return this.doRenderItem(s,n);switch(a){case"hase":this._rollHaseMacro(s,n);break;case"stat":"TechAttack"==n?this._rollTechMacro(s,null):this._rollStatMacro(s,n);break;case"item":this._rollWeaponOrFeatureMacro(s,n,o);break;case"coreBonus":this._rollCoreBonusMacro(o.pilot,n);break;case"coreActive":this._rollCoreActiveMacro(s);break;case"corePassive":this._rollCorePassiveMacro(s);break;case"activation":this._rollActivationMacro(s,n,o)}}_rollHaseMacro(t,e){game.lancer.prepareStatMacro(t,`mm.${e}`)}_rollStatMacro(t,e){game.lancer.prepareStatMacro(t,`mm.${e}`)}_rollTechMacro(t,e){game.lancer.prepareTechMacro(t,null)}_rollWeaponOrFeatureMacro(t,e,i){game.lancer.prepareItemMacro(t,e,i)}_rollCoreBonusMacro(t,e){game.lancer.prepareItemMacro(t,e)}_rollCoreActiveMacro(t){game.lancer.prepareCoreActiveMacro(t)}_rollCorePassiveMacro(t){game.lancer.prepareCorePassiveMacro(t)}_rollActivationMacro(t,e,i){game.lancer.prepareActivationMacro(t,e,i.Type,i.Index)}}class LancerSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return console.log("startup"),new ActionHandlerLancer(t,e)}getAvailableRollHandlers(){return{core:"Core Lancer"}}doGetRollHandler(t){return new RollHandlerBaseLancer}doRegisterSettings(t,e){}}class ActionHandlerSwade extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.id;i.tokenId=a;let s=t.actor;return s?(i.actorId=s.id,this._addAttributes(i,a,s),this._addSkills(i,a,s),this._addStatuses(i,a,s),this._addWoundsAndFatigue(i,a,s),this._addBennies(i,a,s),this._addPowers(i,a,s),this._addInventory(i,a,s),this._addEdgesAndHinderances(i,a,s),this._addSpecialAbilities(i,a,s),this._addUtilities(i,a,s),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_addAttributes(t,e,i){const a=i.data.data.attributes,s="attribute",n=this.initializeEmptySubcategory("attributes");Object.entries(a).forEach((t=>{const i=t[0],a=t[1],o=CONFIG.SWADE.attributes[i];let r;r=get("abbreviateAttributes")?this.i18n(o.short):this.i18n(o.long);const l={name:r,encodedValue:[s,e,i].join(this.delimiter),id:i},c=this._buildDieString(a.die,a["wild-die"]);l.info1=c,n.actions.push(l)}));const o=this.i18n("tokenactionhud.attributes");let r=this.initializeEmptyCategory("attributes");this._combineSubcategoryWithCategory(r,o,n),this._combineCategoryWithList(t,o,r)}_addSkills(t,e,i){const a=this.initializeEmptyCategory("skills"),s="skill",n=i.data.items.filter((t=>t.type===s)),o=this.initializeEmptySubcategory("skills");n.forEach((t=>{const i=[s,e,t.id].join(this.delimiter),a={name:t.name,encodedValue:i,id:t.id};let n=this._parseDie(t.data.die,t.data["wild-die"]);a.info1=n,o.actions.push(a)}));const r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(a,r,o),this._combineCategoryWithList(t,r,a)}_addPowers(t,e,i){const a=i.data.items.filter((t=>"power"===t.type));if(0===a.length)return;const s="powerPoints",n=this.initializeEmptyCategory(s),o=i.data.data.powerPoints;o&&(n.info1=`${o.value}/${o.max}`),this._addCounterSubcategory(n,e,o,this.i18n("tokenactionhud.points"),s);const r=this.i18n("tokenactionhud.powers"),l=this._groupPowers(a);Object.entries(l).forEach((t=>{const i=t[0],a=t[1];this._addPowersSubcategory(e,i,a,s,n)})),this._combineCategoryWithList(t,r,n)}_groupPowers(t){return[...new Set(t.map((t=>t.data.data.rank)))].reduce(((e,i)=>{let a=i;return""===a&&(a="No rank"),e.hasOwnProperty(i)||(e[a]=[]),e[a].push(...t.filter((t=>t.data.data.rank===i))),e}),{})}_addInventory(t,e,i){const a=this.initializeEmptyCategory("inventory");let s=i.data.items;"character"===i.data.type&&(s=s.filter((t=>t.data.data.equipped)));const n=s.filter((t=>"weapon"===t.type)),o=this.i18n("tokenactionhud.weapons");this._addItemSubcategory(e,o,n,"weapons",a);const r=s.filter((t=>"armor"===t.type)),l=this.i18n("tokenactionhud.armour");this._addItemSubcategory(e,l,r,"armour",a);const c=s.filter((t=>"shield"===t.type)),d=this.i18n("tokenactionhud.shields");this._addItemSubcategory(e,d,c,"shields",a);const h=s.filter((t=>"misc"===t.type||"gear"===t.type)),u=this.i18n("tokenactionhud.misc");this._addItemSubcategory(e,u,h,"misc",a),this._combineCategoryWithList(t,this.i18n("tokenactionhud.inventory"),a)}_addWoundsAndFatigue(t,e,i){let a=this.initializeEmptyCategory("wounds"),s=this.i18n("tokenactionhud.wounds");this._addCounterSubcategory(a,e,i.data.data.wounds,s,"wounds");let n=this.i18n("tokenactionhud.fatigue");this._addCounterSubcategory(a,e,i.data.data.fatigue,n,"fatigue"),this._combineCategoryWithList(t,this.i18n("tokenactionhud.woundsAndFatigue"),a)}_addCounterSubcategory(t,e,i,a,s){if(!i||i.max<1&&i.value<1)return;const n={name:"-",encodedValue:[s,e,"decrease"].join(this.delimiter),id:`${s}Decrease`,cssClass:"shrink"},o={name:"+",encodedValue:[s,e,"increase"].join(this.delimiter),id:`${s}Increase`,cssClass:"shrink"},r=this.initializeEmptySubcategory(s);r.info1=`${i.value}/${i.max}`,r.actions.push(n),r.actions.push(o),this._combineSubcategoryWithCategory(t,a,r)}_addEdgesAndHinderances(t,e,i){const a=this.initializeEmptyCategory("edges"),s=i.data.items.filter((t=>"edge"===t.type)),n=this.i18n("tokenactionhud.edges");this._addItemSubcategory(e,n,s,"edges",a);const o=i.data.items.filter((t=>"hindrance"===t.type)),r=this.i18n("tokenactionhud.hindrances");this._addItemSubcategory(e,r,o,"hindrances",a),this._combineCategoryWithList(t,this.i18n("tokenactionhud.edgesAndHindrances"),a)}_addSpecialAbilities(t,e,i){const a=this.initializeEmptyCategory("abilities"),s=i.data.items.filter((t=>"ability"===t.type)),n=this.i18n("tokenactionhud.swade.abilities");this._addItemSubcategory(e,n,s,"abilities",a),this._combineCategoryWithList(t,this.i18n("tokenactionhud.swade.specialAbilities"),a)}_addPowersSubcategory(t,e,i,a,s){const n=this.initializeEmptySubcategory(a);i.filter((t=>"-"!==t.name)).forEach((e=>{const i=this._buildPowerAction(t,e);n.actions.push(i)})),this._combineSubcategoryWithCategory(s,e,n)}_addItemSubcategory(t,e,i,a,s){const n=this.initializeEmptySubcategory(a);i.filter((t=>"-"!==t.name)).forEach((e=>{const i=this._buildItemAction(t,e);n.actions.push(i)})),this._combineSubcategoryWithCategory(s,e,n)}_addStatuses(t,e,i){const a=this.initializeEmptyCategory("status"),s="status",n=i.data.data.status,o=this.initializeEmptySubcategory("status");Object.entries(n).forEach((t=>{const i=t[0],a=t[1],n=i.slice(2),r=n.toLowerCase(),l={name:n,id:n,encodedValue:[s,e,r].join(this.delimiter)};l.cssClass=a?"active":"",o.actions.push(l)}));const r=this.i18n("tokenactionhud.status");this._combineSubcategoryWithCategory(a,r,o),this._combineCategoryWithList(t,r,a)}_addBennies(t,e,i){const a=i.data.data.bennies;if(!a)return;const s=this.initializeEmptyCategory("bennies"),n="benny",o=this.i18n("tokenactionhud.bennies"),r=this.i18n("tokenactionhud.spend"),l={name:r,encodedValue:[n,e,"spend"].join(this.delimiter),id:"bennySpend"},c=this.i18n("tokenactionhud.get"),d={name:c,encodedValue:[n,e,"get"].join(this.delimiter),id:"bennyGet"},h=this.initializeEmptySubcategory(n);if(h.name=o,h.info1=a.value.toString(),s.info1=a.value.toString(),h.actions.push(l),h.actions.push(d),this._combineSubcategoryWithCategory(s,o,h),game.user.isGM){const t=game.user.getFlag("swade","bennies");if(null!==t){const i="gmBenny",a={name:r,encodedValue:[i,e,"spend"].join(this.delimiter),id:"gmBennySpend"},n={name:c,encodedValue:[i,e,"get"].join(this.delimiter),id:"gmBennyGet"},l=this.initializeEmptySubcategory(i);l.actions.push(a),l.actions.push(n);const d=`${this.i18n("tokenactionhud.gm")} ${o}`;l.info2=t.toString(),s.info2=t.toString(),this._combineSubcategoryWithCategory(s,d,l)}}this._combineCategoryWithList(t,o,s)}_addUtilities(t,e,i){let a=this.initializeEmptyCategory("utility");this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_parseDie(t,e){let i=this._buildDieString(t);if(!e)return i;let a=this._buildDieString(e);return 0===i.toUpperCase().localeCompare(a.toUpperCase(),void 0,{sensitivity:"base"})?i:`${i}/${a}`}_buildDieString(t){if(!t)return"";let e=`d${t.sides}`;const i=parseInt(t.modifier);if(!t.modifier||0===i)return e;return e+=i>0?`+${i}`:`${i}`,e}_buildItemAction(t,e){const i=e.id,a=e.name,s=["item",t,i].join(this.delimiter),n={name:a,id:i,encodedValue:s};return n.info1=this._getItemQuantity(e),n.info2=this._getItemShots(e),n.img=e.img,n}_getItemQuantity(t){return 1!==t.data.data.quantity?t.data.data.quantity:""}_getItemShots(t){const e=t.data.data.currentShots,i=t.data.data.shots;if(!e)return;let a="";return 0==e&&0==i||(a+=e),i>0&&(a+=`/${i}`),a}_buildPowerAction(t,e){const i=e.id,a=e.name,s=["item",t,i].join(this.delimiter),n={name:a,id:i,encodedValue:s};return n.info1=this._getPowerPoints(e),n.img=e.img,n}_getPowerPoints(t){const e=t.data.data.pp;if("special"===e.toString().toLowerCase())return"*";const i=parseInt(e.toString());return NaN===i?"":i}}class RollHandlerBaseSwade extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);if(this.isRenderItem()&&["item"].includes(a))return this.doRenderItem(s,n);switch(a){case"item":this._rollItem(t,o,n);break;case"status":await this._toggleStatus(t,o,n,s);break;case"benny":this._adjustBennies(t,o,n);break;case"gmBenny":await this._adjustGmBennies(t,o,n);break;case"attribute":this._rollAttribute(t,o,n);break;case"skill":this._rollSkill(t,o,n);break;case"wounds":case"fatigue":case"powerPoints":await this._adjustAttributes(t,o,a,n)}}_rollItem(t,e,i){super.getItem(e,i).show()}async _toggleStatus(t,e,i,a){const s=e.effects.find((t=>t.getFlag("core","statusId")==i)),n=CONFIG.SWADE.statusEffects.find((t=>t.id===i));n["flags.core.statusId"]=i,await canvas.tokens.get(a).toggleEffect(n,{active:!s})}_adjustBennies(t,e,i){"spend"===i&&e.spendBenny(),"get"===i&&e.getBenny()}async _adjustGmBennies(t,e,i){let a=game.user;a.isGM&&(a.getFlag("swade","bennies"),"spend"===i&&game.user.spendBenny(),"get"===i&&game.user.getBenny(),Hooks.callAll("forceUpdateTokenActionHUD"))}_rollAttribute(t,e,i){e.rollAttribute(i,{event:t})}_rollSkill(t,e,i){e.rollSkill(i,{event:t})}async _adjustAttributes(t,e,i,a){let s=e.data.data[i];if(!s)return;const n=s.value,o=s.max,r=s.min??0;let l;switch(a){case"increase":l=Math.clamped(n+1,r,o);break;case"decrease":l=Math.clamped(n-1,r,o)}let c={data:{}};c.data[i]={value:l},await e.update(c)}}class RollHandlerBR2SWSwade extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);if(this.isRenderItem()&&["item"].includes(a))return this.doRenderItem(s,n);switch(a){case"item":this._rollItem(t,o,n,s);break;case"status":await this._toggleStatus(t,o,n,s);break;case"benny":this._adjustBennies(t,o,n);break;case"gmBenny":await this._adjustGmBennies(t,o,n);break;case"attribute":this._rollAttribute(t,o,n,s);break;case"skill":this._rollSkill(t,o,n,s);break;case"wounds":case"fatigue":case"powerPoints":await this._adjustAttributes(t,o,a,n)}}_rollItem(t,e,i,a){let s;s=!0===t.ctrlKey?game.settings.get("betterrolls-swade2","ctrl_click"):!0===t.altKey?game.settings.get("betterrolls-swade2","alt_click"):!0===t.shiftKey?game.settings.get("betterrolls-swade2","shift_click"):game.settings.get("betterrolls-swade2","click"),"trait"===s?game.brsw.create_item_card_from_id(a,e.id,i).then((t=>{game.brsw.roll_item(t,$(t.data.content),!1)})):"trait_damage"===s?game.brsw.create_item_card_from_id(a,e.id,i).then((t=>{game.brsw.roll_item(t,$(t.data.content),!1,!0)})):"system"===s?game.swade.rollItemMacro(e.items.get(i).name):game.brsw.create_item_card_from_id(a,e.id,i)}async _toggleStatus(t,e,i,a){const s=e.effects.find((t=>t.getFlag("core","statusId")==i)),n=CONFIG.SWADE.statusEffects.find((t=>t.id===i));n["flags.core.statusId"]=i,await canvas.tokens.get(a).toggleEffect(n,{active:!s})}_adjustBennies(t,e,i){"spend"===i&&e.spendBenny(),"get"===i&&e.getBenny()}async _adjustGmBennies(t,e,i){let a=game.user;a.isGM&&(a.getFlag("swade","bennies"),"spend"===i&&game.user.spendBenny(),"get"===i&&game.user.getBenny(),Hooks.callAll("forceUpdateTokenActionHUD"))}_rollAttribute(t,e,i,a){let s;s=!0===t.ctrlKey?game.settings.get("betterrolls-swade2","ctrl_click"):!0===t.altKey?game.settings.get("betterrolls-swade2","alt_click"):!0===t.shiftKey?game.settings.get("betterrolls-swade2","shift_click"):game.settings.get("betterrolls-swade2","click"),"trait"===s||"trait_damage"===s?game.brsw.create_attribute_card_from_id(a,e.id,i).then((t=>{game.brsw.roll_attribute(t,$(t.data.content),!1)})):"system"===s?e.rollAttribute(i):game.brsw.create_attribute_card_from_id(a,e.id,i)}_rollSkill(t,e,i,a){let s;s=!0===t.ctrlKey?game.settings.get("betterrolls-swade2","ctrl_click"):!0===t.altKey?game.settings.get("betterrolls-swade2","alt_click"):!0===t.shiftKey?game.settings.get("betterrolls-swade2","shift_click"):game.settings.get("betterrolls-swade2","click"),"trait"===s||"trait_damage"===s?game.brsw.create_skill_card_from_id(a,e.id,i).then((t=>{game.brsw.roll_skill(t,$(t.data.content),!1)})):"system"===s?game.swade.rollItemMacro(e.items.get(i).name):game.brsw.create_skill_card_from_id(a,e.id,i)}async _adjustAttributes(t,e,i,a){let s=e.data.data[i];if(!s)return;const n=s.value,o=s.max,r=s.min??0;let l;switch(a){case"increase":l=Math.clamped(n+1,r,o);break;case"decrease":l=Math.clamped(n-1,r,o)}let c={data:{}};c.data[i]={value:l},await e.update(c)}}function register$5(t,e){game.settings.register(t,"abbreviateAttributes",{name:game.i18n.localize("tokenactionhud.settings.swade.abbreviateAttributes.name"),hint:game.i18n.localize("tokenactionhud.settings.swade.abbreviateAttributes.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc(t)}})}class SwadeSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSwade(t,e)}getAvailableRollHandlers(){let t={core:"Core SWADE"};return SystemManager.addHandler(t,"betterrolls-swade2"),t}doGetRollHandler(t){switch(t){case"betterrolls-swade2":return new RollHandlerBR2SWSwade;default:return new RollHandlerBaseSwade}}doRegisterSettings(t,e){register$5(t)}}class ActionHandlerStarWarsFFG extends ActionHandler{constructor(t,e){super(t,e),this.filterManager.createOrGetFilter("skills")}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id;let n=this._getItemsList(s,a,"weapon");this._combineCategoryWithList(i,this.i18n("tokenactionhud.weapons"),n);let o=this._getItemsList(s,a,"forcepower");this._combineCategoryWithList(i,this.i18n("SWFFG.ForcePower"),o);const r=s.data.data;return r.skilltypes.forEach((t=>{let e=this._getSkills(t,r,a);this._combineCategoryWithList(i,t.label,e)})),game.user.isGM&&this._combineCategoryWithList(i,"utility",this._getGMList(e)),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getGMList(t){let e=this.initializeEmptyCategory("utility"),i=this.initializeEmptySubcategory();return i.actions=[{name:"Destiny Pool Init",encodedValue:"gm|destiny|destiny",id:"gm_destiny"}],this._combineSubcategoryWithCategory(e,"GM",i),e}_getItemsList(t,e,i){let a=this.initializeEmptyCategory(i),s=this.initializeEmptySubcategory(),n=t.items.filter((t=>t.type===i));return s.actions=this._produceItemMap(e,n,i),this._combineSubcategoryWithCategory(a,"",s),a}_getSkills(t,e,i){let a=this.initializeEmptyCategory("skills");const s=Object.keys(e.skills).filter((i=>e.skills[i].type===t.type)).sort(((t,e)=>{let i=0;return t.toLowerCase()>e.toLowerCase()?i=1:t.toLowerCase()<e.toLowerCase()&&(i=-1),i}));Logger.debug(s);let n=this.initializeEmptySubcategory();return n.actions=this._produceSkillMap(i,e,s,"skill"),this._combineSubcategoryWithCategory(a,"",n),a}_produceItemMap(t,e,i){return e.map((e=>{let a=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:a,id:e.id}}))}_produceSkillMap(t,e,i,a){return i.map((i=>{let s=[a,t,i].join(this.delimiter);return{name:e.skills[i].label,encodedValue:s,id:i}}))}}class RollHandlerBaseStarWarsFFG extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"gm":switch(n){case"destiny":return this._rollDestiny()}case"weapon":return game.ffg.DiceHelpers.rollItem(n,o.id);case"skill":return this._rollSkill(o,n,t);case"forcepower":return this._rollForcePower(o,n)}}_rollForcePower(t,e){let i=t.items.get(e);i||(i=game.items.get(e)),i||(i=ImportHelpers.findCompendiumEntityById("Item",e));const a=t.data.data.stats.forcePool.max-t.data.data.stats.forcePool.value;if(a>0){let e=t.sheet.getData();const s=new DicePoolFFG({force:a});game.ffg.DiceHelpers.displayRollDialog(e,s,`${game.i18n.localize("SWFFG.Rolling")} ${i.name}`,i.name,i)}}_rollDestiny(){game.settings.set("starwarsffg","dPoolLight",0),game.settings.set("starwarsffg","dPoolDark",0);const t=`<button class="ffg-destiny-roll">${game.i18n.localize("SWFFG.DestinyPoolRoll")}</button>`;new Map([...game.settings.settings].filter((([t,e])=>e.key.includes("destinyrollers")))).forEach((t=>{game.settings.set(t.module,t.key,void 0)})),CONFIG.FFG.DestinyGM=game.user.id,ChatMessage.create({user:game.user.id,content:t})}_rollSkill(t,e,i){let a=2;i.ctrlKey&&!i.shiftKey?a=3:!i.ctrlKey&&i.shiftKey&&(a=1);const s=t.sheet.getData(),n=t.data.data.skills[e],o=s.data.characteristics[n.characteristic];game.ffg.DiceHelpers.rollSkillDirect(n,o,a,s)}}class StarWarsFFGSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerStarWarsFFG(t,e)}getAvailableRollHandlers(){return{core:"Core starwarsffg"}}doGetRollHandler(t){return new RollHandlerBaseStarWarsFFG}doRegisterSettings(t,e){}}class ActionHandlerT20 extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id;let n=this._getItemList(s,a),o=this._getFeatsList(s,a),r=this._getSpellsList(s,a);this._getSkillsList(s.data.data.pericias,a);let l=this.i18n("tokenactionhud.inventory"),c=this.i18n("tokenactionhud.spells"),d=this.i18n("tokenactionhud.features");this.i18n("tokenactionhud.skills"),this._combineCategoryWithList(i,l,n),this._combineCategoryWithList(i,c,r),this._combineCategoryWithList(i,d,o);let h=this.i18n("tokenactionhud.abilities");return this._getAbilityList(a,s.data.data.atributos,"atributos",h,"atributo"),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character"];canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const i=t.tokenId;this._addMultiSkills(t,i);let a=this.i18n("tokenactionhud.abilities");this._addMultiAbilities(t,i,"atributos",a,"atributo")}_getItemList(t,e){let i,a=this._filterLongerActions(t.data.items.filter((t=>t.data.qtd>0))),s=this._sortByItemSort(a),n="item";i=s.filter((t=>"consumivel"!==t.type));let o=this._getActiveEquipment(i),r=o.filter((t=>"arma"==t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),l=this.initializeEmptySubcategory();l.actions=r;let c=o.filter((t=>"equip"==t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),d=this.initializeEmptySubcategory();d.actions=c;let h=o.filter((t=>"arma"!=t.type&&"equip"!=t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),u=this.initializeEmptySubcategory();u.actions=h;let g=this._getActiveEquipment(s.filter((t=>"consumivel"==t.type))),m=this._filterExpendedItems(g).map((i=>this._buildEquipmentItem(e,t,n,i))),y=this.initializeEmptySubcategory();y.actions=m;let p=a.filter((t=>"tool"===t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),b=this.initializeEmptySubcategory();b.actions=p;let f=this.i18n("tokenactionhud.weapons"),k=this.i18n("tokenactionhud.equipment"),_=this.i18n("tokenactionhud.other"),C=this.i18n("tokenactionhud.consumables"),S=this.i18n("tokenactionhud.tools"),v=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(v,f,l),this._combineSubcategoryWithCategory(v,k,d),this._combineSubcategoryWithCategory(v,_,u),this._combineSubcategoryWithCategory(v,C,y),this._combineSubcategoryWithCategory(v,S,b),v}_getActiveEquipment(t){const e=Object.keys(game.tormenta20.config.listaAtivacao).filter((t=>"none"!==t)),i=["poder","magia","consumivel"];return t.filter((t=>{if(!i.includes(t.type))return!0;return!!t.data.ativacao&&e.includes(t.data.ativacao.execucao)}))}_getSpellsList(t,e){let i=this._filterLongerActions(t.data.items.filter((t=>"magia"===t.type)));i=this._filterExpendedItems(i);let a=this._sortSpellsByLevel(i);return this._categoriseSpells(t,e,a)}_sortSpellsByLevel(t){let e=Object.values(t);return e.sort(((t,e)=>t.data.circulo===e.data.circulo?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):t.data.circulo-e.data.circulo)),e}_categoriseSpells(t,e,i){const a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory();i.reduce(function(i,a){let n=a.data.preparada;var o,r=a.data.circulo;n||(o=`${this.i18n("tokenactionhud.level")} ${r}`);let l=this._buildItem(e,t,"magia",a),c=s.subcategories.find((t=>t.name===o));return c||(c=this.initializeEmptySubcategory()),c.actions.push(l),s.subcategories.indexOf(c)<0&&this._combineSubcategoryWithCategory(s,o,c),i}.bind(this),{});let n=this.initializeEmptyCategory("magias"),o=this.i18n("tokenactionhud.powers"),r=this.i18n("tokenactionhud.books");return this._combineSubcategoryWithCategory(n,o,a),this._combineSubcategoryWithCategory(n,r,s),n}_addSpellInfo(t,e){let i=t.data.duracao;e.info1="",e.info2="",e.info3="","sust"===i?.unidade&&(e.info1+="S")}_getFeatsList(t,e){let i=this._filterLongerActions(t.data.items.filter((t=>"poder"==t.type))),a=this._sortByItemSort(i);return this._categoriseFeats(e,t,a)}_categoriseFeats(t,e,i){let a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory();this.initializeEmptySubcategory(),this.initializeEmptySubcategory(),i.reduce(function(i,n){const o=n.data.ativacao.execucao;let r=this._buildEquipmentItem(t,e,"poder",n);o&&""!==o&&"Livre"!==o?a.actions.push(r):s.actions.push(r)}.bind(this),{});let n=this.initializeEmptyCategory("poderes"),o=this.i18n("tokenactionhud.active");this._combineSubcategoryWithCategory(n,o,a);let r=this.i18n("tokenactionhud.passive");return this._combineSubcategoryWithCategory(n,r,s),n}_getSkillsList(t,e){let i=this.initializeEmptyCategory("pericia"),a="pericia",s=Object.entries(t).map((i=>{try{let s=i[0],n=game.tormenta20.config.pericias[s];n=n.charAt(0).toUpperCase()+n.slice(1);let o=[a,e,i[0]].join(this.delimiter),r=this._getProficiencyIcon(t[s].treinado);return{name:n,id:i[0],encodedValue:o,icon:r}}catch(t){return Logger.error(i),null}})).filter((t=>!!t)),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.skills");return this._combineSubcategoryWithCategory(i,o,n),i}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("pericia"),a="pericia",s=Object.entries(game.tormenta20.config.pericias).map((t=>{let i=t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,o,n),this._combineCategoryWithList(t,o,i,!0)}_getAbilityList(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=Object.entries(game.tormenta20.config.atributos).map((i=>{if(0===e[i[0]].value)return;let a=i[1];a=a.charAt(0).toUpperCase()+a.slice(1);let n=[s,t,i[0]].join(this.delimiter);return{name:a,id:i[0],encodedValue:n,icon:""}})),r=this.initializeEmptySubcategory();return r.actions=o.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,r),n}_addMultiAbilities(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=Object.entries(game.tormenta20.config.atributos).map((t=>{let i=t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(n,a,r),this._combineCategoryWithList(t,a,n,!0)}_getEffectsList(t,e){let i=this.initializeEmptyCategory("effects");return this._addEffectsSubcategories(t,e,i),i}_getConditionsList(t,e){let i=this.initializeEmptyCategory("conditions");return this._addConditionsSubcategory(t,e,i),i}_addEffectsSubcategories(t,e,i){const a="effect",s=t.effects.entries;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();s.forEach((t=>{const i=t.data.label,s=[a,e,t.id].join(this.delimiter),r=t.data.disabled?"":"active",l=t.data.icon;let c={name:i,id:t.id,encodedValue:s,img:l,cssClass:r};t.isTemporary?n.actions.push(c):o.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!s)return;let o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this.i18n(t.label),s=[a,e,t.id].join(this.delimiter),r=n.every((e=>e.effects.entries.some((e=>e.data.flags.core?.statusId===t.id))))?"active":"",l=t.icon,c={name:i,id:t.id,encodedValue:s,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenactionhud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id));if(!s)return;let n=this.initializeEmptySubcategory();s.forEach((i=>{const s=this.i18n(i.label),o=[a,e,i.id].join(this.delimiter),r=t.effects.entries.some((t=>t.data.flags.core?.statusId===i.id))?"active":"",l=i.icon,c={name:s,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.conditions"),n)}_addIntiativeSubcategory(t,e,i){const a=game.combat;let s,n;a&&(s=a.combatants.find((t=>t.tokenId===i)),n=s?.initiative);let o=this.initializeEmptySubcategory(),r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};n&&(r.info1=n),r.cssClass=n?"active":"",o.actions.push(r),this._combineSubcategoryWithCategory(e,this.i18n("tokenactionhud.initiative"),o)}_addMultiIntiativeSubcategory(t,e,i){const a=game.combat;let s,n=this.initializeEmptySubcategory(),o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};if(a){s=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=s?"active":"",n.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.initiative"),n)}_buildEquipmentItem(t,e,i,a){let s=this._buildItem(t,e,i,a);return this._addItemInfo(e,a,s),s}_buildItem(t,e,i,a){let s=[i,t,a.id].join(this.delimiter),n=this._getImage(a),o=this._getActionIcon(a.data?.ativacao?.execucao);return{name:a.name,id:a.id,encodedValue:s,img:n,icon:o}}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e),i.info2="",i.info3=""}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="",i=t.data.qtd;return i>1&&(e=i),e}_filterLongerActions(t){return t}_filterNonpreparedSpells(t){return t.filter((t=>t.data.preparada))}_filterExpendedItems(t){return t.filter((t=>{let e=t.data.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",1:'<i class="fas fa-check"></i>'}[t]}_getActionIcon(t){return{movimento:'<i class="fas fa-plus"></i>',reacao:'<i class="fas fa-bolt"></i>',livre:'<i class="far fa-circle"></i>',completa:'<i class="fas fa-star"></i>',duasRodadas:'<i class="fas fa-hourglass-start"></i>',verTexto:'<i class="fas fa-book"></i>'}[t]}}class RollHandlerBaseT20 extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];if("multi"===s)for(let e of canvas.tokens.controlled){let i=e.data._id;await this._handleMacros(t,a,i,n)}else await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"atributo":this.rollAbilityMacro(t,i,a);break;case"pericia":this.rollSkillMacro(t,i,a);break;case"item":case"magia":case"poder":this.isRenderItem()?this.doRenderItem(i,a):this.rollItemMacro(t,i,a)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAtributo(i)}rollSkillMacro(t,e,i){const a=super.getActor(e),s={actor:a,type:"percia",data:a.data.data.pericias[i],name:a.data.data.pericias[i].label,id:i};a.rollPericia(s)}rollItemMacro(t,e,i){let a=super.getActor(e);return super.getItem(a,i).roll({event:t})}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const a=super.getActor(e).effects.entries.find((t=>t.id===i));if(!a)return;const s=a.data.flags.core?.statusId;s?await this.toggleCondition(t,e,s):(await a.update({disabled:!a.data.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i){const a=super.getToken(e),s=this.isRightClick(t);if(i.includes("combat-utility-belt.")&&game.cub&&!s){const t=this.findCondition(i)?.label;if(!t)return;game.cub.hasCondition(t,a)?await game.cub.removeCondition(t,a):await game.cub.addCondition(t,a)}else{const t=this.findCondition(i);if(!t)return;s?await a.toggleOverlay(t):await a.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}}class Tormenta20SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerT20(t,e)}getAvailableRollHandlers(){return{core:"Tormenta20"}}doGetRollHandler(t){let e;switch(t){case"core":default:e=new RollHandlerBaseT20}return e}doRegisterSettings(t,e){}}class ActionHandlerSymbaroum extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id,s.data.type;let n=this._getMysticalPowers(s,a),o=this._getTraits(s,a),r=this._getWeapons(s,a),l=this._getArmors(s,a),c=this._getAbilities(s,a),d=this._getAttributes(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.symbaroum.mysticalPowers"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.traits"),o),game.settings.get("symbaroum","combatAutomation")||this._combineCategoryWithList(i,this.i18n("tokenactionhud.armour"),l),this._combineCategoryWithList(i,this.i18n("tokenactionhud.weapons"),r),this._combineCategoryWithList(i,this.i18n("tokenactionhud.symbaroum.abilities"),c),this._combineCategoryWithList(i,this.i18n("tokenactionhud.attributes"),d),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getMysticalPowers(t,e){let i=t.items.filter((t=>"mysticalPower"===t.data?.type&&t.data.data?.script)),a=this.initializeEmptyCategory("actorPowers"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,i,"mysticalPower"),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.roll"),s),a}_getTraits(t,e){let i=t.items.filter((t=>"trait"===t.data?.type&&t.data.data?.script)),a=this.initializeEmptyCategory("actorsTraits"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,i,"trait"),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.roll"),s),a}_getWeapons(t,e){let i=t.items.filter((t=>"weapon"===t.data?.type&&"active"===t.data.data?.state)),a=this.initializeEmptyCategory("actorWeapons"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,i,"weapon"),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.roll"),s),a}_getArmors(t,e){let i=this.initializeEmptyCategory("actorArmors"),a=this.initializeEmptySubcategory(),s=["armor",e,t.data.data.combat.id].join(this.delimiter),n={name:t.data.data.combat.armor,encodedValue:s,id:t.data.data.combat.id};return a.actions=[n],this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.roll"),a),i}_getAbilities(t,e){let i=t.items.filter((t=>"ability"===t.data?.type&&t.data.data?.script)),a=this.initializeEmptyCategory("actorAbilities"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,i,"ability"),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.roll"),s),a}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),a=Object.entries(t.data.data.attributes),s=this.initializeEmptySubcategory();return s.actions=a.map((t=>{let i=["attribute",e,t[0]].join(this.delimiter);return{name:game.i18n.localize(t[1].label),encodedValue:i,id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),s),i}_produceMap(t,e,i){return e.map((e=>{let a=[i,t,e.id].join(this.delimiter),s=this._getImage(e);return{name:e.name,encodedValue:a,id:e.id,img:s}}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("systems/symbaroum/asset/image/trait.png")?"":e}}class RollHandlerBaseSymbaroum extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"weapon":this._handleWeapon(a,t,o,n);break;case"armor":this._handleArmor(a,t,o,n);break;case"ability":this._handleAbility(a,t,o,n);break;case"mysticalPower":this._handleMysticalPowers(a,t,o,n);break;case"trait":this._handleTraits(a,t,o,n);break;case"attribute":this._handleAttributes(a,t,o,n)}}_handleWeapon(t,e,i,a){let s=i.data.data.weapons.filter((t=>t.id===a));i.rollWeapon(s[0])}_handleArmor(t,e,i,a){i.rollArmor()}_handleAbility(t,e,i,a){let s=i.items.filter((t=>t.id===a));i.usePower(s[0])}_handleMysticalPowers(t,e,i,a){let s=i.items.filter((t=>t.id===a));i.usePower(s[0])}_handleTraits(t,e,i,a){let s=i.items.filter((t=>t.id===a));i.usePower(s[0])}_handleAttributes(t,e,i,a){i.rollAttribute(a)}}class SymbaroumSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return console.log("startup"),new ActionHandlerSymbaroum(t,e)}getAvailableRollHandlers(){return{core:"Core Symbaroum"}}doGetRollHandler(t){return new RollHandlerBaseSymbaroum}doRegisterSettings(t,e){}}class ActionHandlerAlienrpg extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i={},a={},s={},n={},o={},r={},l={},c={},d={},h={},u={},g=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(g),g;if(!t)return g;let m=t.data._id;g.tokenId=m;let y=t.actor;if(!y)return g;let p=y.data.type;if(!["character","synthetic","creature"].includes(p))return g;switch(g.actorId=y.id,"character"===p||"synthetic"===p?(i=this._getAttributes(y,m),a=this._getSkills(y,m),s=this._getWeaponsList(y,m),n=this._getItemsList(y,m),o=this._getTalentsList(y,m),r=this._getAgendaList(y,m),l=this._getConsumablesList(y,m),c=this._getPowerList(y,m),d=this._getConditionsList(y,m),h=this._getUtilityList(y,m)):(i=this._getCreatureAttributes(y,m),u=this._getAttackList(y,m),h=this._getUtilityList(y,m)),y.data.type){case"character":this._combineCategoryWithList(g,this.i18n("tokenactionhud.attributes"),i),this._combineCategoryWithList(g,this.i18n("tokenactionhud.skills"),a),this._combineCategoryWithList(g,this.i18n("tokenactionhud.weapons"),s),this._combineCategoryWithList(g,this.i18n("tokenactionhud.inventory"),n),this._combineCategoryWithList(g,this.i18n("tokenactionhud.talents"),o),this._combineCategoryWithList(g,this.i18n("tokenactionhud.settings.alienrpg.agenda"),r),this._combineCategoryWithList(g,this.i18n("tokenactionhud.settings.alienrpg.consumables"),l),this._combineCategoryWithList(g,this.i18n("tokenactionhud.settings.alienrpg.power"),c),this._combineCategoryWithList(g,this.i18n("tokenactionhud.settings.alienrpg.conditions"),d),this._combineCategoryWithList(g,this.i18n("tokenactionhud.utility"),h),this._setFilterSuggestions(y),get("showHudTitle")&&(g.hudTitle=t.data?.name);break;case"synthetic":this._combineCategoryWithList(g,this.i18n("tokenactionhud.attributes"),i),this._combineCategoryWithList(g,this.i18n("tokenactionhud.skills"),a),this._combineCategoryWithList(g,this.i18n("tokenactionhud.weapons"),s),this._combineCategoryWithList(g,this.i18n("tokenactionhud.inventory"),n),this._combineCategoryWithList(g,this.i18n("tokenactionhud.talents"),o),this._combineCategoryWithList(g,this.i18n("tokenactionhud.settings.alienrpg.agenda"),r),this._combineCategoryWithList(g,this.i18n("tokenactionhud.settings.alienrpg.power"),c),this._combineCategoryWithList(g,this.i18n("tokenactionhud.utility"),h),this._setFilterSuggestions(y),get("showHudTitle")&&(g.hudTitle=t.data?.name);break;case"creature":this._combineCategoryWithList(g,this.i18n("tokenactionhud.attributes"),i),this._combineCategoryWithList(g,this.i18n("tokenactionhud.attack"),u),this._combineCategoryWithList(g,this.i18n("tokenactionhud.utility"),h),this._setFilterSuggestions(y),get("showHudTitle")&&(g.hudTitle=t.data?.name)}return g}_getWeaponsList(t,e){let i="weapon",a=this.initializeEmptyCategory("items"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,t.items.filter((t=>t.type==i)),i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.weapons"),s),a}_getItemsList(t,e){let i=this.initializeEmptyCategory("items"),a=["item","armor"],s=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort),n=s.filter((t=>"armor"===t.type)),o=this._buildItemActions(e,"armor",n),r=this.initializeEmptySubcategory();r.actions=o;let l=s.filter((t=>"item"===t.type)),c=this._buildItemActions(e,"item",l),d=this.initializeEmptySubcategory();return d.actions=c,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.armour"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.equipment"),d),i}_getTalentsList(t,e){let i=this.initializeEmptyCategory("items"),a=["talent"],s=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort).filter((t=>"talent"===t.type)),n=this._buildItemActions(e,"item",s),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.talents"),o),i}_getAgendaList(t,e){let i=this.initializeEmptyCategory("items"),a=["agenda"],s=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort).filter((t=>"agenda"===t.type)),n=this._buildItemActions(e,"item",s),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.agenda"),o),i}_getConsumablesList(t,e){let i=this.initializeEmptyCategory("consumables"),a=this.initializeEmptySubcategory();this.initializeEmptySubcategory();let s="consumables",n=Object.entries(t.data.data.consumables);n.splice(1,1);let o=n.map((t=>{let i=this.i18n("tokenactionhud.settings.alienrpg.consumables"+t[0]),a=t[0],n=[s,e,a,i].join(this.delimiter);return{name:i,encodedValue:n,id:a}}));return a.actions=this._produceMap(e,o,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.consumables"),a),i}_getPowerList(t,e){let i=this.initializeEmptyCategory("power");this.initializeEmptySubcategory();let a=this.initializeEmptySubcategory(),s="power",n=["item"],o=(t.items??[]).filter((t=>n.includes(t.type))).sort(this._foundrySort).filter((t=>t.data.totalPower>0)).map((t=>{let i=t.data.name,a=t.data._id,n=[s,e,i,a].join(this.delimiter);return{name:i,encodedValue:n,id:a}}));return a.actions=this._produceMap(e,o,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.power"),a),i}_buildItemActions(t,e,i,a=!1){let s=this._produceMap(t,i,e,a);return s.forEach((t=>this._addItemInfo(i.find((e=>e.data._id===t.id)),t))),s}_addItemInfo(t,e){e.info1=this._getQuantityData(t)}_getQuantityData(t){let e="",i=t.data.data.quantity?.value;return i>1&&(e=i),e}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory(),s="attribute",n=Object.entries(t.data.data.attributes).map((t=>{let i=this.i18n("tokenactionhud.settings.alienrpg.attribute"+t[0]),a=t[0];return{name:i,encodedValue:[s,e,a].join(this.delimiter),id:a}}));return a.actions=this._produceMap(e,n,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a),i}_getCreatureAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n="creatureattribute",o=Object.entries(t.data.data.attributes).map((t=>{let i=this.i18n("tokenactionhud.settings.alienrpg.attribute"+t[0]),a=t[0];return{name:i,encodedValue:[n,e,a].join(this.delimiter),id:a}})),r=Object.entries(t.data.data.general);r.splice(2,3);let l=r.map((t=>{let i=this.i18n("tokenactionhud.settings.alienrpg.attribute"+t[0]),a=t[0];return{name:i,encodedValue:[n,e,a].join(this.delimiter),id:a}}));return a.actions=this._produceMap(e,o,n),s.actions=this._produceMap(e,l,n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a),this._combineSubcategoryWithCategory(i,"",s),i}_getSkills(t,e){let i=this.initializeEmptyCategory("skills"),a=this.initializeEmptySubcategory(),s="skill",n=Object.entries(t.data.data.skills).map((t=>{let i=this.i18n("tokenactionhud.settings.alienrpg.skill"+t[0]),a=t[0];return{name:i,encodedValue:[s,e,a].join(this.delimiter),id:a}}));return a.actions=this._produceMap(e,n,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.skills"),a),i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["monster","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));this._addMultiUtilities(t,t.tokenId,i)}_getAttackList(t,e){let i=this.initializeEmptyCategory("attack"),a=this.initializeEmptySubcategory();if("creature"===t.data.type){let t=this.initializeEmptySubcategory(),a=[],s=["creatureAttack",e,"creatureAttack",""].join(this.delimiter);a={id:"creatureAttack",name:this.i18n("tokenactionhud.settings.alienrpg.creatureAttack"),encodedValue:s},t.actions.push(a);let n=[],o=["acidSplash",e,"acidSplash",""].join(this.delimiter);n={id:"acidSplash",name:this.i18n("tokenactionhud.settings.alienrpg.attributeacidSplash"),encodedValue:o},t.actions.push(n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.attributeacidSplash"),t)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attack"),a),i}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=[],o=0;switch(t.data.type){case"character":o=t.data.data.header?.health,o&&n.push(this._getHeaderActions(e,"health",this.i18n("tokenactionhud.settings.alienrpg.health"),o.value,"10")),s.actions=n;let a=t.data.data.header?.stress;a&&n.push(this._getHeaderActions(e,"stress",this.i18n("tokenactionhud.settings.alienrpg.stresspoints"),a.value,"10")),s.actions=n;let r=[],l=["rollStress",e,"rollStress",""].join(this.delimiter);r={id:"rollStress",name:this.i18n("tokenactionhud.settings.alienrpg.rollStress"),encodedValue:l},s.actions.push(r);let c=[],d=["rollCrit",e,"rollCrit",""].join(this.delimiter);c={id:"rollCrit",name:this.i18n("tokenactionhud.settings.alienrpg.rollCrit"),encodedValue:d},s.actions.push(c),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.health"),s);break;case"creature":o=t.data.data.header?.health,o&&n.push(this._getHeaderActions(e,"health",this.i18n("tokenactionhud.settings.alienrpg.health"),o.value,"10")),s.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.health"),s);break;case"synthetic":o=t.data.data.header?.health,o&&n.push(this._getHeaderActions(e,"health",this.i18n("tokenactionhud.settings.alienrpg.health"),o.value,"10")),s.actions=n;let h=[],u=["rollCrit",e,"rollCrit",""].join(this.delimiter);if(h={id:"rollCrit",name:this.i18n("tokenactionhud.settings.alienrpg.rollCrit"),encodedValue:u},s.actions.push(h),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.health"),s),t.data.data.header.synthstress){let t=[],i=["rollStress",e,"rollStress",0].join(this.delimiter);t={id:"rollStress",name:this.i18n("tokenactionhud.settings.alienrpg.rollStress"),encodedValue:i},s.actions.push(t)}}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.utility"),a),i}_getConditionsList(t,e){let i=this.initializeEmptyCategory("conditions"),a=this.initializeEmptySubcategory(),s="conditions";if("character"===t.data.type){let a=this.initializeEmptySubcategory(),n=[];n={id:"toggleStarving",encodedValue:[s,e,"toggleStarving",""].join(this.delimiter),name:this.i18n("tokenactionhud.settings.alienrpg.starving")},n.cssClass=t.data.data.general.starving.value?"active":"",a.actions.push(n),n={id:"toggleDehydrated",encodedValue:[s,e,"toggleDehydrated",""].join(this.delimiter),name:this.i18n("tokenactionhud.settings.alienrpg.dehydrated")},n.cssClass=t.data.data.general.dehydrated.value?"active":"",a.actions.push(n),n={id:"toggleExhausted",encodedValue:[s,e,"toggleExhausted",""].join(this.delimiter),name:this.i18n("tokenactionhud.settings.alienrpg.exhausted")},n.cssClass=t.data.data.general.exhausted.value?"active":"",a.actions.push(n),n={id:"toggleFreezing",encodedValue:[s,e,"toggleFreezing",""].join(this.delimiter),name:this.i18n("tokenactionhud.settings.alienrpg.freezing")},n.cssClass=t.data.data.general.freezing.value?"active":"",a.actions.push(n),n={id:"togglePanic",encodedValue:[s,e,"togglePanic",""].join(this.delimiter),name:this.i18n("tokenactionhud.settings.alienrpg.panic")},n.cssClass=t.data.data.general.panic.value?"active":"",a.actions.push(n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.alienrpg.conditions"),a)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.utility"),a),i}_getHeaderActions(t,e,i,a,s){let n=i.slugify({replacement:"_",strict:!0}),o={name:i,encodedValue:[e,t,n,a].join(this.delimiter),id:n};return o.info1=`${a}/${s}`,o}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s=this.initializeEmptySubcategory();this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.utility"),s),this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.data._id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),a=e.filter((t=>!!t));return i.length>0&&(a=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),a}_produceMap(t,e,i){return e.map((e=>{let a=[i,t,e.id,e.name.toLowerCase()].join(this.delimiter),s=this._getImage(e),n={name:e.name,encodedValue:a,id:e.id,img:s};return"talent"===i&&(n.info2=this._getUsesData(e)),n}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getUsesData(t){let e="",i=t.data.data.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_foundrySort(t,e){return t?.data?.sort||e?.data?.sort?t.data.sort-e.data.sort:0}}class RollHandlerBaseAlienrpg extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");4!=i.length&&super.throwInvalidValueErr();let a,s=i[0],n=i[1],o=i[2],r=i[3],l=super.getActor(n);l&&(a=l.data.type);let c=o?l.items.get(o):null;if(["item","armor"].includes(s)&&this.isRenderItem())return this.doRenderItem(n,o);if("multi"===n)"utility"===s&&o.includes("toggle")?this.performMultiToggleUtilityMacro(o):canvas.tokens.controlled.forEach((e=>{let i=e.data._id;this._handleMacros(t,s,i,o,r)}));else{if(!["utility"].includes(s))switch(a){case"character":case"creature":case"synthetic":await this._handleUniqueActionsChar(s,t,n,l,o)}let e=[];switch(s){case"attribute":e={roll:l.data.data.attributes[o].value,label:l.data.data.attributes[o].label},"click"===t.type?l.rollAbility(l,e):l.rollAbilityMod(l,e);break;case"creatureattribute":switch(o){case"mobility":case"observation":e={roll:l.data.data.general[o].value,label:l.data.data.general[o].label};break;default:let t=r[0].toUpperCase()+r.substring(1);e={roll:l.data.data.attributes[o].value,label:[t]}}"click"===t.type?l.rollAbility(l,e):l.rollAbilityMod(l,e);break;case"skill":e={roll:l.data.data.skills[o].mod,label:l.data.data.skills[o].label},"click"===t.type?l.rollAbility(l,e):l.rollAbilityMod(l,e);break;case"weapon":"click"===t.type?l.nowRollItem(c):l.rollItemMod(c);break;case"item":this._rollItem(l,n,o,s);break;case"armor":e={roll:l.data.data.general.armor.value,spbutt:"armor"},l.rollAbility(l,e);break;case"consumables":const i="ALIENRPG."+(r[0].toUpperCase()+r.substring(1)),a=game.i18n.localize(i)+" "+game.i18n.localize("ALIENRPG.Supply");l.consumablesCheck(l,o,a);break;case"power":const d="ALIENRPG."+(s[0].toUpperCase()+s.substring(1)),h=game.i18n.localize(d)+" "+game.i18n.localize("ALIENRPG.Supply");l.consumablesCheck(l,s,h,o);break;case"conditions":this.performConditionMacro(t,n,o);break;case"utility":this.performUtilityMacro(t,n,o)}}}async _handleUniqueActionsChar(t,e,i,a,s){let n=0;switch(t){case"stress":await this._adjustAttribute(e,a,"stress","value",s);break;case"rollStress":n="character"===a.data.type?{panicroll:a.data.data.header.stress}:{panicroll:{value:0,label:"Stress"}},"click"===e.type?a.rollAbility(a,n):a.rollAbilityMod(a,n);break;case"health":await this._adjustAttribute(e,a,"health","value",s);break;case"creatureAttack":let t={atttype:a.data.data.rTables};a.creatureAttackRoll(a,t);break;case"acidSplash":let i={roll:a.data.data.general.acidSplash.value,label:a.data.data.general.acidSplash.label};a.creatureAcidRoll(a,i);break;case"rollCrit":a.rollCrit(a.data.type)}}async _adjustAttribute(t,e,i,a,s){let n=e.data.data.header[i][a];if(this.rightClick){if(n<=0)return;n--}else{if(n>="10")return;n++}let o={data:{header:{[i]:{[a]:n}}}};await e.update(o)}async togggleConditionState(t,e,i,a,s){let n=e.data.data.general[i][a];if(this.rightClick){if(n<=0)return;n--,"panic"===i&&e.checkAndEndPanic(e)}else{if(n>="1")return;n++,"panic"===i&&e.checkAndEndPanic(e)}let o={data:{general:{[i]:{[a]:n}}}};await e.update(o)}performUtilityMacro(t,e,i){super.getActor(e);let a=super.getToken(e);switch(i){case"toggleVisibility":a.toggleVisibility();break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD")}}async performMultiToggleUtilityMacro(t){if("toggleVisibility"===t){const t=canvas.tokens.controlled.every((t=>!t.data.hidden));canvas.tokens.controlled.forEach((e=>{(t||e.data.hidden)&&e.toggleVisibility()}))}if("toggleCombat"===t){const t=canvas.tokens.controlled.every((t=>t.data.inCombat));for(let e of canvas.tokens.controlled)t?await e.toggleCombat():e.data.inCombat||await e.toggleCombat();Hooks.callAll("forceUpdateTokenActionHUD")}}performConditionMacro(t,e,i){let a=super.getActor(e);switch(super.getToken(e),i){case"toggleStarving":this.togggleConditionState(t,a,"starving","value");break;case"toggleDehydrated":this.togggleConditionState(t,a,"dehydrated","value");break;case"toggleExhausted":this.togggleConditionState(t,a,"exhausted","value");break;case"toggleFreezing":this.togggleConditionState(t,a,"freezing","value");break;case"togglePanic":this.togggleConditionState(t,a,"panic","value")}}_rollItem(t,e,i,a){t.items.get(i);if(["item"].includes(a))return this.doRenderItem(e,i);console.warn("armor roll")}}class AlienrpgSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerAlienrpg(t,e)}getAvailableRollHandlers(){return{core:"Core AlienRPG"}}doGetRollHandler(t){return new RollHandlerBaseAlienrpg}doRegisterSettings(t,e){}}class ActionHandlerOD6S extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;i.tokenId=t.id;let a=t.actor;if(!a)return i;if("container"===a.type)return i;if(i.actorId=a.id,"vehicle"!==a.type&&"starship"!==a.type){let t=this._buildCombatActionsCategory(a,i.tokenId),e=this._buildVehicleCategory(a,i.tokenId),s=this._buildAttributesCategory(a,i.tokenId,"attributes"),n=this._buildSkillsCategory(a,i.tokenId,"skills");this._combineCategoryWithList(i,game.i18n.localize("OD6S.COMBAT"),t),this._combineCategoryWithList(i,game.i18n.localize("OD6S.VEHICLE"),e),this._combineCategoryWithList(i,game.i18n.localize("OD6S.ATTRIBUTES"),s),this._combineCategoryWithList(i,game.i18n.localize("OD6S.SKILLS"),n)}if(isNewerVersion(game.system.data.version,"0.2.4")&&("vehicle"===a.type||"starship"===a.type)&&a.data.data.crewmembers.length>0)for(let t of a.data.data.crewmembers){let e=await game.od6s.getActorFromUuid(t.uuid);if(e.testUserPermission(game.user,"OWNER")){let t=this._buildVehicleCategory(e,e.uuid,"crew");this._combineCategoryWithList(i,e.name,t)}}return i}_buildCombatActionsCategory(t,e){let i="action",a=this.initializeEmptyCategory("combatactions"),s=t.items;const n=["pr","er"];let o=[];for(let a of n){let s=game.i18n.localize(t.data.data[a].label),n=[i,e,a].join(this.delimiter);o.push({name:s,id:a,encodedValue:n})}let r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(a,game.i18n.localize("OD6S.RESISTANCE"),r);let l=s.filter((t=>"weapon"===t.data.type&&t.data.data.equipped.value)).sort(((t,e)=>t.name.localeCompare(e.name))),c=s.filter((t=>"weapon"===t.data.type&&"Melee"===t.data.data.subtype&&t.data.data.equipped.value)).sort(((t,e)=>t.name.localeCompare(e.name))).valueOf(),d=this._produceMap(e,l,i),h=this.initializeEmptySubcategory();h.actions=d,this._combineSubcategoryWithCategory(a,game.i18n.localize("OD6S.WEAPONS"),h);let u=[];for(let t in game.od6s.config.actions)if(game.od6s.config.actions[t].rollable){let a=game.i18n.localize(game.od6s.config.actions[t].name),s=[i,e,game.od6s.config.actions[t].type].join(this.delimiter);if(u.push({name:a,id:t,encodedValue:s}),a===game.i18n.localize("OD6S.ACTION_PARRY"))for(let t=0;t<c.length;t++){const i=game.i18n.localize("OD6S.ACTION_PARRY")+" ("+c[t].data.name+")",a=["parry",e,c[t].id].join(this.delimiter);u.push({name:i,encodedValue:a,id:c[t].id})}}let g=this.initializeEmptySubcategory();return g.actions=u,this._combineSubcategoryWithCategory(a,game.i18n.localize("OD6S.ACTIONS"),g),a}_buildVehicleCategory(t,e,i){let a;a="crew"===i?"crew":"action";let s=this.initializeEmptyCategory("vehicleactions");if(t.getFlag("od6s","crew")){if(isNewerVersion(game.system.data.version,"0.1.14")){let i,n=[];i="vehicle"===t.data.data.vehicle.type?game.i18n.localize(game.od6s.config.vehicleToughnessName):game.i18n.localize(game.od6s.config.starshipToughnessName);let o=[a,e,"vehicletoughness"].join(this.delimiter);if(n.push({name:i,id:"vehicletoughness",encodedValue:o}),t.data.data.vehicle.shields.value>0)for(let i in t.data.data.vehicle.shields.arcs){let s=game.i18n.localize(t.data.data.vehicle.shields.arcs[i].label)+" "+game.i18n.localize("OD6S.SHIELDS"),o=[a,e,"vehicleshields"+i].join(this.delimiter);n.push({name:s,id:"vehicletoughness",encodedValue:o})}let r=this.initializeEmptySubcategory();r.actions=n,this._combineSubcategoryWithCategory(s,game.i18n.localize("OD6S.RESISTANCE"),r)}let i=this.initializeEmptySubcategory();i.actions=this._produceMap(e,t.data.data.vehicle.vehicle_weapons.filter((t=>t.data.equipped.value)),a),this._combineSubcategoryWithCategory(s,game.i18n.localize("OD6S.VEHICLE_WEAPON"),i);let n=[];for(let i in game.od6s.config.vehicle_actions)if(game.od6s.config.vehicle_actions[i].rollable){let s="";if("sensors"===i){if(game.settings.get("od6s","sensors"))for(let o in t.data.data.vehicle.sensors.types){s=game.i18n.localize(game.od6s.config.vehicle_actions[i].name)+": "+game.i18n.localize(t.data.data.vehicle.sensors.types[o].label);let r=[a,e,game.od6s.config.vehicle_actions[i].type+o].join(this.delimiter);n.push({name:s,id:i,encodedValue:r})}}else{s=game.i18n.localize(game.od6s.config.vehicle_actions[i].name);let t=[a,e,game.od6s.config.vehicle_actions[i].type].join(this.delimiter);n.push({name:s,id:i,encodedValue:t})}}let o=this.initializeEmptySubcategory();o.actions=n,this._combineSubcategoryWithCategory(s,game.i18n.localize("OD6S.VEHICLE_ACTIONS"),o)}return s}_buildAttributesCategory(t,e,i){let a="attribute",s=this.initializeEmptyCategory("attributes"),n=t.data.data.attributes,o=Object.entries(n).map((t=>{if(0===t[1].score)return;let i=game.od6s.config.attributes[t[0]].name,s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),r=this.initializeEmptySubcategory();return r.actions=o.filter((t=>!!t)),this._combineSubcategoryWithCategory(s,i,r),s}_buildSkillsCategory(t,e,i){let a=this.initializeEmptyCategory(i),s=t.items.filter((t=>"skill"===t.data.type||"specialization"===t.data.type));s.sort(((t,e)=>t.name.localeCompare(e.name)));let n=this._produceMap(e,s,"skill"),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(a,i,o),a}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let a=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:a,id:e.id}}))}}class RollHandlerCoreOD6S extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a,s=i[0],n=i[1],o=i[2];switch("crew"!==s&&(a=super.getActor(n)),s){case"action":a.rollAction(o);break;case"item":this.rollItemMacro(t,a,o);break;case"parry":this.rollItemMacro(t,a,o,!0);break;case"attribute":a.rollAttribute(o);break;case"skill":this.rollItemMacro(t,a,o);case"crew":a=await game.od6s.getActorFromUuid(n),a.rollAction(o)}}rollItemMacro(t,e,i,a=!1){e.items.find((t=>t.data._id===i)).roll(a)}}class OD6SSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerOD6S(t,e)}getAvailableRollHandlers(){return{core:"Core OD6S"}}doGetRollHandler(t){return new RollHandlerCoreOD6S}doRegisterSettings(t,e){}}class ActionHandlerCthack extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;if("character"!=s.data.type)return i;i.actorId=s.id;let n=this._getSaves(s,a),o=this._getAttributes(s,a),r=this._getItemList(s,a),l=this._getAbilities(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.saves"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.attributes"),o),this._combineCategoryWithList(i,this.i18n("tokenactionhud.equipment"),r),this._combineCategoryWithList(i,this.i18n("tokenactionhud.features"),l),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getSaves(t,e){let i=this.initializeEmptyCategory("saves"),a=this.initializeEmptySubcategory(),s=Object.entries(t.data.data.saves);return a.actions=s.map((t=>{const i=t[0];return{name:game.cthack.config.saves[i],encodedValue:["save",e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.saves"),a),i}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory(),s=t.getAvailableAttributes();return a.actions=s.map((t=>{const i=t[0];let a;a="miscellaneous"===i&&""!==game.settings.get("cthack","MiscellaneousResource")?game.settings.get("cthack","MiscellaneousResource"):game.cthack.config.attributes[i];let s="resource";return"armedDamage"!==i&&"unarmedDamage"!==i||(s="damage"),{name:a,encodedValue:[s,e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a),i}_getItemList(t,e){let i=t.items.filter((t=>"weapon"===t.data?.type)).map((i=>this._buildEquipmentItem(e,t,"weapon",i))),a=this.initializeEmptySubcategory();a.actions=i;let s=t.items.filter((t=>"item"===t.data?.type)).map((i=>this._buildEquipmentItem(e,t,"item",i))),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("tokenactionhud.weapons"),r=this.i18n("tokenactionhud.equipment"),l=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(l,o,a),this._combineSubcategoryWithCategory(l,r,n),l}_getAbilities(t,e){let i=t.items.filter((t=>"ability"===t.data?.type)).map((i=>this._buildEquipmentItem(e,t,"ability",i))),a=this.initializeEmptySubcategory();a.actions=i;let s=this.i18n("tokenactionhud.features"),n=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(n,s,a),n}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let a=[i,t,e.data._id].join(this.delimiter);return{name:e.name,encodedValue:a,id:e.data._id}}))}_buildEquipmentItem(t,e,i,a){return this._buildItem(t,e,i,a)}_buildItem(t,e,i,a){let s=[i,t,a.id].join(this.delimiter),n=this._getImage(a),o=this._getIcon(a);return{name:a.name,id:a.id,encodedValue:s,img:n,icon:o}}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getIcon(t){return"ability"===t.type&&"Permanent"!==t.data.data?.uses?.per?t.data.data.uses.value>0?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>':""}}class RollHandlerBaseCthack extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"save":this._handleSaves(a,t,o,n);break;case"resource":this._handleResources(a,t,o,n);break;case"damage":this._handleDamages(a,t,o,n);break;case"weapon":this.isRenderItem()?this.doRenderItem(s,n):this._handleWeapon(a,t,o,n);break;case"item":this.isRenderItem()?this.doRenderItem(s,n):this._handleItem(a,t,o,n);break;case"ability":this.isRenderItem()?this.doRenderItem(s,n):this._handleAbility(a,t,o,n)}}_handleSaves(t,e,i,a){i.rollSave(a)}_handleResources(t,e,i,a){i.rollResource(a)}_handleDamages(t,e,i,a){i.rollDamageRoll(a)}_handleWeapon(t,e,i,a){let s=i.items.get(a);if(this.isShift(e))i.rollMaterial(s);else{let t=0;if(game.user.targets.size>0){const e=[...game.user.targets][0];"opponent"==e.actor.type&&(t=e.actor.data.data.malus)}t<0?""===s.data.data.range?i.rollSave("str",{modifier:t}):i.rollSave("dex",{modifier:t}):""===s.data.data.range?i.rollSave("str"):i.rollSave("dex")}}_handleItem(t,e,i,a){let s=i.items.get(a);i.rollMaterial(s)}_handleAbility(t,e,i,a){let s=i.items.get(a);s.data.data.uses.value>0?i.useAbility(s):i.resetAbility(s)}}class CthackSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCthack(t,e)}getAvailableRollHandlers(){return{core:"Core Cthack"}}doGetRollHandler(t){return new RollHandlerBaseCthack}doRegisterSettings(t,e){}}class ActionHandlerKg extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id;let n=s.data.type;if("enemy"===n){let t=this._getEnemyTalents(s,a);this._combineCategoryWithList(i,this.i18n("tokenactionhud.attack"),t)}else if("character"===n){let t=this._getMainStat(s,a),e=this._getSubStat(s,a),n=this._getSpiritBurn(s,a),o=this._getTalents(s,a),r=this._getItems(s,a);this._combineCategoryWithList(i,this.i18n("tokenactionhud.kamigakari.mainStats"),t),this._combineCategoryWithList(i,this.i18n("tokenactionhud.kamigakari.subStats"),e),this._combineCategoryWithList(i,this.i18n("tokenactionhud.kamigakari.spiritBurn"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.talents"),o),this._combineCategoryWithList(i,this.i18n("tokenactionhud.kamigakari.items"),r)}return i}_getMainStat(t,e){let i=this.initializeEmptyCategory("mainStat"),a=Object.entries(t.data.data.attributes).filter((t=>void 0!==t[1]?.add&&void 0===t[1]?.base)).map((t=>({id:t[0],name:t[1].label}))),s=this._produceMap(e,a,"stat"),n=this.initializeEmptySubcategory();return n.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.mainStats"),n),i}_getSubStat(t,e){let i=this.initializeEmptyCategory("subStat"),a=Object.entries(t.data.data.attributes).filter((t=>void 0===t[1]?.add&&void 0!==t[1]?.label)).map((t=>({id:t[0],name:t[1].label}))),s=this._produceMap(e,a,"stat"),n=this.initializeEmptySubcategory();return n.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.subStats"),n),i}_getSpiritBurn(t,e){let i=this.initializeEmptyCategory("spiritBurn"),a=[{id:"transcend",name:this.i18n("tokenactionhud.kamigakari.transcend")},{id:"vitalIgnition",name:this.i18n("tokenactionhud.kamigakari.vitalIgnition")},{id:"conceptDestruction",name:this.i18n("tokenactionhud.kamigakari.conceptDestruction")}],s=this._produceMap(e,a,"burn"),n=this.initializeEmptySubcategory();return n.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.spiritBurn"),n),i}_getTalents(t,e){let i=this.initializeEmptyCategory("talent"),a=this._getTalentsByTiming(t,e,"Start"),s=this._getTalentsByTiming(t,e,"Prep"),n=this._getTalentsByTiming(t,e,"Attack"),o=this._getTalentsByTiming(t,e,"Defense"),r=this._getTalentsByTiming(t,e,"End"),l=this._getTalentsByTiming(t,e,"Constant"),c=this._getTalentsByTiming(t,e,"Free");return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.start"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.prep"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.attack"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.free"),c),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.defense"),o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.end"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.constant"),l),i}_getEnemyTalents(t,e){let i=this.initializeEmptyCategory("talent"),a=this._getTalentsByTiming(t,e,"Start"),s=this._getTalentsByTiming(t,e,"Prep"),n=this._getTalentsByManyTiming(t,e,["Attack","Melee","Physical","Ranged","Magical"]),o=this._getTalentsByTiming(t,e,"Defense"),r=this._getTalentsByTiming(t,e,"End"),l=this._getTalentsByTiming(t,e,"Constant"),c=this._getTalentsByTiming(t,e,"Free");return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.start"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.prep"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.attack"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.free"),c),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.defense"),o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.end"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.constant"),l),i}_getTalentsByManyTiming(t,e,i){let a=t.items.filter((t=>i.includes(t.data.data.timing))),s=this._produceMap(e,a,"item"),n=this.initializeEmptySubcategory();return n.actions=s,n}_getTalentsByTiming(t,e,i){let a=t.items.filter((t=>t.data.data.timing===i)),s=this._produceMap(e,a,"item"),n=this.initializeEmptySubcategory();return n.actions=s,n}_getItems(t,e){let i=this.initializeEmptyCategory("item"),a=this._getItemByType(t,e,"equipment"),s=this._getItemByType(t,e,"sacraments"),n=this._getItemByType(t,e,"consumables");return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.equipment"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.sacraments"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.kamigakari.consumables"),n),i}_getItemByType(t,e,i){let a=t.items.filter((t=>t.data.data.class===i||t.data.type==i)),s=this._produceMap(e,a,"item"),n=this.initializeEmptySubcategory();return n.actions=s,n}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let a=[i,t,e.id].join(this.delimiter),s={name:e.name,encodedValue:a,id:e.id};return"item"==i&&void 0!==e.data.data.quantity&&(s.name=e.name+" X "+e.data.data.quantity),s}))}}class RollHandlerBaseKg extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=t.ctrlKey,a=e.split("|");3!=a.length&&super.throwInvalidValueErr();let s=a[0],n=a[1],o=a[2],r=super.getActor(n),l=r.data.type;if("character"===l)switch(s){case"stat":r._rollDice(o,i);break;case"burn":"transcend"===o?r._transcend():"vitalIgnition"===o?r._vitalIgnition():"conceptDestruction"===o&&r._conceptDestruction();break;case"talent":case"item":r._echoItemDescription(o)}else if("enemy"===l)switch(s){case"item":r._echoItemDescription(o)}}}class KamigakariSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerKg(t,e)}getAvailableRollHandlers(){return{core:"Core Kamigakari"}}doGetRollHandler(t){return new RollHandlerBaseKg}doRegisterSettings(t,e){}}class TagmarActionHandler extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;if("Inventario"==s.data.type)return i;i.actorId=s.id;let n=this._buildCombateCategory(s,a);this._combineCategoryWithList(i,"Combate",n);let o=this._buildHabilidadesCategory(s,a);this._combineCategoryWithList(i,"Habilidades",o);let r=this._buildTestesCategory(s,a);return this._combineCategoryWithList(i,"Testes",r),i}_buildTestesCategory(t,e){let i=this.initializeEmptyCategory("testes");i.name="Testes";let a=this._produceMap(e,[{name:"Intelecto",id:"INT"},{name:"Aura",id:"AUR"},{name:"Carisma",id:"CAR"},{name:"Fora",id:"FOR"},{name:"Fsico",id:"FIS"},{name:"Agilidade",id:"AGI"},{name:"Percepo",id:"PER"}],"att"),s=this.initializeEmptySubcategory();s.actions=a,this._combineSubcategoryWithCategory(i,"Atributos",s);let n=this._produceMap(e,[{name:"R. Fsica",id:"Fsica"},{name:"R. Maga",id:"Maga"}],"resist"),o=this.initializeEmptySubcategory();if(o.actions=n,this._combineSubcategoryWithCategory(i,"Resistncia",o),"NPC"==t.data.type){let t=this._produceMap(e,[{name:"Moral",id:"Moral"}],"moral"),a=this.initializeEmptySubcategory();a.actions=t,this._combineSubcategoryWithCategory(i,"Moral",a)}return i}_buildHabilidadesCategory(t,e){let i=this.initializeEmptyCategory("habilidades");i.name="Habilidades";let a=t.items.filter((t=>"Habilidade"===t.data.type));a.sort((function(t,e){return t.name.localeCompare(e.name)}));let s=this._produceMap(e,a,"item"),n=this.initializeEmptySubcategory();return n.actions=s,this._combineSubcategoryWithCategory(i,"Habilidades",n),i}_buildCombateCategory(t,e){let i=this.initializeEmptyCategory("combate");i.name="Combate";let a="item",s=t.items,n=s.filter((t=>"Combate"===t.data.type));n.sort((function(t,e){return t.name.localeCompare(e.name)}));let o=this._produceMap(e,n,a),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(i,"Ataques",r);let l=s.filter((t=>"TecnicasCombate"===t.data.type));l.sort((function(t,e){return t.name.localeCompare(e.name)}));let c=this._produceMap(e,l,a),d=this.initializeEmptySubcategory();return d.actions=c,this._combineSubcategoryWithCategory(i,"Tcnicas de Combate",d),i}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let a=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:a,id:e.id}}))}}class TagmarHandler extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"item":this.rollItemMacro(t,o,n);break;case"att":this.rollAtt(t,o,n);break;case"resist":this._dialogResistencia(t,o,n);break;case"moral":this.rollMoral(t,o,n)}}rollMoral(t,e,i){e._rollTeste({name:"Moral"})}_dialogResistencia(t,e,i){let a,s=!1;new Dialog({title:"Informe a fora de ataque.",content:'\n        <div class="mediaeval">\n            <label for="forca-ataque">Fora de Ataque:</label>\n            <input type="number" name="forca-ataque" id="forca-ataque" value="1" style="width: 60px; text-align: center;"/>\n        </div>',buttons:{Rolar:{icon:'<i class="fas fa-dice-d20"></i>',label:"Rolar Teste",callback:t=>{a=t.find("#forca-ataque").val(),a&&(a=parseInt(a),s=!0)}},Cancelar:{icon:'<i class="fas fa-times"></i>',label:"Cancelar"}},default:"Cancelar",close:t=>{s&&e._rollTeste({name:"Resistencia",id:i,f_ataque:a})}}).render(!0)}rollAtt(t,e,i){e._rollTeste({name:"Atributo",id:i})}rollItemMacro(t,e,i){e.items.find((t=>t.id===i)).rollTagmarItem()}}class TagmarSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new TagmarActionHandler(t,e)}getAvailableRollHandlers(){return{core:"Tagmar RPG"}}doGetRollHandler(t){let e;switch(t){case"core":default:e=new TagmarHandler}return e}doRegisterSettings(t,e){}}class ActionHandlerDs4 extends ActionHandler{doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}_buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.data?.name);return this._buildSingleTokenCategories(t).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildSingleTokenCategories(t){const e=t.id,i=t.actor;return[this._buildChecksCategory(e,i),this._buildInventoryCategory(e,i),this._buildSpellsCategory(e,i)].filter((t=>!!t))}_buildChecksCategory(t,e){const i=this.initializeEmptyCategory("checks"),a=this.i18n("DS4.Checks");i.name=a;const s=this.initializeEmptySubcategory(),n=!!e&&get("displayCheckTargetNumbers");return s.actions=Object.entries(CONFIG.DS4.i18n.checks).map((([i,a])=>({id:i,name:n?`${a} (${e.data.data.checks[i]})`:a,encodedValue:["check",t,i].join(this.delimiter),img:CONFIG.DS4.icons.checks[i]}))),this._combineSubcategoryWithCategory(i,a,s),i}_buildInventoryCategory(t,e){const i=this.initializeEmptyCategory("inventory"),a=this.i18n("DS4.HeadingInventory");i.name=a;const s=e.items.filter((t=>t.data.data.equipped)).sort(((t,e)=>t.data.sort-e.data.sort)),n=this.initializeEmptySubcategory();return n.actions=s.filter((t=>"weapon"===t.type)).map((e=>this._buildItemAction(e,t))),this._combineSubcategoryWithCategory(i,this.i18n("DS4.ItemTypeWeaponPlural"),n),i}_buildSpellsCategory(t,e){const i=this.initializeEmptyCategory("spells");i.name=this.i18n("DS4.HeadingSpells");const a=e.items.filter((t=>t.data.data.equipped)).sort(((t,e)=>t.data.sort-e.data.sort)),s=this.initializeEmptySubcategory();return s.actions=a.filter((t=>"spell"===t.type)).map((e=>this._buildItemAction(e,t))),this._combineSubcategoryWithCategory(i,this.i18n("DS4.ItemTypeSpellPlural"),s),i}_buildItemAction(t,e){return{id:t.id,name:t.name,encodedValue:[t.type,e,t.id].join(this.delimiter),img:t.img}}_buildMultipleTokenList(){const t=this.initializeEmptyActionList();return this._buildMultipleTokenCategories().forEach((e=>{this._combineCategoryWithList(t,e.name,e)})),t}_buildMultipleTokenCategories(){return[this._buildChecksCategory("multi")].filter((t=>!!t))}}class RollHandlerBaseDs4 extends RollHandler{async doHandleActionEvent(t,e){const i=e.split("|");3!=i.length&&super.throwInvalidValueErr();const a=i[0],s=i[1],n=i[2];if("multi"===s)for(const e of canvas.tokens.controlled)await this._handleMacros(t,a,e.id,n);else await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"check":await this._rollCheckMacro(t,i,a);break;case"weapon":case"spell":this.isRenderItem()?this.doRenderItem(i,a):this._rollItemMacro(t,i,a)}}async _rollCheckMacro(t,e,i){const a=super.getToken(e),s=a?.actor;await s.rollCheck(i,a.document)}async _rollItemMacro(t,e,i){const a=super.getActor(e);return super.getItem(a,i).roll()}}class Ds4SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDs4(t,e)}getAvailableRollHandlers(){return{core:"Core DS4"}}doGetRollHandler(t){return new RollHandlerBaseDs4}doRegisterSettings(t,e){!function register$4(t,e){game.settings.register(t,"displayCheckTargetNumbers",{name:game.i18n.localize("tokenactionhud.settings.ds4.displayCheckTargetNumbers.name"),hint:game.i18n.localize("tokenactionhud.settings.ds4.displayCheckTargetNumbers.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerCo extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;let n=s.data.type;if("character"!=n&&"npc"!=n)return i;i.actorId=s.id;let o=this._getCharacteristics(s,a),r=this._getCombat(s,a),l=this._getItemsList(s,a),c=this._getCapacities(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.characteristics"),o),this._combineCategoryWithList(i,this.i18n("tokenactionhud.co.combat"),r),this._combineCategoryWithList(i,this.i18n("tokenactionhud.inventory"),l),this._combineCategoryWithList(i,this.i18n("tokenactionhud.co.capacities"),c),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getCharacteristics(t,e){let i=this.initializeEmptyCategory("characteristics"),a=this.initializeEmptySubcategory(),s=Object.entries(t.data.data.stats);a.actions=s.map((t=>{const i=t[0];return{name:"cof"===game.system.id?game.cof.config.stats[i]:game.coc.config.stats[i],encodedValue:["stat",e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.characteristics"),a);let n=this.initializeEmptySubcategory(),o=Object.entries(t.data.data.attacks);return n.actions=o.map((t=>{const i=t[0];return{name:"cof"===game.system.id?game.cof.config.skills[i]:game.coc.config.skills[i],encodedValue:["skill",e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.co.attacks"),n),i}_getCombat(t,e){let i=this.initializeEmptyCategory("combat"),a=this.initializeEmptySubcategory(),s=t.items.filter((t=>"item"===t.data.type&&("melee"===t.data.data.subtype||"ranged"===t.data.data.subtype)&&t.data.data.worn));a.actions=s.map((i=>this._buildEquipmentItem(e,t,"weapon",i))),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.weapons"),a);let n=this.initializeEmptySubcategory(),o=t.items.filter((t=>"item"===t.data.type&&"spell"===t.data.data.subtype&&(t.data.data.properties.weapon||t.data.data.properties.activable)));return n.actions=o.map((i=>this._buildEquipmentItem(e,t,"spell",i))),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.spells"),n),i}_getItemsList(t,e){let i=this.initializeEmptyCategory("inventory"),a=t.items.filter((t=>"item"===t.data.type&&("melee"===t.data.data.subtype||"ranged"===t.data.data.subtype))).map((i=>this._buildEquipmentItem(e,t,"item",i))),s=this.initializeEmptySubcategory();s.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.weapons"),s);let n=t.items.filter((t=>"item"===t.data?.type&&("armor"===t.data.data.subtype||"shield"===t.data.data.subtype))).map((i=>this._buildEquipmentItem(e,t,"item",i))),o=this.initializeEmptySubcategory();o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.co.protections"),o);let r=t.items.filter((t=>"item"===t.data?.type&&"spell"!==t.data.data.subtype&&t.data.data.properties.consumable&&t.data.data.qty>0)).map((i=>this._buildEquipmentItem(e,t,"item",i))),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.consumables"),l);let c=t.items.filter((t=>"item"===t.data?.type&&"spell"===t.data.data.subtype)).map((i=>this._buildEquipmentItem(e,t,"item",i))),d=this.initializeEmptySubcategory();d.actions=c,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.spells"),d);let h=t.items.filter((t=>"item"===t.data?.type&&"armor"!==t.data.data.subtype&&"shield"!==t.data.data.subtype&&"melee"!==t.data.data.subtype&&"ranged"!==t.data.data.subtype&&"spell"!==t.data.data.subtype&&!t.data.data.properties.consumable)).map((i=>this._buildEquipmentItem(e,t,"item",i))),u=this.initializeEmptySubcategory();return u.actions=h,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.equipment"),u),i}_getCapacities(t,e){let i=this.initializeEmptyCategory("capacities"),a=t.items.filter((t=>"capacity"===t.data?.type)).map((i=>this._buildEquipmentItem(e,t,"capacity",i))),s=this.initializeEmptySubcategory();return s.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.co.capacities"),s),i}_buildEquipmentItem(t,e,i,a){let s=this._buildItem(t,e,i,a);return this._addItemInfo(e,a,s),s}_buildItem(t,e,i,a){let s=[i,t,a.id].join(this.delimiter),n=this._getImage(a),o=this._getIcon(a);return{name:a.name,id:a.id,encodedValue:s,img:n,icon:o}}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getIcon(t){return"item"===t.type&&t.data.data.worn?'<i class="fas fa-shield-alt"></i>':"capacity"===t.type&&t.data.data.activable?t.data.data.buff?t.data.data.properties.buff.activated?'<i class="fas fa-times"></i>':'<i class="fas fa-check"></i>':t.data.data.limitedUsage?t.data.data.properties.limitedUsage.use>0?'<i class="fas fa-check"></i>':"":'<i class="fas fa-check"></i>':""}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e)}_getQuantityData(t){let e="";if("item"===t.type){const i=t.data.data.properties.consumable,a=t.data.data.qty;i?a>0&&(e=a):a>1&&(e=a)}return"capacity"===t.type&&t.data.data.activable&&t.data.data.limitedUsage&&(e+=t.data.data.properties.limitedUsage.use+"/"+t.data.data.properties.limitedUsage.maxUse),e}_buildCapacityItem(t,e,i,a){return this._buildItem(t,e,i,a)}}class RollHandlerBaseCo extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"stat":this._handleStats(a,t,o,n);break;case"skill":this._handleSkills(a,t,o,n);break;case"weapon":this._handleWeapon(a,t,o,n);break;case"spell":this._handleSpell(a,t,o,n);break;case"item":this.isRenderItem()?this.doRenderItem(s,n):this._handleItem(a,t,o,n);break;case"capacity":this.isRenderItem()?this.doRenderItem(s,n):this._handleCapacity(a,t,o,n)}}_handleStats(t,e,i,a){this.isRightClick(e)?i.rollStat(a,{dialog:!1}):i.rollStat(a)}_handleSkills(t,e,i,a){this.isRightClick(e)?i.rollStat(a,{dialog:!1}):i.rollStat(a)}_handleWeapon(t,e,i,a){let s=i.items.get(a);this.isShift(e)?i.rollWeapon(s,{dmgOnly:!0}):i.rollWeapon(s)}_handleSpell(t,e,i,a){let s=i.items.get(a);s.data.data.properties.consumable?i.consumeItem(s):this.isShift(e)?i.rollWeapon(s,{dmgOnly:!0}):i.rollWeapon(s)}_handleItem(t,e,i,a){let s=i.items.get(a);s.data.data.properties.equipable&&i.toggleEquipItem(s,this.isShift(e)),s.data.data.properties.consumable&&i.consumeItem(s)}_handleCapacity(t,e,i,a){let s=i.items.get(a);i.activateCapacity(s)}}class CoSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCo(t,e)}getAvailableRollHandlers(){return{core:"Core CO"}}doGetRollHandler(t){return new RollHandlerBaseCo}doRegisterSettings(t,e){}}class ActionHandlerForbiddenlands extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i={},a={},s={},n={},o={},r={},l={},c={},d=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(d),d;if(!t)return d;let h=t.id;d.tokenId=h;let u=t.actor;if(!u)return d;let g=u.data.type;if(!["character","monster"].includes(g))return d;switch(d.actorId=u.id,"character"===g?(i=this._getAttributes(u,h),a=this._getSkills(u,h),s=this._getWeaponsList(u,h),n=this._getItemsList(u,h),o=this._getTalentsList(u,h),r=this._getConsumablesList(u,h),l=this._getConditionsList(u,h)):"monster"==g&&(i=this._getAttributes(u,h),o=this._getMonsterTalentsList(u,h),c=this._getAttackList(u,h)),u.data.type){case"character":this._combineCategoryWithList(d,this.i18n("tokenactionhud.attributes"),i),this._combineCategoryWithList(d,this.i18n("tokenactionhud.skills"),a),this._combineCategoryWithList(d,this.i18n("tokenactionhud.weapons"),s),this._combineCategoryWithList(d,this.i18n("tokenactionhud.inventory"),n),this._combineCategoryWithList(d,this.i18n("tokenactionhud.talents"),o),this._combineCategoryWithList(d,this.i18n("tokenactionhud.settings.forbiddenlands.consumables"),r),this._combineCategoryWithList(d,this.i18n("tokenactionhud.settings.forbiddenlands.conditions"),l),this._setFilterSuggestions(u),get("showHudTitle")&&(d.hudTitle=t.data?.name);break;case"monster":this._combineCategoryWithList(d,this.i18n("tokenactionhud.attributes"),i),this._combineCategoryWithList(d,this.i18n("tokenactionhud.talents"),o),this._combineCategoryWithList(d,this.i18n("tokenactionhud.attack"),c),this._setFilterSuggestions(u),get("showHudTitle")&&(d.hudTitle=t.data?.name)}return d}_getWeaponsList(t,e){let i="weapon",a=this.initializeEmptyCategory("items"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,t.items.filter((t=>t.type==i)),i),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.weapons"),s),a}_getItemsList(t,e){let i=this.initializeEmptyCategory("items"),a=["item","armor"],s=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort),n=s.filter((t=>"armor"===t.type)),o=this._buildItemActions(e,"armor",n),r=this.initializeEmptySubcategory();r.actions=o;let l=s.filter((t=>"item"===t.type)),c=this._buildItemActions(e,"item",l),d=this.initializeEmptySubcategory();return d.actions=c,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.armour"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.equipment"),d),i}_getTalentsList(t,e){let i=this.initializeEmptyCategory("items"),a=["talent"],s=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort).filter((t=>"talent"===t.type)),n=this._buildItemActions(e,"item",s),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.talents"),o),i}_getConsumablesList(t,e){let i=this.initializeEmptyCategory("consumables"),a=this.initializeEmptySubcategory();this.initializeEmptySubcategory();let s="consumables",n=Object.entries(t.data.data.consumable);n.splice(1,1);let o=n.map((t=>{let i=this.i18n("tokenactionhud.settings.forbiddenlands.consumables"+t[0]),a=t[0],n=[s,e,a,i].join(this.delimiter);return{name:i,encodedValue:n,id:a}}));return a.actions=this._produceMap(e,o,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.forbiddenlands.consumables"),a),i}_buildItemActions(t,e,i,a=!1){let s=this._produceMap(t,i,e,a);return s.forEach((t=>this._addItemInfo(i.find((e=>e.id===t.id)),t))),s}_addItemInfo(t,e){e.info1=this._getQuantityData(t)}_getQuantityData(t){let e="",i=t.data.data.quantity?.value;return i>1&&(e=i),e}_getSkills(t,e){let i=this.initializeEmptyCategory("skills"),a=this.initializeEmptySubcategory(),s="skill",n=Object.entries(t.data.data.skill).map((t=>{let i=this.i18n("tokenactionhud.settings.forbiddenlands.skill"+t[0]),a=t[0];return{name:i,encodedValue:[s,e,a].join(this.delimiter),id:a}}));return a.actions=this._produceMap(e,n,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.skills"),a),i}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory(),s="attribute",n=Object.entries(t.data.data.attribute).map((t=>{let i=this.i18n("tokenactionhud.settings.forbiddenlands.attribute"+t[0]),a=t[0];return{name:i,encodedValue:[s,e,a].join(this.delimiter),id:a}}));return a.actions=this._produceMap(e,n,s),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attributes"),a),i}_getMonsterTalentsList(t,e){let i=this.initializeEmptyCategory("items"),a=["monsterTalent"],s=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort).filter((t=>"monsterTalent"===t.type)),n=this._buildItemActions(e,"item",s),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.talents"),o),i}_getAttackList(t,e){let i=this.initializeEmptyCategory("attack"),a=this.initializeEmptySubcategory(),s=["monsterAttack"],n=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort).filter((t=>"monsterAttack"===t.type)),o=this._buildItemActions(e,"monsterAttack",n);return a.actions=o,this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attack"),a),i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["monster","character"];canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)))}_getConditionsList(t,e){let i=this.initializeEmptyCategory("conditions"),a=this.initializeEmptySubcategory(),s="conditions";if("character"===t.data.type){let a=this.initializeEmptySubcategory(),n=[];n={id:"toggleHungry",encodedValue:[s,e,"toggleHungry",""].join(this.delimiter),name:this.i18n("CONDITION.HUNGRY")},n.cssClass=t.data.data.condition.hungry.value?"active":"",a.actions.push(n),n={id:"toggleThirsty",encodedValue:[s,e,"toggleThirsty",""].join(this.delimiter),name:this.i18n("CONDITION.THIRSTY")},n.cssClass=t.data.data.condition.thirsty.value?"active":"",a.actions.push(n),n={id:"toggleCold",encodedValue:[s,e,"toggleCold",""].join(this.delimiter),name:this.i18n("CONDITION.COLD")},n.cssClass=t.data.data.condition.cold.value?"active":"",a.actions.push(n),n={id:"toggleSleepy",encodedValue:[s,e,"toggleSleepy",""].join(this.delimiter),name:this.i18n("CONDITION.SLEEPY")},n.cssClass=t.data.data.condition.sleepy.value?"active":"",a.actions.push(n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.settings.forbiddenlands.conditions"),a)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.utility"),a),i}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),a=e.filter((t=>!!t));return i.length>0&&(a=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),a}_produceMap(t,e,i){return e.map((e=>{let a=[i,t,e.id,e.name.toLowerCase()].join(this.delimiter),s=this._getImage(e);return{name:e.name,encodedValue:a,id:e.id,img:s}}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_foundrySort(t,e){return t?.data?.sort||e?.data?.sort?t.data.sort-e.data.sort:0}}class RollHandlerBaseForbiddenlands extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");4!=i.length&&super.throwInvalidValueErr();let a,s=i[0],n=i[1],o=i[2],r=i[3],l=super.getActor(n);l&&(a=l.data.type),o&&l.items.get(o);if(["item","armor"].includes(s)&&this.isRenderItem())return this.doRenderItem(n,o);if("multi"===n)"utility"===s&&o.includes("toggle")?this.performMultiToggleUtilityMacro(o):canvas.tokens.controlled.forEach((e=>{let i=e.id;this._handleMacros(t,s,i,o,r)}));else{if(!["utility"].includes(s))switch(a){case"character":case"monster":await this._handleUniqueActionsChar(s,t,n,l,o)}let e=[];switch(s){case"attribute":e={roll:l.data.data.attribute[o].value,label:l.data.data.attribute[o].label},"click"===t.type&&l.sheet.rollAttribute(game.i18n.localize(e.label).toLowerCase());break;case"skill":e={roll:l.data.data.skill[o].mod,label:l.data.data.skill[o].label},"click"===t.type&&l.sheet.rollSkill(game.i18n.localize(e.label).toLowerCase());break;case"weapon":"click"===t.type&&l.sheet.rollGear(o);break;case"item":l.items.get(o).sendToChat();break;case"armor":l.sheet.rollSpecificArmor(o);break;case"power":l.sheet.rollSpell(o);break;case"conditions":this.performConditionMacro(t,n,o);break;case"utility":this.performUtilityMacro(t,n,o)}}}async _handleUniqueActionsChar(t,e,i,a,s){let n=0;switch(t){case"stress":await this._adjustAttribute(e,a,"stress","value",s);break;case"rollStress":n="character"===a.data.type?{panicroll:a.data.data.header.stress}:{panicroll:{value:0,label:"Stress"}},"click"===e.type?a.rollAbility(a,n):a.rollAbilityMod(a,n);break;case"health":await this._adjustAttribute(e,a,"health","value",s);break;case"creatureAttack":let t={atttype:a.data.data.rTables};a.creatureAttackRoll(a,t);break;case"acidSplash":let i={roll:a.data.data.general.acidSplash.value,label:a.data.data.general.acidSplash.label};a.creatureAcidRoll(a,i);break;case"rollCrit":a.rollCrit(a.data.type)}}async _adjustAttribute(t,e,i,a,s){let n=e.data.data.header[i][a];if(this.rightClick){if(n<=0)return;n--}else{if(n>="10")return;n++}let o={data:{header:{[i]:{[a]:n}}}};await e.update(o)}async togggleConditionState(t,e,i,a,s){let n=e.data.data.general[i][a];if(this.rightClick){if(n<=0)return;n--,"panic"===i&&e.checkAndEndPanic(e)}else{if(n>="1")return;n++,"panic"===i&&e.checkAndEndPanic(e)}let o={data:{general:{[i]:{[a]:n}}}};await e.update(o)}performUtilityMacro(t,e,i){super.getActor(e);let a=super.getToken(e);switch(i){case"toggleVisibility":a.toggleVisibility();break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD")}}async performMultiToggleUtilityMacro(t){if("toggleVisibility"===t){const t=canvas.tokens.controlled.every((t=>!t.data.hidden));canvas.tokens.controlled.forEach((e=>{(t||e.data.hidden)&&e.toggleVisibility()}))}if("toggleCombat"===t){const t=canvas.tokens.controlled.every((t=>t.data.inCombat));for(let e of canvas.tokens.controlled)t?await e.toggleCombat():e.data.inCombat||await e.toggleCombat();Hooks.callAll("forceUpdateTokenActionHUD")}}performConditionMacro(t,e,i){let a=super.getActor(e);switch(super.getToken(e),i){case"toggleStarving":this.togggleConditionState(t,a,"starving","value");break;case"toggleDehydrated":this.togggleConditionState(t,a,"dehydrated","value");break;case"toggleExhausted":this.togggleConditionState(t,a,"exhausted","value");break;case"toggleFreezing":this.togggleConditionState(t,a,"freezing","value");break;case"togglePanic":this.togggleConditionState(t,a,"panic","value")}}_rollItem(t,e,i,a){t.items.get(i);if(["item"].includes(a))return this.doRenderItem(e,i);console.warn("armor roll")}}class ForbiddenLandsSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerForbiddenlands(t,e)}getAvailableRollHandlers(){return{core:"Core Forbidden Lands"}}doGetRollHandler(t){return new RollHandlerBaseForbiddenlands}doRegisterSettings(t,e){}}class ActionHandlerDnD4e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}buildUpgradeAnnouncement(){const t=this.initializeEmptyActionList(),e=this.initializeEmptyCategory("blank");return e.name="You must upgrade 4E System to at least 0.2.62",t.categories.push(e),t}async _buildSingleTokenList(t){if(!game.dnd4eBeta.tokenBarHooks)return this.buildUpgradeAnnouncement();const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.data?.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){return[this._buildAbilitiesCategory(t),this._buildSkillsCategory(t),this._buildPowersCategory(t),this._buildFeaturesCategory(t),this._buildItemssCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildAbilitiesCategory(t){const e=t.actor.data.data.abilities;return this._getAbilityList(t.id,e,"abilities",this.i18n("tokenactionhud.abilities"),"ability")}_buildMultipleTokenList(){if(!game.dnd4eBeta.tokenBarHooks)return this.buildUpgradeAnnouncement();const t=this.initializeEmptyActionList();t.tokenId="multi",t.actorId="multi";const e=["Player Character","NPC"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.data.type)));const a=t.tokenId;this._addMultiSkills(t,a);let s=this.i18n("tokenactionhud.abilities");return this._addMultiAbilities(t,a,"abilities",s,"ability"),get("showConditionsCategory")&&this._addMultiConditions(t,a),this._addMultiUtilities(t,a,i),t}_buildFeaturesCategory(t){const e=t.actor,i=t.id;let a=this.initializeEmptyCategory("Features");a.name=this.i18n("DND4EBETA.Features");const s={raceFeats:{label:"DND4EBETA.FeatRace",items:[],dataset:{type:"raceFeats"}},classFeats:{label:"DND4EBETA.FeatClass",items:[],dataset:{type:"classFeats"}},pathFeats:{label:"DND4EBETA.FeatPath",items:[],dataset:{type:"pathFeats"}},destinyFeats:{label:"DND4EBETA.FeatDestiny",items:[],dataset:{type:"destinyFeats"}},feat:{label:"DND4EBETA.FeatLevel",items:[],dataset:{type:"feat"}},ritual:{label:"DND4EBETA.FeatRitual",items:[],dataset:{type:"ritual"}}};return e.data.items.forEach((t=>{Object.keys(s).includes(t.data.type)&&s[t.data.type].items.push(t)})),Object.entries(s).map((t=>{const s=this._buildFeatureSubCategory(e,t[1].items,i);this._combineSubcategoryWithCategory(a,this.i18n(t[1].label),s)})),a}_buildFeatureSubCategory(t,e,i){const a="feature",s=this.initializeEmptySubcategory();return e.forEach((t=>{const e=[a,i,t.id].join(this.delimiter),n={name:t.data.name,id:t.id,encodedValue:e,img:this._getImage(t)};s.actions.push(n)})),s}_buildItemssCategory(t){const e=t.actor,i=t.id;let a=this.initializeEmptyCategory("Inventory");a.name=this.i18n("DND4EBETA.Inventory");const s={};get("equipmentCategoryList").split(",").forEach((t=>{t.trim()&&(s[t.trim()]=!0)}));const n={weapon:{label:"DND4EBETA.ItemTypeWeaponPl",items:[]},equipment:{label:"DND4EBETA.ItemTypeEquipmentPl",items:[]},consumable:{label:"DND4EBETA.ItemTypeConsumablePl",items:[],subcategories:{},subcategoryField:"consumableType"},tool:{label:"DND4EBETA.ItemTypeToolPl",items:[]},backpack:{label:"DND4EBETA.ItemTypeContainerPl",items:[]},loot:{label:"DND4EBETA.ItemTypeLootPl",items:[]}};Object.entries(game.dnd4eBeta.config.consumableTypes).forEach((t=>{const e={label:t[1],items:[]};n.consumable.subcategories[t[0]]=e})),e.data.items.forEach((t=>{if(Object.keys(n).includes(t.data.type)){const e=n[t.data.type];if(e.subcategories&&e.subcategoryField&&t.data.data[e.subcategoryField]){const i=t.data.data[e.subcategoryField];if(e.subcategories[i])return void e.subcategories[i].items.push(t)}e.items.push(t)}}));const o=0===Object.keys(s).length;return Object.entries(n).map((t=>{if(o||s[t[0]]){const n=this._buildItemSubCategory(e,t[1].items,i,t[1].subcategories,s);this._combineSubcategoryWithCategory(a,this.i18n(t[1].label),n)}})),a}_buildItemSubCategory(t,e,i,a,s){const n="inventory",o=this.initializeEmptySubcategory();if(e.forEach((t=>{const e=[n,i,t.id].join(this.delimiter),a={name:t.data.name,id:t.id,encodedValue:e,img:this._getImage(t)};get("hideUnequippedInventory")&&!t.data.data.equipped||get("hideQuantityZero")&&t.data.data.quantity<1||o.actions.push(a)})),a){const e=0===Object.keys(s).length;Object.entries(a).map((a=>{if(e||s[a[0]]){const e=this._buildItemSubCategory(t,a[1].items,i,a[1].subcategories,s);this._combineSubcategoryWithCategory(o,this.i18n(a[1].label),e)}}))}return o}_buildPowersCategory(t){const e=t.actor,i=t.id;let a=e.data.items.filter((t=>"power"===t.data.type)),s=this.initializeEmptyCategory("Powers");s.name=this.i18n("DND4EBETA.Powers");let n=this._getDocumentData(e).powerGroupTypes;n||(e.data.data.powerGroupTypes="usage",n="usage");const o=game.dnd4eBeta.tokenBarHooks.generatePowerGroups(e);let r="useType";switch(n){case"action":r="actionType";break;case"type":r="powerType"}return o.other||(o.other={label:"DND4EBETA.Other",items:[],dataset:{type:"other"}}),a.forEach((t=>{const e=this._getDocumentData(t)[r];o[e]?o[e].items.push(t):o.other.items.push(t)})),Object.entries(o).map((t=>{const a=this._buildPowerSubCategory(e,t[1].items,i);this._combineSubcategoryWithCategory(s,this.i18n(t[1].label),a)})),s}_buildPowerSubCategory(t,e,i){const a="power",s=this.initializeEmptySubcategory();let n=e;get("hideUsedPowers")?n=n.filter((e=>"recharge"===this._getDocumentData(e).useType||game.dnd4eBeta.tokenBarHooks.isPowerAvailable(t,e))):n.forEach((e=>{game.dnd4eBeta.tokenBarHooks.isPowerAvailable(t,e)}));const o=get("forcePowerColours");return n.forEach((t=>{const e=[a,i,t.id].join(this.delimiter),n={name:t.data.name,id:t.id,encodedValue:e,img:this._getImage(t)};o&&(n.cssClass=`force-ability-usage--${this._getDocumentData(t).useType}`),s.actions.push(n)})),s}_buildSkillsCategory(t){const e=t.actor;if("vehicle"===e.data.type)return;const i=e.data.data.skills;let a=this.initializeEmptyCategory("skills");a.name=this.i18n("tokenactionhud.skills");let s="skill",n=get("abbreviateSkills"),o=Object.entries(i).map((e=>{try{let a=e[0],o=n?a:game.dnd4eBeta.config.skills[a];o=o.charAt(0).toUpperCase()+o.slice(1);let r=[s,t.id,e[0]].join(this.delimiter),l=this._getProficiencyIcon(i[a].value);return{name:o,id:e[0],encodedValue:r,icon:l}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenactionhud.skills");return this._combineSubcategoryWithCategory(a,l,r),a}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),a="skill",s=get("abbreviateSkills"),n=Object.entries(game.dnd4eBeta.config.skills).map((t=>{let i=s?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenactionhud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,a,s){let n=this.initializeEmptyCategory(i);n.name=a;let o=get("abbreviateSkills"),r=Object.entries(game.dnd4eBeta.config.abilities).map((a=>{if(0===e[a[0]].value)return;let n=o?a[0]:a[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[s,t,a[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[a[0]].proficient),{name:n,id:a[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,a,l),n}_addMultiAbilities(t,e,i,a,s){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(game.dnd4eBeta.config.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,a,l),this._combineCategoryWithList(t,a,n,!0)}_buildUtilityCategory(t){const e=t.actor;let i=this.initializeEmptyCategory("utility");i.name=this.i18n("tokenactionhud.utility");let a="utility",s=this.initializeEmptySubcategory();this._addIntiativeSubcategory(a,i,t.id);let n=[a,t.id,"healDialog"].join(this.delimiter);s.actions.push({id:"heal",encodedValue:n,name:this.i18n("DND4EBETA.Healing")});let o=[a,t.id,"save"].join(this.delimiter);s.actions.push({id:"save",encodedValue:o,name:this.i18n("DND4EBETA.SavingThrow")});let r=[a,t.id,"saveDialog"].join(this.delimiter);if(s.actions.push({id:"saveDialog",encodedValue:r,name:this.i18n("Show Save Dialog")}),game.dnd4eBeta.tokenBarHooks.version>=2){(!get("hideUsedPowers")||this._getDocumentData(e).actionpoints?.value>0)&&s.actions.push({id:"actionPoint",encodedValue:[a,t.id,"actionPoint"].join(this.delimiter),name:this.i18n("DND4EBETA.ActionPointUse")});(!get("hideUsedPowers")||!this._getDocumentData(e).details?.secondwind)&&s.actions.push({id:"secondWind",encodedValue:[a,t.id,"secondWind"].join(this.delimiter),name:this.i18n("DND4EBETA.SecondWind")}),s.actions.push({id:"deathSave",encodedValue:[a,t.id,"deathSave"].join(this.delimiter),name:this.i18n("DND4EBETA.DeathSavingThrow")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.utility"),s),i}_buildEffectsCategory(t){let e=this.initializeEmptyCategory("effects");return e.name=this.i18n("tokenactionhud.effects"),this._addEffectsSubcategories(t.actor,t.id,e),e}_buildConditionsCategory(t){if(!get("showConditionsCategory"))return;let e=this.initializeEmptyCategory("conditions");return e.name=this.i18n("tokenactionhud.conditions"),this._addConditionsSubcategory(t.actor,t.id,e),e}_addEffectsSubcategories(t,e,i){const a="effect",s="find"in t.effects.entries?t.effects.entries:t.effects;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this._getDocumentData(t),s=i.label,r=[a,e,t.id].join(this.delimiter),l=i.disabled?"":"active",c=i.icon;let d={name:s,id:t.id,encodedValue:r,img:c,cssClass:l};t.isTemporary?n.actions.push(d):o.actions.push(d)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!s)return;let o=this.initializeEmptySubcategory();s.forEach((t=>{const i=this.i18n(t.label),s=[a,e,t.id].join(this.delimiter),r=n.every((e=>{("some"in e.effects.entries?e.effects.entries:e.effects).some((e=>e.data.flags.core?.statusId===t.id))}))?"active":"",l=t.icon,c={name:i,id:t.id,encodedValue:s,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenactionhud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const a="condition",s=CONFIG.statusEffects.filter((t=>""!==t.id));if(!s)return;let n=this.initializeEmptySubcategory();s.forEach((i=>{const s=this.i18n(i.label),o=[a,e,i.id].join(this.delimiter),r=("some"in t.effects.entries?t.effects.entries:t.effects).some((t=>t.data.flags.core?.statusId===i.id))?"active":"",l=i.icon,c={name:s,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.conditions"),n)}_addIntiativeSubcategory(t,e,i){const a=game.combat;let s,n;a&&(s=a.combatants.find((t=>t.tokenId===i)),n=s?.initiative);let o=this.initializeEmptySubcategory(),r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};n&&(r.info1=n),r.cssClass=n?"active":"",o.actions.push(r),this._combineSubcategoryWithCategory(e,this.i18n("tokenactionhud.initiative"),o)}_addMultiIntiativeSubcategory(t,e,i){const a=game.combat;let s,n=this.initializeEmptySubcategory(),o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:`${this.i18n("tokenactionhud.rollInitiative")}`};if(a){s=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=s?"active":"",n.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.initiative"),n)}_addMultiUtilities(t,e,i){let a=this.initializeEmptyCategory("utility"),s="utility";this._addMultiIntiativeSubcategory(s,e,a);let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.data.type))){let t=[s,e,"shortRest"].join(this.delimiter);n.actions.push({id:"shortRest",encodedValue:t,name:this.i18n("tokenactionhud.shortRest")});let a=[s,e,"longRest"].join(this.delimiter);n.actions.push({id:"longRest",encodedValue:a,name:this.i18n("tokenactionhud.longRest")});let r={id:"inspiration",encodedValue:[s,e,"inspiration"].join(this.delimiter),name:this.i18n("tokenactionhud.inspiration")};r.cssClass=i.every((t=>t.data.data.attributes?.inspiration))?"active":"",o.actions.push(r)}this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.rests"),n),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.utility"),o),this._combineCategoryWithList(t,this.i18n("tokenactionhud.utility"),a)}_getImage(t){let e="";return get("showIcons")&&(e=t.data.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=this._getDocumentData(t).uses;return!e||!(e.max>0&&!e.value)}))}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',5:'<i class="fas fa-check"></i>',8:'<i class="fas fa-check-double"></i>'}[t]}_getDocumentData(t){return t.data.data??t.data}}class RollHandlerBaseDnD4e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];if("multi"===s)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,a,i,n)}else await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){switch(e){case"ability":this.rollAbilityMacro(t,i,a);break;case"skill":this.rollSkillMacro(t,i,a);break;case"feature":case"inventory":this.isRenderItem()?this.doRenderItem(i,a):this.rollItemMacro(t,i,a);break;case"power":this.isRenderItem()?this.doRenderItem(i,a):this.rollPowerMacro(t,i,a);break;case"utility":await this.performUtilityMacro(t,i,a);break;case"effect":await this.toggleEffect(t,i,a);break;case"condition":await this.toggleCondition(t,i,a)}}rollAbilityMacro(t,e,i){const a=super.getActor(e);return game.dnd4eBeta.tokenBarHooks.rollAbility(a,i,t)}rollSkillMacro(t,e,i){const a=super.getActor(e);return game.dnd4eBeta.tokenBarHooks.rollSkill(a,i,t)}rollItemMacro(t,e,i){let a=super.getActor(e),s=super.getItem(a,i);return game.dnd4eBeta.tokenBarHooks.rollItem(a,s,t)}rollPowerMacro(t,e,i){let a=super.getActor(e),s=super.getItem(a,i);return this.needsRecharge(a,s)?(t.currentTarget={closest:t=>({dataset:{itemId:i}})},void game.dnd4eBeta.tokenBarHooks.rechargePower(a,s,t)):game.dnd4eBeta.tokenBarHooks.rollPower(a,s,t)}needsRecharge(t,e){return"recharge"===this._getDocumentData(e).useType&&!game.dnd4eBeta.tokenBarHooks.isPowerAvailable(t,e)}async performUtilityMacro(t,e,i){let a=super.getActor(e),s=super.getToken(e);switch(i){case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":s.toggleVisibility();break;case"saveDialog":game.dnd4eBeta.tokenBarHooks.saveDialog(a,t);break;case"save":game.dnd4eBeta.tokenBarHooks.quickSave(a,t);break;case"healDialog":game.dnd4eBeta.tokenBarHooks.healDialog(a,t);break;case"initiative":await this.performInitiativeMacro(e);break;case"actionPoint":game.dnd4eBeta.tokenBarHooks.actionPoint(a,t);break;case"secondWind":game.dnd4eBeta.tokenBarHooks.secondWind(a,t);break;case"deathSave":game.dnd4eBeta.tokenBarHooks.deathSave(a,t)}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const a=super.getActor(e),s=("find"in a.effects.entries?a.effects.entries:a.effects).find((t=>t.id===i));if(!s)return;const n=s.data.flags.core?.statusId;n?await this.toggleCondition(t,e,n):(await s.update({disabled:!s.data.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i){const a=super.getToken(e),s=this.isRightClick(t);if(i.includes("combat-utility-belt.")&&game.cub&&!s){const t=this.findCondition(i)?.label;if(!t)return;game.cub.hasCondition(t,a)?await game.cub.removeCondition(t,a):await game.cub.addCondition(t,a)}else{const t=this.findCondition(i);if(!t)return;s?await a.toggleEffect(t,{overlay:!0}):await a.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}_getDocumentData(t){return t.data.data??t.data}}class DnD4eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDnD4e(t,e)}getAvailableRollHandlers(){return{core:"Core dnd4e"}}doGetRollHandler(t){return new RollHandlerBaseDnD4e}doRegisterSettings(t,e){!function register$3(t,e){game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showConditionsCategory",{name:game.i18n.localize("tokenactionhud.settings.dnd5e.showConditionsCategory.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd5e.showConditionsCategory.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideUsedPowers",{name:game.i18n.localize("tokenactionhud.settings.dnd4e.hideUsedPowers.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd4e.hideUsedPowers.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"forcePowerColours",{name:game.i18n.localize("tokenactionhud.settings.dnd4e.forcePowerColours.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd4e.forcePowerColours.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"hideUnequippedInventory",{name:game.i18n.localize("tokenactionhud.settings.dnd4e.hideUnequippedInventory.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd4e.hideUnequippedInventory.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideQuantityZero",{name:game.i18n.localize("tokenactionhud.settings.dnd4e.hideQuantityZero.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd4e.hideQuantityZero.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"equipmentCategoryList",{name:game.i18n.localize("tokenactionhud.settings.dnd4e.equipmentCategoryList.name"),hint:game.i18n.localize("tokenactionhud.settings.dnd4e.equipmentCategoryList.hint"),scope:"client",config:!0,type:String,default:"consumable, tool, alchemical, potion, poison, food, scroll, trinket",onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerED4e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}async _buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.data?.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){let e=this._buildGeneralCategory(t),i=this._buildFavoritesCategory(t),a=this._buildTalentsCategory(t),s=this._buildMatrixCategory(t),n=this._buildSkillsCategory(t),o=this._buildItemsCategory(t);return[e,i,a,s,n,this._buildAttacksCategory(t),this._buildCreaturePowersCategory(t),this._buildCreatureManeuversCategory(t),o,this._buildCombatCategory(t)]}_buildGeneralCategory(t){if(!get("showGeneral"))return;const e=t.actor,i=0===["creature"].indexOf(e.data.type);let a=["earthdawn.d.dexterity","earthdawn.s.strength","earthdawn.t.toughness","earthdawn.p.perception","earthdawn.w.willpower","earthdawn.c.charisma"].map((e=>({name:this.i18n(e),id:null,encodedValue:["attribute",t.id,e].join(this.delimiter)}))).filter((t=>!!t)),s=this.initializeEmptySubcategory();s.actions=a;let n=this.initializeEmptySubcategory();n.actions=[{name:this.i18n("earthdawn.r.recovery"),id:null,encodedValue:["recovery",t.id,"recovery"].join(this.delimiter)}],i||n.actions.push({name:this.i18n("earthdawn.n.newDay"),id:null,encodedValue:["newday",t.id,"newday"].join(this.delimiter)},{name:this.i18n("earthdawn.h.halfMagic"),id:null,encodedValue:["halfmagic",t.id,"halfmagic"].join(this.delimiter)});const o={"earthdawn.u.useKarma":"usekarma"};let r=["earthdawn.u.useKarma"].map((i=>({name:this.i18n(i),id:null,encodedValue:["toggle",t.id,o[i]].join(this.delimiter),cssClass:"true"===e.data.data.usekarma?"active":""}))).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),l=this.initializeEmptySubcategory();l.actions=r;let c=this.initializeEmptyCategory("general");return c.name=this.i18n("tokenactionhud.general"),this._combineSubcategoryWithCategory(c,this.i18n("earthdawn.a.attributes"),s),this._combineSubcategoryWithCategory(c,this.i18n("earthdawn.o.other"),n),i||this._combineSubcategoryWithCategory(c,this.i18n("tokenactionhud.systems"),l),c}_buildFavoritesCategory(t){if(!get("showFavorites"))return;const e=t.actor;if(["pc","npc"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"true"===t.data.data.favorite));let a=this.initializeEmptyCategory("favorites");a.name=this.i18n("earthdawn.h.hotlist");let s=i.map((e=>{try{let i=e.id,a=e.type.toLowerCase(),s=e.name;e.data.data.hasOwnProperty("ranks")&&(s+=" ("+e.data.data.ranks+")");let n=[a,t.id,i].join(this.delimiter);return{name:s,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),n=this.initializeEmptySubcategory();n.actions=s;let o=this.i18n("earthdawn.h.hotlist");return this._combineSubcategoryWithCategory(a,o,n),a}_buildTalentsCategory(t){if(!get("showTalents"))return;const e=t.actor;if(["pc","npc"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"talent"===t.type));let a=this.initializeEmptyCategory("talents");a.name=this.i18n("earthdawn.t.talents");let s="talent",n=i.map((e=>{try{let i=e.id,a=e.name+" ("+e.data.data.ranks+")",n=[s,t.id,i].join(this.delimiter);return{name:a,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.t.talents");return this._combineSubcategoryWithCategory(a,r,o),a}_buildMatrixCategory(t){if(!get("showMatrices")||!t.actor.items.find((t=>"spellmatrix"===t.type)))return;const e=t.actor;if(["pc","npc"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"spellmatrix"===t.type));if(i.length<1)return;let a=this.initializeEmptyCategory("matrix");return a.name=this.i18n("earthdawn.m.matrixes"),i.forEach((e=>{try{let i=this.initializeEmptySubcategory(),s=e.id;i.actions=[{name:this.i18n("earthdawn.a.attune"),id:s,encodedValue:["matrixAttune",t.id,s].join(this.delimiter)},{name:this.i18n("earthdawn.m.matrixWeaveRed"),id:s,encodedValue:["matrixWeave",t.id,s].join(this.delimiter)},{name:this.i18n("earthdawn.m.matrixCastRed"),id:s,encodedValue:["matrixCast",t.id,s].join(this.delimiter)},{name:this.i18n("earthdawn.m.matrixClearRed"),id:s,encodedValue:["matrixClear",t.id,s].join(this.delimiter)}];let n=e.data.data.currentspell?`${e.data.data.currentspell} (${e.data.data.totalthreads}/${e.data.data.threadsrequired})`:e.name;this._combineSubcategoryWithCategory(a,n,i)}catch(t){throw Logger.error(e),t}})),a}_buildSkillsCategory(t){if(!get("showSkills"))return;const e=t.actor;if(["pc","npc"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"skill"===t.type));let a=this.initializeEmptyCategory("skills");a.name=this.i18n("earthdawn.s.skills");let s="skill",n=i.map((e=>{try{let i=e.id,a=e.name+" ("+e.data.data.ranks+")",n=[s,t.id,i].join(this.delimiter);return{name:a,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.s.skills");return this._combineSubcategoryWithCategory(a,r,o),a}_buildItemsCategory(t){if(!get("showInventory"))return;const e=t.actor,i=t.id;if(["pc","npc"].indexOf(e.data.type)<0)return;let a="inventory",s=e.data.items.filter((t=>["weapon","armor","shield","equipment"].indexOf(t.type)>-1)),n=s.filter((t=>"weapon"===t.type)).map((t=>this._buildItem(i,e,a,t))).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=s.filter((t=>"armor"===t.type)).map((t=>this._buildItem(i,e,a,t))).sort(((t,e)=>t.name.localeCompare(e.name))),l=this.initializeEmptySubcategory();l.actions=r;let c=s.filter((t=>"shield"===t.type)).map((t=>this._buildItem(i,e,a,t))).sort(((t,e)=>t.name.localeCompare(e.name))),d=this.initializeEmptySubcategory();d.actions=c;let h=s.filter((t=>"equipment"===t.type)).map((t=>this._buildItem(i,e,a,t))).sort(((t,e)=>t.name.localeCompare(e.name))),u=this.initializeEmptySubcategory();u.actions=h;let g=this.i18n("earthdawn.w.weapons"),m=this.i18n("earthdawn.a.armors"),y=this.i18n("earthdawn.s.shields"),p=this.i18n("earthdawn.e.equipment"),b=this.initializeEmptyCategory("inventory");return b.name=this.i18n("earthdawn.i.inventory"),this._combineSubcategoryWithCategory(b,g,o),this._combineSubcategoryWithCategory(b,m,l),this._combineSubcategoryWithCategory(b,y,d),this._combineSubcategoryWithCategory(b,p,u),b}_buildItem(t,e,i,a){const s=a.id??a._id;let n=[i,t,s].join(this.delimiter),o=this._getImage(a),r={name:a.name,id:s,encodedValue:n,img:o};return["weapon","armor","shield"].indexOf(a.type)>=0&&(r.cssClass=!0===a.data.data.worn?"active":""),r}_buildCombatCategory(t){if(!get("showCombat"))return;let e=t.actor,i=this.initializeEmptyCategory("combat");i.name=this.i18n("earthdawn.c.combat");let a=e.data.items.filter((t=>["weapon","equipment"].indexOf(t.type)>-1)).filter((t=>"weapon"===t.type&&this._getEntityData(t).worn)).map((i=>this._buildItem(t.id,e,"weaponAttack",i))).sort(((t,e)=>t.name.localeCompare(e.name))),s=this.initializeEmptySubcategory();s.actions=a,this._combineSubcategoryWithCategory(i,`${this.i18n("earthdawn.w.weapons")} ${this.i18n("earthdawn.a.attack")}`,s);const n={"earthdawn.c.combatOptionsAggressive":"tactics.aggressive","earthdawn.c.combatOptionsDefensive":"tactics.defensive","earthdawn.c.combatModifierHarried":"tactics.harried","earthdawn.c.combatModifierKnockedDown":"tactics.knockeddown"};let o=["earthdawn.c.combatOptionsAggressive","earthdawn.c.combatOptionsDefensive","earthdawn.c.combatModifierHarried","earthdawn.c.combatModifierKnockedDown"].map((i=>({name:this.i18n(i),id:null,encodedValue:["toggle",t.id,n[i]].join(this.delimiter),cssClass:!0===e.data.data.tactics[n[i].split(".")[1]]?"active":""}))).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(i,`${this.i18n("earthdawn.o.option")} & ${this.i18n("earthdawn.m.modifier")}`,r);let l=this.initializeEmptySubcategory();return l.actions=[{name:this.i18n("earthdawn.t.takeDamage"),id:null,encodedValue:["takedamage",t.id,"takedamage"].join(this.delimiter)},{name:this.i18n("earthdawn.c.combatOptionsKnockdownTest"),id:null,encodedValue:["knockdowntest",t.id,"knockdowntest"].join(this.delimiter)},{name:this.i18n("earthdawn.c.combatOptionsJumpUp"),id:null,encodedValue:["jumpup",t.id,"jumpup"].join(this.delimiter)}],this._combineSubcategoryWithCategory(i,this.i18n("earthdawn.a.actions"),l),i}_buildAttacksCategory(t){const e=t.actor;if(["creature"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"Attack"===t.data.data.powerType));let a=this.initializeEmptyCategory("attacks");a.name=this.i18n("earthdawn.a.attacks");let s="attack",n=i.map((e=>{try{let i=e.id,a=e.name,n=[s,t.id,i].join(this.delimiter);return{name:a,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.a.attack");return this._combineSubcategoryWithCategory(a,r,o),a}_buildCreaturePowersCategory(t){const e=t.actor;if(["creature"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"Power"===t.data.data.powerType));let a=this.initializeEmptyCategory("powers");a.name=this.i18n("earthdawn.p.powers");let s="power",n=i.map((e=>{try{let i=e.id,a=e.name,n=[s,t.id,i].join(this.delimiter);return{name:a,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.p.power");return this._combineSubcategoryWithCategory(a,r,o),a}_buildCreatureManeuversCategory(t){const e=t.actor;if(["creature"].indexOf(e.data.type)<0)return;const i=e.data.items.filter((t=>"Maneuver"===t.data.data.powerType));let a=this.initializeEmptyCategory("maneuvers");a.name=this.i18n("earthdawn.m.maneuvers");let s="maneuver",n=i.map((e=>{try{let i=e.id,a=e.name,n=[s,t.id,i].join(this.delimiter);return{name:a,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.m.maneuver");return this._combineSubcategoryWithCategory(a,r,o),a}_getEntityData(t){return t.data.data??t.data}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}}class RollHandlerBaseED4e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2];if("multi"===s)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,a,i,n)}else await this._handleMacros(t,a,s,n)}async _handleMacros(t,e,i,a){let s=super.getActor(i);switch(e){case"skill":case"talent":this.rollTalentMacro(t,i,a);break;case"attack":case"power":case"maneuver":this.handleCreatureActionMacro(t,i,a);break;case"inventory":this.rollInventoryMacro(t,i,a);break;case"toggle":this.toggleDataProperty(t,i,a);break;case"attribute":this.rollAttributeMacro(t,i,a);break;case"recovery":s.recoveryTest();break;case"newday":s.newDay();break;case"halfmagic":s.halfMagic();break;case"matrixAttune":s.attuneMatrix(s.items.get(a));break;case"matrixWeave":s.weaveThread(s.items.get(a));break;case"matrixCast":s.castSpell(s.items.get(a));break;case"matrixClear":s.clearMatrix(s.items.get(a));break;case"weaponAttack":s.rollPrep({weaponID:a,rolltype:"attack"});break;case"takedamage":this.takeDamage(s);break;case"knockdowntest":s.knockdownTest({});break;case"jumpup":s.jumpUpTest()}}rollAttributeMacro(t,e,i){super.getActor(e).rollPrep({attribute:`${i.split(".").slice(-1)}Step`,name:i})}rollTalentMacro(t,e,i){super.getActor(e).rollPrep({talentID:i})}rollInventoryMacro(t,e,i){const a=super.getActor(e).items.get(i);"equipment"===a.type?a.sheet.render(!0):["weapon","armor","shield"].indexOf(a.type)>=0?this.toggleItemWornProperty(t,e,i):Logger.error(a.type," is not a valid actionId for rolling an inventory item")}toggleDataProperty(t,e,i){const a=super.getActor(e);if(i.includes("tactics")){const t=i.split(".")[1];a.update({data:{tactics:{[t]:!a.data.data.tactics[t]}}})}else{const t=a.data.data[i];let e="string"===typeof t?this._toggleBooleanString(t):!t;a.update({data:{[i]:e}})}}toggleItemWornProperty(t,e,i){const a=super.getActor(e).items.get(i),s=a.data.data.worn;let n="string"===typeof s?this._toggleBooleanString(s):!s;a.update({data:{worn:n}})}_toggleBooleanString(t){return t.toLowerCase().includes("true")?"false":t.toLowerCase().includes("false")?"true":"false"}handleCreatureActionMacro(t,e,i){const a=super.getActor(e),s=a.items.get(i);if(0!==s.data.data.attackstep){const t=0,e=s.data.data.strain?s.data.data.strain:0,n=0;let o="Attack"===s.data.data.powerType?"attack":s.data.data.attackstep>0?"test":"";const r={itemID:i,steps:s.data.data.attackstep,talent:s.name,strain:e,type:o,karma:n,modifier:t};a.NPCtest(r)}else a.items.get(i).sheet.render(!0)}async takeDamage(t){let e=await new Promise((t=>{new Dialog({title:this.i18n("earthdawn.t.takeDamage"),content:`\n          <div style="float: left">\n              <label>${this.i18n("earthdawn.d.damage")}: </label>\n              <input id="damage_box" value=0 autofocus/>\n          </div>\n          <div>\n              <label>${this.i18n("earthdawn.t.type")}: </label>\n              <select id="type_box">\n                <option value="physical">Physical</option>\n                <option value="mystic">Mystic</option>\n              </select>\n          </div>\n          <div>\n            <label>${this.i18n("earthdawn.i.ignoreArmor")}?</label>\n            <input type="checkbox" id="ignore_box"/>\n          </div>`,buttons:{ok:{label:this.i18n("earthdawn.o.ok"),callback:e=>{t({damage:e.find("#damage_box").val(),type:e.find("#type_box").val(),ignore:e.find("#ignore_box:checked")})}}},default:"ok"}).render(!0)}));e.ignorearmor=e.ignore.length>0,await t.takeDamage(e)}}class ED4eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerED4e(t,e)}doGetRollHandler(t){return new RollHandlerBaseED4e}doRegisterSettings(t,e){!function register$2(t,e){game.settings.register(t,"showGeneral",{name:"Show General",hint:"Display category for general rolls like Attributes, Half-Magic or Recovery",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showFavorites",{name:"Show Favorites",hint:"Display category for items marked as favorites",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showTalents",{name:"Show Talents",hint:"Display category for all talents",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showSkills",{name:"Show Skills",hint:"Display category for all skills",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showMatrices",{name:"Show Matrices",hint:"Display category for all spell matrices",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showInventory",{name:"Show Inventory",hint:"Display category for weapons and equipment",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showStatusToggle",{name:"Show Status Toggle",hint:"Display category for toggling system use and conditions",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showCombat",{name:"Show Combat",hint:"Display category for combat (Weapons, Matrices, Favorites, etc.",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}getAvailableRollHandlers(){return{core:"Core Earthdawn 4e"}}}class ActionHandlerGURPS extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!GURPS)return i;if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;return s?(i.actorId=s.data._id,this._combineCategoryWithList(i,this.i18n("tokenactionhud.attributes"),this._attributes(s,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.defenses"),this._defenses(s,a)),Object.keys(s.data.data.melee).length>0&&this._melee(i,this.i18n("tokenactionhud.melee"),s,a),Object.keys(s.data.data.ranged).length>0&&this._ranged(i,this.i18n("tokenactionhud.ranged"),s,a),Object.keys(s.data.data.skills).length>0&&this._addToList(i,this.i18n("tokenactionhud.skills"),s,a,"skills","Sk"),Object.keys(s.data.data.spells).length>0&&this._addToList(i,this.i18n("tokenactionhud.spells"),s,a,"spells","Sp"),this._advantages(i,s,a),this._addQuickNotes(i,s,a),get("showManeuvers")&&game.combats.combats.find((t=>t.isActive&&!!t.getCombatantByToken(a)))&&this._combineCategoryWithList(i,this.i18n("GURPS.setManeuver"),this._maneuvers(s,a)),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_advantages(t,e,i){let a=!1,s=this.initializeEmptyCategory("ads");GURPS.recurselist(e.data.data.ads,((t,e,n)=>{let o=this.initializeEmptySubcategory();this._addNoteOTFs(o,i,t.name+" "+t.notes)&&(a=!0,this._combineSubcategoryWithCategory(s,t.name,o))})),a&&this._combineCategoryWithList(t,this.i18n("GURPS.advantages"),s)}_addQuickNotes(t,e,i){let a=this.initializeEmptyCategory("qn"),s=this.initializeEmptySubcategory();this._addNoteOTFs(s,i,e.data.data.additionalresources.qnotes)&&this._combineSubcategoryWithCategory(a,"",s),this._combineCategoryWithList(t,this.i18n("GURPS.quicknotes"),a)}_ranged(t,e,i,a){let s=get("maxListSize"),n=0,o=0,r="ranged",l=this.initializeEmptyCategory(r);GURPS.recurselist(i.data.data.ranged,((i,c,d)=>{let h=this.initializeEmptySubcategory(),u='"';i.name.includes(u)&&(u="'");let g=i.mode?" ("+i.mode+")":"",m=i.name+g;if(h.actions.push({name:this.i18n("tokenactionhud.attack")+" ("+i.level+")",encodedValue:["otf",a,"R:"+u+m+u].join(this.delimiter)}),!isNaN(parseInt(i.acc))){let t=(i.acc>=0?"+":"")+i.acc;h.actions.push({name:this.i18n("tokenactionhud.gurps.addacc")+" ("+t+")",encodedValue:["otf",a,t+" "+m+" "+this.i18n("GURPS.acc")].join(this.delimiter)})}h.actions.push({name:this.i18n("tokenactionhud.damage")+" ("+i.damage+")",encodedValue:["dam",a,"D:"+u+m+u].join(this.delimiter)}),this._addNoteOTFs(h,a,m+" "+i.notes),this._combineSubcategoryWithCategory(l,m,h),++n>=s&&(n=0,o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l),l=this.initializeEmptyCategory(r+o))})),n>0&&(o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l))}_addToList(t,e,i,a,s,n){let o=get("maxListSize"),r=0,l=0,c=this.initializeEmptyCategory(s);GURPS.recurselist(i.data.data[s],((i,d,h)=>{if(i.level>0){let d=this.initializeEmptySubcategory(),h='"';i.name.includes(h)&&(h="'"),d.actions.push({name:i.name+" ("+i.level+")",encodedValue:["otf",a,n+":"+h+i.name+h].join(this.delimiter)}),this._addNoteOTFs(d,a,i.name+" "+i.notes),this._combineSubcategoryWithCategory(c,"",d),++r>=o&&(r=0,l++,this._combineCategoryWithList(t,e+(l>1?"-"+l:""),c),c=this.initializeEmptyCategory(s+l))}})),r>0&&(l++,this._combineCategoryWithList(t,e+(l>1?"-"+l:""),c))}_addNoteOTFs(t,e,i){let a=!1;return i&&GURPS.gurpslink(i,!1,!0).forEach((i=>{a=!0,t.actions.push({name:i.text,encodedValue:["otf",e,i.action.orig].join(this.delimiter)})})),a}_melee(t,e,i,a){let s=get("maxListSize"),n=0,o=0,r="melee",l=this.initializeEmptyCategory(r);GURPS.recurselist(i.data.data.melee,((i,c,d)=>{let h=this.initializeEmptySubcategory(),u='"';i.name.includes(u)&&(u="'");let g=i.mode?" ("+i.mode+")":"",m=i.name+g;h.actions.push({name:this.i18n("tokenactionhud.attack")+" ("+i.level+")",encodedValue:["otf",a,"M:"+u+m+u].join(this.delimiter)}),isNaN(parseInt(i.parry))||h.actions.push({name:this.i18n("GURPS.parry")+" ("+i.parry+")",encodedValue:["otf",a,"P:"+u+m+u].join(this.delimiter)}),isNaN(parseInt(i.block))||h.actions.push({name:this.i18n("GURPS.block")+" ("+i.block+")",encodedValue:["otf",a,"B:"+u+m+u].join(this.delimiter)}),h.actions.push({name:this.i18n("tokenactionhud.damage")+" ("+i.damage+")",encodedValue:["dam",a,"D:"+u+m+u].join(this.delimiter)}),this._addNoteOTFs(h,a,i.name+" "+i.notes),this._combineSubcategoryWithCategory(l,m,h),++n>=s&&(n=0,o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l),l=this.initializeEmptyCategory(r+o))})),n>0&&(o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l))}_maneuvers(t,e){let i=this.initializeEmptyCategory("maneuvers"),a=this.initializeEmptySubcategory();return Object.values(GURPS.Maneuvers.getAll()).forEach((t=>{let i=this.i18n(t.data.label);a.actions.push({name:i,encodedValue:["otf",e,"/man "+i].join(this.delimiter),img:t.icon})})),this._combineSubcategoryWithCategory(i,"",a),i}_defenses(t,e){let i=this.initializeEmptyCategory("defenses"),a=this._addDefense(e,this.i18n("GURPS.dodge")+" ("+t.data.data.currentdodge+")","DODGE");return this._addDefense(e,this.i18n("tokenactionhud.gurps.retreatdodge")+" ("+(t.data.data.currentdodge+3)+")","DODGE +3 "+this.i18n("GURPS.modifierDodgeRetreat"),a),this._combineSubcategoryWithCategory(i,"",a),t.data.data.equippedparry&&(a=this._addDefense(e,this.i18n("GURPS.parry")+" ("+t.data.data.equippedparry+")","PARRY"),t.data.data.equippedparryisfencing?this._addDefense(e,this.i18n("tokenactionhud.gurps.retreatparryfence")+" ("+(t.data.data.equippedparry+3)+")","PARRY +3 fencing retreat",a):this._addDefense(e,this.i18n("tokenactionhud.gurps.retreatparry")+" ("+(t.data.data.equippedparry+1)+")","PARRY +1 retreating",a),this._combineSubcategoryWithCategory(i,"",a)),t.data.data.equippedblock&&(a=this._addDefense(e,this.i18n("GURPS.block")+" ("+t.data.data.equippedblock+")","BLOCK"),this._addDefense(e,this.i18n("tokenactionhud.gurps.retreatblock")+" ("+(t.data.data.equippedblock+1)+")","BLOCK +1 retreating",a),this._combineSubcategoryWithCategory(i,"",a)),i}_addDefense(t,e,i,a){return a||(a=this.initializeEmptySubcategory()),a.actions.push({name:e,encodedValue:["otf",t,i].join(this.delimiter)}),a}_attributes(t,e){let i=this.initializeEmptyCategory("attributes");for(let a in t.data.data.attributes){let s=this.initializeEmptySubcategory(),n=this.i18n(`GURPS.attributes${a}`)+" ("+t.data.data.attributes[a].value+")";s.actions.push({name:n,encodedValue:["otf",e,a].join(this.delimiter)}),s.actions.push({name:this.i18n("tokenactionhud.gurps.blindroll")+" "+n,encodedValue:["otf",e,"!"+a].join(this.delimiter)}),this._combineSubcategoryWithCategory(i,this.i18n(`GURPS.attributes${a}NAME`),s)}let a=!1,s=this.initializeEmptySubcategory();for(let i in t.data.data.reactions){let n=t.data.data.reactions[i];a=!0;let o=n.modifier>=0?"+":"",r=n.situation?" "+n.situation:"",l=o+n.modifier+r;this._addNoteOTFs(s,e,"["+l+"]")}a&&this._combineSubcategoryWithCategory(i,this.i18n("GURPS.reaction"),s),a=!1,s=this.initializeEmptySubcategory();for(let i in t.data.data.conditionalmods){let n=t.data.data.conditionalmods[i];a=!0;let o=n.modifier>=0?"+":"",r=n.situation?" "+n.situation:"",l=o+n.modifier+r;this._addNoteOTFs(s,e,"["+l+"]")}return a&&this._combineSubcategoryWithCategory(i,this.i18n("GURPS.conditionalMods"),s),i}}class RollHandlerBaseGURPS extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);if("multi"===s)for(let e of canvas.tokens.controlled)o=super.getActor(e.id),await this._handleMacros(t,a,o,n);else await this._handleMacros(t,a,o,n)}async _handleMacros(t,e,i,a){switch(e){case"otf":this.executeOTF(t,i,a);break;case"dam":this.executeOTF(t,i,a,!0)}}async executeOTF(t,e,i,a=!1){if(a&&this.isRightClick(t)){let a=GURPS.parselink(i);a.action.calcOnly=!0;let s=await GURPS.performAction(a.action,e),n={...t};n.preventDefault=()=>{},n.currentTarget={...n.currentTarget},n.currentTarget.innerText=s,GURPS.resolveDamageRoll(n,e,s,"",game.user.isGM,!0)}else{let t=GURPS.LastActor;GURPS.SetLastActor(e),GURPS.executeOTF(i).then((e=>GURPS.SetLastActor(t)))}}}class GURPSSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerGURPS(t,e)}doGetRollHandler(t){return new RollHandlerBaseGURPS}doRegisterSettings(t,e){!function register$1(t,e){game.settings.register(t,"showManeuvers",{name:"Show Maneuvers",hint:"Display 'Set Maneuver' button when in combat",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"maxListSize",{name:"Max Skill/Spell list size",hint:"Split the Skill/Spell lists into multiple columns if they exceeed this length (minimum 10).  You may want to adjust this based on the HUD Scale and your screen size.",scope:"client",config:!0,type:Number,default:20,onChange:i=>{(isNaN(i)||i<10)&&(i=10,game.settings.set(t,"maxListSize",i)),e(i)}})}(t,e)}getAvailableRollHandlers(){return{core:"Core GURPS"}}}class ActionHandlerSpace1889 extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;return s?(i.actorId=s.data._id,this._combineCategoryWithList(i,this.i18n("tokenactionhud.attributes"),this._abilities(s,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.skills"),this._skills(s,a)),null!=s.data.talents.find((t=>t.data.isRollable))&&this._combineCategoryWithList(i,this.i18n("tokenactionhud.talents"),this._talants(s,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.attack"),this._attacks(s,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.defenses"),this._defenses(s,a)),this._combineCategoryWithList(i,this.i18n("tokenactionhud.damage"),this._damage(s,a)),get("showHudTitle")&&(i.hudTitle=t.data?.name),i):i}_defenses(t,e){let i=this.initializeEmptyCategory("defenses");const a="defense";let s=this._addEntry(e,this.i18n("SPACE1889.SecondaryAttributeDef")+" ("+t.data.data.secondaries.defense.total+")","defense",a);return"creature"!=t.data.type&&(this._addEntry(e,this.i18n("SPACE1889.Block")+" ("+t.data.data.block.value+")","block",a,s),this._addEntry(e,this.i18n("SPACE1889.Parry")+" ("+t.data.data.parry.value+")","parry",a,s),this._addEntry(e,this.i18n("SPACE1889.Evasion")+" ("+t.data.data.evasion.value+")","evasion",a,s)),this._combineSubcategoryWithCategory(i,this.i18n("SPACE1889.SecondaryAttributeDef"),s),i}_addEntry(t,e,i,a,s){return s||(s=this.initializeEmptySubcategory()),s.actions.push({name:e,encodedValue:[a,t,i].join(this.delimiter)}),s}_skills(t,e){let i=this.initializeEmptyCategory("skills"),a=this.initializeEmptySubcategory();for(const i of t.data.skills){this._addEntry(e,this.i18n(i.data.nameLangId)+" ("+i.data.rating.toString()+")",i.data.id,"skill",a);for(const s of t.data.speciSkills)s.data.underlyingSkillId==i.data.id&&this._addEntry(e,this.i18n(s.data.nameLangId)+" ("+s.data.rating.toString()+")",s.data.id,"specialization",a)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.skills"),a),i}_attacks(t,e){let i=this.initializeEmptyCategory("attacks"),a=this.initializeEmptySubcategory();for(const i of t.data.weapons)this._addEntry(e,i.name+" ("+i.data.attack.toString()+")",i.data.id,"weapon",a);return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.attack"),a),i}_talants(t,e){let i=this.initializeEmptyCategory("talents"),a=this.initializeEmptySubcategory();for(const i of t.data.talents)i.data.isRollable&&this._addEntry(e,this.i18n(i.data.nameLangId),i.data.id,"talent",a);return this._combineSubcategoryWithCategory(i,this.i18n("tokenactionhud.talents"),a),i}_damage(t,e){let i=this.initializeEmptyCategory("damage"),a=this._addEntry(e,this.i18n("SPACE1889.Lethal"),"lethal","damage");return this._addEntry(e,this.i18n("SPACE1889.NonLethal"),"nonLethal","damage",a),this._combineSubcategoryWithCategory(i,this.i18n("SPACE1889.AddDamage"),a),i}_abilities(t,e){const i=t.data.data.abilities;let a=this.initializeEmptyCategory("abilities"),s=Object.entries(game.space1889.config.abilities).map((t=>{if(0===i[t[0]].value)return;let a=this.i18n(t[1])+"("+i[t[0]].total.toString()+")",s=["primary",e,t[0]].join(this.delimiter);return{name:a,id:t[0],encodedValue:s}})),n=this.initializeEmptySubcategory();return n.actions=s.filter((t=>!!t)),this._addEntry(e,this.i18n("SPACE1889.SecondaryAttributePer")+" ("+t.data.data.secondaries.perception.total.toString()+")","perception","secondary",n),this._combineSubcategoryWithCategory(a,this.i18n("SPACE1889.AbilityPl"),n),a}}class RollHandlerBaseSpace1889 extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);if("multi"===s)for(let e of canvas.tokens.controlled)o=super.getActor(e.id),await this._handleMacros(t,a,o,n);else await this._handleMacros(t,a,o,n)}async _handleMacros(t,e,i,a){switch(e){case"primary":this.executePrimary(t,i,a);break;case"secondary":this.executeSecondary(t,i,a);break;case"skill":this.executeSkill(t,i,a);break;case"specialization":this.executeSpecialization(t,i,a);break;case"talent":this.executeTalent(t,i,a);break;case"weapon":this.executeWeapon(t,i,a);break;case"defense":this.executeDefense(t,i,a);break;case"damage":this.executeDamage(i,a)}}executePrimary(t,e,i){e.rollPrimary(i,t)}executeSecondary(t,e,i){e.rollSecondary(i,t)}executeSkill(t,e,i){e.rollSkill(i,t)}executeSpecialization(t,e,i){e.rollSpecialization(i,t)}executeTalent(t,e,i){e.rollTalent(i,t)}executeWeapon(t,e,i){e.rollAttack(i,t)}executeDefense(t,e,i){e.rollDefence(i,t)}executeDamage(t,e){t.addDamage(e)}}class Space1889SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSpace1889(t,e)}doGetRollHandler(t){return new RollHandlerBaseSpace1889}doRegisterSettings(t,e){!function register(t,e){game.settings.register(t,"maxListSize",{name:"Max Skill/Spell list size",hint:"Split the Skill/Spell lists into multiple columns if they exceeed this length (minimum 10).  You may want to adjust this based on the HUD Scale and your screen size.",scope:"client",config:!0,type:Number,default:20,onChange:i=>{i<10&&(i=10,game.settings.set(t,"maxListSize",i)),e(i)}})}(t,e)}getAvailableRollHandlers(){return{core:"Core Space1889"}}}class ActionHandlerCoC7 extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.data._id;i.tokenId=a;let s=t.actor;if(!s)return i;if(!["character","npc","creature"].includes(s.type))return i;i.actorId=s.data._id;let n=this._getActions(s,a),o=this._getSkills(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.actions"),n),this._combineCategoryWithList(i,this.i18n("tokenactionhud.skills"),o),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getActions(t,e){let i=this.initializeEmptyCategory("actions"),a=this.initializeEmptySubcategory(),s=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory();for(let i in t.data.data.characteristics)a.actions.push({name:this.i18n(t.data.data.characteristics[i].label),encodedValue:["characteristic",e,i].join(this.delimiter)});t.data.data.attribs.lck.value&&a.actions.push({name:t.data.data.attribs.lck.label,encodedValue:["attribute",e,"lck"].join(this.delimiter)}),t.data.data.attribs.san.value&&a.actions.push({name:t.data.data.attribs.san.label,encodedValue:["attribute",e,"san"].join(this.delimiter)}),a.actions.length&&a.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.Entities."+t.data.type.charAt(0).toUpperCase()+t.data.type.slice(1)),a);for(let i of t.items)"weapon"===i.type&&(i.data.data.properties?.rngd?n.actions.push({name:i.name,encodedValue:["weapon",e,i.id].join(this.delimiter)}):s.actions.push({name:i.name,encodedValue:["weapon",e,i.id].join(this.delimiter)}));return s.actions.length&&(s.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.MeleeWeapons"),s)),n.actions.length&&(n.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.RangeWeapons"),n)),i}_getSkills(t,e){let i=this.initializeEmptyCategory("skills"),a=this.initializeEmptySubcategory();for(let i of t.items)"skill"===i.type&&a.actions.push({name:i.name,encodedValue:["skill",e,i.name].join(this.delimiter)});return a.actions.length&&a.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.Entities."+t.data.type.charAt(0).toUpperCase()+t.data.type.slice(1)),a),i}}class RollHandlerBaseCoC7 extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){console.log("doHandleActionEvent",t,e);let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"characteristic":o.characteristicCheck(n,t.shiftKey);break;case"attribute":o.attributeCheck(n,t.shiftKey);break;case"weapon":o.weaponCheck({id:n},t.shiftKey);break;case"skill":o.skillCheck({name:n},t.shiftKey)}}}class CoC7SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCoC7(t,e)}getAvailableRollHandlers(){return{core:"Core CoC7"}}doGetRollHandler(t){return new RollHandlerBaseCoC7}doRegisterSettings(t,e){}}class ActionHandlerCleenmain extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let a=t.id;i.tokenId=a;let s=t.actor;if(!s)return i;i.actorId=s.id,s.data.type;let n=this._getWeapons(s,a),o=this._getSkills(s,a);return this._combineCategoryWithList(i,this.i18n("tokenactionhud.skills"),o),this._combineCategoryWithList(i,this.i18n("tokenactionhud.weapons"),n),get("showHudTitle")&&(i.hudTitle=t.data?.name),i}_getSkills(t,e){let i=t.items.filter((t=>"skill"==t.type)).sort((function(t,e){return t.name.localeCompare(e.name)})),a=this.initializeEmptyCategory("actorSkills"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,i,"skill"),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.roll"),s),a}_getWeapons(t,e){let i=t.items.filter((t=>"weapon"===t.type)),a=this.initializeEmptyCategory("actorWeapons"),s=this.initializeEmptySubcategory();return s.actions=this._produceMap(e,i,"weapon"),this._combineSubcategoryWithCategory(a,this.i18n("tokenactionhud.roll"),s),a}_produceMap(t,e,i){return e.map((e=>{let a=[i,t,e.id].join(this.delimiter),s=this._getImage(e);return{name:e.name,encodedValue:a,id:e.id,img:s}}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("systems/cleenmain/assets/image/default.png")?"":e}}class RollHandlerBaseCleenmain extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let a=i[0],s=i[1],n=i[2],o=super.getActor(s);switch(a){case"weapon":this._handleWeapon(a,t,o,n);break;case"skill":this._handleSkill(a,t,o,n)}}_handleWeapon(t,e,i,a){return i.check(a,"weapon-attack")}_handleSkill(t,e,i,a){return i.check(a,"skill")}}class CleenmainSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return console.log("startup"),new ActionHandlerCleenmain(t,e)}getAvailableRollHandlers(){return{core:"Core Cle en main"}}doGetRollHandler(t){return new RollHandlerBaseCleenmain}doRegisterSettings(t,e){}}let r;Hooks.on("init",(()=>{!function registerHandlerbars(){Handlebars.registerHelper("cap",(function(t){return!t||t.length<1?"":t[0].toUpperCase()+t.slice(1)})),Handlebars.registerHelper("ifCond",(function(t,e,i,a){switch(e){case"==":return t==i?a.fn(this):a.inverse(this);case"===":return t===i?a.fn(this):a.inverse(this);case"!=":return t!=i?a.fn(this):a.inverse(this);case"!==":return t!==i?a.fn(this):a.inverse(this);case"<":return t<i?a.fn(this):a.inverse(this);case"<=":return t<=i?a.fn(this):a.inverse(this);case">":return t>i?a.fn(this):a.inverse(this);case">=":return t>=i?a.fn(this):a.inverse(this);case"&&":return t&&i?a.fn(this):a.inverse(this);case"||":return t||i?a.fn(this):a.inverse(this);default:return a.inverse(this)}})),Handlebars.registerHelper("activeText",(function(t){return get("activeCssAsText")?t.fn(this):t.inverse(this)})),loadTemplates(["modules/token-action-hud/templates/category.hbs","modules/token-action-hud/templates/subcategory.hbs","modules/token-action-hud/templates/actionSet.hbs","modules/token-action-hud/templates/action.hbs","modules/token-action-hud/templates/tagdialog.hbs"])}(),game.modules.get("token-action-hud").api={};const t={dnd5e:"dnd5e",dungeonworld:"dungeonworld",pf2e:"pf2e",wfrp4e:"wfrp4e",sfrpg:"sfrpg",sw5e:"sw5e",demonlord:"demonlord",pf1:"pf1",lancer:"lancer",D35E:"D35E",swade:"swade",starwarsffg:"starwarsffg",tormenta20:"tormenta20","blades-in-the-dark":"blades-in-the-dark",symbaroum:"symbaroum",od6s:"od6s",alienrpg:"alienrpg",cthack:"cthack",kamigakari:"kamigakari",tagmar:"tagmar",tagmar_rpg:"tagmar_rpg",ds4:"ds4",coc:"coc",cof:"cof","forbidden-lands":"forbidden-lands",dnd4e:"dnd4e",earthdawn4e:"earthdawn4e",gurps:"gurps",space1889:"space1889",CoC7:"CoC7",cleenmain:"cleenmain"};Hooks.call("preCreateTAHSystemManager",t);const e=t[game.data.system.id];e||console.error("Token Action HUD: System not supported"),r=class SystemManagerFactory{static create(t,e){switch(t){case"blades-in-the-dark":return new BitDSystemManager(e);case"demonlord":return new DemonlordSystemManager(e);case"dnd5e":return new Dnd5eSystemManager(e);case"dungeonworld":return new DungeonWorldSystemManager(e);case"pf1":return new Pf1SystemManager(e);case"D35E":return new D35ESystemManager(e);case"od6s":return new OD6SSystemManager(e);case"pf2e":return new Pf2eSystemManager(e);case"sfrpg":return new SfrpgSystemManager(e);case"sw5e":return new SW5eSystemManager(e);case"wfrp4e":return new Wfrp4eSystemManager(e);case"lancer":return new LancerSystemManager(e);case"swade":return new SwadeSystemManager(e);case"starwarsffg":return new StarWarsFFGSystemManager(e);case"tormenta20":return new Tormenta20SystemManager(e);case"symbaroum":return new SymbaroumSystemManager(e);case"alienrpg":return new AlienrpgSystemManager(e);case"cthack":return new CthackSystemManager(e);case"kamigakari":return new KamigakariSystemManager(e);case"tagmar":case"tagmar_rpg":return new TagmarSystemManager(e);case"ds4":return new Ds4SystemManager(e);case"cof":case"coc":return new CoSystemManager(e);case"forbidden-lands":return new ForbiddenLandsSystemManager(e);case"dnd4e":return new DnD4eSystemManager(e);case"earthdawn4e":return new ED4eSystemManager(e);case"gurps":return new GURPSSystemManager(e);case"space1889":return new Space1889SystemManager(e);case"CoC7":return new CoC7SystemManager(e);case"cleenmain":return new CleenmainSystemManager(e)}}}.create(e,"token-action-hud"),r.registerSettings(),game.settings.get(r.appName,"dorakoUI")&&function injectCSS(t){const e=document.getElementsByTagName("head")[0],i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href","modules/token-action-hud/styles/"+t+".css"),i.setAttribute("media","all"),e.insertBefore(i,e.lastChild)}("dorako-action-hud")})),Hooks.on("canvasReady",(async()=>{let t=game.user;if(!t)throw new Error("Token Action HUD | No user found.");game.tokenActionHUD||(game.tokenActionHUD=new TokenActionHUD(r),await game.tokenActionHUD.init(t)),game.tokenActionHUD.setTokensReference(canvas.tokens),Hooks.on("controlToken",((t,e)=>{game.tokenActionHUD.update()})),Hooks.on("updateToken",((t,e,i,a,s)=>{i.hasOwnProperty("y")||i.hasOwnProperty("x")||game.tokenActionHUD.validTokenChange(e)&&game.tokenActionHUD.update()})),Hooks.on("deleteToken",((t,e,i,a)=>{game.tokenActionHUD.validTokenChange(e)&&game.tokenActionHUD.update()})),Hooks.on("hoverToken",((t,e)=>{game.tokenActionHUD.validTokenHover(t,e)&&game.tokenActionHUD.update()})),Hooks.on("updateActor",(t=>{game.tokenActionHUD.validActorOrItemUpdate(t)&&game.tokenActionHUD.update()})),Hooks.on("deleteActor",(t=>{game.tokenActionHUD.validActorOrItemUpdate(t)&&game.tokenActionHUD.update()})),Hooks.on("deleteItem",(t=>{let e=t.actor;game.tokenActionHUD.validActorOrItemUpdate(e)&&game.tokenActionHUD.update()})),Hooks.on("createItem",(t=>{let e=t.actor;game.tokenActionHUD.validActorOrItemUpdate(e)&&game.tokenActionHUD.update()})),Hooks.on("updateItem",(t=>{let e=t.actor;game.tokenActionHUD.validActorOrItemUpdate(e)&&game.tokenActionHUD.update()})),Hooks.on("renderTokenActionHUD",(()=>{game.tokenActionHUD.applySettings(),game.tokenActionHUD.trySetPos()})),Hooks.on("renderCompendium",((t,e)=>{let i=t?.metadata;game.tokenActionHUD.isLinkedCompendium(`${i?.package}.${i?.name}`)&&game.tokenActionHUD.update()})),Hooks.on("deleteCompendium",((t,e)=>{let i=t?.metadata;game.tokenActionHUD.isLinkedCompendium(`${i?.package}.${i?.name}`)&&game.tokenActionHUD.update()})),Hooks.on("createCombat",(t=>{game.tokenActionHUD.update()})),Hooks.on("deleteCombat",(t=>{game.tokenActionHUD.update()})),Hooks.on("updateCombat",(t=>{game.tokenActionHUD.update()})),Hooks.on("updateCombatant",((t,e)=>{game.tokenActionHUD.update()})),Hooks.on("forceUpdateTokenActionHUD",(()=>{game.tokenActionHUD.update()})),game.tokenActionHUD.update()}))}));
