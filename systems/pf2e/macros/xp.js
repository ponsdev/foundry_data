function getLevels(actors,type){return actors.filter((a=>a.data.type===type)).map((a=>parseInt(a.data.data.details.level.value??"1",10)))}function dialogTemplate(xp){return`\n<h2>XP</h2>\n<table>\n    <tr>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.PartySize")}</th>\n        <td>${xp.partySize}</td>\n    </tr>\n    <tr>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.PartyLevel")}</th>\n        <td>${xp.partyLevel}</td>\n    </tr>\n    <tr>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.Threat")}</th>\n        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats."+xp.rating)} (${xp.totalXP} XP)</td>\n    </tr>\n    <tr>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.Reward")}</th>\n        <td>${xp.xpPerPlayer} XP</td>\n    </tr>\n</table>\n<h2>${game.i18n.localize("PF2E.Encounter.Budget.EncounterBudget")}</h2>\n<table class="pf2-table">\n    <tr>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.Threat")}</th>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.XPBudget")}</th>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.XPNeeded")}</th>\n        <th>${game.i18n.localize("PF2E.Encounter.Budget.Reward")}</th>\n    </tr>\n    <tr>\n        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.trivial")}</td>\n        <td>${xp.encounterBudgets.trivial}</td>\n        <td>${xp.encounterBudgets.trivial-xp.totalXP}</td>\n        <td>40</td>\n    </tr>\n    <tr>\n        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.low")}</td>\n        <td>${xp.encounterBudgets.low}</td>\n        <td>${xp.encounterBudgets.low-xp.totalXP}</td>\n        <td>60</td>\n    </tr>\n    <tr>\n        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.moderate")}</td>\n        <td>${xp.encounterBudgets.moderate}</td>\n        <td>${xp.encounterBudgets.moderate-xp.totalXP}</td>\n        <td>80</td>\n    </tr>\n    <tr>\n        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.severe")}</td>\n        <td>${xp.encounterBudgets.severe}</td>\n        <td>${xp.encounterBudgets.severe-xp.totalXP}</td>\n        <td>120</td>\n    </tr>\n    <tr>\n        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.extreme")}</td>\n        <td>${xp.encounterBudgets.extreme}</td>\n        <td>${xp.encounterBudgets.extreme-xp.totalXP}</td>\n        <td>160</td>\n    </tr>\n</table>\n<h2>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureXPAndRole")}</h2>\n<table class="pf2-table">\n    <tr>\n        <th>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevel")}</th>\n        <th>XP</th>\n        <th>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.SuggestedRole")}</th>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel-4}</td>\n        <td>10</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-4")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel-3}</td>\n        <td>15</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-3")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel-2}</td>\n        <td>20</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-2")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel-1}</td>\n        <td>30</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-1")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel}</td>\n        <td>40</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.0")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel+1}</td>\n        <td>60</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.1")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel+2}</td>\n        <td>80</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.2")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel+3}</td>\n        <td>120</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.3")}</td>\n    </tr>\n    <tr>\n        <td>${xp.partyLevel+4}</td>\n        <td>160</td>\n        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.4")}</td>\n    </tr>\n</table>`}const askLevelPopupTemplate=()=>{const partySize=parseInt(localStorage.getItem("xpMacroPartySize")??4,10),partyLevel=parseInt(localStorage.getItem("xpMacroPartyLevel")??1,10);return`\n    <form>\n    <div class="form-group">\n        <label>${game.i18n.localize("PF2E.Encounter.Budget.PartySize")}</label>\n        <input id="party-size" name="party-size" type="number" value="${partySize}">\n    </div>\n    <div class="form-group">\n        <label>${game.i18n.localize("PF2E.Encounter.Budget.PartyLevel")}</label>\n        <input id="party-level" name="party-level" type="number" value="${partyLevel}">\n    </div>\n    </form>\n    `};function showXP(partyLevel,partySize,npcLevels,hazardLevels){const xp=game.pf2e.gm.calculateXP(partyLevel,partySize,npcLevels,hazardLevels,{proficiencyWithoutLevel:"ProficiencyWithoutLevel"===game.settings.get("pf2e","proficiencyVariant")});new Dialog({title:"XP",content:dialogTemplate(xp),buttons:{}}).render(!0)}!function(){const actors=canvas.tokens.controlled.map((a=>a.actor)),npcLevels=getLevels(actors,"npc"),pcLevels=getLevels(actors,"character"),hazardLevels=function(actors){return actors.filter((a=>"hazard"===a.data.type))}(actors);0!==npcLevels.length||0!==hazardLevels.length?0===pcLevels.length?function(npcLevels,hazardLevels){new Dialog({title:"Party Information",content:askLevelPopupTemplate,buttons:{no:{icon:'<i class="fas fa-times"></i>',label:"Cancel"},yes:{icon:'<i class="fas fa-calculator"></i>',label:"Calculate XP",callback:$html=>{const partySize=parseInt($html[0].querySelector('[name="party-size"]').value,10)??1,partyLevel=parseInt($html[0].querySelector('[name="party-level"]').value,10)??1;localStorage.setItem("xpMacroPartySize",partySize),localStorage.setItem("xpMacroPartyLevel",partyLevel),showXP(partyLevel,partySize,npcLevels,hazardLevels)}}},default:"yes"}).render(!0)}(npcLevels,hazardLevels):showXP(pcLevels[0],pcLevels.length,npcLevels,hazardLevels):ui.notifications.error("You must select at least one npc and/or hazard token and optionally all PC tokens")}();