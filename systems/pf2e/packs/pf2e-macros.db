{"_id":"084MOWWSEVNwpHVG","actorIds":[],"author":"ru9MkwAaWXaeSZph","command":"const tokens = canvas.tokens.controlled.filter((t) => ['character', 'npc', 'familiar'].includes(t.actor.data.type));\n\nif (tokens.length === 0) {\n    ui.notifications.error(`You must select at least one npc/pc token`);\n} else {\n    tokens.map((p) => p.actor).forEach((actor) => actor.data.data.attributes.perception.roll(event, ['secret']));\n}","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.084MOWWSEVNwpHVG"}},"img":"systems/pf2e/icons/spells/vision-of-weakness.webp","name":"Perception For Selected Tokens","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"0GU2sdy3r2MeC56x","actorIds":[],"author":"4rlSA43v1xPa1vsy","command":"const FAST_RECOVERY = 'Compendium.pf2e.feats-srd.N8Xz5fuW6o7GW124';\nconst DREAM_MAY = 'Compendium.pf2e.feats-srd.kqnFdIhToKTnOpMl';\n\nconst levelMultiplier = (actor) =>\n    actor.items.filter((item) => [FAST_RECOVERY, DREAM_MAY].includes(item.data.flags.core?.sourceId)).length + 1;\n\nconst recover = () => {\n    const Character = CONFIG.PF2E.Actor.entityClasses.character;\n    const Condition = CONFIG.PF2E.Item.entityClasses.condition;\n    const tokens = canvas.tokens.controlled.filter((token) => token.actor instanceof Character);\n\n    if (tokens.length === 0) {\n        ui.notifications.warn('Select at least one token.');\n    }\n\n    for (const token of tokens) {\n        const actor = token.actor;\n        const actorData = duplicate(actor.data);\n        const items = Array.from(actor.items.values());\n        const abilities = actorData.data.abilities;\n        const attributes = actorData.data.attributes;\n\n        // Hit points\n        const conModifier = abilities.con.mod;\n        const level = actorData.data.details.level.value;\n        const maxRestored = Math.max(conModifier, 1) * level * levelMultiplier(actor);\n        const hpLost = attributes.hp.max - attributes.hp.value;\n        const hpRestored = hpLost >= maxRestored ? maxRestored : hpLost;\n        attributes.hp.value += hpRestored;\n\n        // Conditions\n        const conditions = items.filter((item) => item.type === 'condition' && item.getFlag('pf2e', 'condition'));\n        const conditionChanges = {};\n\n        // Fatigued condition\n        const fatigued = conditions.find((item) => item.name === 'Fatigued');\n        if (fatigued instanceof Condition) {\n            PF2eConditionManager.removeConditionFromToken(fatigued.id, token);\n            conditionChanges.Fatigued = null;\n        }\n\n        // Doomed and Drained conditions\n        for (const conditionName of ['Doomed', 'Drained']) {\n            const doomedOrDrained = conditions.find((condition) => condition.name === conditionName);\n            if (doomedOrDrained === undefined) {\n                continue;\n            }\n            const value = doomedOrDrained.data.data.value.value;\n            if (value === 1) {\n                PF2eConditionManager.removeConditionFromToken(doomedOrDrained.id, token);\n                conditionChanges[conditionName] = null;\n            } else {\n                const newValue = value - 1;\n                PF2eConditionManager.updateConditionValue(doomedOrDrained.id, token, newValue);\n                conditionChanges[conditionName] = newValue;\n            }\n        }\n\n        // Restore wand charges\n\n        const wands = items.filter((i) => i.data.data.consumableType?.value === 'wand');\n        let wandRecharged = false;\n        const updateData = wands.map((w) => {\n            return { _id: w.id, 'data.charges.value': parseInt(w.data.data.charges.max) };\n        });\n        if (updateData.length > 0) {\n            wandRecharged = true;\n        }\n\n        // Spellcasting entries\n        const restoredList = [];\n        const entries = items.filter((item) => item.type === 'spellcastingEntry');\n        const entriesUpdateData = entries.flatMap((entry) => {\n            const entryType = entry.data.data.prepared.value ? entry.data.data.prepared.value : 'focus';\n\n            // Focus spells\n            if (entryType === 'focus') {\n                const focusPool = duplicate(entry.data.data.focus);\n                if (focusPool.points < focusPool.pool) {\n                    focusPool.points = focusPool.pool;\n                    restoredList.push('Focus Pool');\n                    return { _id: entry.id, 'data.focus': focusPool };\n                }\n\n                return [];\n            }\n\n            // Innate, Spontaneous, and Prepared spells\n            const slots = entry.data.data.slots;\n            let updated = false;\n            for (const slot of Object.values(slots)) {\n                if (['spontaneous', 'innate'].includes(entryType)) {\n                    if (slot.value < slot.max) {\n                        slot.value = slot.max;\n                        updated = true;\n                    }\n                } else {\n                    for (const preparedSpell of Object.values(slot.prepared)) {\n                        if (preparedSpell.expended) {\n                            preparedSpell.expended = false;\n                            updated = true;\n                        }\n                    }\n                }\n            }\n\n            if (updated) {\n                restoredList.push(entryType === 'focus' ? 'Focus Pool' : `${entry.name} spell slots`);\n                return { _id: entry.id, 'data.slots': slots };\n            }\n            return [];\n        });\n\n        updateData.push(...entriesUpdateData);\n\n        // Stamina points\n        const staminaSetting = game.settings.storage.get('world').get('pf2e.staminaVariant');\n        const staminaEnabled = staminaSetting ? Boolean(parseInt(staminaSetting.replace(/\"/g, ''), 10)) : false;\n\n        if (staminaEnabled) {\n            const stamina = attributes.sp;\n            const keyAbility = actorData.data.details.keyability.value;\n            if (stamina.value < stamina.max) {\n                stamina.value = stamina.max;\n                restoredList.push('Stamina');\n            }\n            const resolve = attributes.resolve;\n            const maxResolve = abilities[keyAbility].mod;\n            if (resolve.value < maxResolve) {\n                resolve.value = maxResolve;\n                restoredList.push('Resolve');\n            }\n        }\n\n        // Updated actor with the sweet fruits of rest\n        if (hpRestored > 0 || restoredList.length > 0) {\n            actor.update({ 'data.attributes': attributes });\n        }\n        if (updateData.length > 0) {\n            actor.updateOwnedItem(updateData);\n        }\n\n        // Construct messages\n        const messages = [`${token.name} awakens well-rested.`];\n\n        // Hit-point restoration\n        if (hpRestored > 0) {\n            messages.push(`${hpRestored} hit points restored.`);\n        }\n\n        // Wand recharge\n        if (wandRecharged) {\n            messages.push('Spellcasting wands recharged.');\n        }\n\n        // Attribute restoration\n        const restoredString =\n            restoredList.length === 0\n                ? ''\n                : restoredList.length === 1\n                ? `${restoredList[0]}`\n                : restoredList.length === 2\n                ? `${restoredList.join(' and ')}`\n                : `${restoredList.slice(0, -1).join(', ')}, and ` + `${restoredList.slice(-1)[0]}`;\n        messages.push(restoredList.length > 0 ? `${restoredString} fully restored.` : null);\n\n        // Condition removal\n        const removedConditions = Object.keys(conditionChanges).filter((key) => conditionChanges[key] === null);\n        const removedString =\n            removedConditions.length === 0\n                ? ''\n                : removedConditions.length === 1\n                ? `${removedConditions[0]}`\n                : removedConditions.length === 2\n                ? `${removedConditions.join(' or ')}`\n                : `${restoredList.slice(0, -1).join(', ')}, or ` + `${restoredList.slice(-1)[0]}`;\n        messages.push(removedConditions.length > 0 ? `No longer ${removedString}.` : null);\n\n        // Condition value reduction\n        const reducedConditions = Object.keys(conditionChanges).filter((key) =>\n            Number.isInteger(conditionChanges[key]),\n        );\n        const reducedString =\n            reducedConditions.length === 0\n                ? ''\n                : reducedConditions.length === 1\n                ? `${reducedConditions[0]} condition`\n                : `${reducedConditions.join(' and ')} conditions`;\n        messages.push(reducedConditions.length > 0 ? `${reducedString} reduced by 1.` : null);\n\n        // Send chat message with results\n        ChatMessage.create({\n            user: game.user.id,\n            content: messages.join(' '),\n            speaker: { alias: token.name },\n        });\n    }\n};\n\nnew Dialog({\n    title: 'Rest',\n    content: '<p>Rest for the night?</p>',\n    buttons: {\n        yes: {\n            icon: '<i class=\"fas fa-check\"></i>',\n            label: 'Rest',\n            callback: recover,\n        },\n        no: {\n            icon: '<i class=\"fas fa-times\"></i>',\n            label: 'Cancel',\n        },\n    },\n    default: 'yes',\n}).render(true);","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.0GU2sdy3r2MeC56x"}},"img":"icons/svg/sleep.svg","name":"Rest for the Night","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"4nEbRlo2cB9KkK7T","actorIds":[],"author":"uAvrJeywnWLwQIhl","command":"let ITEM_UUID = 'Compendium.pf2e.feat-effects.gYpy9XBPScIlY93p'; // Stance: Mountain Stance\n\nfunction checkFeat(slug) {\n    if (token.actor.items.find((i) => i.data.data.slug === slug && i.type === 'feat')) {\n        return true;\n    }\n    return false;\n}\n\nif (checkFeat('mountain-stronghold')) {\n    ITEM_UUID = 'Compendium.pf2e.feat-effects.LXbVcutEIW8eWZEz';\n}\nif (checkFeat('mountain-quake')) {\n    ITEM_UUID = 'Compendium.pf2e.feat-effects.wuERa7exfXXl6I37';\n}\n\n(async () => {\n    const effect = duplicate(await fromUuid(ITEM_UUID));\n    effect.flags.core = effect.flags.core ?? {};\n    effect.flags.core.sourceId = effect.flags.core.sourceId ?? ITEM_UUID;\n    for await (const token of canvas.tokens.controlled) {\n        let existing = token.actor.items.find(\n            (i) => i.type === 'effect' && i?.data?.flags?.core?.sourceId === ITEM_UUID,\n        );\n        if (existing) {\n            token.actor.deleteOwnedItem(existing._id);\n        } else {\n            let clothingPotency = 0;\n            const clothing = token.actor.items\n                .filter((item) => item.data.type === 'armor')\n                ?.filter((item) => item.data.data.slug === 'clothing-explorers')\n                ?.find((item) => item.data.data.equipped.value);\n            if (clothing) {\n                clothingPotency = parseInt(clothing.data?.data?.potencyRune?.value);\n            }\n            let bracers = token.actor.items\n                .filter((item) => item.data.type === 'equipment')\n                ?.filter((item) => item.data.data.slug === 'bracers-of-armor-i')\n                ?.filter((item) => item.data.data.equipped.value)\n                ?.find((item) => item.data.data.invested.value)\n                ? 1\n                : 0;\n            bracers = token.actor.items\n                .filter((item) => item.data.type === 'equipment')\n                ?.filter((item) => item.data.data.slug === 'bracers-of-armor-ii')\n                ?.filter((item) => item.data.data.equipped.value)\n                ?.find((item) => item.data.data.invested.value)\n                ? 2\n                : bracers;\n            bracers = token.actor.items\n                .filter((item) => item.data.type === 'equipment')\n                ?.filter((item) => item.data.data.slug === 'bracers-of-armor-iii')\n                ?.filter((item) => item.data.data.equipped.value)\n                ?.find((item) => item.data.data.invested.value)\n                ? 3\n                : bracers;\n            let mageArmorBonus = 0;\n            const mageArmor = token.actor.items\n                .filter((item) => item.data.type === 'effect')\n                ?.find((item) => item.data.data.slug === 'spell-effect-mage-armor');\n            if (mageArmor) {\n                mageArmorBonus = mageArmor.data.data.level.value === 10 ? 3 : mageArmor.data.data.level.value >= 5 ? 2 : 1;\n            }\n            let itemBonus = Math.max(bracers, clothingPotency, mageArmorBonus);\n            const rule = effect.data.rules.find(\n                (r) => r.selector === 'ac' && r.key === 'PF2E.RuleElement.FlatModifier',\n            );\n            if (rule) {\n                rule.value = rule.value + itemBonus;\n            }\n            token.actor.createOwnedItem(effect);\n        }\n    }\n})();\n","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.4nEbRlo2cB9KkK7T"}},"img":"systems/pf2e/icons/features/feats/mountain-stance.webp","name":"Toggle Mountain Stance","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"6duZj0Ygiqv712rq","actorIds":[],"author":"4rlSA43v1xPa1vsy","command":"function CheckFeat(slug) {\n    if (token.actor.items.find((i) => i.data.data.slug === slug && i.type === 'feat')) {\n        return true;\n    }\n    return false;\n}\nconst rollTreatWounds = async ({ DC, bonus, med, riskysurgery, mortalhealing }) => {\n    const options = actor.getRollOptions(['all', 'skill-check', 'medicine']);\n\n    options.push('treat wounds');\n    options.push('action:treat-wounds');\n\n    const dc = {\n        value: DC,\n    };\n    if (riskysurgery || mortalhealing) {\n        dc.modifiers = {\n            success: 'one-degree-better',\n        };\n    }\n    if (riskysurgery) {\n        options.push('risky-surgery');\n    }\n\n    med.roll({\n        dc: dc,\n        event: event,\n        options: options,\n        callback: (roll) => {\n            let healFormula, successLabel;\n            const magicHands = CheckFeat('magic-hands');\n\n            const bonusString = bonus > 0 ? `+ ${bonus}` : '';\n            if (roll.data.degreeOfSuccess === 3) {\n                healFormula = magicHands ? `32${bonusString}` : `4d8${bonusString}`;\n                successLabel = 'Critical Success';\n            } else if (roll.data.degreeOfSuccess === 2) {\n                healFormula = magicHands ? `16${bonusString}` : `2d8${bonusString}`;\n                successLabel = 'Success';\n            } else if (roll.data.degreeOfSuccess === 1) {\n                successLabel = 'Failure';\n            } else if (roll.data.degreeOfSuccess === 0) {\n                healFormula = '1d8';\n                successLabel = 'Critical Failure';\n            }\n            if (riskysurgery) {\n                healFormula = roll.data.degreeOfSuccess > 1 ? `${healFormula}-1d8` : healFormula ? `2d8` : `1d8`;\n            }\n            if (healFormula !== undefined) {\n                const healRoll = new Roll(healFormula).roll();\n                const rollType = roll.data.degreeOfSuccess > 1 ? 'Healing' : 'Damage';\n                ChatMessage.create(\n                    {\n                        user: game.user.id,\n                        type: CHAT_MESSAGE_TYPES.ROLL,\n                        flavor: `<strong>${rollType} Roll: Treat Wounds</strong> (${successLabel})`,\n                        roll: healRoll,\n                        speaker: ChatMessage.getSpeaker(),\n                    },\n                    {},\n                );\n            }\n        },\n    });\n};\n\nasync function applyChanges($html) {\n    for (const token of canvas.tokens.controlled) {\n        var { med } = token.actor.data.data.skills;\n        const { name } = token;\n        const mod = parseInt($html.find('[name=\"modifier\"]').val()) || 0;\n        const requestedProf = parseInt($html.find('[name=\"dc-type\"]')[0].value) || 1;\n        const riskysurgery = $html.find('[name=\"risky_surgery_bool\"]')[0]?.checked;\n        const mortalhealing = $html.find('[name=\"mortal_healing_bool\"]')[0]?.checked;\n        const skill = $html.find('[name=\"skill\"]')[0]?.value;\n\n        // Handle Rule Interpretation\n        if (game.user.isGM) {\n            await game.settings.set(\n                'pf2e',\n                'RAI.TreatWoundsAltSkills',\n                $html.find('[name=\"strict_rules\"]')[0]?.checked,\n            );\n        }\n\n        var usedProf = 0;\n\n        if (game.settings.get('pf2e', 'RAI.TreatWoundsAltSkills')) {\n            if (skill === 'cra') {\n                med = token.actor.data.data.skills['cra'];\n            }\n            if (skill === 'nat') {\n                med = token.actor.data.data.skills['nat'];\n            }\n            usedProf = requestedProf <= med.rank ? requestedProf : med.rank;\n        } else {\n            usedProf = requestedProf <= med.rank ? requestedProf : med.rank;\n            if (skill === 'cra') {\n                med = token.actor.data.data.skills['cra'];\n            }\n            if (skill === 'nat') {\n                med = token.actor.data.data.skills['nat'];\n                if (usedProf === 0) {\n                    usedProf = 1;\n                }\n            }\n        }\n        const medicBonus = CheckFeat('medic-dedication') ? (usedProf - 1) * 5 : 0;\n        const roll = [\n            () => ui.notifications.warn(`${name} is not trained in Medicine and doesn't know how to treat wounds.`),\n            () => rollTreatWounds({ DC: 15 + mod, bonus: 0 + medicBonus, med, riskysurgery, mortalhealing }),\n            () => rollTreatWounds({ DC: 20 + mod, bonus: 10 + medicBonus, med, riskysurgery, mortalhealing }),\n            () => rollTreatWounds({ DC: 30 + mod, bonus: 30 + medicBonus, med, riskysurgery, mortalhealing }),\n            () => rollTreatWounds({ DC: 40 + mod, bonus: 50 + medicBonus, med, riskysurgery, mortalhealing }),\n        ][usedProf];\n\n        roll();\n    }\n}\n\nif (token === undefined) {\n    ui.notifications.warn('No token is selected.');\n} else {\n    const chirurgeon = CheckFeat('chirurgeon');\n    const naturalMedicine = CheckFeat('natural-medicine');\n    const dialog = new Dialog({\n        title: 'Treat Wounds',\n        content: `\n<div>Select a target DC. Remember that you can't attempt a heal above your proficiency. Attempting to do so will downgrade the DC and amount healed to the highest you're capable of.</div>\n<hr/>\n${\n    chirurgeon || naturalMedicine\n        ? `\n<form>\n<div class=\"form-group\">\n<label>Treat Wounds Skill:</label>\n\n<select id=\"skill\" name=\"skill\">\n<option value=\"med\">Medicine</option>\n\n${chirurgeon ? `<option value=\"cra\">Crafting</option>` : ``}\n${naturalMedicine ? `<option value=\"nat\">Nature</option>` : ``}\n</select>\n</div>\n</form>\n`\n        : ``\n}\n<form>\n<div class=\"form-group\">\n<label>Medicine DC:</label>\n<select id=\"dc-type\" name=\"dc-type\">\n<option value=\"1\">Trained DC 15</option>\n<option value=\"2\">Expert DC 20, +10 Healing</option>\n<option value=\"3\">Master DC 30, +30 Healing</option>\n<option value=\"4\">Legendary DC 40, +50 Healing</option>\n</select>\n</div>\n</form>\n<form>\n<div class=\"form-group\">\n<label>DC Modifier:</label>\n<input id=\"modifier\" name=\"modifier\" type=\"number\"/>\n</div>\n</form>\n${\n    CheckFeat('risky-surgery')\n        ? `<form><div class=\"form-group\">\n<label>Risky Surgery</label>\n<input type=\"checkbox\" id=\"risky_surgery_bool\" name=\"risky_surgery_bool\"></input>\n</div></form>`\n        : ``\n}\n${\n    CheckFeat('mortal-healing')\n        ? `<form><div class=\"form-group\">\n<label>Mortal Healing</label>\n<input type=\"checkbox\" id=\"mortal_healing_bool\" name=\"mortal_healing_bool\" checked></input>\n</div></form>`\n        : ``\n}\n${\n    game.user.isGM\n        ? `<form><div class=\"form-group\">\n<label>Allow higher DC from alternate skills?</label>\n<input type=\"checkbox\" id=\"strict_rules\" name=\"strict_rules\"` +\n          (game.settings.get('pf2e', 'RAI.TreatWoundsAltSkills') ? ` checked` : ``) +\n          `></input>\n</div></form>`\n        : ``\n}\n</form>\n`,\n        buttons: {\n            yes: {\n                icon: `<i class=\"fas fa-hand-holding-medical\"></i>`,\n                label: 'Treat Wounds',\n                callback: applyChanges,\n            },\n            no: {\n                icon: `<i class=\"fas fa-times\"></i>`,\n                label: 'Cancel',\n            },\n        },\n        default: 'yes',\n    });\n    dialog.render(true);\n}\n","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.6duZj0Ygiqv712rq"}},"img":"icons/svg/regen.svg","name":"Treat Wounds","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"MAHxEeGf31wqv3jp","actorIds":[],"author":"oxKN2HrOvz2sSqlF","command":"/**\n * @typedef {{data: {data: {details: {level: number|string|undefined|null, isComplex: boolean}}, type: string}}} Hazard\n */\n\n/**\n * @param actors {Array<Hazard>}\n * @param type {string}\n * @returns {Array<HazardLevel>}\n */\nfunction getHazardLevels(actors, type) {\n    return actors\n        .filter((a) => a.data.type === type)\n        .map((a) => {\n            return {\n                level: parseInt(a.data.data.details.level ?? 1, 10),\n                isComplex: a.data.data.details.isComplex ?? false,\n            };\n        });\n}\n\n/**\n * @typedef {{data: {data: {details: {level: {value: number|string|undefined|null}}}, type: string}}} Actor\n */\n\n/**\n * @param actors {Array<Actor>}\n * @param type {string}\n * @returns {Array<number>}\n */\nfunction getLevels(actors, type) {\n    return actors.filter((a) => a.data.type === type).map((a) => parseInt(a.data.data.details.level.value ?? '1', 10));\n}\n\n/**\n * @param xp {XP}\n * @returns {string}\n */\nfunction dialogTemplate(xp) {\n    return `\n<h2>XP</h2>\n<table>\n    <tr>\n        <th>Party</th>\n        <td>PCs: ${xp.partySize} (Lv ${xp.partyLevel})</td>\n    </tr>\n    <tr>\n        <th>Rating</th>\n        <td>${xp.rating} (${xp.xpPerPlayer} XP)</td>\n    </tr>\n    <tr>\n        <th>Total XP</th>\n        <td>PCs: ${xp.encounterBudgets.moderate} XP, NPCs & Hazards: ${xp.totalXP} XP</td>\n    </tr>\n</table>\n<h2>Budgets</h2>\n<table>\n    <tr>\n        <th>Trivial</th>\n        <td>${xp.encounterBudgets.trivial} XP</td>\n    </tr>\n    <tr>\n        <th>Low</th>\n        <td>${xp.encounterBudgets.low} XP</td>\n    </tr>\n    <tr>\n        <th>Moderate</th>\n        <td>${xp.encounterBudgets.moderate} XP</td>\n    </tr>\n    <tr>\n        <th>Severe</th>\n        <td>${xp.encounterBudgets.severe} XP</td>\n    </tr>\n    <tr>\n        <th>Extreme</th>\n        <td>${xp.encounterBudgets.extreme} XP</td>\n    </tr>\n</table>`;\n}\n\nconst askLevelPopupTemplate = () => {\n    const partySize = parseInt(localStorage.getItem('xpMacroPartySize') ?? 4, 10);\n    const partyLevel = parseInt(localStorage.getItem('xpMacroPartyLevel') ?? 1, 10);\n    return `\n    <form>\n    <div class=\"form-group\">\n        <label>Party Size</label>\n        <input id=\"party-size\" name=\"party-size\" type=\"number\" value=\"${partySize}\">\n    </div>\n    <div class=\"form-group\">\n        <label>Party level</label>\n        <input id=\"party-level\" name=\"party-level\" type=\"number\" value=\"${partyLevel}\">\n    </div>\n    </form>\n    `;\n};\n\n/**\n * @param partyLevel {number}\n * @param partySize {number}\n * @param npcLevels {Array<number>}\n * @param hazardLevels {Array<HazardLevel>}\n */\nfunction showXP(partyLevel, partySize, npcLevels, hazardLevels) {\n    const xp = game.pf2e.gm.calculateXP(partyLevel, partySize, npcLevels, hazardLevels, {\n        proficiencyWithoutLevel: game.settings.get('pf2e', 'proficiencyVariant') === 'ProficiencyWithoutLevel',\n    });\n    new Dialog({\n        title: 'XP',\n        content: dialogTemplate(xp),\n        buttons: {},\n    }).render(true);\n}\n\n/**\n * @param npcLevels {Array<number>}\n * @param hazardLevels {Array<HazardLevel>}\n */\nfunction askPartyLevelAndSize(npcLevels, hazardLevels) {\n    new Dialog({\n        title: 'Party Information',\n        content: askLevelPopupTemplate,\n        buttons: {\n            no: {\n                icon: '<i class=\"fas fa-times\"></i>',\n                label: 'Cancel',\n            },\n            yes: {\n                icon: '<i class=\"fas fa-calculator\"></i>',\n                label: 'Calculate XP',\n                callback: ($html) => {\n                    const partySize = parseInt($html[0].querySelector('[name=\"party-size\"]').value, 10) ?? 1;\n                    const partyLevel = parseInt($html[0].querySelector('[name=\"party-level\"]').value, 10) ?? 1;\n                    // persist for future uses\n                    localStorage.setItem('xpMacroPartySize', partySize);\n                    localStorage.setItem('xpMacroPartyLevel', partyLevel);\n                    showXP(partyLevel, partySize, npcLevels, hazardLevels);\n                },\n            },\n        },\n        default: 'yes',\n    }).render(true);\n}\n\nfunction main() {\n    const actors = canvas.tokens.controlled.map((a) => a.actor);\n\n    const npcLevels = getLevels(actors, 'npc');\n    const pcLevels = getLevels(actors, 'character');\n    const hazardLevels = getHazardLevels(actors, 'hazard');\n\n    if (npcLevels.length === 0 && hazardLevels.length === 0) {\n        ui.notifications.error(`You must select at least one npc and/or hazard token and optionally all PC tokens`);\n        return;\n    }\n\n    if (pcLevels.length === 0) {\n        askPartyLevelAndSize(npcLevels, hazardLevels);\n    } else {\n        showXP(pcLevels[0], pcLevels.length, npcLevels, hazardLevels);\n    }\n}\n\nmain();","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.MAHxEeGf31wqv3jp"}},"img":"systems/pf2e/icons/spells/athletic-rush.webp","name":"XP","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"NQkc5rKoeFemdVHr","actorIds":[],"author":"ru9MkwAaWXaeSZph","command":"const tokens = canvas.tokens.controlled;\n\nif (tokens.length === 0) {\n    ui.notifications.error(`You must select at least one pc token`);\n} else {\n    game.pf2e.gm.launchTravelSheet(tokens.map((p) => p.actor));\n}","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.NQkc5rKoeFemdVHr"}},"img":"systems/pf2e/icons/equipment/adventuring-gear/cartographers-kit.webp","name":"Travel Duration","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"aS6F7PSUlS9JM5jr","actorIds":[],"author":"gE95JAZb6BOLkaNX","command":"let toChat = (content) => {\r\n    let chatData = {\r\n        user: game.user.id,\r\n        content,\r\n        speaker: ChatMessage.getSpeaker(),\r\n    }\r\n    ChatMessage.create(chatData, {})\r\n}\r\n\r\nlet applyChanges = false;\r\nnew Dialog({\r\n  title: `Take a Breather`,\r\n  content: `\r\n    <div>Rest for 10 minutes, spend a resolve point, and regain stamina?</div>\r\n    `,\r\n  buttons: {\r\n    yes: {\r\n      icon: \"<i class='fas fa-check'></i>\",\r\n      label: `Take a Breather`,\r\n      callback: () => applyChanges = true\r\n    },\r\n    no: {\r\n      icon: \"<i class='fas fa-times'></i>\",\r\n      label: `Cancel`\r\n    },\r\n  },\r\n  default: \"yes\",\r\n  close: html => {\r\n    if (applyChanges) {\r\n        for ( let token of canvas.tokens.controlled ) {\r\n            const {name} = token;\r\n            console.log(token);\r\n            const {resolve, sp} = token.actor.data.data.attributes;\r\n            console.log(resolve, sp);\r\n            if (resolve.value > 0) {\r\n                let oldSP = sp.value;\r\n                toChat(`${name} has ${sp.value}/${sp.max} SP and spends a resolve point, taking a 10 minute breather. Stamina Refreshed.`);\r\n                token.actor.update({\r\n                    'data.attributes.sp.value': sp.max,\r\n                    'data.attributes.resolve.value': resolve.value-1\r\n                });\r\n            } else {\r\n                toChat(`${name} is tired and needs to go to bed! No resolve points remaining.`);\r\n            }\r\n        }\r\n      }\r\n    }\r\n}).render(true);","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.aS6F7PSUlS9JM5jr"}},"img":"icons/svg/unconscious.svg","name":"Take a Breather","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"jO4Ipjz3BGo6ZzG9","actorIds":[],"author":"lO8uxG8O9SiAPpi1","command":"function CoverMacro() {\n    if (!actor) {\n        ui.notifications.warn(\"You must have an actor selected.\");\n        return;\n    }\n    coverDialog(actor).render(true);\n}\n\nfunction coverDialog(pc) {\n\n  const optsCover = [\n      {name: \"Lesser\"},\n      {name: \"Standard\"},\n      {name: \"Greater\"},\n      {name: \"Clear\"},\n  ]    \n  let coveringUp;\n\n  let content = `<p><strong>Character:</strong> ${pc.name}<br/>`;\n  content += '</p>';\n  content += '<hr/>';\n  content += '<div class=\"form-group\">';\n  content += '<p><label>Cover Type : </label><select id=\"coverType\">';\n  for (let i = 0 ; i < optsCover.length ; i++) {\n    content += `<option value='${i}'`;\n    content += `>${optsCover[i].name}</option>`;\n  }\n  content += '</select></p>';\n  content += '</div>';\n\n  return new Dialog({\n    title: \"Cover\",\n    content: content,\n    buttons: {\n      roll: {\n        icon: \"<i class='fas fa-check'></i>\",\n        label: \"Activate\",\n        callback: () => coveringUp = true,\n      },\n      cancel: {\n        icon: \"<i class='fas fa-times'></i>\",\n        label: \"Cancel\",\n        callback: () => coveringUp = false,\n      },\n    },\n    default: \"Activate\",\n    close: html => {\n        if (coveringUp) {\n            let chosenCover = optsCover[html.find('#coverType')[0].value];\n            activateCover(chosenCover.name);\n        }\n    }\n  });\n}\n\nasync function activateCover(chosenCover) {\n\n    let msgContent;\n    let myCover;\n    let takingCover = true;\n    let lesserCover = 'Compendium.pf2e.equipment-effects.lKkQvMzNG55Yhyef';\n    let standardCover = 'Compendium.pf2e.equipment-effects.I9lfZUiCwMiGogVi';\n    let greaterCover = 'Compendium.pf2e.equipment-effects.dlxrYwsliiZbsTYB';\n    let allCovers = [lesserCover, standardCover, greaterCover];\n    switch(chosenCover) {\n        case 'Clear':\n            var i;\n            for(i=0; i< allCovers.length; i++){\n                let item = await fromUuid(allCovers[i]);\n                let existing = actor.items.filter(j => j.type === item.type).find(e => e.name === item.name);\n                if (existing) {\n                    await token.actor.deleteOwnedItem(existing._id);\n                }\n            }\n            msgContent = \"Clearing cover modifiers for \";\n            takingCover = false;\n            break;\n        case 'Lesser':\n            myCover = lesserCover;\n            msgContent = \"Granting lesser cover to \";\n            break;\n        case 'Standard':\n            myCover = standardCover;\n            msgContent = \"Granting standard cover to \";\n            break;\n        case 'Greater':\n            myCover = greaterCover;\n            msgContent = \"Granting greater cover to \";\n            break;\n        default:\n    }\n\n    \n    if (takingCover) {\n        const item = await fromUuid(myCover);\n        await token.actor.createOwnedItem(item);    \n    }\n    \n    msgContent = msgContent + actor.data.name\n\n    let chatData = {\n        user: game.user._id,\n        content: msgContent,\n        whisper: [game.user._id],\n    };\n    ChatMessage.create(chatData, {});\n}\n\n\nCoverMacro()","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.jO4Ipjz3BGo6ZzG9"}},"img":"systems/pf2e/icons/actions/OneAction.webp","name":"Take Cover","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"mxHKWibjPrgfJTDg","actorIds":[],"author":"ru9MkwAaWXaeSZph","command":"function escapeHtml(html) {\n    const text = document.createTextNode(html);\n    const p = document.createElement('p');\n    p.appendChild(text);\n    return p.innerHTML;\n}\n\nfunction capitalize(s) {\n    return s.charAt(0).toUpperCase() + s.slice(1);\n}\n\nfunction isExperiencedProfessional(actor) {\n    return actor.data.items.some((item) => item.type === 'feat' && item.name === 'Experienced Professional');\n}\n\nfunction rankToProficiency(rank) {\n    if (rank === 0) {\n        return 'untrained';\n    } else if (rank === 1) {\n        return 'trained';\n    } else if (rank === 2) {\n        return 'expert';\n    } else if (rank === 3) {\n        return 'master';\n    } else {\n        return 'legendary';\n    }\n}\n\nfunction degreeOfSuccessLabel(degreeOfSuccessLabel) {\n    if (degreeOfSuccessLabel === 0) {\n        return 'Critical Failure';\n    } else if (degreeOfSuccessLabel === 1) {\n        return 'Failure';\n    } else if (degreeOfSuccessLabel === 2) {\n        return 'Success';\n    } else {\n        return 'Critical Success';\n    }\n}\n\nfunction coinsToString(coins, degreeOfSuccess) {\n    if (degreeOfSuccess === 'Critical Failure') {\n        return 'none';\n    } else {\n        return Object.entries(coins)\n            .map(([key, value]) => `${value} ${CONFIG.PF2E.currencies[key]}`)\n            .join(', ');\n    }\n}\n\nfunction chatTemplate(skillName, earnIncomeResult) {\n    const degreeOfSuccess = degreeOfSuccessLabel(earnIncomeResult.degreeOfSuccess);\n    const payPerDay = escapeHtml(coinsToString(earnIncomeResult.rewards.perDay, degreeOfSuccess));\n    const combinedPay = escapeHtml(coinsToString(earnIncomeResult.rewards.combined, degreeOfSuccess));\n    const level = earnIncomeResult.level;\n    const daysSpentWorking = earnIncomeResult.daysSpentWorking;\n    const forDays =\n        daysSpentWorking > 1 ? `<p><strong>Salary for ${daysSpentWorking} days</strong>: ${combinedPay}</p>` : '';\n    const successColor = earnIncomeResult.degreeOfSuccess > 1 ? 'darkgreen' : 'darkred';\n    const dc = earnIncomeResult.dc;\n    const roll = earnIncomeResult.roll;\n    return `\n    <div class=\"pf2e chat-card\">\n        <header class=\"card-header flexrow\">\n            <img src=\"systems/pf2e/icons/equipment/treasure/currency/gold-pieces.webp\" title=\"Income\" width=\"36\" height=\"36\">\n            <h3>Earn Income Level ${level}</h3>\n        </header>\n        <div class=\"card-content\">\n            <p><strong>Result</strong>: <span style=\"color: ${successColor}\">${degreeOfSuccess} (DC: ${dc}, Roll: ${roll})</span></p>\n            <p><strong>Skill</strong>: ${escapeHtml(skillName)}</p>\n            <p><strong>Salary per day:</strong> ${payPerDay}</p>\n            ${forDays}\n        </div>\n    </div>\n    `;\n}\n\nfunction postToChat(skillName, earnIncomeResult) {\n    const content = chatTemplate(skillName, earnIncomeResult);\n    const chatData = {\n        user: game.user.id,\n        content,\n        speaker: ChatMessage.getSpeaker(),\n    };\n    ChatMessage.create(chatData, {});\n}\n\nfunction isProficiencyWithoutLevel() {\n    return game.settings.get('pf2e', 'proficiencyVariant') === 'ProficiencyWithoutLevel';\n}\n\nfunction calculateIncome(actor, skill, roll, level, days) {\n    const dcOptions = {\n        proficiencyWithoutLevel: isProficiencyWithoutLevel(),\n    };\n    const earnIncomeOptions = {\n        useLoreAsExperiencedProfessional: isExperiencedProfessional(actor) && skill.isLore,\n    };\n    const income = game.pf2e.actions.earnIncome(level, days, roll, skill.proficiency, earnIncomeOptions, dcOptions);\n    postToChat(skill.name, income);\n}\n\nfunction runEarnIncome(actor, skill, assurance, level, days) {\n    if (assurance) {\n        const actorLevel = actor.data.data.details?.level?.value ?? 1;\n        const proficiencyLevel = isProficiencyWithoutLevel() ? 0 : actorLevel;\n        const proficiencyBonus = proficiencyLevel + skill.rank * 2;\n        calculateIncome(actor, skill, { dieValue: 10, modifier: proficiencyBonus }, level, days);\n    } else {\n        const options = actor.getRollOptions(['all', 'skill-check', skill.name]);\n        options.push('earn-income');\n        game.pf2e.Check.roll(\n            new game.pf2e.CheckModifier(\n                '<span style=\"font-family: Pathfinder2eActions\">A</span> Earn Income',\n                actor.data.data.skills[skill.acronym],\n                [],\n            ),\n            { actor, type: 'skill-check', options },\n            event,\n            (roll) => {\n                const dieValue = roll.results[0];\n                const modifier = roll._total - dieValue;\n                calculateIncome(actor, skill, { dieValue, modifier }, level, days);\n            },\n        );\n    }\n}\n\nfunction getSkills(actor) {\n    return (\n        Object.entries(actor.data.data.skills)\n            .map(([acronym, value]) => {\n                return {\n                    acronym,\n                    name: capitalize(value.name),\n                    isLore: value.lore === true,\n                    proficiency: rankToProficiency(value.rank),\n                    rank: value.rank,\n                };\n            })\n            // earn income is a trained action\n            .filter((skill) => skill.proficiency !== 'untrained')\n    );\n}\n\nfunction askSkillPopupTemplate(skills) {\n    const level = parseInt(localStorage.getItem('earnIncomeLevel') ?? 0, 10);\n    const days = parseInt(localStorage.getItem('earnIncomeDays') ?? 1, 10);\n    const skillAcronym = localStorage.getItem('earnIncomeSkillAcronym');\n    const assurance = localStorage.getItem('earnIncomeAssurance') === 'true';\n    return `\n    <form>\n    <div class=\"form-group\">\n        <label>Trained Skills/Lores</label>\n        <select name=\"skillAcronym\">\n            ${skills\n                .map(\n                    (skill) =>\n                        `<option value=\"${skill.acronym}\" ${\n                            skillAcronym === skill.acronym ? 'selected' : ''\n                        }>${escapeHtml(skill.name)}</option>`,\n                )\n                .join('')}\n        </select>\n    </div>\n    <div class=\"form-group\">\n        <label>Use Assurance</label>\n        <input name=\"assurance\" type=\"checkbox\" ${assurance ? 'checked' : ''}>\n    </div>\n    <div class=\"form-group\">\n        <label>Level</label>\n        <select name=\"level\">\n            ${Array(21)\n                .fill(0)\n                .map((_, index) => `<option value=\"${index}\" ${index === level ? 'selected' : ''}>${index}</option>`)\n                .join('')}\n        </select>\n    </div>\n    <div class=\"form-group\">\n        <label>Days</label>\n        <input type=\"number\" name=\"days\" value=\"${days}\">\n    </div>\n    </form>\n    `;\n}\n\nfunction showEarnIncomePopup(actor) {\n    if (actor === null || actor === undefined) {\n        ui.notifications.error(`You must select at least one PC`);\n    } else {\n        const skills = getSkills(actor);\n        new Dialog({\n            title: 'Earn Income',\n            content: askSkillPopupTemplate(skills),\n            buttons: {\n                no: {\n                    icon: '<i class=\"fas fa-times\"></i>',\n                    label: 'Cancel',\n                },\n                yes: {\n                    icon: '<i class=\"fas fa-coins\"></i>',\n                    label: 'Earn Income',\n                    callback: ($html) => {\n                        const level = parseInt($html[0].querySelector('[name=\"level\"]').value, 10) ?? 1;\n                        const days = parseInt($html[0].querySelector('[name=\"days\"]').value, 10) ?? 1;\n                        const skillAcronym = $html[0].querySelector('[name=\"skillAcronym\"]').value;\n                        const assurance = $html[0].querySelector('[name=\"assurance\"]').checked;\n                        const skill = skills.find((skill) => skill.acronym === skillAcronym);\n                        localStorage.setItem('earnIncomeLevel', level);\n                        localStorage.setItem('earnIncomeDays', days);\n                        localStorage.setItem('earnIncomeSkillAcronym', skillAcronym);\n                        localStorage.setItem('earnIncomeAssurance', assurance);\n                        runEarnIncome(actor, skill, assurance, level, days);\n                    },\n                },\n            },\n            default: 'yes',\n        }).render(true);\n    }\n}\n\nshowEarnIncomePopup(actor);","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.mxHKWibjPrgfJTDg"}},"img":"systems/pf2e/icons/equipment/treasure/currency/gold-pieces.webp","name":"Earn Income","permission":{"default":0},"scope":"global","type":"script"}
{"_id":"yBuEphSaJJ7V9Yw3","actorIds":[],"author":"ru9MkwAaWXaeSZph","command":"const tokens = canvas.tokens.controlled.filter((t) => ['character', 'npc', 'familiar'].includes(t.actor.data.type));\n\nif (tokens.length === 0) {\n    ui.notifications.error(`You must select at least one npc/pc token`);\n} else {\n    tokens.map((p) => p.actor).forEach((actor) => actor.data.data.skills.ste.roll(event, ['secret']));\n}","flags":{"core":{"sourceId":"Compendium.pf2e.pf2e-macros.yBuEphSaJJ7V9Yw3"}},"img":"systems/pf2e/icons/features/classes/surprice-attack.webp","name":"Stealth For Selected Tokens","permission":{"default":0},"scope":"global","type":"script"}
